cscope 15 $HOME/bf-sde-9.0.0/pkgsrc/switch-p4-16/p4src               0000256149
	@shared/acl.p4

23 #iâdeà
_P4_ACL_


24 
	#_P4_ACL_


	)

29 
aùiÚ
 
	$šg»ss_aş_d’y
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

30 
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

31 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
) {

32 
šdex
 = 
¡©s_šdex
;

33 
ig_md
.
æags
.
aş_d’y
 = 
Œue
;

34 
	}
}

36 
aùiÚ
 
	$šg»ss_aş_³rm™
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

37 
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

38 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
) {

39 
šdex
 = 
¡©s_šdex
;

40 
ig_md
.
æags
.
aş_d’y
 = 
çl£
;

41 
	}
}

43 
aùiÚ
 
	$šg»ss_aş_»dœeù
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

44 
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

45 
šout
 
sw™ch_Ãxthİ_t
 
Ãxthİ
,

46 
sw™ch_Ãxthİ_t
 
Ãxthİ_šdex
,

47 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
) {

48 
šdex
 = 
¡©s_šdex
;

49 
ig_md
.
æags
.
aş_d’y
 = 
çl£
;

50 #ifdeà
ACL_REDIRECT_OPT


51 
ig_md
.
aş_Ãxthİ
 = 
Ãxthİ_šdex
;

52 
ig_md
.
aş_»dœeù
 = 
Œue
;

54 
	}
}

56 
aùiÚ
 
	$šg»ss_aş_mœrÜ
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

57 
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

58 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
,

59 
sw™ch_mœrÜ_£ssiÚ_t
 
£ssiÚ_id
) {

60 #ifdeà
INGRESS_MIRROR_ACL_ENABLE


61 
šdex
 = 
¡©s_šdex
;

62 
ig_md
.
mœrÜ
.
ty³
 = 
SWITCH_MIRROR_TYPE_PORT
;

63 
ig_md
.
mœrÜ
.
¤c
 = 
SWITCH_PKT_SRC_CLONED_INGRESS
;

64 
ig_md
.
mœrÜ
.
£ssiÚ_id
 = session_id;

66 
	}
}

71 
aùiÚ
 
	$eg»ss_aş_d’y
(
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

72 
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

73 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
) {

74 
šdex
 = 
¡©s_šdex
;

75 
eg_md
.
æags
.
aş_d’y
 = 
Œue
;

76 
	}
}

78 
aùiÚ
 
	$eg»ss_aş_³rm™
(
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

79 
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

80 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
) {

81 
šdex
 = 
¡©s_šdex
;

82 
eg_md
.
æags
.
aş_d’y
 = 
çl£
;

83 
	}
}

85 
aùiÚ
 
	$eg»ss_aş_mœrÜ
(
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

86 
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

87 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
,

88 
sw™ch_mœrÜ_£ssiÚ_t
 
£ssiÚ_id
) {

89 #ifdeà
EGRESS_MIRROR_ACL_ENABLE


90 
šdex
 = 
¡©s_šdex
;

91 
eg_md
.
mœrÜ
.
ty³
 = 
SWITCH_MIRROR_TYPE_PORT
;

92 
eg_md
.
mœrÜ
.
¤c
 = 
SWITCH_PKT_SRC_CLONED_EGRESS
;

93 
eg_md
.
mœrÜ
.
£ssiÚ_id
 = session_id;

95 
	}
}

100 
	#INGRESS_MAC_ACL_KEY
 \

101 
lkp
.
mac_¤c_addr
 : 
‹º¬y
; \

102 
lkp
.
mac_d¡_addr
 : 
‹º¬y
; \

103 
lkp
.
mac_ty³
 : 
‹º¬y
;

	)

105 
	#INGRESS_IPV4_ACL_KEY
 \

106 
lkp
.
_¤c_addr
[31:0] : 
‹º¬y
; \

107 
lkp
.
_d¡_addr
[31:0] : 
‹º¬y
; \

108 
lkp
.
_´Ùo
 : 
‹º¬y
; \

109 
lkp
.
_tos
 : 
‹º¬y
; \

110 
lkp
.
l4_¤c_pÜt
 : 
‹º¬y
; \

111 
lkp
.
l4_d¡_pÜt
 : 
‹º¬y
; \

112 
lkp
.
_‰l
 : 
‹º¬y
; \

113 
lkp
.
_äag
 : 
‹º¬y
; \

114 
lkp
.
tı_æags
 : 
‹º¬y
;

	)

116 
	#INGRESS_IPV6_ACL_KEY
 \

117 
lkp
.
_¤c_addr
 : 
‹º¬y
; \

118 
lkp
.
_d¡_addr
 : 
‹º¬y
; \

119 
lkp
.
_´Ùo
 : 
‹º¬y
; \

120 
lkp
.
_tos
 : 
‹º¬y
; \

121 
lkp
.
l4_¤c_pÜt
 : 
‹º¬y
; \

122 
lkp
.
l4_d¡_pÜt
 : 
‹º¬y
; \

123 
lkp
.
_‰l
 : 
‹º¬y
; \

124 
lkp
.
tı_æags
 : 
‹º¬y
;

	)

126 
	#INGRESS_IP_ACL_KEY
 \

127 
lkp
.
mac_ty³
 : 
‹º¬y
; \

128 
lkp
.
_¤c_addr
 : 
‹º¬y
; \

129 
lkp
.
_d¡_addr
 : 
‹º¬y
; \

130 
lkp
.
_´Ùo
 : 
‹º¬y
; \

131 
lkp
.
_tos
 : 
‹º¬y
; \

132 
lkp
.
l4_¤c_pÜt
 : 
‹º¬y
; \

133 
lkp
.
l4_d¡_pÜt
 : 
‹º¬y
; \

134 
lkp
.
_‰l
 : 
‹º¬y
; \

135 
lkp
.
tı_æags
 : 
‹º¬y
;

	)

137 
	#EGRESS_IPV4_ACL_KEY
 \

138 
hdr
.
v4
.
¤c_addr
 : 
‹º¬y
; \

139 
hdr
.
v4
.
d¡_addr
 : 
‹º¬y
; \

140 
hdr
.
v4
.
´ÙocŞ
 : 
‹º¬y
; \

141 
hdr
.
v4
.
diff£rv
 : 
‹º¬y
; \

142 
lkp
.
tı_æags
 : 
‹º¬y
; \

143 
lkp
.
l4_¤c_pÜt
 : 
‹º¬y
; \

144 
lkp
.
l4_d¡_pÜt
 : 
‹º¬y
;

	)

146 
	#EGRESS_IPV6_ACL_KEY
 \

147 
hdr
.
v6
.
¤c_addr
 : 
‹º¬y
; \

148 
hdr
.
v6
.
d¡_addr
 : 
‹º¬y
; \

149 
hdr
.
v6
.
Ãxt_hdr
 : 
‹º¬y
; \

150 
hdr
.
v6
.
Œaffic_şass
 : 
‹º¬y
; \

151 
lkp
.
tı_æags
 : 
‹º¬y
; \

152 
lkp
.
l4_¤c_pÜt
 : 
‹º¬y
; \

153 
lkp
.
l4_d¡_pÜt
 : 
‹º¬y
;

	)

158 
cÚŒŞ
 
	$Ing»ssIpAş
(

159 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

160 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

161 
out
 
sw™ch_¡©s_šdex_t
 
šdex
,

162 
out
 
sw™ch_Ãxthİ_t
 
Ãxthİ
)(

163 
sw™ch_ušt32_t
 
bË_size
=512) {

165 
bË
 
aş
 {

166 
key
 = {

167 
INGRESS_IP_ACL_KEY


168 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

169 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

170 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

173 
aùiÚs
 = {

174 
NoAùiÚ
;

175 
	`šg»ss_aş_d’y
(
ig_md
, 
šdex
);

176 
	`šg»ss_aş_³rm™
(
ig_md
, 
šdex
);

177 
	`šg»ss_aş_»dœeù
(
ig_md
, 
šdex
, 
Ãxthİ
);

180 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

181 
size
 = 
bË_size
;

184 
­¶y
 {

185 
aş
.
	`­¶y
();

187 
	}
}

192 
cÚŒŞ
 
	$Ing»ssIpv4Aş
(

193 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

194 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

195 
out
 
sw™ch_¡©s_šdex_t
 
šdex
,

196 
out
 
sw™ch_Ãxthİ_t
 
Ãxthİ
)(

197 
sw™ch_ušt32_t
 
bË_size
=512) {

199 
bË
 
aş
 {

200 
key
 = {

201 
INGRESS_IPV4_ACL_KEY


202 
lkp
.
mac_ty³
 : 
‹º¬y
;

203 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

204 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

205 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

208 
aùiÚs
 = {

209 
NoAùiÚ
;

210 
	`šg»ss_aş_d’y
(
ig_md
, 
šdex
);

211 
	`šg»ss_aş_³rm™
(
ig_md
, 
šdex
);

212 
	`šg»ss_aş_»dœeù
(
ig_md
, 
šdex
, 
Ãxthİ
);

215 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

216 
size
 = 
bË_size
;

219 
­¶y
 {

220 
aş
.
	`­¶y
();

222 
	}
}

227 
cÚŒŞ
 
	$Ing»ssIpv6Aş
(

228 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

229 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

230 
out
 
sw™ch_¡©s_šdex_t
 
šdex
,

231 
out
 
sw™ch_Ãxthİ_t
 
Ãxthİ
)(

232 
sw™ch_ušt32_t
 
bË_size
=512) {

233 
bË
 
aş
 {

234 
key
 = {

235 
INGRESS_IPV6_ACL_KEY


236 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

237 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

238 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

241 
aùiÚs
 = {

242 
NoAùiÚ
;

243 
	`šg»ss_aş_d’y
(
ig_md
, 
šdex
);

244 
	`šg»ss_aş_³rm™
(
ig_md
, 
šdex
);

245 
	`šg»ss_aş_»dœeù
(
ig_md
, 
šdex
, 
Ãxthİ
);

248 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

249 
size
 = 
bË_size
;

252 
­¶y
 {

253 
aş
.
	`­¶y
();

255 
	}
}

260 
cÚŒŞ
 
	$Ing»ssMacAş
(

261 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

262 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

263 
out
 
sw™ch_¡©s_šdex_t
 
šdex
,

264 
out
 
sw™ch_Ãxthİ_t
 
Ãxthİ
)(

265 
sw™ch_ušt32_t
 
bË_size
=512) {

267 
bË
 
aş
 {

268 
key
 = {

269 
INGRESS_MAC_ACL_KEY


270 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

271 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

274 
aùiÚs
 = {

275 
NoAùiÚ
;

276 
	`šg»ss_aş_d’y
(
ig_md
, 
šdex
);

277 
	`šg»ss_aş_³rm™
(
ig_md
, 
šdex
);

278 
	`šg»ss_aş_»dœeù
(
ig_md
, 
šdex
, 
Ãxthİ
);

281 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

282 
size
 = 
bË_size
;

285 
­¶y
 {

286 
aş
.
	`­¶y
();

288 
	}
}

302 
cÚŒŞ
 
LOU
(
š
 
b™
<16> 
¤c_pÜt
,

303 
š
 
b™
<16> 
d¡_pÜt
,

304 
šout
 
b™
<8> 
tı_æags
,

305 
out
 
sw™ch_l4_pÜt_Ïb–_t
 
pÜt_Ïb–
) {

307 cÚ¡ 
sw™ch_ušt32_t
 
	gbË_size
 = 
sw™ch_l4_pÜt_Ïb–_width
 / 2;

310 
aùiÚ
 
£t_¤c_pÜt_Ïb–
(
b™
<8> 
Ïb–
) {

311 
	gpÜt_Ïb–
[7:0] = 
Ïb–
;

314 
aùiÚ
 
£t_d¡_pÜt_Ïb–
(
b™
<8> 
Ïb–
) {

315 
	gpÜt_Ïb–
[15:8] = 
Ïb–
;

318 @
’Œ›s_w™h_¿nges
(
bË_size
)

320 
bË
 
	gl4_d¡_pÜt
 {

321 
	gkey
 = {

322 
d¡_pÜt
 : 
¿nge
;

325 
	gaùiÚs
 = {

326 
NoAùiÚ
;

327 
	g£t_d¡_pÜt_Ïb–
;

330 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

331 
	gsize
 = 
bË_size
;

334 @
’Œ›s_w™h_¿nges
(
bË_size
)

335 
bË
 
	gl4_¤c_pÜt
 {

336 
	gkey
 = {

337 
¤c_pÜt
 : 
¿nge
;

340 
	gaùiÚs
 = {

341 
NoAùiÚ
;

342 
	g£t_¤c_pÜt_Ïb–
;

345 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

346 
	gsize
 = 
bË_size
;

349 
aùiÚ
 
£t_tı_æags
(
b™
<8> 
æags
) {

350 
	gtı_æags
 = 
æags
;

353 
bË
 
	gtı
 {

354 
	gkey
 = { 
tı_æags
 : 
exaù
; }

355 
	gaùiÚs
 = {

356 
NoAùiÚ
;

357 
	g£t_tı_æags
;

360 
	gsize
 = 256;

363 
	g­¶y
 {

364 #ifdeà
L4_PORT_LOU_ENABLE


365 
	gl4_¤c_pÜt
.
­¶y
();

366 
	gl4_d¡_pÜt
.
­¶y
();

369 #ifdeà
TCP_FLAGS_LOU_ENABLE


370 
	gtı
.
­¶y
();

385 
cÚŒŞ
 
	$Ing»ssAş
(

386 
šout
 
sw™ch_lookup_f›lds_t
 
lkp
,

387 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

388 #ià
	`defšed
(
INGRESS_SHARED_IP_ACL_ENABLE
)

389 
sw™ch_ušt32_t
 
_bË_size
=512,

391 
sw™ch_ušt32_t
 
v4_bË_size
=512,

392 
sw™ch_ušt32_t
 
v6_bË_size
=512,

394 
sw™ch_ušt32_t
 
mac_bË_size
=512,

395 
boŞ
 
mac_aş_’abË
=
çl£
,

396 
boŞ
 
mac_·ck‘_şass_’abË
=
çl£
) {

398 #ià
	`defšed
(
INGRESS_SHARED_IP_ACL_ENABLE
)

399 
	`Ing»ssIpAş
(
_bË_size
è
_aş
;

401 
	`Ing»ssIpv4Aş
(
v4_bË_size
è
v4_aş
;

402 
	`Ing»ssIpv6Aş
(
v6_bË_size
è
v6_aş
;

404 
	`Ing»ssMacAş
(
mac_bË_size
è
mac_aş
;

405 
	`LOU
(è
lou
;

407 #ià
	`defšed
(
INGRESS_SHARED_IP_ACL_ENABLE
)

408 
CouÁ”
<
b™
<16>, 
sw™ch_¡©s_šdex_t
>(

409 
_bË_size
 + 
mac_bË_size
, 
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

411 
CouÁ”
<
b™
<16>, 
sw™ch_¡©s_šdex_t
>(

412 
v4_bË_size
 + 
v6_bË_size
 + 
mac_bË_size
, 
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

415 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
;

416 
sw™ch_Ãxthİ_t
 
Ãxthİ
;

418 
­¶y
 {

419 
ig_md
.
æags
.
aş_d’y
 = 
çl£
;

420 
¡©s_šdex
 = 0;

421 
Ãxthİ
 = 0;

423 
lou
.
	`­¶y
(
lkp
.
l4_¤c_pÜt
,†kp.
l4_d¡_pÜt
,†kp.
tı_æags
, 
ig_md
.
l4_pÜt_Ïb–
);

425 ià(
mac_aş_’abË
 && !
	`INGRESS_BYPASS
(
ACL
)) {

426 ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_NONE
 || \

427 (
mac_·ck‘_şass_’abË
 && 
ig_md
.
æags
.
mac_pkt_şass
)) {

428 
mac_aş
.
	`­¶y
(
lkp
, 
ig_md
, 
¡©s_šdex
, 
Ãxthİ
);

432 #ià
	`defšed
(
INGRESS_SHARED_IP_ACL_ENABLE
)

433 ià(!
	`INGRESS_BYPASS
(
ACL
)) {

434 ià(
lkp
.
_ty³
 !ğ
SWITCH_IP_TYPE_NONE
) {

435 
_aş
.
	`­¶y
(
lkp
, 
ig_md
, 
¡©s_šdex
, 
Ãxthİ
);

439 ià(!
	`INGRESS_BYPASS
(
ACL
è&& (!
mac_·ck‘_şass_’abË
 || !
ig_md
.
æags
.
mac_pkt_şass
)) {

440 ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV6
) {

441 
v6_aş
.
	`­¶y
(
lkp
, 
ig_md
, 
¡©s_šdex
, 
Ãxthİ
);

442 } ià(!
mac_aş_’abË
 || 
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV4
) {

443 
v4_aş
.
	`­¶y
(
lkp
, 
ig_md
, 
¡©s_šdex
, 
Ãxthİ
);

448 #ià
	`defšed
(
ACL_REDIRECT_ENABLE
è&& !defšed(
ACL_REDIRECT_OPT
)

449 ià(
Ãxthİ
 != 0)

450 
ig_md
.
Ãxthİ
 =‚exthop;

453 
¡©s
.
	`couÁ
(
¡©s_šdex
);

455 
	}
}

459 
aùiÚ
 
	$¿ş_d’y
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

460 
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

461 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
) {

462 
šdex
 = 
¡©s_šdex
;

463 
ig_md
.
æags
.
¿ş_d’y
 = 
Œue
;

464 
	}
}

466 
aùiÚ
 
	$¿ş_³rm™
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

467 
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

468 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
) {

469 
šdex
 = 
¡©s_šdex
;

470 
ig_md
.
æags
.
¿ş_d’y
 = 
çl£
;

471 
	}
}

473 
aùiÚ
 
	$¿ş_»dœeù
(
šout
 
sw™ch_¡©s_šdex_t
 
šdex
,

474 
šout
 
sw™ch_Ãxthİ_t
 
Ãxthİ
,

475 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
,

476 
sw™ch_Ãxthİ_t
 
Ãxthİ_šdex
) {

477 
šdex
 = 
¡©s_šdex
;

478 
Ãxthİ
 = 
Ãxthİ_šdex
;

479 
	}
}

484 
cÚŒŞ
 
	$Ipv4Raş
(

485 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

486 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

487 
out
 
sw™ch_¡©s_šdex_t
 
šdex
,

488 
out
 
sw™ch_Ãxthİ_t
 
Ãxthİ
)(

489 
sw™ch_ušt32_t
 
bË_size
=512) {

491 
bË
 
aş
 {

492 
key
 = {

493 
INGRESS_IPV4_ACL_KEY


494 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

495 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

496 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

499 
aùiÚs
 = {

500 
NoAùiÚ
;

501 
	`¿ş_d’y
(
ig_md
, 
šdex
);

502 
	`¿ş_³rm™
(
ig_md
, 
šdex
);

503 
	`¿ş_»dœeù
(
šdex
, 
Ãxthİ
);

506 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

507 
size
 = 
bË_size
;

510 
­¶y
 {

511 
aş
.
	`­¶y
();

513 
	}
}

519 
cÚŒŞ
 
	$Ipv6Raş
(

520 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

521 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

522 
out
 
sw™ch_¡©s_šdex_t
 
šdex
,

523 
out
 
sw™ch_Ãxthİ_t
 
Ãxthİ
)(

524 
sw™ch_ušt32_t
 
bË_size
=512) {

526 
bË
 
aş
 {

527 
key
 = {

528 
INGRESS_IPV6_ACL_KEY


529 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

530 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

531 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

534 
aùiÚs
 = {

535 
NoAùiÚ
;

536 
	`¿ş_d’y
(
ig_md
, 
šdex
);

537 
	`¿ş_³rm™
(
ig_md
, 
šdex
);

538 
	`¿ş_»dœeù
(
šdex
, 
Ãxthİ
);

541 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

542 
size
 = 
bË_size
;

545 
­¶y
 {

546 
aş
.
	`­¶y
();

548 
	}
}

559 
cÚŒŞ
 
	$Rou‹rAş
(
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

560 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

561 
sw™ch_ušt32_t
 
v4_bË_size
=512,

562 
sw™ch_ušt32_t
 
v6_bË_size
=512,

563 
boŞ
 
¡©s_’abË
=
çl£
) {

565 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
;

566 
sw™ch_Ãxthİ_t
 
Ãxthİ
;

568 
CouÁ”
<
b™
<16>, 
sw™ch_¡©s_šdex_t
>(

569 
v4_bË_size
 + 
v6_bË_size
, 
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

571 
	`Ipv4Raş
(
v4_bË_size
è
v4_¿ş
;

572 
	`Ipv6Raş
(
v6_bË_size
è
v6_¿ş
;

574 
­¶y
 {

575 #ifdeà
RACL_ENABLE


576 
¡©s_šdex
 = 0;

578 ià(!
	`INGRESS_BYPASS
(
ACL
)) {

579 ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV4
) {

580 
v4_¿ş
.
	`­¶y
(
lkp
, 
ig_md
, 
¡©s_šdex
, 
Ãxthİ
);

581 } ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV6
) {

582 #ifdeà
IPV6_ENABLE


583 
v6_¿ş
.
	`­¶y
(
lkp
, 
ig_md
, 
¡©s_šdex
, 
Ãxthİ
);

588 #ifdeà
PBR_ENABLE


589 ià(
Ãxthİ
 !ğ0 && 
ig_md
.
æags
.
rou‹d
)

590 
ig_md
.
Ãxthİ
 =‚exthop;

593 ià(
¡©s_’abË
 && 
ig_md
.
æags
.
rou‹d
)

594 
¡©s
.
	`couÁ
(
¡©s_šdex
);

597 
	}
}

606 
cÚŒŞ
 
	$Ipv4MœrÜAş
(

607 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

608 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

609 
out
 
sw™ch_¡©s_šdex_t
 
šdex
)(

610 
sw™ch_ušt32_t
 
bË_size
=512) {

612 
bË
 
aş
 {

613 
key
 = {

614 
INGRESS_IPV4_ACL_KEY


615 
lkp
.
mac_ty³
 : 
‹º¬y
;

616 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

617 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

620 
aùiÚs
 = {

621 
NoAùiÚ
;

622 
	`šg»ss_aş_mœrÜ
(
ig_md
, 
šdex
);

625 
size
 = 
bË_size
;

628 
­¶y
 {

629 
aş
.
	`­¶y
();

631 
	}
}

640 
cÚŒŞ
 
	$Ipv6MœrÜAş
(

641 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

642 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

643 
out
 
sw™ch_¡©s_šdex_t
 
šdex
)(

644 
sw™ch_ušt32_t
 
bË_size
=512) {

646 
bË
 
aş
 {

647 
key
 = {

648 
INGRESS_IPV6_ACL_KEY


649 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

650 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

653 
aùiÚs
 = {

654 
NoAùiÚ
;

655 
	`šg»ss_aş_mœrÜ
(
ig_md
, 
šdex
);

658 
size
 = 
bË_size
;

661 
­¶y
 {

662 
aş
.
	`­¶y
();

664 
	}
}

673 
cÚŒŞ
 
	$IpMœrÜAş
(

674 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

675 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

676 
out
 
sw™ch_¡©s_šdex_t
 
šdex
)(

677 
sw™ch_ušt32_t
 
bË_size
=512) {

679 
bË
 
aş
 {

680 
key
 = {

681 
INGRESS_IP_ACL_KEY


682 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

683 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

686 
aùiÚs
 = {

687 
NoAùiÚ
;

688 
	`šg»ss_aş_mœrÜ
(
ig_md
, 
šdex
);

691 
size
 = 
bË_size
;

694 
­¶y
 {

695 
aş
.
	`­¶y
();

697 
	}
}

708 
cÚŒŞ
 
	$MœrÜAş
(

709 
šout
 
sw™ch_lookup_f›lds_t
 
lkp
,

710 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

711 
sw™ch_ušt32_t
 
v4_bË_size
=512,

712 
sw™ch_ušt32_t
 
v6_bË_size
=512,

713 
boŞ
 
¡©s_’abË
=
çl£
) {

715 
	`Ipv4MœrÜAş
(
v4_bË_size
è
v4
;

716 
	`Ipv6MœrÜAş
(
v6_bË_size
è
v6
;

717 
	`IpMœrÜAş
(
v6_bË_size
è

;

719 
CouÁ”
<
b™
<16>, 
sw™ch_¡©s_šdex_t
>(

720 
v4_bË_size
 + 
v6_bË_size
, 
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

721 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
;

723 
­¶y
 {

724 #ifdeà
INGRESS_MIRROR_ACL_ENABLE


725 
¡©s_šdex
 = 0;

727 ià(!
	`INGRESS_BYPASS
(
ACL
)) {

728 #ifdeà
NON_SHARED_INGRESS_MIRROR_ACL


729 ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV4
) {

730 
v4
.
	`­¶y
(
lkp
, 
ig_md
, 
¡©s_šdex
);

731 } ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV6
) {

732 #ifdeà
IPV6_ENABLE


733 
v6
.
	`­¶y
(
lkp
, 
ig_md
, 
¡©s_šdex
);

737 

.
	`­¶y
(
lkp
, 
ig_md
, 
¡©s_šdex
);

741 ià(
¡©s_’abË
)

742 
¡©s
.
	`couÁ
(
¡©s_šdex
);

745 
	}
}

756 
cÚŒŞ
 
	$Ipv4Eg»ssMœrÜAş
(

757 
š
 
sw™ch_h—d”_t
 
hdr
,

758 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

759 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

760 
out
 
sw™ch_¡©s_šdex_t
 
šdex
)(

761 
sw™ch_ušt32_t
 
bË_size
=512) {

763 
bË
 
aş
 {

764 
key
 = {

765 
EGRESS_IPV4_ACL_KEY


766 
hdr
.
‘h”Ãt
.
‘h”_ty³
 : 
‹º¬y
;

767 
eg_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

768 
eg_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

771 
aùiÚs
 = {

772 
NoAùiÚ
;

773 
	`eg»ss_aş_mœrÜ
(
eg_md
, 
šdex
);

776 
size
 = 
bË_size
;

779 
­¶y
 {

780 
aş
.
	`­¶y
();

782 
	}
}

793 
cÚŒŞ
 
	$Ipv6Eg»ssMœrÜAş
(

794 
š
 
sw™ch_h—d”_t
 
hdr
,

795 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

796 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

797 
out
 
sw™ch_¡©s_šdex_t
 
šdex
)(

798 
sw™ch_ušt32_t
 
bË_size
=512) {

800 
bË
 
aş
 {

801 
key
 = {

802 
EGRESS_IPV6_ACL_KEY


803 
eg_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

804 
eg_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

807 
aùiÚs
 = {

808 
NoAùiÚ
;

809 
	`eg»ss_aş_mœrÜ
(
eg_md
, 
šdex
);

812 
size
 = 
bË_size
;

815 
­¶y
 {

816 
aş
.
	`­¶y
();

818 
	}
}

830 
cÚŒŞ
 
	$Eg»ssMœrÜAş
(

831 
š
 
sw™ch_h—d”_t
 
hdr
,

832 
šout
 
sw™ch_lookup_f›lds_t
 
lkp
,

833 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

834 
sw™ch_ušt32_t
 
v4_bË_size
=512,

835 
sw™ch_ušt32_t
 
v6_bË_size
=512,

836 
boŞ
 
¡©s_’abË
=
çl£
) {

837 
	`Ipv4Eg»ssMœrÜAş
(
v4_bË_size
è
v4
;

838 
	`Ipv6Eg»ssMœrÜAş
(
v6_bË_size
è
v6
;

840 
CouÁ”
<
b™
<16>, 
sw™ch_¡©s_šdex_t
>(

841 
v4_bË_size
 + 
v6_bË_size
, 
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

842 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
;

844 
­¶y
 {

845 #ifdeà
EGRESS_MIRROR_ACL_ENABLE


846 ià(!
	`EGRESS_BYPASS
(
ACL
)) {

847 ià(
hdr
.
v4
.
	`isV®id
()) {

848 
v4
.
	`­¶y
(
hdr
, 
lkp
, 
eg_md
, 
¡©s_šdex
);

849 } ià(
hdr
.
v6
.
	`isV®id
()) {

850 #ifdeà
IPV6_ENABLE


851 
v6
.
	`­¶y
(
hdr
, 
lkp
, 
eg_md
, 
¡©s_šdex
);

856 ià(
¡©s_’abË
)

857 
¡©s
.
	`couÁ
(
¡©s_šdex
);

860 
	}
}

870 
cÚŒŞ
 
	$Ing»ssSy¡emAş
(

871 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

872 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
,

873 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
)(

874 
sw™ch_ušt32_t
 
bË_size
=512) {

876 cÚ¡ 
sw™ch_ušt32_t
 
drİ_¡©s_bË_size
 = 8192;

878 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS
è
¡©s
;

880 
M‘”
<
b™
<8>>(1 << 
sw™ch_cİp_m‘”_id_width
, 
M‘”Ty³_t
.
PACKETS
è
cİp_m‘”
;

881 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS
è
cİp_¡©s
;

883 
sw™ch_cİp_m‘”_id_t
 
cİp_m‘”_id
;

885 
aùiÚ
 
	`drİ
(
sw™ch_drİ_»asÚ_t
 
drİ_»asÚ
, 
boŞ
 
di§bË_Ë¬nšg
) {

886 
ig_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0x1;

887 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
 =

888 
di§bË_Ë¬nšg
 ? 
SWITCH_DIGEST_TYPE_INVALID
 : 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
;

889 
ig_md
.
drİ_»asÚ
 = drop_reason;

892 
aùiÚ
 
	`cİy_to_ıu
(
sw™ch_ıu_»asÚ_t
 
»asÚ_code
,

893 
sw™ch_qid_t
 
qid
,

894 
sw™ch_cİp_m‘”_id_t
 
m‘”_id
,

895 
boŞ
 
di§bË_Ë¬nšg
) {

896 
ig_md
.
qos
.
qid
 = qid;

898 
ig_šŒ_md_fÜ_tm
.
cİy_to_ıu
 = 1
w1
;

899 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
 =

900 
di§bË_Ë¬nšg
 ? 
SWITCH_DIGEST_TYPE_INVALID
 : 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
;

901 #ifdeà
COPP_ENABLE


902 
ig_šŒ_md_fÜ_tm
.
·ck‘_cŞÜ
 = (
b™
<2>è
cİp_m‘”
.
	`execu‹
(
m‘”_id
);

903 
cİp_m‘”_id
 = 
m‘”_id
;

905 
ig_md
.
ıu_»asÚ
 = 
»asÚ_code
;

908 
aùiÚ
 
	`»dœeù_to_ıu
(
sw™ch_ıu_»asÚ_t
 
»asÚ_code
,

909 
sw™ch_qid_t
 
qid
,

910 
sw™ch_cİp_m‘”_id_t
 
m‘”_id
,

911 
boŞ
 
di§bË_Ë¬nšg
) {

912 
ig_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0b1;

913 
	`cİy_to_ıu
(
»asÚ_code
, 
qid
, 
m‘”_id
, 
di§bË_Ë¬nšg
);

916 
bË
 
sy¡em_aş
 {

917 
key
 = {

918 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

919 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

920 
ig_md
.
ifšdex
 : 
‹º¬y
;

923 
ig_md
.
lkp
.
pkt_ty³
 : 
‹º¬y
;

924 
ig_md
.
lkp
.
mac_ty³
 : 
‹º¬y
;

925 
ig_md
.
lkp
.
mac_d¡_addr
 : 
‹º¬y
;

926 
ig_md
.
lkp
.
_ty³
 : 
‹º¬y
;

927 
ig_md
.
lkp
.
_‰l
 : 
‹º¬y
;

928 
ig_md
.
lkp
.
_´Ùo
 : 
‹º¬y
;

929 
ig_md
.
lkp
.
_äag
 : 
‹º¬y
;

930 
ig_md
.
lkp
.
_d¡_addr
 : 
‹º¬y
;

931 
ig_md
.
lkp
.
l4_¤c_pÜt
 : 
‹º¬y
;

932 
ig_md
.
lkp
.
l4_d¡_pÜt
 : 
‹º¬y
;

933 
ig_md
.
lkp
.
¬p_İcode
 : 
‹º¬y
;

936 
ig_md
.
æags
.
pÜt_vÏn_miss
 : 
‹º¬y
;

937 
ig_md
.
æags
.
aş_d’y
 : 
‹º¬y
;

938 
ig_md
.
æags
.
¿ş_d’y
 : 
‹º¬y
;

939 
ig_md
.
æags
.
rmac_h™
 : 
‹º¬y
;

940 
ig_md
.
æags
.
dmac_miss
 : 
‹º¬y
;

941 
ig_md
.
æags
.
my
 : 
‹º¬y
;

942 
ig_md
.
æags
.
gËª
 : 
‹º¬y
;

943 
ig_md
.
æags
.
rou‹d
 : 
‹º¬y
;

944 #ifdeà
INGRESS_ACL_POLICER_ENABLE


945 
ig_md
.
qos
.
aş_pŞiûr_cŞÜ
 : 
‹º¬y
;

947 #ifdeà
STORM_CONTROL_ENABLE


948 
ig_md
.
qos
.
¡Üm_cÚŒŞ_cŞÜ
 : 
‹º¬y
;

950 
ig_md
.
æags
.
lšk_loÿl
 : 
‹º¬y
;

952 #ifdeà
INGRESS_PORT_METER_ENABLE


953 
ig_md
.
æags
.
pÜt_pŞiûr_drİ
 : 
‹º¬y
;

956 #ifdeà
UNICAST_SELF_FORWARDING_CHECK


957 
ig_md
.
checks
.
§me_bd
 : 
‹º¬y
;

958 
ig_md
.
checks
.
§me_if
 : 
‹º¬y
;

961 #ifdeà
STP_ENABLE


962 
ig_md
.
¡p
.
¡©e_
 : 
‹º¬y
;

964 #ifdeà
PFC_ENABLE


965 
ig_md
.
æags
.
pfc_wd_drİ
 : 
‹º¬y
;

967 
ig_md
.
v4
.
uniÿ¡_’abË
 : 
‹º¬y
;

968 
ig_md
.
v6
.
uniÿ¡_’abË
 : 
‹º¬y
;

970 #ifdeà
MULTICAST_ENABLE


971 
ig_md
.
checks
.
m½f
 : 
‹º¬y
;

972 
ig_md
.
v4
.
muÉiÿ¡_’abË
 : 
‹º¬y
;

973 
ig_md
.
v4
.
muÉiÿ¡_¢oİšg
 : 
‹º¬y
;

974 
ig_md
.
v6
.
muÉiÿ¡_’abË
 : 
‹º¬y
;

975 
ig_md
.
v6
.
muÉiÿ¡_¢oİšg
 : 
‹º¬y
;

977 
ig_md
.
drİ_»asÚ
 : 
‹º¬y
;

980 
aùiÚs
 = {

981 
NoAùiÚ
;

982 
drİ
;

983 
cİy_to_ıu
;

984 
»dœeù_to_ıu
;

987 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

988 
size
 = 
bË_size
;

991 
aùiÚ
 
	`cİp_drİ
() {

992 
ig_šŒ_md_fÜ_tm
.
cİy_to_ıu
 = 1
w0
;

993 
cİp_¡©s
.
	`couÁ
();

996 
aùiÚ
 
	`cİp_³rm™
() {

997 
cİp_¡©s
.
	`couÁ
();

1000 
bË
 
cİp
 {

1001 
key
 = {

1002 
ig_šŒ_md_fÜ_tm
.
·ck‘_cŞÜ
 : 
‹º¬y
;

1003 
cİp_m‘”_id
 : 
‹º¬y
;

1006 
aùiÚs
 = {

1007 
cİp_³rm™
;

1008 
cİp_drİ
;

1011 cÚ¡ 
deçuÉ_aùiÚ
 = 
cİp_³rm™
;

1012 
size
 = (1 << 
sw™ch_cİp_m‘”_id_width
 + 1);

1013 
couÁ”s
 = 
cİp_¡©s
;

1016 
aùiÚ
 
	`couÁ
(è{ 
¡©s
.count(); }

1018 
bË
 
drİ_¡©s
 {

1019 
key
 = {

1020 
ig_md
.
drİ_»asÚ
 : 
exaù
 @
	`Çme
("drop_reason");

1021 
ig_md
.
pÜt
 : 
exaù
 @
	`Çme
("port");

1024 
aùiÚs
 = {

1025 @
deçuÉÚly
 
NoAùiÚ
;

1026 
couÁ
;

1029 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

1030 
couÁ”s
 = 
¡©s
;

1031 
size
 = 
drİ_¡©s_bË_size
;

1034 
­¶y
 {

1035 
ig_šŒ_md_fÜ_tm
.
cİy_to_ıu
 = 1
w0
;

1036 
cİp_m‘”_id
 = 0;

1038 ià(!
	`INGRESS_BYPASS
(
SYSTEM_ACL
))

1039 
sy¡em_aş
.
	`­¶y
();

1041 #ifdeà
COPP_ENABLE


1042 
cİp
.
	`­¶y
();

1044 
drİ_¡©s
.
	`­¶y
();

1046 
	}
}

1051 
cÚŒŞ
 
	$Eg»ssMacAş
(
š
 
sw™ch_h—d”_t
 
hdr
,

1052 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

1053 
out
 
sw™ch_¡©s_šdex_t
 
šdex
)(

1054 
sw™ch_ušt32_t
 
bË_size
=512) {

1055 
bË
 
aş
 {

1056 
key
 = {

1057 
eg_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

1058 
eg_md
.
bd_Ïb–
 : 
‹º¬y
;

1059 
hdr
.
‘h”Ãt
.
¤c_addr
 : 
‹º¬y
;

1060 
hdr
.
‘h”Ãt
.
d¡_addr
 : 
‹º¬y
;

1061 
hdr
.
‘h”Ãt
.
‘h”_ty³
 : 
‹º¬y
;

1064 
aùiÚs
 = {

1065 
NoAùiÚ
;

1066 
	`eg»ss_aş_d’y
(
eg_md
, 
šdex
);

1067 
	`eg»ss_aş_³rm™
(
eg_md
, 
šdex
);

1070 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

1071 
size
 = 
bË_size
;

1074 
­¶y
 {

1075 
aş
.
	`­¶y
();

1077 
	}
}

1082 
cÚŒŞ
 
	$Eg»ssIpv4Aş
(
š
 
sw™ch_h—d”_t
 
hdr
,

1083 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

1084 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

1085 
out
 
sw™ch_¡©s_šdex_t
 
šdex
)(

1086 
sw™ch_ušt32_t
 
bË_size
=512) {

1087 
bË
 
aş
 {

1088 
key
 = {

1089 
EGRESS_IPV4_ACL_KEY


1090 
hdr
.
‘h”Ãt
.
‘h”_ty³
 : 
‹º¬y
;

1091 
eg_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

1092 
eg_md
.
bd_Ïb–
 : 
‹º¬y
;

1093 
eg_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

1096 
aùiÚs
 = {

1097 
NoAùiÚ
;

1098 
	`eg»ss_aş_d’y
(
eg_md
, 
šdex
);

1099 
	`eg»ss_aş_³rm™
(
eg_md
, 
šdex
);

1102 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

1103 
size
 = 
bË_size
;

1106 
­¶y
 {

1107 
aş
.
	`­¶y
();

1109 
	}
}

1114 
cÚŒŞ
 
	$Eg»ssIpv6Aş
(
š
 
sw™ch_h—d”_t
 
hdr
,

1115 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

1116 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

1117 
out
 
sw™ch_¡©s_šdex_t
 
šdex
)(

1118 
sw™ch_ušt32_t
 
bË_size
=512) {

1119 
bË
 
aş
 {

1120 
key
 = {

1121 
EGRESS_IPV6_ACL_KEY


1122 
eg_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

1123 
eg_md
.
bd_Ïb–
 : 
‹º¬y
;

1124 
eg_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

1127 
aùiÚs
 = {

1128 
NoAùiÚ
;

1129 
	`eg»ss_aş_d’y
(
eg_md
, 
šdex
);

1130 
	`eg»ss_aş_³rm™
(
eg_md
, 
šdex
);

1133 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

1134 
size
 = 
bË_size
;

1137 
­¶y
 {

1138 
aş
.
	`­¶y
();

1140 
	}
}

1142 
cÚŒŞ
 
	$Eg»ssAş
(
š
 
sw™ch_h—d”_t
 
hdr
,

1143 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

1144 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

1145 
sw™ch_ušt32_t
 
v4_bË_size
=512,

1146 
sw™ch_ušt32_t
 
v6_bË_size
=512,

1147 
sw™ch_ušt32_t
 
mac_bË_size
=512,

1148 
boŞ
 
mac_aş_’abË
=
çl£
) {

1149 
	`Eg»ssIpv4Aş
(
v4_bË_size
è
eg»ss_v4_aş
;

1150 
	`Eg»ssIpv6Aş
(
v6_bË_size
è
eg»ss_v6_aş
;

1151 
	`Eg»ssMacAş
(
mac_bË_size
è
eg»ss_mac_aş
;

1153 
CouÁ”
<
b™
<16>, 
sw™ch_¡©s_šdex_t
>(

1154 
v4_bË_size
 + 
v6_bË_size
 + 
mac_bË_size
, 
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

1156 
sw™ch_¡©s_šdex_t
 
¡©s_šdex
;

1158 
­¶y
 {

1159 
eg_md
.
æags
.
aş_d’y
 = 
çl£
;

1160 #ifdeà
EGRESS_IP_ACL_ENABLE


1161 
¡©s_šdex
 = 0;

1163 ià(
mac_aş_’abË
 && !
	`EGRESS_BYPASS
(
ACL
)) {

1164 
eg»ss_mac_aş
.
	`­¶y
(
hdr
, 
eg_md
, 
¡©s_šdex
);

1166 ià(!
	`EGRESS_BYPASS
(
ACL
)) {

1167 ià(
hdr
.
v6
.
	`isV®id
()) {

1168 
eg»ss_v6_aş
.
	`­¶y
(
hdr
, 
lkp
, 
eg_md
, 
¡©s_šdex
);

1169 } ià(!
mac_aş_’abË
 || 
hdr
.
v4
.
	`isV®id
()) {

1170 
eg»ss_v4_aş
.
	`­¶y
(
hdr
, 
lkp
, 
eg_md
, 
¡©s_šdex
);

1174 
¡©s
.
	`couÁ
(
¡©s_šdex
);

1177 
	}
}

1179 
cÚŒŞ
 
	$Eg»ssSy¡emAş
(

1180 
šout
 
sw™ch_h—d”_t
 
hdr
,

1181 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

1182 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

1183 
out
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
)(

1184 
sw™ch_ušt32_t
 
bË_size
=512) {

1186 cÚ¡ 
sw™ch_ušt32_t
 
drİ_¡©s_bË_size
 = 8192;

1187 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS
è
¡©s
;

1189 
aùiÚ
 
	`drİ
(
sw™ch_drİ_»asÚ_t
 
»asÚ_code
) {

1190 
eg_md
.
drİ_»asÚ
 = 
»asÚ_code
;

1191 
eg_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0x1;

1194 
aùiÚ
 
	`cİy_to_ıu
(
sw™ch_ıu_»asÚ_t
 
»asÚ_code
) {

1195 
eg_md
.
ıu_»asÚ
 = 
»asÚ_code
;

1196 
eg_šŒ_md_fÜ_d´¤
.
mœrÜ_ty³
 = 
SWITCH_MIRROR_TYPE_CPU
;

1197 
eg_md
.
mœrÜ
.
ty³
 = 
SWITCH_MIRROR_TYPE_CPU
;

1198 
eg_md
.
mœrÜ
.
£ssiÚ_id
 = 
SWITCH_MIRROR_SESSION_CPU
;

1199 
eg_md
.
mœrÜ
.
¤c
 = 
SWITCH_PKT_SRC_CLONED_EGRESS
;

1202 
aùiÚ
 
	`»dœeù_to_ıu
(
sw™ch_ıu_»asÚ_t
 
»asÚ_code
) {

1203 
	`cİy_to_ıu
(
»asÚ_code
);

1204 
eg_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0x1;

1207 
aùiÚ
 
	`š£¹_time¡amp
() {

1208 #ifdeà
PTP_ENABLE


1209 
hdr
.
time¡amp
.
	`£tV®id
();

1210 
hdr
.
time¡amp
.time¡am°ğ
eg_md
.
šg»ss_time¡amp
;

1214 
bË
 
sy¡em_aş
 {

1215 
key
 = {

1216 
eg_šŒ_md
.
eg»ss_pÜt
 : 
‹º¬y
;

1217 
eg_md
.
æags
.
aş_d’y
 : 
‹º¬y
;

1219 #ifdeà
MLAG_ENABLE


1220 
eg_md
.
æags
.
mÏg_memb”
 : 
‹º¬y
;

1221 
eg_md
.
æags
.
³”_lšk
 : 
‹º¬y
;

1223 
eg_md
.
checks
.
mtu
 : 
‹º¬y
;

1225 #ifdeà
STP_ENABLE


1226 
eg_md
.
checks
.
¡p
 : 
‹º¬y
;

1228 #ifdeà
WRED_ENABLE


1229 
eg_md
.
æags
.
w»d_drİ
 : 
‹º¬y
;

1231 #ifdeà
PFC_ENABLE


1232 
eg_md
.
æags
.
pfc_wd_drİ
 : 
‹º¬y
;

1237 
aùiÚs
 = {

1238 
NoAùiÚ
;

1239 
drİ
;

1240 
cİy_to_ıu
;

1241 
»dœeù_to_ıu
;

1242 
š£¹_time¡amp
;

1245 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

1246 
size
 = 
bË_size
;

1249 
aùiÚ
 
	`couÁ
(è{ 
¡©s
.count(); }

1251 
bË
 
drİ_¡©s
 {

1252 
key
 = {

1253 
eg_md
.
drİ_»asÚ
 : 
exaù
 @
	`Çme
("drop_reason");

1254 
eg_šŒ_md
.
eg»ss_pÜt
 : 
exaù
 @
	`Çme
("port");

1257 
aùiÚs
 = {

1258 @
deçuÉÚly
 
NoAùiÚ
;

1259 
couÁ
;

1262 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

1263 
couÁ”s
 = 
¡©s
;

1264 
size
 = 
drİ_¡©s_bË_size
;

1268 
­¶y
 {

1269 
eg_md
.
drİ_»asÚ
 = 0;

1271 ià(!
	`EGRESS_BYPASS
(
SYSTEM_ACL
))

1272 
sy¡em_aş
.
	`­¶y
();

1273 
drİ_¡©s
.
	`­¶y
();

1275 
	}
}

	@shared/dtel.p4

33 
cÚŒŞ
 
	$D‹lAş
(
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

34 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

35 
out
 
sw™ch_d‹l_»pÜt_ty³_t
 
»pÜt_ty³
)(

36 
sw™ch_ušt32_t
 
bË_size
=512) {

37 
aùiÚ
 
	`aş_h™
(
sw™ch_d‹l_»pÜt_ty³_t
 
ty³
) {

38 
»pÜt_ty³
 = 
ty³
;

41 
bË
 
aş
 {

42 
key
 = {

43 
INGRESS_IP_ACL_KEY


44 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

45 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

46 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

49 
aùiÚs
 = {

50 
aş_h™
;

53 cÚ¡ 
deçuÉ_aùiÚ
 = 
	`aş_h™
(
SWITCH_DTEL_REPORT_TYPE_NONE
);

54 
size
 = 
bË_size
;

57 
­¶y
 {

58 
aş
.
	`­¶y
();

60 
	}
}

62 
cÚŒŞ
 
	$Ipv4D‹lAş
(
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

63 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

64 
out
 
sw™ch_d‹l_»pÜt_ty³_t
 
»pÜt_ty³
)(

65 
sw™ch_ušt32_t
 
bË_size
=512) {

66 
aùiÚ
 
	`aş_h™
(
sw™ch_d‹l_»pÜt_ty³_t
 
ty³
) {

67 
»pÜt_ty³
 = 
ty³
;

70 
bË
 
aş
 {

71 
key
 = {

72 
INGRESS_IPV4_ACL_KEY


73 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

74 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

75 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

78 
aùiÚs
 = {

79 
	`aş_h™
();

82 cÚ¡ 
deçuÉ_aùiÚ
 = 
	`aş_h™
(
SWITCH_DTEL_REPORT_TYPE_NONE
);

83 
size
 = 
bË_size
;

86 
­¶y
 {

87 
aş
.
	`­¶y
();

89 
	}
}

91 
cÚŒŞ
 
	$Ipv6D‹lAş
(
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

92 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

93 
out
 
sw™ch_d‹l_»pÜt_ty³_t
 
»pÜt_ty³
)(

94 
sw™ch_ušt32_t
 
bË_size
=512) {

95 
aùiÚ
 
	`aş_h™
(
sw™ch_d‹l_»pÜt_ty³_t
 
ty³
) {

96 
»pÜt_ty³
 = 
ty³
;

99 
bË
 
aş
 {

100 
key
 = {

101 
INGRESS_IPV6_ACL_KEY


102 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

103 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

104 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

107 
aùiÚs
 = {

108 
	`aş_h™
();

111 cÚ¡ 
deçuÉ_aùiÚ
 = 
	`aş_h™
(
SWITCH_DTEL_REPORT_TYPE_NONE
);

112 
size
 = 
bË_size
;

115 
­¶y
 {

116 
aş
.
	`­¶y
();

118 
	}
}

128 
cÚŒŞ
 
	$DeæeùOnDrİ
(

129 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

130 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
)(

131 
sw™ch_ušt32_t
 
bË_size
=1024) {

133 
aùiÚ
 
	`’abË_dod
() {

134 
ig_šŒ_md_fÜ_tm
.
deæeù_Ú_drİ
 = 1
w1
;

137 
aùiÚ
 
	`di§bË_dod
() {

138 
ig_šŒ_md_fÜ_tm
.
deæeù_Ú_drİ
 = 1
w0
;

141 
bË
 
cÚfig
 {

142 
key
 = {

143 
ig_md
.
d‹l
.
»pÜt_ty³
 : 
‹º¬y
;

144 
ig_šŒ_md_fÜ_tm
.
uÿ¡_eg»ss_pÜt
 : 
‹º¬y
 @
	`Çme
("egress_port");

145 
ig_md
.
qos
.
qid
: 
‹º¬y
 @
	`Çme
("qid");

146 
ig_md
.
muÉiÿ¡
.
id
 : 
‹º¬y
;

149 
aùiÚs
 = {

150 
’abË_dod
;

151 
di§bË_dod
;

154 
size
 = 
bË_size
;

155 cÚ¡ 
deçuÉ_aùiÚ
 = 
di§bË_dod
;

158 
­¶y
 {

159 
cÚfig
.
	`­¶y
();

161 
	}
}

171 
cÚŒŞ
 
	$MœrÜOnDrİ
(
š
 
sw™ch_drİ_»asÚ_t
 
drİ_»asÚ
,

172 
šout
 
sw™ch_d‹l_m‘ad©a_t
 
d‹l_md
,

173 
šout
 
sw™ch_mœrÜ_m‘ad©a_t
 
mœrÜ_md
) {

174 
aùiÚ
 
	`mœrÜ
() {

175 
mœrÜ_md
.
ty³
 = 
SWITCH_MIRROR_TYPE_DTEL_DROP
;

176 
mœrÜ_md
.
¤c
 = 
SWITCH_PKT_SRC_CLONED_INGRESS
;

179 
bË
 
cÚfig
 {

180 
key
 = {

181 
drİ_»asÚ
 : 
‹º¬y
;

182 
d‹l_md
.
»pÜt_ty³
 : 
‹º¬y
;

185 
aùiÚs
 = {

186 
NoAùiÚ
;

187 
mœrÜ
;

190 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

197 
­¶y
 {

198 
cÚfig
.
	`­¶y
();

200 
	}
}

209 
cÚŒŞ
 
DrİR•Üt
(
š
 
sw™ch_d‹l_m‘ad©a_t
 
d‹l_md
, iÀ
b™
<32> 
hash
, 
šout
 b™<2> 
æag
) {

211 
	gRegi¡”
<
	gb™
<1>, b™<17>>(1 << 17, 0è
	g¬¿y1
;

212 
	gRegi¡”
<
	gb™
<1>, b™<17>>(1 << 17, 0è
	g¬¿y2
;

213 
	gRegi¡”AùiÚ
<
	gb™
<1>, b™<17>, b™<1>>(
	g¬¿y1
è
	gf‹r1
 = {

214 
­¶y
(
šout
 
b™
<1> 
v®
, 
out
 b™<1> 
rv
) {

215 
rv
 = 
v®
;

216 
	gv®
 = 0b1;

220 
	gRegi¡”AùiÚ
<
	gb™
<1>, b™<17>, b™<1>>(
	g¬¿y2
è
	gf‹r2
 = {

221 
­¶y
(
šout
 
b™
<1> 
v®
, 
out
 b™<1> 
rv
) {

222 
rv
 = 
v®
;

223 
	gv®
 = 0b1;

227 
	g­¶y
 {

228 
	gæag
 = 0;

229 ià(
	gd‹l_md
.
	g»pÜt_ty³
 & (
	gSWITCH_DTEL_REPORT_TYPE_DROP
 | 
	gSWITCH_DTEL_SUPPRESS_REPORT
è=ğ
SWITCH_DTEL_REPORT_TYPE_DROP
)

230 
æag
[0:0] = 
f‹r1
.
execu‹
(
hash
[16:0]);

231 ià(
	gd‹l_md
.
	g»pÜt_ty³
 & (
	gSWITCH_DTEL_REPORT_TYPE_DROP
 | 
	gSWITCH_DTEL_SUPPRESS_REPORT
è=ğ
SWITCH_DTEL_REPORT_TYPE_DROP
)

232 
æag
[1:1] = 
f‹r2
.
execu‹
(
hash
[31:15]);

243 
	ssw™ch_queue_®”t_th»shŞd_t
 {

244 
	mb™
<32> 
	mqd•th
;

245 
	mb™
<32> 
	mÏ‹ncy
;

248 
	ssw™ch_queue_»pÜt_quÙa_t
 {

249 
	mb™
<32> 
	mcouÁ”
;

250 
	mb™
<32> 
	mÏ‹ncy
;

256 
cÚŒŞ
 
QueueR•Üt
(
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

257 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

258 
out
 
b™
<1> 
q®”t
) {

260 
	gb™
<16> 
	gquÙa_
;

261 cÚ¡ 
	gb™
<32> 
	gqueue_bË_size
 = 1024;

262 cÚ¡ 
	gb™
<32> 
	gqueue_»gi¡”_size
 = 2048;

265 
	gRegi¡”
<
	gsw™ch_queue_®”t_th»shŞd_t
, 
	gb™
<16>>(
	gqueue_»gi¡”_size
è
	gth»shŞds
;

266 
	gRegi¡”AùiÚ
<
	gsw™ch_queue_®”t_th»shŞd_t
, 
	gb™
<16>, b™<1>>(
	gth»shŞds
è
	gcheck_th»shŞds
 = {

267 
­¶y
(
šout
 
sw™ch_queue_®”t_th»shŞd_t
 
»g
, 
out
 
b™
<1> 
æag
) {

269 ià(
»g
.
Ï‹ncy
 <ğ
eg_md
.
d‹l
.Ï‹ncy ||„eg.
qd•th
 <ğ(
b™
<32>è
eg_šŒ_md
.
’q_qd•th
) {

270 
æag
 = 1;

275 
aùiÚ
 
£t_qmask
(
b™
<32> 
quªtiz©iÚ_mask
) {

277 
	geg_md
.
	gd‹l
.
	gÏ‹ncy
 = 
eg_md
.
d‹l
.
Ï‹ncy
 & 
quªtiz©iÚ_mask
;

279 
aùiÚ
 
£t_q®”t
(
b™
<16> 
šdex
, b™<16> 
quÙa
, b™<32> 
quªtiz©iÚ_mask
) {

280 
	gq®”t
 = 
check_th»shŞds
.
execu‹
(
šdex
);

281 
	gquÙa_
 = 
quÙa
;

282 
£t_qmask
(
quªtiz©iÚ_mask
);

285 
bË
 
	gqueue_®”t
 {

286 
	gkey
 = {

287 
eg_md
.
qos
.
qid
 : 
exaù
 @
Çme
("qid");

288 
	geg_md
.
	gpÜt
 : 
exaù
 @
Çme
("port");

291 
	gaùiÚs
 = {

292 
£t_q®”t
;

293 
	g£t_qmask
;

296 
	gsize
 = 
queue_bË_size
;

300 
	gRegi¡”
<
	gsw™ch_queue_»pÜt_quÙa_t
, 
	gb™
<16>>(
	gqueue_»gi¡”_size
è
	gquÙas
;

301 
	gRegi¡”AùiÚ
<
	gsw™ch_queue_»pÜt_quÙa_t
, 
	gb™
<16>, b™<1>>(
	gquÙas
è
	g»£t_quÙa
 = {

302 
­¶y
(
šout
 
sw™ch_queue_»pÜt_quÙa_t
 
»g
, 
out
 
b™
<1> 
æag
) {

303 
æag
 = 0;

304 
	g»g
.
	gcouÁ”
 = (
b™
<32>è
quÙa_
[15:0];

308 
	gRegi¡”AùiÚ
<
	gsw™ch_queue_»pÜt_quÙa_t
, 
	gb™
<16>, b™<1>>(
	gquÙas
è
	gcheck_Ï‹ncy_ªd_upd©e_quÙa
 = {

309 
­¶y
(
šout
 
sw™ch_queue_»pÜt_quÙa_t
 
»g
, 
out
 
b™
<1> 
æag
) {

310 
æag
 = 0;

313 ià(
	g»g
.
	gcouÁ”
 > 0) {

314 
	g»g
.
	gcouÁ”
 = 
»g
.
couÁ”
 - 1;

315 
	gæag
 = 1;

319 ià(
	g»g
.
	gÏ‹ncy
 !ğ
eg_md
.
d‹l
.
Ï‹ncy
) {

320 
»g
.
Ï‹ncy
 = 
eg_md
.
d‹l
.latency;

321 
	gæag
 = 1;

327 
	gRegi¡”AùiÚ
<
	gsw™ch_queue_»pÜt_quÙa_t
, 
	gb™
<16>, b™<1>>(
	gquÙas
è
	gupd©e_quÙa
 = {

328 
­¶y
(
šout
 
sw™ch_queue_»pÜt_quÙa_t
 
»g
, 
out
 
b™
<1> 
æag
) {

329 
æag
 = 0;

331 ià(
	g»g
.
	gcouÁ”
 > 0) {

332 
	g»g
.
	gcouÁ”
 = 
»g
.
couÁ”
 - 1;

333 
	gæag
 = 1;

339 
aùiÚ
 
»£t_quÙa_
(
b™
<16> 
šdex
) {

340 
	gq®”t
 = 
»£t_quÙa
.
execu‹
(
šdex
);

343 
aùiÚ
 
upd©e_quÙa_
(
b™
<16> 
šdex
) {

344 
	geg_md
.
	gd‹l
.
	g»pÜt_ty³
 = 
eg_md
.
d‹l
.
»pÜt_ty³
 | 
SWITCH_DTEL_REPORT_TYPE_QUEUE
;

345 
	gq®”t
 = 
upd©e_quÙa
.
execu‹
(
šdex
);

348 
aùiÚ
 
check_Ï‹ncy_ªd_upd©e_quÙa_
(
b™
<16> 
šdex
) {

349 
	geg_md
.
	gd‹l
.
	g»pÜt_ty³
 = 
eg_md
.
d‹l
.
»pÜt_ty³
 | 
SWITCH_DTEL_REPORT_TYPE_QUEUE
;

350 
	gq®”t
 = 
check_Ï‹ncy_ªd_upd©e_quÙa
.
execu‹
(
šdex
);

353 
bË
 
	gcheck_quÙa
 {

354 
	gkey
 = {

355 
eg_md
.
pkt_¤c
 : 
exaù
;

356 
	gq®”t
 : 
exaù
;

357 
	geg_md
.
	gqos
.
	gqid
 : 
exaù
 @
Çme
("qid");

358 
	geg_md
.
	gpÜt
 : 
exaù
 @
Çme
("port");

361 
	gaùiÚs
 = {

362 
NoAùiÚ
;

363 
	g»£t_quÙa_
;

364 
	gupd©e_quÙa_
;

365 
	gcheck_Ï‹ncy_ªd_upd©e_quÙa_
;

368 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

369 
	gsize
 = 3 * 
queue_bË_size
;

372 
	g­¶y
 {

373 ià(
	geg_md
.
	gpkt_¤c
 =ğ
SWITCH_PKT_SRC_BRIDGED
)

374 
queue_®”t
.
­¶y
();

375 
	gcheck_quÙa
.
­¶y
();

380 
cÚŒŞ
 
FlowR•Üt
(
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
, 
out
 
b™
<2> 
æag
) {

381 
	gb™
<16> 
	gdige¡
;

384 
	gHash
<
	gb™
<16>>(
	gHashAlgÜ™hm_t
.
	gCRC16
è
	ghash
;

387 
	gRegi¡”
<
	gb™
<16>, b™<16>>(1 << 16, 0è
	g¬¿y1
;

388 
	gRegi¡”
<
	gb™
<16>, b™<16>>(1 << 16, 0è
	g¬¿y2
;

394 @
»duùiÚ_Ü_group
("filter")

395 
	gRegi¡”AùiÚ
<
	gb™
<16>, b™<16>, b™<2>>(
	g¬¿y1
è
	gf‹r1
 = {

396 
­¶y
(
šout
 
b™
<16> 
»g
, 
out
 b™<2> 
rv
) {

397 ià(
»g
 =ğ16
w0
) {

398 
rv
 = 0b10;

399 } ià(
	g»g
 =ğ
dige¡
) {

400 
rv
 = 0b01;

402 
	g»g
 = 
dige¡
;

406 @
»duùiÚ_Ü_group
("filter")

407 
	gRegi¡”AùiÚ
<
	gb™
<16>, b™<16>, b™<2>>(
	g¬¿y2
è
	gf‹r2
 = {

408 
­¶y
(
šout
 
b™
<16> 
»g
, 
out
 b™<2> 
rv
) {

409 ià(
»g
 =ğ16
w0
) {

410 
rv
 = 0b10;

411 } ià(
	g»g
 =ğ
dige¡
) {

412 
rv
 = 0b01;

414 
	g»g
 = 
dige¡
;

418 
	g­¶y
 {

419 #ifdeà
DTEL_FLOW_REPORT_ENABLE


420 
	gæag
 = 0;

421 
	gdige¡
 = 
hash
.
g‘
({
eg_md
.
d‹l
.
Ï‹ncy
,ƒg_md.
šg»ss_pÜt
,ƒg_md.
pÜt
,ƒg_md.dtel.hash});

422 ià(
	geg_md
.
	gd‹l
.
	g»pÜt_ty³
 & (
	gSWITCH_DTEL_REPORT_TYPE_FLOW
 | 
	gSWITCH_DTEL_SUPPRESS_REPORT
è=ğ
SWITCH_DTEL_REPORT_TYPE_FLOW
)

423 
æag
 = 
f‹r1
.
execu‹
(
eg_md
.
d‹l
.
hash
[15:0]);

424 ià(
	geg_md
.
	gd‹l
.
	g»pÜt_ty³
 & (
	gSWITCH_DTEL_REPORT_TYPE_FLOW
 | 
	gSWITCH_DTEL_SUPPRESS_REPORT
è=ğ
SWITCH_DTEL_REPORT_TYPE_FLOW
)

426 
æag
 = fÏg | 
f‹r2
.
execu‹
(
eg_md
.
d‹l
.
hash
[31:16]);

431 
cÚŒŞ
 
Ing»ssD‹l
(
š
 
sw™ch_h—d”_t
 
hdr
,

432 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

433 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

434 
š
 
b™
<16> 
hash
,

435 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

436 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_fÜ_tm
) {

438 
Ipv4D‹lAş
(è
	gv4_d‹l_aş
;

439 
D‹lAş
(è
	gd‹l_aş
;

441 
DeæeùOnDrİ
(è
	gdod
;

442 
MœrÜOnDrİ
(è
	gmod
;

444 
	gHash
<
	gsw™ch_ušt16_t
>(
	gHashAlgÜ™hm_t
.
	gIDENTITY
è
	g£ËùÜ_hash
;

445 
AùiÚS–eùÜ
(120, 
£ËùÜ_hash
, 
S–eùÜMode_t
.
FAIR
è
	g£ssiÚ_£ËùÜ
;

446 
aùiÚ
 
£t_mœrÜ_£ssiÚ
(
sw™ch_mœrÜ_£ssiÚ_t
 
£ssiÚ_id
) {

447 
	gig_md
.
	gd‹l
.
	g£ssiÚ_id
 = 
£ssiÚ_id
;

450 
bË
 
	gmœrÜ_£ssiÚ
 {

451 
	gkey
 = { 
hash
 : 
£ËùÜ
; }

452 
	gaùiÚs
 = {

453 
NoAùiÚ
;

454 
	g£t_mœrÜ_£ssiÚ
;

457 
	gim¶em’tiÚ
 = 
£ssiÚ_£ËùÜ
;

460 
	g­¶y
 {

461 #ifdeà
DTEL_ENABLE


462 
	gig_md
.
	gd‹l
.
	g»pÜt_ty³
 = 
SWITCH_DTEL_REPORT_TYPE_NONE
;

463 
	gig_md
.
	gd‹l
.
	g£ssiÚ_id
 = 0;

465 #ifdeà
DTEL_ACL_ENABLE


466 ià(!
INGRESS_BYPASS
(
ACL
)) {

467 #ifdeà
IPV6_ENABLE


468 
	gd‹l_aş
.
­¶y
(
lkp
, 
ig_md
, ig_md.
d‹l
.
»pÜt_ty³
);

470 ià(
	glkp
.
	g_ty³
 =ğ
SWITCH_IP_TYPE_IPV4
) {

471 
v4_d‹l_aş
.
­¶y
(
lkp
, 
ig_md
, ig_md.
d‹l
.
»pÜt_ty³
);

477 #ià
defšed
(
DTEL_DROP_REPORT_ENABLE
è|| defšed(
DTEL_QUEUE_REPORT_ENABLE
)

478 
	gdod
.
­¶y
(
ig_md
, 
ig_šŒ_fÜ_tm
);

479 #ifdeà
DTEL_DROP_REPORT_ENABLE


480 ià(
	gig_md
.
	gmœrÜ
.
	gty³
 =ğ
SWITCH_MIRROR_TYPE_INVALID
)

481 
mod
.
­¶y
(
ig_md
.
drİ_»asÚ
, ig_md.
d‹l
, ig_md.
mœrÜ
);

484 
	gmœrÜ_£ssiÚ
.
­¶y
();

490 
cÚŒŞ
 
Eg»ssD‹l
(
šout
 
sw™ch_h—d”_t
 
hdr
,

491 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

492 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

493 
š
 
b™
<32> 
hash
,

494 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
) {

495 
DrİR•Üt
(è
	gdrİ_»pÜt
;

496 
QueueR•Üt
(è
	gqueue_»pÜt
;

497 
FlowR•Üt
(è
	gæow_»pÜt
;

499 
	gb™
<2> 
	gdrİ_»pÜt_æag
;

500 
	gb™
<2> 
	gæow_»pÜt_æag
;

501 
	gb™
<1> 
	gqueue_»pÜt_æag
;

503 
	gRegi¡”
<
	gb™
<32>, 
	gsw™ch_mœrÜ_£ssiÚ_t
>(1024è
	g£q_numb”
;

504 
	gRegi¡”AùiÚ
<
	gb™
<32>, 
	gsw™ch_mœrÜ_£ssiÚ_t
, b™<32>>(
	g£q_numb”
è
	gg‘_£q_numb”
 = {

505 
­¶y
(
šout
 
b™
<32> 
»g
, 
out
 b™<32> 
rv
) {

506 
»g
 =„eg + 1;

507 
	grv
 = 
»g
;

511 
aùiÚ
 
mœrÜ
() {

513 
	geg_md
.
	gmœrÜ
.
	gty³
 = 
SWITCH_MIRROR_TYPE_DTEL_SWITCH_LOCAL
;

514 
	geg_md
.
	gmœrÜ
.
	g¤c
 = 
SWITCH_PKT_SRC_CLONED_EGRESS
;

517 
aùiÚ
 
drİ
() {

519 
	geg_šŒ_md_fÜ_d´¤
.
	gdrİ_ùl
 = 0x1;

522 
aùiÚ
 
upd©e
(

523 
sw™ch_ušt32_t
 
sw™ch_id
,

524 
b™
<6> 
hw_id
,

525 
b™
<4> 
Ãxt_´Ùo
,

526 
sw™ch_d‹l_»pÜt_ty³_t
 
»pÜt_ty³
) {

527 
	ghdr
.
	gd‹l
.
£tV®id
();

528 
	ghdr
.
	gd‹l
.
	gv”siÚ
 = 0;

529 
	ghdr
.
	gd‹l
.
	gÃxt_´Ùo
 = 
Ãxt_´Ùo
;

530 
	ghdr
.
	gd‹l
.
	gd_q_f
 = (
b™
<3>è
»pÜt_ty³
;

531 
	ghdr
.
	gd‹l
.
	g»£rved
 = 0;

532 
	ghdr
.
	gd‹l
.
	ghw_id
 = 
hw_id
;

533 
	ghdr
.
	gd‹l
.
	g£q_numb”
 = 
g‘_£q_numb”
.
execu‹
(
eg_md
.
d‹l
.
£ssiÚ_id
);

534 
	ghdr
.
	gd‹l
.
	gtime¡amp
 = (
b™
<32>è
eg_md
.
šg»ss_time¡amp
;

535 
	ghdr
.
	gd‹l
.
	gsw™ch_id
 = 
sw™ch_id
;

548 
bË
 
	gcÚfig
 {

549 
	gkey
 = {

550 
eg_md
.
pkt_¤c
 : 
‹º¬y
;

551 
	geg_md
.
	gd‹l
.
	g»pÜt_ty³
 : 
‹º¬y
;

552 
	gdrİ_»pÜt_æag
 : 
‹º¬y
;

553 
	gæow_»pÜt_æag
 : 
‹º¬y
;

554 
	gqueue_»pÜt_æag
 : 
‹º¬y
;

557 
	gaùiÚs
 = {

558 
NoAùiÚ
;

559 
	gdrİ
;

560 
	gmœrÜ
;

561 
	gupd©e
;

564 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

567 
aùiÚ
 
cÚv”t_šg»ss_pÜt
(
sw™ch_pÜt_t
 
pÜt
) {

568 
	ghdr
.
	gd‹l_drİ_»pÜt
.
	gšg»ss_pÜt
 = 
pÜt
;

571 
bË
 
	gšg»ss_pÜt_cÚv”siÚ
 {

572 
	gkey
 = { 
hdr
.
d‹l_drİ_»pÜt
.
šg»ss_pÜt
 : 
exaù
 @
Çme
("port"); }

573 
	gaùiÚs
 = {

574 
NoAùiÚ
;

575 
	gcÚv”t_šg»ss_pÜt
;

578 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

581 
aùiÚ
 
cÚv”t_eg»ss_pÜt
(
sw™ch_pÜt_t
 
pÜt
) {

582 
	ghdr
.
	gd‹l_drİ_»pÜt
.
	geg»ss_pÜt
 = 
pÜt
;

585 
bË
 
	geg»ss_pÜt_cÚv”siÚ
 {

586 
	gkey
 = { 
hdr
.
d‹l_drİ_»pÜt
.
eg»ss_pÜt
 : 
exaù
 @
Çme
("port"); }

587 
	gaùiÚs
 = {

588 
NoAùiÚ
;

589 
	gcÚv”t_eg»ss_pÜt
;

592 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

595 
aùiÚ
 
cÚv”t_šg»ss_pÜt2
(
sw™ch_pÜt_t
 
pÜt
) {

596 
	ghdr
.
	gd‹l_sw™ch_loÿl_»pÜt
.
	gšg»ss_pÜt
 = 
pÜt
;

599 
bË
 
	gšg»ss_pÜt_cÚv”siÚ2
 {

600 
	gkey
 = { 
hdr
.
d‹l_sw™ch_loÿl_»pÜt
.
šg»ss_pÜt
 : 
exaù
 @
Çme
("port"); }

601 
	gaùiÚs
 = {

602 
NoAùiÚ
;

603 
	gcÚv”t_šg»ss_pÜt2
;

606 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

609 
aùiÚ
 
cÚv”t_eg»ss_pÜt2
(
sw™ch_pÜt_t
 
pÜt
) {

610 
	ghdr
.
	gd‹l_sw™ch_loÿl_»pÜt
.
	geg»ss_pÜt
 = 
pÜt
;

613 
bË
 
	geg»ss_pÜt_cÚv”siÚ2
 {

614 
	gkey
 = { 
hdr
.
d‹l_sw™ch_loÿl_»pÜt
.
eg»ss_pÜt
 : 
exaù
 @
Çme
("port"); }

615 
	gaùiÚs
 = {

616 
NoAùiÚ
;

617 
	gcÚv”t_eg»ss_pÜt2
;

620 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

623 
	g­¶y
 {

624 #ifdeà
DTEL_ENABLE


625 
	geg_md
.
	gd‹l
.
	gÏ‹ncy
 =

626 
eg_md
.
time¡amp
[31:0] -ƒg_md.
šg»ss_time¡amp
[31:0];

627 ià(
	geg_md
.
	gpkt_¤c
 =ğ
SWITCH_PKT_SRC_DEFLECTED
 && 
hdr
.
d‹l_drİ_»pÜt
.
isV®id
())

628 
eg_md
.
pÜt
 = 
hdr
.
d‹l_drİ_»pÜt
.
eg»ss_pÜt
;

629 ià(
	ghdr
.
	gd‹l_drİ_»pÜt
.
isV®id
()) {

630 
	gdrİ_»pÜt
.
­¶y
(
eg_md
.
d‹l
, 
hash
, 
drİ_»pÜt_æag
);

631 
	gšg»ss_pÜt_cÚv”siÚ
.
­¶y
();

632 
	geg»ss_pÜt_cÚv”siÚ
.
­¶y
();

635 #ifdeà
DTEL_QUEUE_REPORT_ENABLE


636 
	gqueue_»pÜt
.
­¶y
(
eg_md
, 
eg_šŒ_md
, 
queue_»pÜt_æag
);

639 ià(
	geg_md
.
	gpkt_¤c
 =ğ
SWITCH_PKT_SRC_BRIDGED
)

640 
æow_»pÜt
.
­¶y
(
eg_md
, 
æow_»pÜt_æag
);

642 ià(
	ghdr
.
	gd‹l_sw™ch_loÿl_»pÜt
.
isV®id
()) {

643 
	gšg»ss_pÜt_cÚv”siÚ2
.
­¶y
();

644 
	geg»ss_pÜt_cÚv”siÚ2
.
­¶y
();

647 
	gcÚfig
.
­¶y
();

	@shared/headers.p4

27 #iâdeà
_P4_HEADERS_


28 
	#_P4_HEADERS_


	)

30 
	gb™
<48> 
	tmac_addr_t
;

31 
	gb™
<32> 
	tv4_addr_t
;

32 
	gb™
<128> 
	tv6_addr_t
;

33 
	gb™
<12> 
	tvÏn_id_t
;

35 @
·_cÚš”_size
("ingress", "hdr.ethernet.src_addr", 16, 32)

36 @
·_cÚš”_size
("ingress", "hdr.ethernet.dst_addr", 16, 32)

37 @
·_cÚš”_size
("ingress", "hdr.ethernet.$valid", 16)

38 
h—d”
 
	g‘h”Ãt_h
 {

39 
mac_addr_t
 
	gd¡_addr
;

40 
mac_addr_t
 
	g¤c_addr
;

41 
	gb™
<16> 
	g‘h”_ty³
;

44 
h—d”
 
	gvÏn_g_h
 {

45 
	gb™
<3> 
	gpı
;

46 
	gb™
<1> 
	gcfi
;

47 
vÏn_id_t
 
	gvid
;

48 
	gb™
<16> 
	g‘h”_ty³
;

51 
h—d”
 
	gm¶s_h
 {

52 
	gb™
<20> 
	gÏb–
;

53 
	gb™
<3> 
	gexp
;

54 
	gb™
<1> 
	gbos
;

55 
	gb™
<8> 
	g‰l
;

58 
h—d”
 
	gv4_h
 {

59 
	gb™
<4> 
	gv”siÚ
;

60 
	gb™
<4> 
	gihl
;

61 
	gb™
<8> 
	gdiff£rv
;

62 
	gb™
<16> 
	gtÙ®_Ën
;

63 
	gb™
<16> 
	gid’tifiÿtiÚ
;

64 
	gb™
<3> 
	gæags
;

65 
	gb™
<13> 
	gäag_off£t
;

66 
	gb™
<8> 
	g‰l
;

67 
	gb™
<8> 
	g´ÙocŞ
;

68 
	gb™
<16> 
	ghdr_checksum
;

69 
v4_addr_t
 
	g¤c_addr
;

70 
v4_addr_t
 
	gd¡_addr
;

74 
h—d”
 
	grou‹r_®”t_İtiÚ_h
 {

75 
	gb™
<8> 
	gty³
;

76 
	gb™
<8> 
	gËngth
;

77 
	gb™
<16> 
	gv®ue
;

80 
h—d”
 
	gv4_İtiÚ_h
 {

81 
	gb™
<8> 
	gty³
;

82 
	gb™
<8> 
	gËngth
;

83 
	gb™
<16> 
	gv®ue
;

86 
h—d”
 
	gv6_h
 {

87 
	gb™
<4> 
	gv”siÚ
;

88 
	gb™
<8> 
	gŒaffic_şass
;

89 
	gb™
<20> 
	gæow_Ïb–
;

90 
	gb™
<16> 
	g·ylßd_Ën
;

91 
	gb™
<8> 
	gÃxt_hdr
;

92 
	gb™
<8> 
	ghİ_lim™
;

93 
v6_addr_t
 
	g¤c_addr
;

94 
v6_addr_t
 
	gd¡_addr
;

97 
h—d”
 
	gtı_h
 {

98 
	gb™
<16> 
	g¤c_pÜt
;

99 
	gb™
<16> 
	gd¡_pÜt
;

100 
	gb™
<32> 
	g£q_no
;

101 
	gb™
<32> 
	gack_no
;

102 
	gb™
<4> 
	gd©a_off£t
;

103 
	gb™
<4> 
	g»s
;

104 
	gb™
<8> 
	gæags
;

105 
	gb™
<16> 
	gwšdow
;

106 
	gb™
<16> 
	gchecksum
;

107 
	gb™
<16> 
	gurg’t_±r
;

110 
h—d”
 
	gudp_h
 {

111 
	gb™
<16> 
	g¤c_pÜt
;

112 
	gb™
<16> 
	gd¡_pÜt
;

113 
	gb™
<16> 
	gËngth
;

114 
	gb™
<16> 
	gchecksum
;

117 
h—d”
 
	gicmp_h
 {

118 
	gb™
<8> 
	gty³
;

119 
	gb™
<8> 
	gcode
;

120 
	gb™
<16> 
	gchecksum
;

124 
h—d”
 
	gigmp_h
 {

125 
	gb™
<8> 
	gty³
;

126 
	gb™
<8> 
	gcode
;

127 
	gb™
<16> 
	gchecksum
;

132 
h—d”
 
	g¬p_h
 {

133 
	gb™
<16> 
	ghw_ty³
;

134 
	gb™
<16> 
	g´Ùo_ty³
;

135 
	gb™
<8> 
	ghw_addr_Ën
;

136 
	gb™
<8> 
	g´Ùo_addr_Ën
;

137 
	gb™
<16> 
	gİcode
;

142 
h—d”
 
	groûv2_bth_h
 {

143 
	gb™
<8> 
	gİcod“
;

144 
	gb™
<1> 
	g£
;

145 
	gb™
<1> 
	gmig¿tiÚ_»q
;

146 
	gb™
<2> 
	g·d_couÁ
;

147 
	gb™
<4> 
	gŒª¥Üt_v”siÚ
;

148 
	gb™
<16> 
	g·¹™iÚ_key
;

149 
	gb™
<1> 
	gf_»s1
;

150 
	gb™
<1> 
	gb_»s1
;

151 
	gb™
<6> 
	g»£rved
;

152 
	gb™
<24> 
	gd¡_qp
;

153 
	gb™
<1> 
	gack_»q
;

154 
	gb™
<7> 
	g»£rved2
;

159 
h—d”
 
	gfcÛ_fc_h
 {

160 
	gb™
<4> 
	gv”siÚ
;

161 
	gb™
<100> 
	g»£rved
;

162 
	gb™
<8> 
	gsof
;

164 
	gb™
<8> 
	gr_ùl
;

165 
	gb™
<24> 
	gd_id
;

166 
	gb™
<8> 
	gcs_ùl
;

167 
	gb™
<24> 
	gs_id
;

168 
	gb™
<8> 
	gty³
;

169 
	gb™
<24> 
	gf_ùl
;

170 
	gb™
<8> 
	g£q_id
;

171 
	gb™
<8> 
	gdf_ùl
;

172 
	gb™
<16> 
	g£q_út
;

173 
	gb™
<16> 
	gox_id
;

174 
	gb™
<16> 
	grx_id
;

179 
h—d”
 
	gv6_¤h_h
 {

180 
	gb™
<8> 
	gÃxt_hdr
;

181 
	gb™
<8> 
	ghdr_ext_Ën
;

182 
	gb™
<8> 
	groutšg_ty³
;

183 
	gb™
<8> 
	g£g_Ëá
;

184 
	gb™
<8> 
	gÏ¡_’Œy
;

185 
	gb™
<8> 
	gæags
;

186 
	gb™
<16> 
	gg
;

190 
h—d”
 
	gvxÏn_h
 {

191 
	gb™
<8> 
	gæags
;

192 
	gb™
<24> 
	g»£rved
;

193 
	gb™
<24> 
	gvni
;

194 
	gb™
<8> 
	g»£rved2
;

198 
h—d”
 
	gvxÏn_g³_h
 {

199 
	gb™
<8> 
	gæags
;

200 
	gb™
<16> 
	g»£rved
;

201 
	gb™
<24> 
	gvni
;

202 
	gb™
<8> 
	g»£rved2
;

206 
h—d”
 
	gg»_h
 {

207 
	gb™
<1> 
	gC
;

208 
	gb™
<1> 
	gR
;

209 
	gb™
<1> 
	gK
;

210 
	gb™
<1> 
	gS
;

211 
	gb™
<1> 
	gs
;

212 
	gb™
<3> 
	g»cur£
;

213 
	gb™
<5> 
	gæags
;

214 
	gb™
<3> 
	gv”siÚ
;

215 
	gb™
<16> 
	g´Ùo
;

219 
h—d”
 
	gnvg»_h
 {

220 
	gb™
<24> 
	gvsid
;

221 
	gb™
<8> 
	gæow_id
;

226 
h—d”
 
	g”¥ª_ty³2_h
 {

227 
	gb™
<4> 
	gv”siÚ
;

228 
	gb™
<12> 
	gvÏn
;

229 
	gb™
<6> 
	gcos_’_t
;

230 
	gb™
<10> 
	g£ssiÚ_id
;

231 
	gb™
<12> 
	g»£rved
;

232 
	gb™
<20> 
	gšdex
;

236 
h—d”
 
	g”¥ª_ty³3_h
 {

237 
	gb™
<4> 
	gv”siÚ
;

238 
	gb™
<12> 
	gvÏn
;

239 
	gb™
<6> 
	gcos_bso_t
;

240 
	gb™
<10> 
	g£ssiÚ_id
;

241 
	gb™
<32> 
	gtime¡amp
;

242 
	gb™
<16> 
	gsgt
;

243 
	gb™
<1> 
	gp
;

244 
	gb™
<5> 
	gá
;

245 
	gb™
<6> 
	ghw_id
;

246 
	gb™
<1> 
	gd
;

247 
	gb™
<2> 
	gg¿
;

248 
	gb™
<1> 
	go
;

252 
h—d”
 
	g”¥ª_¶©fÜm_h
 {

253 
	gb™
<6> 
	gid
;

254 
	gb™
<58> 
	gšfo
;

258 
h—d”
 
	gg’eve_h
 {

259 
	gb™
<2> 
	gv”siÚ
;

260 
	gb™
<6> 
	gİt_Ën
;

261 
	gb™
<1> 
	gßm
;

262 
	gb™
<1> 
	gü™iÿl
;

263 
	gb™
<6> 
	g»£rved
;

264 
	gb™
<16> 
	g´Ùo_ty³
;

265 
	gb™
<24> 
	gvni
;

266 
	gb™
<8> 
	g»£rved2
;

269 
h—d”
 
	gg’eve_İtiÚ_h
 {

270 
	gb™
<16> 
	gİt_şass
;

271 
	gb™
<8> 
	gİt_ty³
;

272 
	gb™
<3> 
	g»£rved
;

273 
	gb™
<5> 
	gİt_Ën
;

277 
h—d”
 
	gbfd_h
 {

278 
	gb™
<3> 
	gv”siÚ
;

279 
	gb™
<5> 
	gdŸg
;

280 
	gb™
<8> 
	gæags
;

281 
	gb™
<8> 
	gd‘eù_muÉi
;

282 
	gb™
<8> 
	gËn
;

283 
	gb™
<32> 
	gmy_disüimš©Ü
;

284 
	gb™
<32> 
	gyour_disüimš©Ü
;

285 
	gb™
<32> 
	gdesœed_mš_tx_š‹rv®
;

286 
	gb™
<32> 
	g»q_mš_rx_š‹rv®
;

287 
	gb™
<32> 
	g»q_mš_echo_rx_š‹rv®
;

292 
h—d”
 
	gd‹l_»pÜt_v05_h
 {

293 
	gb™
<4> 
	gv”siÚ
;

294 
	gb™
<4> 
	gÃxt_´Ùo
;

295 
	gb™
<3> 
	gd_q_f
;

296 
	gb™
<15> 
	g»£rved
;

297 
	gb™
<6> 
	ghw_id
;

298 
	gb™
<32> 
	g£q_numb”
;

299 
	gb™
<32> 
	gtime¡amp
;

300 
	gb™
<32> 
	gsw™ch_id
;

304 
h—d”
 
	gd‹l_drİ_»pÜt_h
 {

305 
	gb™
<7> 
	g·d0
;

306 
	gb™
<9> 
	gšg»ss_pÜt
;

307 
	gb™
<7> 
	g·d1
;

308 
	gb™
<9> 
	geg»ss_pÜt
;

309 #ià
__TARGET_TOFINO__
 == 1

310 
	gb™
<3> 
	g·d2
;

311 
	gb™
<5> 
	gqueue_id
;

313 
	gb™
<1> 
	g·d2
;

314 
	gb™
<7> 
	gqueue_id
;

316 
	gb™
<8> 
	gdrİ_»asÚ
;

317 
	gb™
<16> 
	g»£rved
;

321 
h—d”
 
	gd‹l_sw™ch_loÿl_»pÜt_h
 {

322 
	gb™
<7> 
	g·d0
;

323 
	gb™
<9> 
	gšg»ss_pÜt
;

324 
	gb™
<7> 
	g·d1
;

325 
	gb™
<9> 
	geg»ss_pÜt
;

326 #ià
__TARGET_TOFINO__
 == 1

327 
	gb™
<3> 
	g·d2
;

328 
	gb™
<5> 
	gqueue_id
;

330 
	gb™
<1> 
	g·d2
;

331 
	gb™
<7> 
	gqueue_id
;

333 
	gb™
<5> 
	g·d3
;

334 
	gb™
<19> 
	gqueue_occu·ncy
;

335 
	gb™
<32> 
	gtime¡amp
;

340 
h—d”
 
	gd‹l_»pÜt_v10_h
 {

341 
	gb™
<4> 
	gv”siÚ
;

342 
	gb™
<4> 
	gËngth
;

343 
	gb™
<3> 
	gÃxt_´Ùo
;

344 
	gb™
<6> 
	gm‘ad©a_b™s
;

345 
	gb™
<6> 
	g»£rved
;

346 
	gb™
<3> 
	gd_q_f
;

347 
	gb™
<6> 
	ghw_id
;

348 
	gb™
<32> 
	gsw™ch_id
;

349 
	gb™
<32> 
	g£q_numb”
;

350 
	gb™
<32> 
	gtime¡amp
;

354 
	sd‹l_»pÜt_m‘ad©a_0
 {

355 
	mb™
<16> 
	mšg»ss_pÜt
;

356 
	mb™
<16> 
	meg»ss_pÜt
;

359 
	sd‹l_»pÜt_m‘ad©a_2
 {

360 
	mb™
<8> 
	mqueue_id
;

361 
	mb™
<24> 
	mqueue_occu·ncy
;

364 
	sd‹l_»pÜt_m‘ad©a_3
 {

365 
	mb™
<32> 
	mtime¡amp
;

368 
	sd‹l_»pÜt_m‘ad©a_4
 {

369 
	mb™
<8> 
	mqueue_id
;

370 
	mb™
<8> 
	mdrİ_»asÚ
;

371 
	mb™
<16> 
	m»£rved
;

375 
h—d”
 
	gçbric_h
 {

376 
	gb™
<8> 
	g»£rved
;

377 
	gb™
<3> 
	gcŞÜ
;

378 
	gb™
<5> 
	gqos
;

379 
	gb™
<8> 
	g»£rved2
;

380 
	gb™
<16> 
	gd¡_pÜt_Ü_group
;

384 
h—d”
 
	gıu_h
 {

385 
	gb™
<5> 
	geg»ss_queue
;

386 
	gb™
<1> 
	gtx_by·ss
;

387 
	gb™
<1> 
	gÿ±u»_ts
;

388 
	gb™
<1> 
	g»£rved
;

389 
	gb™
<16> 
	gšg»ss_pÜt
;

390 
	gb™
<16> 
	gšg»ss_ifšdex
;

391 
	gb™
<16> 
	gšg»ss_bd
;

392 
	gb™
<16> 
	g»asÚ_code
;

393 
	gb™
<16> 
	g‘h”_ty³
;

415 
h—d”
 
	gtime¡amp_h
 {

416 
	gb™
<48> 
	gtime¡amp
;

	@shared/l2.p4

23 #iâdeà
_P4_L2_


24 
	#_P4_L2_


	)

37 
cÚŒŞ
 
	$Ing»ssSTP
(
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

38 
šout
 
sw™ch_¡p_m‘ad©a_t
 
¡p_md
)(

39 
boŞ
 
muÉË_¡p_’abË
=
çl£
,

40 
sw™ch_ušt32_t
 
bË_size
=4096) {

44 cÚ¡ 
b™
<32> 
¡p_¡©e_size
 = 1 << 19;

45 
Regi¡”
<
b™
<1>, b™<32>>(
¡p_¡©e_size
, 0è
¡p
;

46 
Hash
<
b™
<32>>(
HashAlgÜ™hm_t
.
IDENTITY
è
hash
;

47 
Regi¡”AùiÚ
<
b™
<1>, b™<32>, b™<1>>(
¡p
è
¡p_check
 = {

48 
	`­¶y
(
šout
 
b™
<1> 
v®
, 
out
 b™<1> 
rv
) {

49 
rv
 = 
v®
;

53 
aùiÚ
 
	`£t_¡p_¡©e
(
sw™ch_¡p_¡©e_t
 
¡p_¡©e
) {

54 
¡p_md
.
¡©e_
 = 
¡p_¡©e
;

57 
bË
 
m¡p
 {

58 
key
 = {

59 
ig_md
.
pÜt
 : 
exaù
;

60 
¡p_md
.
group
: 
exaù
;

63 
aùiÚs
 = {

64 
NoAùiÚ
;

65 
£t_¡p_¡©e
;

68 
size
 = 
bË_size
;

69 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

72 
­¶y
 {

73 #ifdeà
STP_ENABLE


74 ià(!
	`INGRESS_BYPASS
(
STP
)) {

75 ià(
muÉË_¡p_’abË
) {

76 
m¡p
.
	`­¶y
();

79 ià(
ig_md
.
bd
[15:12] == 0) {

80 
¡p_md
.
¡©e_
[0:0] = 
¡p_check
.
	`execu‹
(

81 
hash
.
	`g‘
({
ig_md
.
bd
[11:0], ig_md.
pÜt
[6:0]}));

87 
	}
}

95 
cÚŒŞ
 
	$Eg»ssSTP
(
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
, iÀ
sw™ch_pÜt_t
 
pÜt
, 
out
 
boŞ
 
¡p_¡©e
) {

99 
Regi¡”
<
b™
<1>, b™<32>>(1 << 19, 0è
¡p
;

100 
Hash
<
b™
<32>>(
HashAlgÜ™hm_t
.
IDENTITY
è
hash
;

101 
Regi¡”AùiÚ
<
b™
<1>, b™<32>, b™<1>>(
¡p
è
¡p_check
 = {

102 
	`­¶y
(
šout
 
b™
<1> 
v®
, 
out
 b™<1> 
rv
) {

103 
rv
 = 
v®
;

107 
­¶y
 {

108 
¡p_¡©e
 = 
çl£
;

109 #ifdeà
STP_ENABLE


110 ià(!
	`EGRESS_BYPASS
(
STP
)) {

112 ià(
eg_md
.
bd
[15:12] == 0) {

113 
b™
<32> 
¡p_hash_
 = 
hash
.
	`g‘
({
eg_md
.
bd
[11:0], 
pÜt
[6:0]});

114 
¡p_¡©e
 = (
boŞ
è
¡p_check
.
	`execu‹
(
¡p_hash_
);

119 
	}
}

133 
cÚŒŞ
 
	$SMAC
(
š
 
mac_addr_t
 
¤c_addr
,

134 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

135 
šout
 
sw™ch_dige¡_ty³_t
 
dige¡_ty³
)(

136 
sw™ch_ušt32_t
 
bË_size
) {

138 
boŞ
 
¤c_miss
;

139 
sw™ch_ifšdex_t
 
¤c_move
;

141 
aùiÚ
 
	`smac_miss
() {

142 
¤c_miss
 = 
Œue
;

145 
aùiÚ
 
	`smac_h™
(
sw™ch_ifšdex_t
 
ifšdex
) {

146 
¤c_move
 = 
ig_md
.
ifšdex
 ^ ifindex;

149 
bË
 
smac
 {

150 
key
 = {

151 
ig_md
.
bd
 : 
exaù
;

152 
¤c_addr
 : 
exaù
;

155 
aùiÚs
 = {

156 @
deçuÉÚly
 
smac_miss
;

157 
smac_h™
;

160 cÚ¡ 
deçuÉ_aùiÚ
 = 
smac_miss
;

161 
size
 = 
bË_size
;

162 
idË_timeout
 = 
Œue
;

165 
aùiÚ
 
	`nÙify
() {

166 
dige¡_ty³
 = 
SWITCH_DIGEST_TYPE_MAC_LEARNING
;

172 
bË
 
Ë¬nšg
 {

173 
key
 = {

174 
¤c_miss
 : 
exaù
;

175 
¤c_move
 : 
‹º¬y
;

178 
aùiÚs
 = {

179 
NoAùiÚ
;

180 
nÙify
;

183 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

187 
­¶y
 {

188 
¤c_miss
 = 
çl£
;

189 
¤c_move
 = 0;

191 ià(!
	`INGRESS_BYPASS
(
SMAC
)) {

192 
smac
.
	`­¶y
();

195 ià(
ig_md
.
Ë¬nšg
.
bd_mode
 =ğ
SWITCH_LEARNING_MODE_LEARN
 &&

196 
ig_md
.
Ë¬nšg
.
pÜt_mode
 =ğ
SWITCH_LEARNING_MODE_LEARN
) {

197 
Ë¬nšg
.
	`­¶y
();

200 
	}
}

214 
cÚŒŞ
 
DMAC_t
(
š
 
mac_addr_t
 
d¡_addr
, 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
);

216 
cÚŒŞ
 
	$DMAC
(

217 
š
 
mac_addr_t
 
d¡_addr
, 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(
sw™ch_ušt32_t
 
bË_size
) {

219 
aùiÚ
 
	`dmac_miss
() {

220 
ig_md
.
eg»ss_ifšdex
 = 
SWITCH_IFINDEX_FLOOD
;

221 
ig_md
.
æags
.
dmac_miss
 = 
Œue
;

224 
aùiÚ
 
	`dmac_h™
(
sw™ch_ifšdex_t
 
ifšdex
,

225 
sw™ch_pÜt_Ïg_šdex_t
 
pÜt_Ïg_šdex
) {

226 
ig_md
.
eg»ss_ifšdex
 = 
ifšdex
;

227 
ig_md
.
eg»ss_pÜt_Ïg_šdex
 = 
pÜt_Ïg_šdex
;

228 
ig_md
.
checks
.
§me_if
 = ig_md.
ifšdex
 ^ ifindex;

231 
aùiÚ
 
	`dmac_muÉiÿ¡
(
sw™ch_mgid_t
 
šdex
) {

232 
ig_md
.
muÉiÿ¡
.
id
 = 
šdex
;

235 
aùiÚ
 
	`dmac_»dœeù
(
sw™ch_Ãxthİ_t
 
Ãxthİ_šdex
) {

236 
ig_md
.
Ãxthİ
 = 
Ãxthİ_šdex
;

239 
bË
 
dmac
 {

240 
key
 = {

241 
ig_md
.
bd
 : 
exaù
;

242 
d¡_addr
 : 
exaù
;

245 
aùiÚs
 = {

246 
dmac_miss
;

247 
dmac_h™
;

248 
dmac_muÉiÿ¡
;

249 
dmac_»dœeù
;

252 cÚ¡ 
deçuÉ_aùiÚ
 = 
dmac_miss
;

253 
size
 = 
bË_size
;

256 
­¶y
 {

257 
ig_md
.
æags
.
dmac_miss
 = 
çl£
;

259 ià(!
	`INGRESS_BYPASS
(
L2
)) {

260 
dmac
.
	`­¶y
();

263 
	}
}

265 
cÚŒŞ
 
	$Ing»ssBd
(
š
 
sw™ch_bd_t
 
bd
, iÀ
sw™ch_pkt_ty³_t
 
pkt_ty³
)(
sw™ch_ušt32_t
 
bË_size
) {

267 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

269 
aùiÚ
 
	`couÁ
(è{ 
¡©s
.count(); }

271 
bË
 
bd_¡©s
 {

272 
key
 = {

273 
bd
 : 
exaù
;

274 
pkt_ty³
 : 
exaù
;

277 
aùiÚs
 = {

278 
couÁ
;

279 @
deçuÉÚly
 
NoAùiÚ
;

282 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

285 
size
 = 3 * 
bË_size
;

286 
couÁ”s
 = 
¡©s
;

289 
­¶y
 {

290 
bd_¡©s
.
	`­¶y
();

292 
	}
}

294 
cÚŒŞ
 
	$Eg»ssBd
(
š
 
sw™ch_h—d”_t
 
hdr
,

295 
š
 
sw™ch_bd_t
 
bd
,

296 
š
 
sw™ch_pkt_ty³_t
 
pkt_ty³
,

297 
š
 
sw™ch_pkt_¤c_t
 
pkt_¤c
,

298 
out
 
sw™ch_bd_Ïb–_t
 
Ïb–
,

299 
out
 
sw™ch_smac_šdex_t
 
smac_idx
,

300 
out
 
sw™ch_mtu_t
 
mtu_idx
)(

301 
sw™ch_ušt32_t
 
bË_size
) {

303 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

305 
aùiÚ
 
	`couÁ
() {

306 
¡©s
.
	`couÁ
();

309 
bË
 
bd_¡©s
 {

310 
key
 = {

311 
bd
 : 
exaù
;

312 
pkt_ty³
 : 
exaù
;

315 
aùiÚs
 = {

316 
couÁ
;

317 @
deçuÉÚly
 
NoAùiÚ
;

320 
size
 = 3 * 
bË_size
;

321 
couÁ”s
 = 
¡©s
;

324 
aùiÚ
 
	`£t_bd_´İ”t›s
(
sw™ch_bd_Ïb–_t
 
bd_Ïb–
,

325 
sw™ch_smac_šdex_t
 
smac_šdex
,

326 
sw™ch_mtu_t
 
mtu_šdex
) {

327 
Ïb–
 = 
bd_Ïb–
;

328 
smac_idx
 = 
smac_šdex
;

329 
mtu_idx
 = 
mtu_šdex
;

332 
bË
 
bd_m­pšg
 {

333 
key
 = { 
bd
 : 
exaù
; }

334 
aùiÚs
 = {

335 
NoAùiÚ
;

336 
£t_bd_´İ”t›s
;

339 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

340 
size
 = 
bË_size
;

343 
­¶y
 {

344 
mtu_idx
 = 0;

345 
bd_m­pšg
.
	`­¶y
();

346 ià(
pkt_¤c
 =ğ
SWITCH_PKT_SRC_BRIDGED
)

347 
bd_¡©s
.
	`­¶y
();

349 
	}
}

361 
cÚŒŞ
 
	$VÏnDeÿp
(
šout
 
sw™ch_h—d”_t
 
hdr
, 
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
) {

362 
aùiÚ
 
	`»move_vÏn_g
() {

363 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = hdr.
vÏn_g
[0].ether_type;

364 
hdr
.
vÏn_g
.
	`pİ_äÚt
(1);

367 
aùiÚ
 
	`»move_doubË_g
() {

368 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = hdr.
vÏn_g
[1].ether_type;

369 
hdr
.
vÏn_g
.
	`pİ_äÚt
(2);

372 
bË
 
vÏn_deÿp
 {

373 
key
 = {

374 #ifdeà
QINQ_ENABLE


375 
eg_md
.
šg»ss_pÜt
 : 
‹º¬y
 @
	`Çme
("ingress_port");

377 
hdr
.
vÏn_g
[0].
	`isV®id
(è: 
‹º¬y
;

378 #ifdeà
QINQ_RIF_ENABLE


379 
hdr
.
vÏn_g
[1].
	`isV®id
(è: 
‹º¬y
;

383 
aùiÚs
 = {

384 
NoAùiÚ
;

385 
»move_vÏn_g
;

386 
»move_doubË_g
;

389 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

392 
­¶y
 {

393 ià(!
	`EGRESS_BYPASS
(
REWRITE
)) {

394 #ià
	`defšed
(
QINQ_ENABLE
è|| defšed(
QINQ_RIF_ENABLE
)

395 
vÏn_deÿp
.
	`­¶y
();

398 ià(
hdr
.
vÏn_g
[0].
	`isV®id
()) {

399 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = hdr.
vÏn_g
[0].ether_type;

400 
hdr
.
vÏn_g
[0].
	`£tInv®id
();

405 
	}
}

414 
cÚŒŞ
 
	$VÏnXÏ‹
(
šout
 
sw™ch_h—d”_t
 
hdr
,

415 
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

416 
sw™ch_ušt32_t
 
bd_bË_size
,

417 
sw™ch_ušt32_t
 
pÜt_bd_bË_size
) {

418 
aùiÚ
 
	`£t_vÏn_uÁagged
() {

422 
aùiÚ
 
	`£t_doubË_gged
(
vÏn_id_t
 
vid0
, vÏn_id_ˆ
vid1
) {

423 #ifdeà
QINQ_RIF_ENABLE


424 
hdr
.
vÏn_g
[0].
	`£tV®id
();

425 
hdr
.
vÏn_g
[0].
pı
 = 0;

426 
hdr
.
vÏn_g
[0].
cfi
 = 0;

427 
hdr
.
vÏn_g
[0].
vid
 = 
vid0
;

428 
hdr
.
vÏn_g
[0].
‘h”_ty³
 = 
ETHERTYPE_VLAN
;

429 
hdr
.
vÏn_g
[1].
	`£tV®id
();

430 
hdr
.
vÏn_g
[1].
pı
 = 0;

431 
hdr
.
vÏn_g
[1].
cfi
 = 0;

432 
hdr
.
vÏn_g
[1].
vid
 = 
vid1
;

433 
hdr
.
vÏn_g
[1].
‘h”_ty³
 = hdr.
‘h”Ãt
.ether_type;

434 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_QINQ
;

438 
aùiÚ
 
	`£t_vÏn_gged
(
vÏn_id_t
 
vid
) {

439 #ifdeà
QINQ_ENABLE


440 
hdr
.
vÏn_g
.
	`push_äÚt
(1);

442 
hdr
.
vÏn_g
[0].
	`£tV®id
();

443 
hdr
.
vÏn_g
[0].
‘h”_ty³
 = hdr.
‘h”Ãt
.ether_type;

445 
hdr
.
vÏn_g
[0].
pı
 = 
eg_md
.
lkp
.pcp;

446 
hdr
.
vÏn_g
[0].
cfi
 = 0;

447 
hdr
.
vÏn_g
[0].
vid
 = vid;

448 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_VLAN
;

451 
bË
 
pÜt_bd_to_vÏn_m­pšg
 {

452 
key
 = {

453 
eg_md
.
pÜt_Ïg_šdex
 : 
exaù
 @
	`Çme
("port_lag_index");

454 
eg_md
.
bd
 : 
exaù
 @
	`Çme
("bd");

457 
aùiÚs
 = {

458 
£t_vÏn_uÁagged
;

459 
£t_vÏn_gged
;

460 
£t_doubË_gged
;

463 cÚ¡ 
deçuÉ_aùiÚ
 = 
£t_vÏn_uÁagged
;

464 
size
 = 
pÜt_bd_bË_size
;

468 
bË
 
bd_to_vÏn_m­pšg
 {

469 
key
 = { 
eg_md
.
bd
 : 
exaù
 @
	`Çme
("bd"); }

470 
aùiÚs
 = {

471 
£t_vÏn_uÁagged
;

472 
£t_vÏn_gged
;

475 cÚ¡ 
deçuÉ_aùiÚ
 = 
£t_vÏn_uÁagged
;

476 
size
 = 
bd_bË_size
;

479 
aùiÚ
 
	`£t_ty³_vÏn
() {

480 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_VLAN
;

483 
aùiÚ
 
	`£t_ty³_qšq
() {

484 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_QINQ
;

487 
bË
 
£t_‘h”_ty³
 {

488 
key
 = {

489 
hdr
.
vÏn_g
[0].
	`isV®id
(è: 
exaù
;

490 
hdr
.
vÏn_g
[1].
	`isV®id
(è: 
exaù
;

493 
aùiÚs
 = {

494 
NoAùiÚ
;

495 
£t_ty³_vÏn
;

496 
£t_ty³_qšq
;

499 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

500 cÚ¡ 
’Œ›s
 = {

501 (
Œue
, 
çl£
è: 
	`£t_ty³_vÏn
();

502 (
Œue
,rueè: 
	`£t_ty³_qšq
();

506 
­¶y
 {

507 ià(!
	`EGRESS_BYPASS
(
REWRITE
)) {

508 ià(!
pÜt_bd_to_vÏn_m­pšg
.
	`­¶y
().
h™
) {

509 
bd_to_vÏn_m­pšg
.
	`­¶y
();

512 #ifdeà
QINQ_ENABLE


513 
£t_‘h”_ty³
.
	`­¶y
();

517 
	}
}

	@shared/l3.p4

23 
	~"aş.p4
"

24 
	~"l2.p4
"

36 
cÚŒŞ
 
	gFib
<
	gT
>(
š
 
v4_addr_t
 
	gd¡_addr
,

37 
š
 
sw™ch_vrf_t
 
	gvrf
,

38 
out
 
sw™ch_šg»ss_æags_t
 
	gæags
,

39 
out
 
sw™ch_Ãxthİ_t
 
	gÃxthİ
)(

40 
sw™ch_ušt32_t
 
	gho¡_bË_size
,

41 
sw™ch_ušt32_t
 
	gÍm_bË_size
,

42 
boŞ
 
	gloÿl_ho¡_’abË
=
çl£
,

43 
sw™ch_ušt32_t
 
	gloÿl_ho¡_bË_size
=1024) {

44 
aùiÚ
 
fib_h™
(
sw™ch_Ãxthİ_t
 
Ãxthİ_šdex
) {

45 
Ãxthİ
 = 
Ãxthİ_šdex
;

46 
	gæags
.
	grou‹d
 = 
Œue
;

49 
aùiÚ
 
fib_miss
() {

50 
	gæags
.
	grou‹d
 = 
çl£
;

53 
aùiÚ
 
fib_my
() {

54 
	gæags
.
	gmy
 = 
Œue
;

57 
bË
 
	gfib
 {

58 
	gkey
 = {

59 
vrf
 : 
exaù
;

60 
	gd¡_addr
 : 
exaù
;

63 
	gaùiÚs
 = {

64 
fib_miss
;

65 
	gfib_h™
;

66 
	gfib_my
;

69 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
fib_miss
;

70 
	gsize
 = 
ho¡_bË_size
;

73 
bË
 
	gfib_loÿl_ho¡
 {

74 
	gkey
 = {

75 
vrf
 : 
exaù
;

76 
	gd¡_addr
 : 
exaù
;

79 
	gaùiÚs
 = {

80 
fib_miss
;

81 
	gfib_h™
;

82 
	gfib_my
;

85 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
fib_miss
;

86 
	gsize
 = 
loÿl_ho¡_bË_size
;

89 @
®pm
(1)

90 #ià
__TARGET_TOFINO__
 == 2

91 @
®pm_·¹™iÚs
(2048)

92 @
®pm_subŒ“s_³r_·¹™iÚ
(2)

94 @
®pm_·¹™iÚs
(1024)

95 @
®pm_subŒ“s_³r_·¹™iÚ
(2)

97 
bË
 
	gfib_Ím
 {

98 
	gkey
 = {

99 
vrf
 : 
exaù
;

100 
	gd¡_addr
 : 
Ím
;

103 
	gaùiÚs
 = {

104 
fib_miss
;

105 
	gfib_h™
;

108 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
fib_miss
;

109 
	gsize
 = 
Ím_bË_size
;

112 
	g­¶y
 {

113 ià(
	gloÿl_ho¡_’abË
) {

114 ià(!
	gfib_loÿl_ho¡
.
­¶y
().
	gh™
) {

115 ià(!
	gfib
.
­¶y
().
	gh™
) {

116 
	gfib_Ím
.
­¶y
();

120 ià(!
	gfib
.
­¶y
().
	gh™
) {

121 
	gfib_Ím
.
­¶y
();

127 
cÚŒŞ
 
	gFibv6
<
	gT
>(
š
 
v6_addr_t
 
	gd¡_addr
,

128 
š
 
sw™ch_vrf_t
 
	gvrf
,

129 
out
 
sw™ch_šg»ss_æags_t
 
	gæags
,

130 
out
 
sw™ch_Ãxthİ_t
 
	gÃxthİ
)(

131 
sw™ch_ušt32_t
 
	gho¡_bË_size
,

132 
sw™ch_ušt32_t
 
	gÍm_bË_size
,

133 
sw™ch_ušt32_t
 
	gÍm64_bË_size


135 
aùiÚ
 
fib_h™
(
sw™ch_Ãxthİ_t
 
Ãxthİ_šdex
) {

136 
	gÃxthİ
 = 
Ãxthİ_šdex
;

137 
	gæags
.
	grou‹d
 = 
Œue
;

140 
aùiÚ
 
fib_miss
() {

141 
	gæags
.
	grou‹d
 = 
çl£
;

144 
aùiÚ
 
fib_my
() {

145 
	gæags
.
	gmy
 = 
Œue
;

148 
bË
 
	gfib
 {

149 
	gkey
 = {

150 
vrf
 : 
exaù
;

151 
	gd¡_addr
 : 
exaù
;

154 
	gaùiÚs
 = {

155 
fib_miss
;

156 
	gfib_h™
;

157 
	gfib_my
;

160 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
fib_miss
;

161 
	gsize
 = 
ho¡_bË_size
;

164 @
®pm
(1)

165 #ià
defšed
(
IPV6_LPM64_ENABLE
)

166 @
®pm_·¹™iÚs
(1024)

167 @
®pm_subŒ“s_³r_·¹™iÚ
(2)

169 @
®pm_·¹™iÚs
(1024)

170 @
®pm_subŒ“s_³r_·¹™iÚ
(2)

172 
bË
 
	gfib_Ím
 {

173 
	gkey
 = {

174 
vrf
 : 
exaù
;

175 
	gd¡_addr
 : 
Ím
;

178 
	gaùiÚs
 = {

179 
fib_miss
;

180 
	gfib_h™
;

183 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
fib_miss
;

184 
	gsize
 = 
Ím_bË_size
;

187 #ià
defšed
(
IPV6_LPM64_ENABLE
)

188 @
®pm
(1)

189 @
®pm_·¹™iÚs
(1024)

190 @
®pm_subŒ“s_³r_·¹™iÚ
(2)

191 
bË
 
	gfib_Ím64
 {

192 
	gkey
 = {

193 
vrf
 : 
exaù
;

194 
	gd¡_addr
[127:64] : 
Ím
;

197 
	gaùiÚs
 = {

198 
fib_miss
;

199 
	gfib_h™
;

202 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
fib_miss
;

203 
	gsize
 = 
Ím64_bË_size
;

207 
	g­¶y
 {

208 ià(!
	gfib
.
­¶y
().
	gh™
) {

209 #ià
defšed
(
IPV6_LPM64_ENABLE
)

210 ià(!
	gfib_Ím64
.
­¶y
().
	gh™
) {

211 
	gfib_Ím
.
­¶y
();

215 
	gfib_Ím
.
­¶y
();

221 
cÚŒŞ
 
	$MTU
(
š
 
sw™ch_h—d”_t
 
hdr
,

222 
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

223 
šout
 
sw™ch_mtu_t
 
mtu_check
)(

224 
sw™ch_ušt32_t
 
bË_size
=1024) {

226 
aùiÚ
 
	`v4_mtu_check
(
sw™ch_mtu_t
 
mtu
) {

227 
mtu_check
 = 
mtu
 |-| 
hdr
.
v4
.
tÙ®_Ën
;

230 
aùiÚ
 
	`v6_mtu_check
(
sw™ch_mtu_t
 
mtu
) {

231 
mtu_check
 = 
mtu
 |-| 
hdr
.
v6
.
·ylßd_Ën
;

234 
aùiÚ
 
	`mtu_miss
() {

235 
mtu_check
 = 16
w0xffff
;

238 
bË
 
mtu
 {

239 
key
 = {

240 
mtu_check
 : 
exaù
;

241 
hdr
.
v4
.
	`isV®id
(è: 
exaù
;

242 
hdr
.
v6
.
	`isV®id
(è: 
exaù
;

245 
aùiÚs
 = {

246 
v4_mtu_check
;

247 
v6_mtu_check
;

248 
mtu_miss
;

251 cÚ¡ 
deçuÉ_aùiÚ
 = 
mtu_miss
;

252 
size
 = 
bË_size
;

255 
­¶y
 {

256 ià(!
	`EGRESS_BYPASS
(
MTU
))

257 
mtu
.
	`­¶y
();

259 
	}
}

266 
cÚŒŞ
 
	$Ing»ssUniÿ¡
(
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

267 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

268 
DMAC_t
 
dmac
,

269 
sw™ch_ušt32_t
 
v4_ho¡_bË_size
,

270 
sw™ch_ušt32_t
 
v4_rou‹_bË_size
,

271 
sw™ch_ušt32_t
 
v6_ho¡_bË_size
=1024,

272 
sw™ch_ušt32_t
 
v6_rou‹_bË_size
=512,

273 
sw™ch_ušt32_t
 
v6_rou‹64_bË_size
=512,

274 
boŞ
 
loÿl_ho¡_’abË
=
çl£
,

275 
sw™ch_ušt32_t
 
v4_loÿl_ho¡_bË_size
=1024) {

277 
Fib
<
v4_addr_t
>(
v4_ho¡_bË_size
,

278 
v4_rou‹_bË_size
,

279 
loÿl_ho¡_’abË
,

280 
v4_loÿl_ho¡_bË_size
è
v4_fib
;

281 
Fibv6
<
v6_addr_t
>(
v6_ho¡_bË_size
, 
v6_rou‹_bË_size
, 
v6_rou‹64_bË_size
è
v6_fib
;

283 
aùiÚ
 
	`rmac_h™
() {

284 
ig_md
.
æags
.
rmac_h™
 = 
Œue
;

287 
aùiÚ
 
	`rmac_miss
() {

296 
bË
 
rmac
 {

297 
key
 = {

298 
ig_md
.
rmac_group
 : 
exaù
;

299 
lkp
.
mac_d¡_addr
 : 
exaù
;

302 
aùiÚs
 = {

303 
rmac_h™
;

304 @
deçuÉÚly
 
rmac_miss
;

307 cÚ¡ 
deçuÉ_aùiÚ
 = 
rmac_miss
;

308 
size
 = 1024;

311 
­¶y
 {

312 ià(
rmac
.
	`­¶y
().
h™
) {

313 ià(!
	`INGRESS_BYPASS
(
L3
)) {

314 ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV4
 \

315 && 
ig_md
.
v4
.
uniÿ¡_’abË
) {

316 
v4_fib
.
	`­¶y
(
lkp
.
_d¡_addr
[31:0],

317 
ig_md
.
vrf
,

318 
ig_md
.
æags
,

319 
ig_md
.
Ãxthİ
);

320 } ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV6
 \

321 && 
ig_md
.
v6
.
uniÿ¡_’abË
) {

322 #ifdeà
IPV6_ENABLE


323 
v6_fib
.
	`­¶y
(
lkp
.
_d¡_addr
,

324 
ig_md
.
vrf
,

325 
ig_md
.
æags
,

326 
ig_md
.
Ãxthİ
);

333 
dmac
.
	`­¶y
(
lkp
.
mac_d¡_addr
, 
ig_md
);

336 
	}
}

	@shared/meter.p4

23 #iâdeà
_P4_METER_


24 
	#_P4_METER_


	)

26 
	~"aş.p4
"

39 
cÚŒŞ
 
	$Ing»ssPŞiûr
(
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

40 
šout
 
sw™ch_qos_m‘ad©a_t
 
qos_md
,

41 
out
 
boŞ
 
æag
)(

42 
sw™ch_ušt32_t
 
bË_size
=1024) {

43 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

44 
	`DœeùM‘”
(
M‘”Ty³_t
.
BYTES
è
m‘”
;

47 
aùiÚ
 
	`m‘”_d’y
() {

48 
¡©s
.
	`couÁ
();

49 
æag
 = 
Œue
;

50 
qos_md
.
cŞÜ
 = qos_md.
aş_pŞiûr_cŞÜ
;

53 
aùiÚ
 
	`m‘”_³rm™
() {

54 
¡©s
.
	`couÁ
();

57 
bË
 
m‘”_aùiÚ
 {

58 
key
 = {

59 
qos_md
.
aş_pŞiûr_cŞÜ
 : 
exaù
;

60 
qos_md
.
m‘”_šdex
 : 
exaù
;

63 
aùiÚs
 = {

64 
m‘”_³rm™
;

65 
m‘”_d’y
;

68 cÚ¡ 
deçuÉ_aùiÚ
 = 
m‘”_³rm™
;

69 
size
 = 3 * 
bË_size
;

70 
couÁ”s
 = 
¡©s
;

73 
aùiÚ
 
	`£t_cŞÜ
() {

74 
qos_md
.
aş_pŞiûr_cŞÜ
 = (
b™
<2>è
m‘”
.
	`execu‹
();

77 
bË
 
m‘”_šdex
 {

78 
key
 = {

79 
qos_md
.
m‘”_šdex
: 
exaù
;

82 
aùiÚs
 = {

83 @
deçuÉÚly
 
NoAùiÚ
;

84 
£t_cŞÜ
;

87 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

88 
size
 = 
bË_size
;

89 
m‘”s
 = 
m‘”
;

92 
­¶y
 {

93 #ià
	`defšed
(
INGRESS_ACL_POLICER_ENABLE
)

94 
æag
 = 
çl£
;

96 ià(!
	`INGRESS_BYPASS
(
POLICER
))

97 
m‘”_šdex
.
	`­¶y
();

99 ià(!
	`INGRESS_BYPASS
(
POLICER
))

100 
m‘”_aùiÚ
.
	`­¶y
();

103 
	}
}

117 
cÚŒŞ
 
	$StÜmCÚŒŞ
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

118 
š
 
sw™ch_pkt_ty³_t
 
pkt_ty³
,

119 
out
 
boŞ
 
æag
)(

120 
sw™ch_ušt32_t
 
bË_size
=512) {

121 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS
è
¡Üm_cÚŒŞ_¡©s
;

122 
M‘”
<
b™
<16>>(
bË_size
, 
M‘”Ty³_t
.
BYTES
è
m‘”
;

124 
aùiÚ
 
	`couÁ
() {

125 
¡Üm_cÚŒŞ_¡©s
.
	`couÁ
();

128 
aùiÚ
 
	`drİ_ªd_couÁ
() {

129 
¡Üm_cÚŒŞ_¡©s
.
	`couÁ
();

130 
æag
 = 
Œue
;

133 
bË
 
¡©s
 {

134 
key
 = {

135 
ig_md
.
qos
.
¡Üm_cÚŒŞ_cŞÜ
: 
exaù
;

136 
pkt_ty³
 : 
‹º¬y
;

137 
ig_md
.
pÜt
: 
exaù
;

138 
ig_md
.
æags
.
dmac_miss
 : 
‹º¬y
;

141 
aùiÚs
 = {

142 @
deçuÉÚly
 
NoAùiÚ
;

143 
couÁ
;

144 
drİ_ªd_couÁ
;

147 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

148 
size
 = 
bË_size
;

149 
couÁ”s
 = 
¡Üm_cÚŒŞ_¡©s
;

152 
aùiÚ
 
	`£t_m‘”
(
b™
<16> 
šdex
) {

153 
ig_md
.
qos
.
¡Üm_cÚŒŞ_cŞÜ
 = (
b™
<2>è
m‘”
.
	`execu‹
(
šdex
);

156 
bË
 
¡Üm_cÚŒŞ
 {

157 
key
 = {

158 
ig_md
.
pÜt
 : 
exaù
;

159 
pkt_ty³
 : 
‹º¬y
;

160 
ig_md
.
æags
.
dmac_miss
 : 
‹º¬y
;

163 
aùiÚs
 = {

164 @
deçuÉÚly
 
NoAùiÚ
;

165 
£t_m‘”
;

168 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

169 
size
 = 
bË_size
;

172 
­¶y
 {

173 
ig_md
.
qos
.
¡Üm_cÚŒŞ_cŞÜ
 = 0;

174 #ifdeà
STORM_CONTROL_ENABLE


175 
æag
 = 
çl£
;

177 ià(!
	`INGRESS_BYPASS
(
STORM_CONTROL
))

178 
¡Üm_cÚŒŞ
.
	`­¶y
();

180 ià(!
	`INGRESS_BYPASS
(
STORM_CONTROL
))

181 
¡©s
.
	`­¶y
();

184 
	}
}

197 
cÚŒŞ
 
	$PÜtPŞiûr
(
š
 
sw™ch_pÜt_t
 
pÜt
,

198 
out
 
boŞ
 
æag
)(

199 
sw™ch_ušt32_t
 
bË_size
=288) {

200 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
BYTES
è
¡©s
;

201 
M‘”
<
b™
<9>>(
bË_size
, 
M‘”Ty³_t
.
BYTES
è
m‘”
;

202 
sw™ch_pkt_cŞÜ_t
 
cŞÜ
;

204 
aùiÚ
 
	`³rm™_ªd_couÁ
() {

205 
¡©s
.
	`couÁ
();

206 
æag
 = 
çl£
;

209 
aùiÚ
 
	`drİ_ªd_couÁ
() {

210 
¡©s
.
	`couÁ
();

211 
æag
 = 
Œue
;

214 
bË
 
m‘”_aùiÚ
 {

215 
key
 = {

216 
cŞÜ
: 
exaù
;

217 
pÜt
: 
exaù
;

220 
aùiÚs
 = {

221 @
deçuÉÚly
 
NoAùiÚ
;

222 
³rm™_ªd_couÁ
;

223 
drİ_ªd_couÁ
;

226 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

227 
size
 = 
bË_size
*2;

228 
couÁ”s
 = 
¡©s
;

231 
aùiÚ
 
	`£t_m‘”
(
b™
<9> 
šdex
) {

232 
cŞÜ
 = (
b™
<2>è
m‘”
.
	`execu‹
(
šdex
);

235 
bË
 
m‘”_šdex
 {

236 
key
 = {

237 
pÜt
 : 
exaù
;

240 
aùiÚs
 = {

241 @
deçuÉÚly
 
NoAùiÚ
;

242 
£t_m‘”
;

245 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

246 
size
 = 
bË_size
;

249 
­¶y
 {

250 
m‘”_šdex
.
	`­¶y
();

251 
m‘”_aùiÚ
.
	`­¶y
();

253 
	}
}

255 
cÚŒŞ
 
	$PÜtPŞiûr2
(
š
 
sw™ch_pÜt_t
 
pÜt
,

256 
out
 
boŞ
 
æag
)(

257 
sw™ch_ušt32_t
 
bË_size
=288) {

258 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
BYTES
è
¡©s
;

259 
M‘”
<
b™
<9>>(
bË_size
, 
M‘”Ty³_t
.
BYTES
è
m‘”
;

260 
sw™ch_pkt_cŞÜ_t
 
cŞÜ
;

262 
aùiÚ
 
	`³rm™_ªd_couÁ
() {

263 
¡©s
.
	`couÁ
();

264 
æag
 = 
çl£
;

267 
aùiÚ
 
	`drİ_ªd_couÁ
() {

268 
¡©s
.
	`couÁ
();

269 
æag
 = 
Œue
;

272 
bË
 
m‘”_aùiÚ
 {

273 
key
 = {

274 
cŞÜ
: 
exaù
;

275 
pÜt
: 
exaù
;

278 
aùiÚs
 = {

279 @
deçuÉÚly
 
NoAùiÚ
;

280 
³rm™_ªd_couÁ
;

281 
drİ_ªd_couÁ
;

284 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

285 
size
 = 
bË_size
*2;

286 
couÁ”s
 = 
¡©s
;

289 
aùiÚ
 
	`£t_m‘”
(
b™
<9> 
šdex
) {

290 
cŞÜ
 = (
b™
<2>è
m‘”
.
	`execu‹
(
šdex
);

293 
bË
 
m‘”_šdex
 {

294 
key
 = {

295 
pÜt
 : 
exaù
;

298 
aùiÚs
 = {

299 @
deçuÉÚly
 
NoAùiÚ
;

300 
£t_m‘”
;

303 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

304 
size
 = 
bË_size
;

307 
­¶y
 {

308 
m‘”_šdex
.
	`­¶y
();

309 
m‘”_aùiÚ
.
	`­¶y
();

311 
	}
}

	@shared/multicast.p4

23 #iâdeà
_P4_MULTICAST_


24 
	#_P4_MULTICAST_


	)

35 
cÚŒŞ
 
	gMuÉiÿ¡Bridge
<
	gT
>(

36 
š
 
v4_addr_t
 
	g¤c_addr
,

37 
š
 
v4_addr_t
 
	gg½_addr
,

38 
š
 
sw™ch_bd_t
 
	gbd
,

39 
out
 
sw™ch_mgid_t
 
	ggroup_id
,

40 
out
 
	gb™
<1> 
	gmuÉiÿ¡_h™
)(

41 
sw™ch_ušt32_t
 
	gs_g_bË_size
,

42 
sw™ch_ušt32_t
 
	g¡¬_g_bË_size
) {

43 
aùiÚ
 
s_g_h™
(
sw™ch_mgid_t
 
mgid
) {

44 
	ggroup_id
 = 
mgid
;

45 
	gmuÉiÿ¡_h™
 = 1;

48 
aùiÚ
 
¡¬_g_h™
(
sw™ch_mgid_t
 
mgid
) {

49 
	ggroup_id
 = 
mgid
;

50 
	gmuÉiÿ¡_h™
 = 1;

53 
aùiÚ
 
¡¬_g_miss
() {

54 
	gmuÉiÿ¡_h™
 = 0;

57 
bË
 
	gs_g
 {

58 
	gkey
 = {

59 
bd
 : 
exaù
;

60 
	g¤c_addr
 : 
exaù
;

61 
	gg½_addr
 : 
exaù
;

64 
	gaùiÚs
 = {

65 
NoAùiÚ
;

66 
	gs_g_h™
;

69 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

70 
	gsize
 = 
s_g_bË_size
;

73 
bË
 
	g¡¬_g
 {

74 
	gkey
 = {

75 
bd
 : 
exaù
;

76 
	gg½_addr
 : 
exaù
;

79 
	gaùiÚs
 = {

80 
¡¬_g_miss
;

81 
	g¡¬_g_h™
;

84 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
¡¬_g_miss
;

85 
	gsize
 = 
¡¬_g_bË_size
;

88 
	g­¶y
 {

89 #ifdeà
MULTICAST_ENABLE


90 
	gs_g
.
­¶y
().
	gaùiÚ_run
) {

91 
	gNoAùiÚ
 : { 
¡¬_g
.
­¶y
(); }

97 
cÚŒŞ
 
	gMuÉiÿ¡Bridgev6
<
	gT
>(

98 
š
 
v6_addr_t
 
	g¤c_addr
,

99 
š
 
v6_addr_t
 
	gg½_addr
,

100 
š
 
sw™ch_bd_t
 
	gbd
,

101 
out
 
sw™ch_mgid_t
 
	ggroup_id
,

102 
out
 
	gb™
<1> 
	gmuÉiÿ¡_h™
)(

103 
sw™ch_ušt32_t
 
	gs_g_bË_size
,

104 
sw™ch_ušt32_t
 
	g¡¬_g_bË_size
) {

105 
aùiÚ
 
s_g_h™
(
sw™ch_mgid_t
 
mgid
) {

106 
	ggroup_id
 = 
mgid
;

107 
	gmuÉiÿ¡_h™
 = 1;

110 
aùiÚ
 
¡¬_g_h™
(
sw™ch_mgid_t
 
mgid
) {

111 
	ggroup_id
 = 
mgid
;

112 
	gmuÉiÿ¡_h™
 = 1;

115 
aùiÚ
 
¡¬_g_miss
() {

116 
	gmuÉiÿ¡_h™
 = 0;

119 
bË
 
	gs_g
 {

120 
	gkey
 = {

121 
bd
 : 
exaù
;

122 
	g¤c_addr
 : 
exaù
;

123 
	gg½_addr
 : 
exaù
;

126 
	gaùiÚs
 = {

127 
NoAùiÚ
;

128 
	gs_g_h™
;

131 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

132 
	gsize
 = 
s_g_bË_size
;

135 
bË
 
	g¡¬_g
 {

136 
	gkey
 = {

137 
bd
 : 
exaù
;

138 
	gg½_addr
 : 
exaù
;

141 
	gaùiÚs
 = {

142 
¡¬_g_miss
;

143 
	g¡¬_g_h™
;

146 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
¡¬_g_miss
;

147 
	gsize
 = 
¡¬_g_bË_size
;

150 
	g­¶y
 {

151 #ifdeà
MULTICAST_ENABLE


152 
	gs_g
.
­¶y
().
	gaùiÚ_run
) {

153 
	gNoAùiÚ
 : { 
¡¬_g
.
­¶y
(); }

159 
cÚŒŞ
 
	gMuÉiÿ¡Rou‹
<
	gT
>(

160 
š
 
v4_addr_t
 
	g¤c_addr
,

161 
š
 
v4_addr_t
 
	gg½_addr
,

162 
š
 
sw™ch_vrf_t
 
	gvrf
,

163 
šout
 
sw™ch_muÉiÿ¡_m‘ad©a_t
 
	gmuÉiÿ¡_md
,

164 
out
 
sw™ch_muÉiÿ¡_½f_group_t
 
	g½f_check
,

165 
out
 
sw™ch_mgid_t
 
	gmuÉiÿ¡_group_id
,

166 
out
 
	gb™
<1> 
	gmuÉiÿ¡_h™
)(

167 
sw™ch_ušt32_t
 
	gs_g_bË_size
,

168 
sw™ch_ušt32_t
 
	g¡¬_g_bË_size
) {

170 
	gDœeùCouÁ”
<
	gb™
<32>>(
	gCouÁ”Ty³_t
.
	gPACKETS
è
	gs_g_¡©s
;

171 
	gDœeùCouÁ”
<
	gb™
<32>>(
	gCouÁ”Ty³_t
.
	gPACKETS
è
	g¡¬_g_¡©s
;

173 
aùiÚ
 
s_g_h™
(

174 
sw™ch_mgid_t
 
mgid
, 
sw™ch_muÉiÿ¡_½f_group_t
 
½f_group
) {

175 
	gmuÉiÿ¡_group_id
 = 
mgid
;

176 
	gmuÉiÿ¡_h™
 = 1;

177 
	g½f_check
 = 
½f_group
 ^ 
muÉiÿ¡_md
.rpf_group;

178 
	gmuÉiÿ¡_md
.
	gmode
 = 
SWITCH_MULTICAST_MODE_PIM_SM
;

179 
	gs_g_¡©s
.
couÁ
();

182 
aùiÚ
 
¡¬_g_h™_bidœ
(

183 
sw™ch_mgid_t
 
mgid
, 
sw™ch_muÉiÿ¡_½f_group_t
 
½f_group
) {

184 
	gmuÉiÿ¡_group_id
 = 
mgid
;

185 
	gmuÉiÿ¡_h™
 = 1;

187 
	g½f_check
 = 
½f_group
 & 
muÉiÿ¡_md
.rpf_group;

188 
	gmuÉiÿ¡_md
.
	gmode
 = 
SWITCH_MULTICAST_MODE_PIM_BIDIR
;

189 
	g¡¬_g_¡©s
.
couÁ
();

192 
aùiÚ
 
¡¬_g_h™_sm
(

193 
sw™ch_mgid_t
 
mgid
, 
sw™ch_muÉiÿ¡_½f_group_t
 
½f_group
) {

194 
	gmuÉiÿ¡_group_id
 = 
mgid
;

195 
	gmuÉiÿ¡_h™
 = 1;

197 
	g½f_check
 = 
½f_group
 ^ 
muÉiÿ¡_md
.rpf_group;

198 
	gmuÉiÿ¡_md
.
	gmode
 = 
SWITCH_MULTICAST_MODE_PIM_SM
;

199 
	g¡¬_g_¡©s
.
couÁ
();

203 
bË
 
	gs_g
 {

204 
	gkey
 = {

205 
vrf
 : 
exaù
;

206 
	g¤c_addr
 : 
exaù
;

207 
	gg½_addr
 : 
exaù
;

210 
	gaùiÚs
 = {

211 @
deçuÉÚly
 
NoAùiÚ
;

212 
	gs_g_h™
;

215 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

216 
	gsize
 = 
s_g_bË_size
;

217 
	gcouÁ”s
 = 
s_g_¡©s
;

221 
bË
 
	g¡¬_g
 {

222 
	gkey
 = {

223 
vrf
 : 
exaù
;

224 
	gg½_addr
 : 
exaù
;

227 
	gaùiÚs
 = {

228 @
deçuÉÚly
 
NoAùiÚ
;

229 
	g¡¬_g_h™_sm
;

230 
	g¡¬_g_h™_bidœ
;

233 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

234 
	gsize
 = 
¡¬_g_bË_size
;

235 
	gcouÁ”s
 = 
¡¬_g_¡©s
;

238 
	g­¶y
 {

239 #ifdeà
MULTICAST_ENABLE


240 ià(!
	gs_g
.
­¶y
().
	gh™
) {

241 
	g¡¬_g
.
­¶y
();

248 
cÚŒŞ
 
	gMuÉiÿ¡Rou‹v6
<
	gT
>(

249 
š
 
v6_addr_t
 
	g¤c_addr
,

250 
š
 
v6_addr_t
 
	gg½_addr
,

251 
š
 
sw™ch_vrf_t
 
	gvrf
,

252 
šout
 
sw™ch_muÉiÿ¡_m‘ad©a_t
 
	gmuÉiÿ¡_md
,

253 
out
 
sw™ch_muÉiÿ¡_½f_group_t
 
	g½f_check
,

254 
out
 
sw™ch_mgid_t
 
	gmuÉiÿ¡_group_id
,

255 
out
 
	gb™
<1> 
	gmuÉiÿ¡_h™
)(

256 
sw™ch_ušt32_t
 
	gs_g_bË_size
,

257 
sw™ch_ušt32_t
 
	g¡¬_g_bË_size
) {

259 
	gDœeùCouÁ”
<
	gb™
<32>>(
	gCouÁ”Ty³_t
.
	gPACKETS
è
	gs_g_¡©s
;

260 
	gDœeùCouÁ”
<
	gb™
<32>>(
	gCouÁ”Ty³_t
.
	gPACKETS
è
	g¡¬_g_¡©s
;

262 
aùiÚ
 
s_g_h™
(

263 
sw™ch_mgid_t
 
mgid
, 
sw™ch_muÉiÿ¡_½f_group_t
 
½f_group
) {

264 
	gmuÉiÿ¡_group_id
 = 
mgid
;

265 
	gmuÉiÿ¡_h™
 = 1;

266 
	g½f_check
 = 
½f_group
 ^ 
muÉiÿ¡_md
.rpf_group;

267 
	gs_g_¡©s
.
couÁ
();

270 
aùiÚ
 
¡¬_g_h™_bidœ
(

271 
sw™ch_mgid_t
 
mgid
, 
sw™ch_muÉiÿ¡_½f_group_t
 
½f_group
) {

272 
	gmuÉiÿ¡_group_id
 = 
mgid
;

273 
	gmuÉiÿ¡_h™
 = 1;

275 
	g½f_check
 = 
½f_group
 & 
muÉiÿ¡_md
.rpf_group;

276 
	gmuÉiÿ¡_md
.
	gmode
 = 
SWITCH_MULTICAST_MODE_PIM_BIDIR
;

277 
	g¡¬_g_¡©s
.
couÁ
();

280 
aùiÚ
 
¡¬_g_h™_sm
(

281 
sw™ch_mgid_t
 
mgid
, 
sw™ch_muÉiÿ¡_½f_group_t
 
½f_group
) {

282 
	gmuÉiÿ¡_group_id
 = 
mgid
;

283 
	gmuÉiÿ¡_h™
 = 1;

285 
	g½f_check
 = 
½f_group
 ^ 
muÉiÿ¡_md
.rpf_group;

286 
	gmuÉiÿ¡_md
.
	gmode
 = 
SWITCH_MULTICAST_MODE_PIM_SM
;

287 
	g¡¬_g_¡©s
.
couÁ
();

291 
bË
 
	gs_g
 {

292 
	gkey
 = {

293 
vrf
 : 
exaù
;

294 
	g¤c_addr
 : 
exaù
;

295 
	gg½_addr
 : 
exaù
;

298 
	gaùiÚs
 = {

299 @
deçuÉÚly
 
NoAùiÚ
;

300 
	gs_g_h™
;

303 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

304 
	gsize
 = 
s_g_bË_size
;

305 
	gcouÁ”s
 = 
s_g_¡©s
;

309 
bË
 
	g¡¬_g
 {

310 
	gkey
 = {

311 
vrf
 : 
exaù
;

312 
	gg½_addr
 : 
exaù
;

315 
	gaùiÚs
 = {

316 @
deçuÉÚly
 
NoAùiÚ
;

317 
	g¡¬_g_h™_sm
;

318 
	g¡¬_g_h™_bidœ
;

321 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

322 
	gsize
 = 
¡¬_g_bË_size
;

323 
	gcouÁ”s
 = 
¡¬_g_¡©s
;

326 
	g­¶y
 {

327 #ifdeà
MULTICAST_ENABLE


328 ià(!
	gs_g
.
­¶y
().
	gh™
) {

329 
	g¡¬_g
.
­¶y
();

335 
cÚŒŞ
 
	$Ing»ssMuÉiÿ¡
(

336 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

337 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

338 
sw™ch_ušt32_t
 
v4_s_g_bË_size
,

339 
sw™ch_ušt32_t
 
v4_¡¬_g_bË_size
,

340 
sw™ch_ušt32_t
 
v6_s_g_bË_size
,

341 
sw™ch_ušt32_t
 
v6_¡¬_g_bË_size
) {

346 
MuÉiÿ¡Bridge
<
v4_addr_t
>(
v4_s_g_bË_size
, 
v4_¡¬_g_bË_size
è
v4_muÉiÿ¡_bridge
;

347 
MuÉiÿ¡Rou‹
<
v4_addr_t
>(
v4_s_g_bË_size
, 
v4_¡¬_g_bË_size
è
v4_muÉiÿ¡_rou‹
;

348 
MuÉiÿ¡Bridgev6
<
v6_addr_t
>(

349 
v6_s_g_bË_size
, 
v6_¡¬_g_bË_size
è
v6_muÉiÿ¡_bridge
;

350 
MuÉiÿ¡Rou‹v6
<
v6_addr_t
>(
v6_s_g_bË_size
, 
v6_¡¬_g_bË_size
è
v6_muÉiÿ¡_rou‹
;

352 
sw™ch_muÉiÿ¡_½f_group_t
 
½f_check
;

353 
b™
<1> 
muÉiÿ¡_h™
;

355 
aùiÚ
 
	`£t_muÉiÿ¡_rou‹
() {

356 
ig_md
.
eg»ss_pÜt_Ïg_šdex
 = 0;

357 
ig_md
.
eg»ss_ifšdex
 = 0;

358 
ig_md
.
checks
.
m½f
 = 
Œue
;

359 
ig_md
.
æags
.
rou‹d
 = 
Œue
;

360 
ig_md
.
checks
.
§me_bd
 = 0x3fff;

363 
aùiÚ
 
	`£t_muÉiÿ¡_bridge
(
boŞ
 
m½f
) {

364 
ig_md
.
eg»ss_pÜt_Ïg_šdex
 = 0;

365 
ig_md
.
eg»ss_ifšdex
 = 0;

366 
ig_md
.
checks
.
m½f
 = mrpf;

367 
ig_md
.
æags
.
rou‹d
 = 
çl£
;

370 
aùiÚ
 
	`£t_muÉiÿ¡_æood
(
boŞ
 
m½f
, boŞ 
æood
) {

371 
ig_md
.
eg»ss_pÜt_Ïg_šdex
 = 0;

372 
ig_md
.
eg»ss_ifšdex
 = 
SWITCH_IFINDEX_FLOOD
;

373 
ig_md
.
checks
.
m½f
 = mrpf;

374 
ig_md
.
æags
.
rou‹d
 = 
çl£
;

375 
ig_md
.
æags
.
æood_to_muÉiÿ¡_rou‹rs
 = 
æood
;

378 
bË
 
fwd_»suÉ
 {

379 
key
 = {

380 
muÉiÿ¡_h™
 : 
‹º¬y
;

381 
lkp
.
_ty³
 : 
‹º¬y
;

382 
ig_md
.
v4
.
muÉiÿ¡_¢oİšg
 : 
‹º¬y
;

383 
ig_md
.
v6
.
muÉiÿ¡_¢oİšg
 : 
‹º¬y
;

384 
ig_md
.
muÉiÿ¡
.
mode
 : 
‹º¬y
;

385 
½f_check
 : 
‹º¬y
;

388 
aùiÚs
 = {

389 
£t_muÉiÿ¡_bridge
;

390 
£t_muÉiÿ¡_rou‹
;

391 
£t_muÉiÿ¡_æood
;

395 
­¶y
 {

396 #ifdeà
MULTICAST_ENABLE


397 ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV4
 && 
ig_md
.
v4
.
muÉiÿ¡_’abË
) {

398 
v4_muÉiÿ¡_rou‹
.
	`­¶y
(
lkp
.
_¤c_addr
[31:0],

399 
lkp
.
_d¡_addr
[31:0],

400 
ig_md
.
vrf
,

401 
ig_md
.
muÉiÿ¡
,

402 
½f_check
,

403 
ig_md
.
muÉiÿ¡
.
id
,

404 
muÉiÿ¡_h™
);

405 } ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV6
 && 
ig_md
.
v6
.
muÉiÿ¡_’abË
) {

406 #ifdeà
IPV6_ENABLE


407 
v6_muÉiÿ¡_rou‹
.
	`­¶y
(
lkp
.
_¤c_addr
,

408 
lkp
.
_d¡_addr
,

409 
ig_md
.
vrf
,

410 
ig_md
.
muÉiÿ¡
,

411 
½f_check
,

412 
ig_md
.
muÉiÿ¡
.
id
,

413 
muÉiÿ¡_h™
);

417 ià(
muÉiÿ¡_h™
 == 0 ||

418 (
ig_md
.
muÉiÿ¡
.
mode
 =ğ
SWITCH_MULTICAST_MODE_PIM_SM
 && 
½f_check
 != 0) ||

419 (
ig_md
.
muÉiÿ¡
.
mode
 =ğ
SWITCH_MULTICAST_MODE_PIM_BIDIR
 && 
½f_check
 == 0)) {

421 ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV4
) {

422 
v4_muÉiÿ¡_bridge
.
	`­¶y
(
lkp
.
_¤c_addr
[31:0],

423 
lkp
.
_d¡_addr
[31:0],

424 
ig_md
.
bd
,

425 
ig_md
.
muÉiÿ¡
.
id
,

426 
muÉiÿ¡_h™
);

427 } ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV6
) {

428 #ifdeà
IPV6_ENABLE


429 
v6_muÉiÿ¡_bridge
.
	`­¶y
(
lkp
.
_¤c_addr
,

430 
lkp
.
_d¡_addr
,

431 
ig_md
.
bd
,

432 
ig_md
.
muÉiÿ¡
.
id
,

433 
muÉiÿ¡_h™
);

438 
fwd_»suÉ
.
	`­¶y
();

441 
	}
}

447 
cÚŒŞ
 
	$MuÉiÿ¡Floodšg
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(
sw™ch_ušt32_t
 
bË_size
) {

449 
aùiÚ
 
	`æood
(
sw™ch_mgid_t
 
mgid
) {

450 
ig_md
.
muÉiÿ¡
.
id
 = 
mgid
;

453 
bË
 
bd_æood
 {

454 
key
 = {

455 
ig_md
.
bd
 : 
exaù
 @
	`Çme
("bd");

456 
ig_md
.
lkp
.
pkt_ty³
 : 
exaù
 @
	`Çme
("pkt_type");

457 #ifdeà
MULTICAST_ENABLE


458 
ig_md
.
æags
.
æood_to_muÉiÿ¡_rou‹rs
 : 
exaù
 @
	`Çme
("flood_to_multicast_routers");

462 
aùiÚs
 = { 
æood
; }

463 
size
 = 
bË_size
;

466 
­¶y
 {

467 
bd_æood
.
	`­¶y
();

469 
	}
}

471 
cÚŒŞ
 
	$MuÉiÿ¡R•liÿtiÚ
(
š
 
sw™ch_rid_t
 
»¶iÿtiÚ_id
,

472 
š
 
sw™ch_pÜt_t
 
pÜt
,

473 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

474 
sw™ch_ušt32_t
 
bË_size
=4096) {

475 
aùiÚ
 
	`rid_h™
(
sw™ch_bd_t
 
bd
) {

476 
eg_md
.
checks
.
§me_bd
 = 
bd
 ^ƒg_md.bd;

477 
eg_md
.
bd
 = bd;

480 
aùiÚ
 
	`rid_miss
() {

481 
eg_md
.
æags
.
rou‹d
 = 
çl£
;

484 
bË
 
rid
 {

485 
key
 = { 
»¶iÿtiÚ_id
 : 
exaù
; }

486 
aùiÚs
 = {

487 
rid_miss
;

488 
rid_h™
;

491 
size
 = 
bË_size
;

492 cÚ¡ 
deçuÉ_aùiÚ
 = 
rid_miss
;

495 
­¶y
 {

496 #ifdeà
MULTICAST_ENABLE


497 ià(
»¶iÿtiÚ_id
 != 0)

498 
rid
.
	`­¶y
();

500 ià(
eg_md
.
checks
.
§me_bd
 == 0)

501 
eg_md
.
æags
.
rou‹d
 = 
çl£
;

504 
	}
}

	@shared/nexthop.p4

34 
cÚŒŞ
 
Nexthİ
(
šout
 
sw™ch_lookup_f›lds_t
 
lkp
,

35 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

36 
š
 
b™
<16> 
hash
)(

37 
sw™ch_ušt32_t
 
	gÃxthİ_bË_size
,

38 
sw™ch_ušt32_t
 
	gecmp_bË_size
,

39 
sw™ch_ušt32_t
 
	gecmp_£ËùiÚ_bË_size
) {

41 
	gHash
<
	gsw™ch_ušt16_t
>(
	gHashAlgÜ™hm_t
.
	gIDENTITY
è
	g£ËùÜ_hash
;

42 
AùiÚS–eùÜ
(

43 
ecmp_£ËùiÚ_bË_size
, 
£ËùÜ_hash
, 
S–eùÜMode_t
.
FAIR
è
	gecmp_£ËùÜ
;

45 
aùiÚ
 
£t_Ãxthİ_´İ”t›s
(
sw™ch_ifšdex_t
 
ifšdex
,

46 
sw™ch_pÜt_Ïg_šdex_t
 
pÜt_Ïg_šdex
,

47 
sw™ch_bd_t
 
bd
) {

48 
	gig_md
.
	geg»ss_ifšdex
 = 
ifšdex
;

49 
	gig_md
.
	geg»ss_pÜt_Ïg_šdex
 = 
pÜt_Ïg_šdex
;

50 
	gig_md
.
	gchecks
.
	g§me_if
 = 
ig_md
.
ifšdex
 ^ ifindex;

51 
	gig_md
.
	gchecks
.
	g§me_bd
 = 
ig_md
.
bd
 ^ bd;

54 
aùiÚ
 
£t_Ãxthİ_´İ”t›s_po¡_rou‹d_æood
(
sw™ch_bd_t
 
bd
, 
sw™ch_mgid_t
 
mgid
) {

55 
	gig_md
.
	geg»ss_ifšdex
 = 0;

56 
	gig_md
.
	geg»ss_pÜt_Ïg_šdex
 = 0;

57 
	gig_md
.
	gchecks
.
	g§me_bd
 = 
ig_md
.
bd
 ^ bd;

58 
	gig_md
.
	gmuÉiÿ¡
.
	gid
 = 
mgid
;

61 
aùiÚ
 
£t_Ãxthİ_´İ”t›s_gËª
() {

62 
	gig_md
.
	gæags
.
	ggËª
 = 
Œue
;

63 
	gig_md
.
	gchecks
.
	g§me_bd
 = 0xffff;

66 
aùiÚ
 
£t_Ãxthİ_´İ”t›s_drİ
() {

67 
	gig_md
.
	gdrİ_»asÚ
 = 
SWITCH_DROP_REASON_NEXTHOP
;

70 
aùiÚ
 
£t_ecmp_´İ”t›s
(
sw™ch_ifšdex_t
 
ifšdex
,

71 
sw™ch_pÜt_Ïg_šdex_t
 
pÜt_Ïg_šdex
,

72 
sw™ch_bd_t
 
bd
,

73 
sw™ch_Ãxthİ_t
 
Ãxthİ_šdex
) {

74 
	gig_md
.
	gÃxthİ
 = 
Ãxthİ_šdex
;

75 
£t_Ãxthİ_´İ”t›s
(
ifšdex
, 
pÜt_Ïg_šdex
, 
bd
);

78 
aùiÚ
 
£t_ecmp_´İ”t›s_po¡_rou‹d_æood
(

79 
sw™ch_bd_t
 
bd
,

80 
sw™ch_mgid_t
 
mgid
,

81 
sw™ch_Ãxthİ_t
 
Ãxthİ_šdex
) {

82 
	gig_md
.
	gÃxthİ
 = 
Ãxthİ_šdex
;

83 
£t_Ãxthİ_´İ”t›s_po¡_rou‹d_æood
(
bd
, 
mgid
);

86 
aùiÚ
 
£t_ecmp_´İ”t›s_gËª
(
sw™ch_Ãxthİ_t
 
Ãxthİ_šdex
) {

87 
	gig_md
.
	gÃxthİ
 = 
Ãxthİ_šdex
;

88 
£t_Ãxthİ_´İ”t›s_gËª
();

91 
aùiÚ
 
£t_tuÂ–_´İ”t›s
(
sw™ch_bd_t
 
bd
, 
sw™ch_tuÂ–_šdex_t
 
tuÂ–_šdex
) {

93 
	gig_md
.
	gtuÂ–
.
	gšdex
 = 
tuÂ–_šdex
;

94 
	gig_md
.
	geg»ss_ifšdex
 = 0;

95 
	gig_md
.
	gchecks
.
	g§me_bd
 = 
ig_md
.
bd
 ^ bd;

98 
bË
 
	gecmp
 {

99 
	gkey
 = {

100 
ig_md
.
Ãxthİ
 : 
exaù
;

101 #ifdeà
ACL_REDIRECT_OPT


102 
	gig_md
.
	gaş_Ãxthİ
 : 
exaù
;

103 
	gig_md
.
	gaş_»dœeù
 : 
exaù
;

105 
	ghash
 : 
£ËùÜ
;

108 
	gaùiÚs
 = {

109 
NoAùiÚ
;

110 
	g£t_ecmp_´İ”t›s
;

111 
	g£t_ecmp_´İ”t›s_gËª
;

112 
	g£t_ecmp_´İ”t›s_po¡_rou‹d_æood
;

113 
	g£t_tuÂ–_´İ”t›s
;

116 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

117 
	gsize
 = 
ecmp_bË_size
;

118 
	gim¶em’tiÚ
 = 
ecmp_£ËùÜ
;

121 
bË
 
	gÃxthİ
 {

122 
	gkey
 = {

123 
ig_md
.
Ãxthİ
 : 
exaù
;

124 #ifdeà
ACL_REDIRECT_OPT


125 
	gig_md
.
	gaş_Ãxthİ
 : 
exaù
;

126 
	gig_md
.
	gaş_»dœeù
 : 
exaù
;

130 
	gaùiÚs
 = {

131 
NoAùiÚ
;

132 
	g£t_Ãxthİ_´İ”t›s
;

133 
	g£t_Ãxthİ_´İ”t›s_drİ
;

134 
	g£t_Ãxthİ_´İ”t›s_gËª
;

135 
	g£t_Ãxthİ_´İ”t›s_po¡_rou‹d_æood
;

136 
	g£t_tuÂ–_´İ”t›s
;

139 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

140 
	gsize
 = 
Ãxthİ_bË_size
;

143 
	g­¶y
 {

144 
	gig_md
.
	gchecks
.
	g§me_bd
 = 0;

145 
	gig_md
.
	gæags
.
	ggËª
 = 
çl£
;

147 
	gÃxthİ
.
­¶y
().
	gaùiÚ_run
) {

148 
	gNoAùiÚ
 : { 
ecmp
.
­¶y
(); }

154 
cÚŒŞ
 
Ou‹rFib
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

155 
š
 
b™
<16> 
hash
)(

156 
sw™ch_ušt32_t
 
	gfib_bË_size
,

157 
sw™ch_ušt32_t
 
	gecmp_bË_size
,

158 
sw™ch_ušt32_t
 
	gecmp_£ËùiÚ_bË_size
) {

159 
	gHash
<
	gsw™ch_ušt16_t
>(
	gHashAlgÜ™hm_t
.
	gIDENTITY
è
	g£ËùÜ_hash
;

160 
AùiÚS–eùÜ
(
ecmp_£ËùiÚ_bË_size
, 
£ËùÜ_hash
, 
S–eùÜMode_t
.
FAIR
è
	gecmp_£ËùÜ
;

162 
aùiÚ
 
£t_Ãxthİ_´İ”t›s
(
sw™ch_ifšdex_t
 
ifšdex
,

163 
sw™ch_pÜt_Ïg_šdex_t
 
pÜt_Ïg_šdex
,

164 
sw™ch_ou‹r_Ãxthİ_t
 
Ãxthİ_šdex
) {

165 
	gig_md
.
	gou‹r_Ãxthİ
 = 
Ãxthİ_šdex
;

166 
	gig_md
.
	geg»ss_ifšdex
 = 
ifšdex
;

167 
	gig_md
.
	geg»ss_pÜt_Ïg_šdex
 = 
pÜt_Ïg_šdex
;

170 
bË
 
	gfib
 {

171 
	gkey
 = {

172 
ig_md
.
tuÂ–
.
šdex
 : 
exaù
;

173 
	ghash
 : 
£ËùÜ
;

176 
	gaùiÚs
 = {

177 
NoAùiÚ
;

178 
	g£t_Ãxthİ_´İ”t›s
;

181 cÚ¡ 
	gdeçuÉ_aùiÚ
 = 
NoAùiÚ
;

182 
	gim¶em’tiÚ
 = 
ecmp_£ËùÜ
;

183 
	gsize
 = 
fib_bË_size
;

186 
	g­¶y
 {

187 #ifdeà
TUNNEL_ENABLE


188 
	gfib
.
­¶y
();

	@shared/parde.p4

21 
	~"h—d”s.p4
"

22 
	~"ty³s.p4
"

27 
·r£r
 
	$SRHP¬£r
(
·ck‘_š
 
pkt
, 
šout
 
sw™ch_h—d”_t
 
hdr
) {

28 
¡©e
 
¡¬t
 {

29 #ifdeà
SRV6_ENABLE


30 
Œªs™iÚ
 
·r£_¤h
;

32 
Œªs™iÚ
 
acû±
;

36 
¡©e
 
·r£_¤h
 {

38 
Œªs™iÚ
 
acû±
;

40 
	}
}

47 
·r£r
 
	$Sw™chIng»ssP¬£r
(

48 
·ck‘_š
 
pkt
,

49 
out
 
sw™ch_h—d”_t
 
hdr
,

50 
out
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

51 
out
 
šg»ss_šŒšsic_m‘ad©a_t
 
ig_šŒ_md
) {

52 
	`Checksum
(è
v4_checksum
;

53 
	`Checksum
(è
šÃr_v4_checksum
;

54 
v®ue_£t
<
b™
<16>>(1è
udp_pÜt_vxÏn
;

55 
v®ue_£t
<
sw™ch_ıu_pÜt_v®ue_£t_t
>(1è
ıu_pÜt
;

57 
¡©e
 
¡¬t
 {

58 
pkt
.
	`exŒaù
(
ig_šŒ_md
);

59 
ig_md
.
pÜt
 = 
ig_šŒ_md
.
šg»ss_pÜt
;

60 
ig_md
.
time¡amp
 = 
ig_šŒ_md
.
šg»ss_mac_t¡amp
;

66 
Œªs™iÚ
 
·r£_pÜt_m‘ad©a
;

69 
¡©e
 
·r£_»subm™
 {

71 
Œªs™iÚ
 
acû±
;

74 
¡©e
 
·r£_pÜt_m‘ad©a
 {

76 
sw™ch_pÜt_m‘ad©a_t
 
pÜt_md
 = 
pÜt_m‘ad©a_uÅack
<sw™ch_pÜt_m‘ad©a_t>(
pkt
);

77 
ig_md
.
pÜt_Ïg_šdex
 = 
pÜt_md
.port_lag_index;

78 
ig_md
.
pÜt_Ïg_Ïb–
 = 
pÜt_md
.port_lag_label;

79 
ig_md
.
ifšdex
 = 
pÜt_md
.ifindex;

80 
Œªs™iÚ
 
·r£_·ck‘
;

83 
¡©e
 
·r£_·ck‘
 {

84 
Œªs™iÚ
 
·r£_‘h”Ãt
;

87 
¡©e
 
·r£_‘h”Ãt
 {

88 
pkt
.
	`exŒaù
(
hdr
.
‘h”Ãt
);

89 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
‘h”Ãt
.
‘h”_ty³
, 
ig_šŒ_md
.
šg»ss_pÜt
) {

90 (
ETHERTYPE_IPV4
, 
_
è: 
·r£_v4
;

91 (
ETHERTYPE_ARP
, 
_
è: 
·r£_¬p
;

92 (
ETHERTYPE_IPV6
, 
_
è: 
·r£_v6
;

93 (
ETHERTYPE_VLAN
, 
_
è: 
·r£_vÏn
;

94 (
ETHERTYPE_QINQ
, 
_
è: 
·r£_vÏn
;

95 (
ETHERTYPE_FCOE
, 
_
è: 
·r£_fcÛ
;

96 
ıu_pÜt
 : 
·r£_ıu
;

97  : 
acû±
;

101 
¡©e
 
·r£_ıu
 {

102 
pkt
.
	`exŒaù
(
hdr
.
çbric
);

103 
pkt
.
	`exŒaù
(
hdr
.
ıu
);

104 
ig_md
.
by·ss
 = 
hdr
.
ıu
.
»asÚ_code
;

105 
ig_md
.
æags
.
ÿ±u»_ts
 = (
boŞ
è
hdr
.
ıu
.capture_ts;

106 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
ıu
.
‘h”_ty³
) {

107 
ETHERTYPE_IPV4
 : 
·r£_v4
;

108 
ETHERTYPE_IPV6
 : 
·r£_v6
;

109 
ETHERTYPE_VLAN
 : 
·r£_vÏn
;

110 
ETHERTYPE_QINQ
 : 
·r£_vÏn
;

111  : 
acû±
;

115 
¡©e
 
·r£_v4
 {

116 
pkt
.
	`exŒaù
(
hdr
.
v4
);

117 
v4_checksum
.
	`add
(
hdr
.
v4
);

118 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
v4
.
ihl
) {

119 5 : 
·r£_v4_no_İtiÚs
;

120 6 : 
·r£_v4_İtiÚs
;

121  : 
acû±
;

125 
¡©e
 
·r£_v4_İtiÚs
 {

127 
pkt
.
	`exŒaù
(
hdr
.
v4_İtiÚ
);

128 
v4_checksum
.
	`add
(
hdr
.
v4_İtiÚ
);

129 
Œªs™iÚ
 
·r£_v4_no_İtiÚs
;

132 
¡©e
 
·r£_v4_no_İtiÚs
 {

133 
ig_md
.
æags
.
v4_checksum_”r
 = 
v4_checksum
.
	`v”ify
();

134 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
v4
.
´ÙocŞ
, hdr.v4.
äag_off£t
) {

135 (
IP_PROTOCOLS_ICMP
, 0è: 
·r£_icmp
;

136 (
IP_PROTOCOLS_IGMP
, 0è: 
·r£_igmp
;

137 (
IP_PROTOCOLS_TCP
, 0è: 
·r£_tı
;

138 (
IP_PROTOCOLS_UDP
, 0è: 
·r£_udp
;

139 (
IP_PROTOCOLS_IPV4
, 0è: 
·r£_š
;

140 (
IP_PROTOCOLS_IPV6
, 0è: 
·r£_v6š
;

142  : 
acû±
;

146 
¡©e
 
·r£_¬p
 {

147 
pkt
.
	`exŒaù
(
hdr
.
¬p
);

148 
Œªs™iÚ
 
acû±
;

151 
¡©e
 
·r£_vÏn
 {

152 
pkt
.
	`exŒaù
(
hdr
.
vÏn_g
.
Ãxt
);

153 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
vÏn_g
.
Ï¡
.
‘h”_ty³
) {

154 
ETHERTYPE_ARP
 : 
·r£_¬p
;

155 
ETHERTYPE_IPV4
 : 
·r£_v4
;

156 
ETHERTYPE_VLAN
 : 
·r£_vÏn
;

157 
ETHERTYPE_IPV6
 : 
·r£_v6
;

158  : 
acû±
;

162 
¡©e
 
·r£_v6
 {

163 #ifdeà
IPV6_ENABLE


164 
pkt
.
	`exŒaù
(
hdr
.
v6
);

165 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
v6
.
Ãxt_hdr
) {

166 
IP_PROTOCOLS_ICMPV6
 : 
·r£_icmp
;

167 
IP_PROTOCOLS_TCP
 : 
·r£_tı
;

168 
IP_PROTOCOLS_UDP
 : 
·r£_udp
;

169 
IP_PROTOCOLS_IPV4
 : 
·r£_š
;

170 
IP_PROTOCOLS_IPV6
 : 
·r£_v6š
;

171  : 
acû±
;

174 
Œªs™iÚ
 
acû±
;

178 
¡©e
 
·r£_udp
 {

179 
pkt
.
	`exŒaù
(
hdr
.
udp
);

180 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
udp
.
d¡_pÜt
) {

181 
udp_pÜt_vxÏn
 : 
·r£_vxÏn
;

182 
UDP_PORT_ROCEV2
 : 
·r£_roûv2
;

183  : 
acû±
;

187 
¡©e
 
·r£_tı
 {

188 
pkt
.
	`exŒaù
(
hdr
.
tı
);

189 
Œªs™iÚ
 
acû±
;

192 
¡©e
 
·r£_icmp
 {

193 
pkt
.
	`exŒaù
(
hdr
.
icmp
);

194 
Œªs™iÚ
 
acû±
;

197 
¡©e
 
·r£_igmp
 {

198 
pkt
.
	`exŒaù
(
hdr
.
igmp
);

199 
Œªs™iÚ
 
acû±
;

202 
¡©e
 
·r£_roûv2
 {

203 #ifdeà
ROCEV2_ACL_ENABLE


204 
pkt
.
	`exŒaù
(
hdr
.
roûv2_bth
);

206 
Œªs™iÚ
 
acû±
;

210 
¡©e
 
·r£_fcÛ
 {

211 #ifdeà
FCOE_ACL_ENABLE


212 
pkt
.
	`exŒaù
(
hdr
.
fcÛ_fc
);

214 
Œªs™iÚ
 
acû±
;

218 
¡©e
 
·r£_vxÏn
 {

219 #ifdeà
VXLAN_ENABLE


220 
pkt
.
	`exŒaù
(
hdr
.
vxÏn
);

221 
ig_md
.
tuÂ–
.
ty³
 = 
SWITCH_TUNNEL_TYPE_VXLAN
;

222 
ig_md
.
tuÂ–
.
id
 = 
hdr
.
vxÏn
.
vni
;

223 
Œªs™iÚ
 
·r£_šÃr_‘h”Ãt
;

225 
Œªs™iÚ
 
acû±
;

229 
¡©e
 
·r£_š
 {

230 #ifdeà
IPINIP_ENABLE


231 
ig_md
.
tuÂ–
.
ty³
 = 
SWITCH_TUNNEL_TYPE_IPINIP
;

232 
Œªs™iÚ
 
·r£_šÃr_v4
;

234 
Œªs™iÚ
 
acû±
;

238 
¡©e
 
·r£_v6š
 {

239 #ià
	`defšed
(
IPINIP_ENABLE
è&& defšed(
IPV6_TUNNEL_ENABLE
)

240 
ig_md
.
tuÂ–
.
ty³
 = 
SWITCH_TUNNEL_TYPE_IPINIP
;

241 
Œªs™iÚ
 
·r£_šÃr_v6
;

243 
Œªs™iÚ
 
acû±
;

247 
¡©e
 
·r£_šÃr_‘h”Ãt
 {

248 
pkt
.
	`exŒaù
(
hdr
.
šÃr_‘h”Ãt
);

249 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
šÃr_‘h”Ãt
.
‘h”_ty³
) {

250 
ETHERTYPE_IPV4
 : 
·r£_šÃr_v4
;

251 
ETHERTYPE_IPV6
 : 
·r£_šÃr_v6
;

252  : 
acû±
;

256 
¡©e
 
·r£_šÃr_v4
 {

257 
pkt
.
	`exŒaù
(
hdr
.
šÃr_v4
);

258 
šÃr_v4_checksum
.
	`add
(
hdr
.
šÃr_v4
);

259 
ig_md
.
æags
.
šÃr_v4_checksum_”r
 = 
šÃr_v4_checksum
.
	`v”ify
();

260 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
šÃr_v4
.
´ÙocŞ
) {

261 
IP_PROTOCOLS_ICMP
 : 
·r£_šÃr_icmp
;

262 
IP_PROTOCOLS_TCP
 : 
·r£_šÃr_tı
;

263 
IP_PROTOCOLS_UDP
 : 
·r£_šÃr_udp
;

264  : 
acû±
;

268 
¡©e
 
·r£_šÃr_v6
 {

269 #ifdeà
IPV6_TUNNEL_ENABLE


270 
pkt
.
	`exŒaù
(
hdr
.
šÃr_v6
);

271 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
šÃr_v6
.
Ãxt_hdr
) {

272 
IP_PROTOCOLS_ICMPV6
 : 
·r£_šÃr_icmp
;

273 
IP_PROTOCOLS_TCP
 : 
·r£_šÃr_tı
;

274 
IP_PROTOCOLS_UDP
 : 
·r£_šÃr_udp
;

275  : 
acû±
;

278 
Œªs™iÚ
 
acû±
;

282 
¡©e
 
·r£_šÃr_udp
 {

283 
pkt
.
	`exŒaù
(
hdr
.
šÃr_udp
);

284 
Œªs™iÚ
 
acû±
;

287 
¡©e
 
·r£_šÃr_tı
 {

288 
pkt
.
	`exŒaù
(
hdr
.
šÃr_tı
);

289 
Œªs™iÚ
 
acû±
;

292 
¡©e
 
·r£_šÃr_icmp
 {

293 
pkt
.
	`exŒaù
(
hdr
.
šÃr_icmp
);

294 
Œªs™iÚ
 
acû±
;

297 
	}
}

302 
·r£r
 
	$Sw™chEg»ssP¬£r
(

303 
·ck‘_š
 
pkt
,

304 
out
 
sw™ch_h—d”_t
 
hdr
,

305 
out
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

306 
out
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
) {

308 
v®ue_£t
<
b™
<16>>(1è
udp_pÜt_vxÏn
;

309 
v®ue_£t
<
sw™ch_ıu_pÜt_v®ue_£t_t
>(1è
ıu_pÜt
;

311 @
ü™iÿl


312 
¡©e
 
¡¬t
 {

313 
pkt
.
	`exŒaù
(
eg_šŒ_md
);

314 
eg_md
.
pkt_Ëngth
 = 
eg_šŒ_md
.pkt_length;

315 
eg_md
.
pÜt
 = 
eg_šŒ_md
.
eg»ss_pÜt
;

316 
eg_md
.
qos
.
qd•th
 = 
eg_šŒ_md
.
’q_qd•th
;

318 #ifdeà
MIRROR_ENABLE


319 
sw™ch_pÜt_mœrÜ_m‘ad©a_h
 
mœrÜ_md
 = 
pkt
.
lookah—d
<switch_port_mirror_metadata_h>();

320 
Œªs™iÚ
 
	`£Ëù
(
eg_šŒ_md
.
deæeùiÚ_æag
, 
mœrÜ_md
.
¤c
, mœrÜ_md.
ty³
) {

321 (1, 
_
, _è: 
·r£_deæeùed_pkt
;

322 (
_
, 
SWITCH_PKT_SRC_BRIDGED
, _è: 
·r£_bridged_pkt
;

323 (
_
, _, 
SWITCH_MIRROR_TYPE_PORT
è: 
·r£_pÜt_mœrÜed_m‘ad©a
;

324 (
_
, 
SWITCH_PKT_SRC_CLONED_EGRESS
, 
SWITCH_MIRROR_TYPE_CPU
è: 
·r£_ıu_mœrÜed_m‘ad©a
;

325 (
_
, _, 
SWITCH_MIRROR_TYPE_DTEL_DROP
è: 
·r£_d‹l_drİ_m‘ad©a
;

326 (
_
, _, 
SWITCH_MIRROR_TYPE_DTEL_SWITCH_LOCAL
è: 
·r£_d‹l_sw™ch_loÿl_m‘ad©a
;

329 
Œªs™iÚ
 
·r£_bridged_pkt
;

333 
¡©e
 
·r£_bridged_pkt
 {

334 
pkt
.
	`exŒaù
(
hdr
.
bridged_md
);

335 
eg_md
.
pkt_¤c
 = 
SWITCH_PKT_SRC_BRIDGED
;

336 
eg_md
.
šg»ss_pÜt
 = 
hdr
.
bridged_md
.
ba£
.ingress_port;

337 
eg_md
.
šg»ss_ifšdex
 = 
hdr
.
bridged_md
.
ba£
.ingress_ifindex;

338 
eg_md
.
bd
 = 
hdr
.
bridged_md
.
ba£
.
šg»ss_bd
;

339 
eg_md
.
Ãxthİ
 = 
hdr
.
bridged_md
.
ba£
.nexthop;

340 
eg_md
.
ıu_»asÚ
 = 
hdr
.
bridged_md
.
ba£
.cpu_reason;

341 
eg_md
.
æags
.
rou‹d
 = 
hdr
.
bridged_md
.
ba£
.routed;

342 
eg_md
.
æags
.
³”_lšk
 = 
hdr
.
bridged_md
.
ba£
.peer_link;

344 
eg_md
.
pkt_ty³
 = 
hdr
.
bridged_md
.
ba£
.pkt_type;

345 
eg_md
.
šg»ss_time¡amp
 = 
hdr
.
bridged_md
.
ba£
.
time¡amp
;

346 
eg_md
.
qos
.
tc
 = 
hdr
.
bridged_md
.
ba£
.tc;

347 
eg_md
.
qos
.
qid
 = 
hdr
.
bridged_md
.
ba£
.qid;

348 
eg_md
.
qos
.
cŞÜ
 = 
hdr
.
bridged_md
.
ba£
.color;

350 #ià
	`defšed
(
EGRESS_IP_ACL_ENABLE
è|| defšed(
EGRESS_MIRROR_ACL_ENABLE
)

351 
eg_md
.
l4_pÜt_Ïb–
 = 
hdr
.
bridged_md
.
aş
.l4_port_label;

352 
eg_md
.
lkp
.
l4_¤c_pÜt
 = 
hdr
.
bridged_md
.
aş
.l4_src_port;

353 
eg_md
.
lkp
.
l4_d¡_pÜt
 = 
hdr
.
bridged_md
.
aş
.l4_dst_port;

354 
eg_md
.
lkp
.
tı_æags
 = 
hdr
.
bridged_md
.
aş
.tcp_flags;

356 #ifdeà
TUNNEL_ENABLE


357 
eg_md
.
ou‹r_Ãxthİ
 = 
hdr
.
bridged_md
.
tuÂ–
.outer_nexthop;

358 
eg_md
.
tuÂ–
.
šdex
 = 
hdr
.
bridged_md
.tunnel.index;

359 
eg_md
.
tuÂ–
.
hash
 = 
hdr
.
bridged_md
.tunnel.hash;

360 
eg_md
.
vrf
 = 
hdr
.
bridged_md
.
tuÂ–
.vrf;

361 
eg_md
.
tuÂ–
.
‹rmš©e
 = 
hdr
.
bridged_md
.tunnel.terminate;

363 #ifdeà
DTEL_ENABLE


364 
eg_md
.
d‹l
.
»pÜt_ty³
 = 
hdr
.
bridged_md
.dtel.report_type;

365 
eg_md
.
d‹l
.
hash
 = 
hdr
.
bridged_md
.dtel.hash;

366 
eg_md
.
d‹l
.
£ssiÚ_id
 = 
hdr
.
bridged_md
.dtel.session_id;

369 
Œªs™iÚ
 
·r£_‘h”Ãt
;

372 
¡©e
 
·r£_deæeùed_pkt
 {

373 #ifdeà
DTEL_ENABLE


374 
pkt
.
	`exŒaù
(
hdr
.
bridged_md
);

375 
eg_md
.
pkt_¤c
 = 
SWITCH_PKT_SRC_DEFLECTED
;

376 
eg_md
.
d‹l
.
»pÜt_ty³
 = 
hdr
.
bridged_md
.dtel.report_type;

377 
eg_md
.
d‹l
.
hash
 = 
hdr
.
bridged_md
.dtel.hash;

379 
eg_md
.
d‹l
.
£ssiÚ_id
 = 0;

380 
eg_md
.
mœrÜ
.
£ssiÚ_id
 = 
hdr
.
bridged_md
.
d‹l
.session_id;

381 
eg_md
.
šg»ss_time¡amp
 = 
hdr
.
bridged_md
.
ba£
.
time¡amp
;

382 
eg_md
.
qos
.
qid
 = 
hdr
.
bridged_md
.
ba£
.qid;

383 
hdr
.
d‹l_drİ_»pÜt
 = {

385 
hdr
.
bridged_md
.
ba£
.
šg»ss_pÜt
,

387 
hdr
.
bridged_md
.
d‹l
.
eg»ss_pÜt
,

389 
hdr
.
bridged_md
.
ba£
.
qid
,

390 
SWITCH_DROP_REASON_TRAFFIC_MANAGER
,

392 
Œªs™iÚ
 
acû±
;

396 
¡©e
 
·r£_pÜt_mœrÜed_m‘ad©a
 {

397 
sw™ch_pÜt_mœrÜ_m‘ad©a_h
 
pÜt_md
;

398 
pkt
.
	`exŒaù
(
pÜt_md
);

399 
pkt
.
	`exŒaù
(
hdr
.
‘h”Ãt
);

400 
eg_md
.
pkt_¤c
 = 
pÜt_md
.
¤c
;

401 
eg_md
.
mœrÜ
.
£ssiÚ_id
 = 
pÜt_md
.session_id;

402 
eg_md
.
šg»ss_time¡amp
 = 
pÜt_md
.
time¡amp
;

403 
eg_md
.
by·ss
 = ~
SWITCH_EGRESS_BYPASS_MTU
;

404 #ifdeà
PACKET_LENGTH_ADJUSTMENT


405 
eg_md
.
mœrÜ
.
ty³
 = 
pÜt_md
.type;

407 #ifdeà
DTEL_ENABLE


409 
eg_md
.
d‹l
.
£ssiÚ_id
 = 0;

411 
Œªs™iÚ
 
acû±
;

414 
¡©e
 
·r£_ıu_mœrÜed_m‘ad©a
 {

415 
sw™ch_ıu_mœrÜ_m‘ad©a_h
 
ıu_md
;

416 
pkt
.
	`exŒaù
(
ıu_md
);

417 
pkt
.
	`exŒaù
(
hdr
.
‘h”Ãt
);

418 
eg_md
.
pkt_¤c
 = 
ıu_md
.
¤c
;

419 
eg_md
.
by·ss
 = ~
SWITCH_EGRESS_BYPASS_MTU
;

420 
eg_md
.
bd
 = 
ıu_md
.bd;

423 
eg_md
.
ıu_»asÚ
 = 
ıu_md
.
»asÚ_code
;

424 #ifdeà
PACKET_LENGTH_ADJUSTMENT


425 
eg_md
.
mœrÜ
.
ty³
 = 
ıu_md
.type;

427 #ifdeà
DTEL_ENABLE


429 
eg_md
.
d‹l
.
£ssiÚ_id
 = 0;

431 
Œªs™iÚ
 
acû±
;

434 
¡©e
 
·r£_d‹l_drİ_m‘ad©a
 {

435 #ifdeà
DTEL_ENABLE


436 
sw™ch_d‹l_drİ_mœrÜ_m‘ad©a_h
 
d‹l_md
;

437 
pkt
.
	`exŒaù
(
d‹l_md
);

438 
eg_md
.
pkt_¤c
 = 
d‹l_md
.
¤c
;

439 
eg_md
.
mœrÜ
.
ty³
 = 
d‹l_md
.type;

440 
eg_md
.
d‹l
.
»pÜt_ty³
 = 
d‹l_md
.report_type;

441 
eg_md
.
d‹l
.
hash
 = 
d‹l_md
.hash;

443 
eg_md
.
d‹l
.
£ssiÚ_id
 = 0;

444 
eg_md
.
mœrÜ
.
£ssiÚ_id
 = 
d‹l_md
.session_id;

445 
eg_md
.
šg»ss_time¡amp
 = 
d‹l_md
.
time¡amp
;

446 
hdr
.
d‹l_drİ_»pÜt
 = {

448 
d‹l_md
.
šg»ss_pÜt
,

450 
SWITCH_PORT_INVALID
,

452 
d‹l_md
.
qid
,

453 
d‹l_md
.
drİ_»asÚ
,

455 
Œªs™iÚ
 
acû±
;

457 
Œªs™iÚ
 
»jeù
;

461 
¡©e
 
·r£_d‹l_sw™ch_loÿl_m‘ad©a
 {

462 #ifdeà
DTEL_ENABLE


463 
sw™ch_d‹l_sw™ch_loÿl_mœrÜ_m‘ad©a_h
 
d‹l_md
;

464 
pkt
.
	`exŒaù
(
d‹l_md
);

465 
eg_md
.
pkt_¤c
 = 
d‹l_md
.
¤c
;

466 
eg_md
.
mœrÜ
.
ty³
 = 
d‹l_md
.type;

467 
eg_md
.
d‹l
.
»pÜt_ty³
 = 
d‹l_md
.report_type;

468 
eg_md
.
d‹l
.
hash
 = 
d‹l_md
.hash;

470 
eg_md
.
d‹l
.
£ssiÚ_id
 = 0;

471 
eg_md
.
mœrÜ
.
£ssiÚ_id
 = 
d‹l_md
.session_id;

472 
eg_md
.
šg»ss_time¡amp
 = 
d‹l_md
.
time¡amp
;

473 
hdr
.
d‹l_sw™ch_loÿl_»pÜt
 = {

475 
d‹l_md
.
šg»ss_pÜt
,

477 
d‹l_md
.
eg»ss_pÜt
,

479 
d‹l_md
.
qid
,

481 
d‹l_md
.
qd•th
,

482 
d‹l_md
.
eg»ss_time¡amp
};

483 
Œªs™iÚ
 
acû±
;

485 
Œªs™iÚ
 
»jeù
;

490 
¡©e
 
·r£_·ck‘
 {

491 
Œªs™iÚ
 
·r£_‘h”Ãt
;

494 
¡©e
 
·r£_‘h”Ãt
 {

495 
pkt
.
	`exŒaù
(
hdr
.
‘h”Ãt
);

496 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
‘h”Ãt
.
‘h”_ty³
, 
eg_šŒ_md
.
eg»ss_pÜt
) {

497 
ıu_pÜt
 : 
·r£_ıu
;

498 (
ETHERTYPE_IPV4
, 
_
è: 
·r£_v4
;

499 (
ETHERTYPE_IPV6
, 
_
è: 
·r£_v6
;

500 (
ETHERTYPE_VLAN
, 
_
è: 
·r£_vÏn
;

501 (
ETHERTYPE_QINQ
, 
_
è: 
·r£_vÏn
;

502  : 
acû±
;

506 
¡©e
 
·r£_ıu
 {

507 
eg_md
.
by·ss
 = 
SWITCH_EGRESS_BYPASS_ALL
;

508 
Œªs™iÚ
 
acû±
;

511 
¡©e
 
·r£_v4
 {

512 
pkt
.
	`exŒaù
(
hdr
.
v4
);

513 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
v4
.
´ÙocŞ
, hdr.v4.
ihl
, hdr.v4.
äag_off£t
) {

514 #ifdeà
TUNNEL_ENABLE


515 (
IP_PROTOCOLS_UDP
, 5, 0è: 
·r£_udp
;

516 #ifdeà
IPINIP_ENABLE


517 (
IP_PROTOCOLS_IPV4
, 5, 0è: 
·r£_šÃr_v4
;

518 (
IP_PROTOCOLS_IPV6
, 5, 0è: 
·r£_šÃr_v6
;

521 (
_
, 6, _è: 
·r£_v4_İtiÚs
;

522  : 
acû±
;

526 
¡©e
 
·r£_v4_İtiÚs
 {

527 
pkt
.
	`exŒaù
(
hdr
.
v4_İtiÚ
);

528 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
v4
.
´ÙocŞ
, hdr.v4.
äag_off£t
) {

529 #ifdeà
TUNNEL_ENABLE


530 (
IP_PROTOCOLS_UDP
, 0è: 
·r£_udp
;

531 #ifdeà
IPINIP_ENABLE


532 (
IP_PROTOCOLS_IPV4
, 0è: 
·r£_šÃr_v4
;

533 (
IP_PROTOCOLS_IPV6
, 0è: 
·r£_šÃr_v6
;

536  : 
acû±
;

540 
¡©e
 
·r£_vÏn
 {

541 
pkt
.
	`exŒaù
(
hdr
.
vÏn_g
.
Ãxt
);

542 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
vÏn_g
.
Ï¡
.
‘h”_ty³
) {

543 
ETHERTYPE_IPV4
 : 
·r£_v4
;

544 
ETHERTYPE_VLAN
 : 
·r£_vÏn
;

545 
ETHERTYPE_IPV6
 : 
·r£_v6
;

546  : 
acû±
;

550 
¡©e
 
·r£_v6
 {

551 #ifdeà
IPV6_ENABLE


552 
pkt
.
	`exŒaù
(
hdr
.
v6
);

553 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
v6
.
Ãxt_hdr
) {

554 #ifdeà
IPV6_TUNNEL_ENABLE


556 
IP_PROTOCOLS_UDP
 : 
·r£_udp
;

557 #ifdeà
IPINIP_ENABLE


558 
IP_PROTOCOLS_IPV4
 : 
·r£_šÃr_v4
;

559 
IP_PROTOCOLS_IPV6
 : 
·r£_šÃr_v6
;

562  : 
acû±
;

565 
Œªs™iÚ
 
acû±
;

569 
¡©e
 
·r£_udp
 {

570 
pkt
.
	`exŒaù
(
hdr
.
udp
);

571 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
udp
.
d¡_pÜt
) {

572 
udp_pÜt_vxÏn
 : 
·r£_vxÏn
;

573  : 
acû±
;

577 
¡©e
 
·r£_tı
 {

578 
pkt
.
	`exŒaù
(
hdr
.
tı
);

579 
Œªs™iÚ
 
acû±
;

582 
¡©e
 
·r£_vxÏn
 {

583 #ifdeà
VXLAN_ENABLE


584 
pkt
.
	`exŒaù
(
hdr
.
vxÏn
);

585 
Œªs™iÚ
 
·r£_šÃr_‘h”Ãt
;

587 
Œªs™iÚ
 
acû±
;

591 
¡©e
 
·r£_šÃr_‘h”Ãt
 {

592 
pkt
.
	`exŒaù
(
hdr
.
šÃr_‘h”Ãt
);

593 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
šÃr_‘h”Ãt
.
‘h”_ty³
) {

594 
ETHERTYPE_IPV4
 : 
·r£_šÃr_v4
;

595 
ETHERTYPE_IPV6
 : 
·r£_šÃr_v6
;

596  : 
acû±
;

600 
¡©e
 
·r£_šÃr_v4
 {

601 
pkt
.
	`exŒaù
(
hdr
.
šÃr_v4
);

602 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
šÃr_v4
.
´ÙocŞ
) {

604 
IP_PROTOCOLS_UDP
 : 
·r£_šÃr_udp
;

605  : 
acû±
;

609 
¡©e
 
·r£_šÃr_v6
 {

610 #ifdeà
IPV6_TUNNEL_ENABLE


611 
pkt
.
	`exŒaù
(
hdr
.
šÃr_v6
);

612 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
šÃr_v6
.
Ãxt_hdr
) {

614 
IP_PROTOCOLS_UDP
 : 
·r£_šÃr_udp
;

615  : 
acû±
;

618 
Œªs™iÚ
 
acû±
;

622 
¡©e
 
·r£_šÃr_udp
 {

623 
pkt
.
	`exŒaù
(
hdr
.
šÃr_udp
);

624 
Œªs™iÚ
 
acû±
;

627 
¡©e
 
·r£_šÃr_tı
 {

628 
pkt
.
	`exŒaù
(
hdr
.
šÃr_tı
);

629 
Œªs™iÚ
 
acû±
;

632 
¡©e
 
·r£_šÃr_icmp
 {

633 
pkt
.
	`exŒaù
(
hdr
.
šÃr_icmp
);

634 
Œªs™iÚ
 
acû±
;

636 
	}
}

642 
cÚŒŞ
 
	$Ing»ssMœrÜ
(

643 
šout
 
sw™ch_h—d”_t
 
hdr
,

644 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

645 
š
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
) {

648 
	`MœrÜ
(è
mœrÜ
;

650 
­¶y
 {

651 #ifdeà
MIRROR_ENABLE


652 ià(
ig_šŒ_md_fÜ_d´¤
.
mœrÜ_ty³
 =ğ
SWITCH_MIRROR_TYPE_PORT
) {

653 
mœrÜ
.
em™
<
sw™ch_pÜt_mœrÜ_m‘ad©a_h
>(

654 
ig_md
.
mœrÜ
.
£ssiÚ_id
,

655 {
ig_md
.
mœrÜ
.
¤c
,

656 
ig_md
.
mœrÜ
.
ty³
,

657 
ig_md
.
time¡amp
,

658 #ià
__TARGET_TOFINO__
 == 1

661 
ig_md
.
mœrÜ
.
£ssiÚ_id
});

663 } ià(
ig_šŒ_md_fÜ_d´¤
.
mœrÜ_ty³
 =ğ
SWITCH_MIRROR_TYPE_DTEL_DROP
) {

664 #ifdeà
DTEL_ENABLE


665 
mœrÜ
.
em™
<
sw™ch_d‹l_drİ_mœrÜ_m‘ad©a_h
>(
ig_md
.
d‹l
.
£ssiÚ_id
, {

666 
ig_md
.
mœrÜ
.
¤c
,

667 
ig_md
.
mœrÜ
.
ty³
,

668 
ig_md
.
time¡amp
,

669 #ià
__TARGET_TOFINO__
 == 1

672 
ig_md
.
d‹l
.
£ssiÚ_id
,

673 
ig_md
.
hash
,

675 
ig_md
.
d‹l
.
»pÜt_ty³
,

677 
ig_md
.
pÜt
,

679 
ig_md
.
eg»ss_pÜt
,

681 
ig_md
.
qos
.
qid
,

682 
ig_md
.
drİ_»asÚ


689 
	}
}

691 
cÚŒŞ
 
	$Eg»ssMœrÜ
(

692 
šout
 
sw™ch_h—d”_t
 
hdr
,

693 
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

694 
š
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
) {

696 
	`MœrÜ
(è
mœrÜ
;

698 
­¶y
 {

699 #ifdeà
MIRROR_ENABLE


700 ià(
eg_šŒ_md_fÜ_d´¤
.
mœrÜ_ty³
 =ğ
SWITCH_MIRROR_TYPE_PORT
) {

701 
mœrÜ
.
em™
<
sw™ch_pÜt_mœrÜ_m‘ad©a_h
>(
eg_md
.mœrÜ.
£ssiÚ_id
, {

702 
eg_md
.
mœrÜ
.
¤c
,

703 
eg_md
.
mœrÜ
.
ty³
,

704 
eg_md
.
šg»ss_time¡amp
,

705 #ià
__TARGET_TOFINO__
 == 1

708 
eg_md
.
mœrÜ
.
£ssiÚ_id
});

709 } ià(
eg_šŒ_md_fÜ_d´¤
.
mœrÜ_ty³
 =ğ
SWITCH_MIRROR_TYPE_CPU
) {

710 
mœrÜ
.
em™
<
sw™ch_ıu_mœrÜ_m‘ad©a_h
>(
eg_md
.mœrÜ.
£ssiÚ_id
, {

711 
eg_md
.
mœrÜ
.
¤c
,

712 
eg_md
.
mœrÜ
.
ty³
,

714 
eg_md
.
šg»ss_pÜt
,

715 
eg_md
.
bd
,

716 
eg_md
.
šg»ss_ifšdex
,

717 
eg_md
.
ıu_»asÚ
});

718 } ià(
eg_šŒ_md_fÜ_d´¤
.
mœrÜ_ty³
 =ğ
SWITCH_MIRROR_TYPE_DTEL_SWITCH_LOCAL
) {

719 #ifdeà
DTEL_ENABLE


720 
mœrÜ
.
em™
<
sw™ch_d‹l_sw™ch_loÿl_mœrÜ_m‘ad©a_h
>(
eg_md
.
d‹l
.
£ssiÚ_id
, {

721 
eg_md
.
mœrÜ
.
¤c
,ƒg_md.mœrÜ.
ty³
,

722 
eg_md
.
šg»ss_time¡amp
,

723 #ià
__TARGET_TOFINO__
 == 1

726 
eg_md
.
d‹l
.
£ssiÚ_id
,

727 
eg_md
.
d‹l
.
hash
,

729 
eg_md
.
d‹l
.
»pÜt_ty³
,

731 
eg_md
.
šg»ss_pÜt
,

733 
eg_md
.
pÜt
,

735 
eg_md
.
qos
.
qid
,

737 
eg_md
.
qos
.
qd•th
,

738 
eg_md
.
time¡amp
[31:0]

744 
	}
}

749 
cÚŒŞ
 
	$Sw™chIng»ssD•¬£r
(

750 
·ck‘_out
 
pkt
,

751 
šout
 
sw™ch_h—d”_t
 
hdr
,

752 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

753 
š
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
) {

755 
	`Ing»ssMœrÜ
(è
mœrÜ
;

756 
Dige¡
<
sw™ch_Ë¬nšg_dige¡_t
>(è
dige¡
;

758 
­¶y
 {

759 
mœrÜ
.
	`­¶y
(
hdr
, 
ig_md
, 
ig_šŒ_md_fÜ_d´¤
);

761 ià(
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
 =ğ
SWITCH_DIGEST_TYPE_MAC_LEARNING
) {

762 
dige¡
.
	`·ck
({
ig_md
.
bd
, ig_md.
ifšdex
, ig_md.
lkp
.
mac_¤c_addr
});

765 
pkt
.
	`em™
(
hdr
.
bridged_md
);

766 
pkt
.
	`em™
(
hdr
.
‘h”Ãt
);

767 
pkt
.
	`em™
(
hdr
.
vÏn_g
);

768 
pkt
.
	`em™
(
hdr
.
¬p
);

769 
pkt
.
	`em™
(
hdr
.
v4
);

770 
pkt
.
	`em™
(
hdr
.
v4_İtiÚ
);

771 
pkt
.
	`em™
(
hdr
.
v6
);

772 
pkt
.
	`em™
(
hdr
.
udp
);

773 
pkt
.
	`em™
(
hdr
.
tı
);

774 
pkt
.
	`em™
(
hdr
.
icmp
);

775 
pkt
.
	`em™
(
hdr
.
igmp
);

776 
pkt
.
	`em™
(
hdr
.
roûv2_bth
);

777 
pkt
.
	`em™
(
hdr
.
vxÏn
);

778 
pkt
.
	`em™
(
hdr
.
šÃr_‘h”Ãt
);

779 
pkt
.
	`em™
(
hdr
.
šÃr_v4
);

780 
pkt
.
	`em™
(
hdr
.
šÃr_v6
);

781 
pkt
.
	`em™
(
hdr
.
šÃr_udp
);

782 
pkt
.
	`em™
(
hdr
.
šÃr_tı
);

783 
pkt
.
	`em™
(
hdr
.
šÃr_icmp
);

785 
	}
}

791 
cÚŒŞ
 
	$Sw™chEg»ssD•¬£r
(

792 
·ck‘_out
 
pkt
,

793 
šout
 
sw™ch_h—d”_t
 
hdr
,

794 
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

795 
š
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
) {

797 
	`Eg»ssMœrÜ
(è
mœrÜ
;

798 
	`Checksum
(è
v4_checksum
;

799 
	`Checksum
(è
šÃr_v4_checksum
;

801 
­¶y
 {

802 
mœrÜ
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md_fÜ_d´¤
);

804 ià(
hdr
.
v4_İtiÚ
.
	`isV®id
()) {

805 
hdr
.
v4
.
hdr_checksum
 = 
v4_checksum
.
	`upd©e
({

806 
hdr
.
v4
.
v”siÚ
,

807 
hdr
.
v4
.
ihl
,

808 
hdr
.
v4
.
diff£rv
,

809 
hdr
.
v4
.
tÙ®_Ën
,

810 
hdr
.
v4
.
id’tifiÿtiÚ
,

811 
hdr
.
v4
.
æags
,

812 
hdr
.
v4
.
äag_off£t
,

813 
hdr
.
v4
.
‰l
,

814 
hdr
.
v4
.
´ÙocŞ
,

815 
hdr
.
v4
.
¤c_addr
,

816 
hdr
.
v4
.
d¡_addr
,

817 
hdr
.
v4_İtiÚ
.
ty³
,

818 
hdr
.
v4_İtiÚ
.
Ëngth
,

819 
hdr
.
v4_İtiÚ
.
v®ue
});

820 } ià(
hdr
.
v4
.
	`isV®id
()) {

821 
hdr
.
v4
.
hdr_checksum
 = 
v4_checksum
.
	`upd©e
({

822 
hdr
.
v4
.
v”siÚ
,

823 
hdr
.
v4
.
ihl
,

824 
hdr
.
v4
.
diff£rv
,

825 
hdr
.
v4
.
tÙ®_Ën
,

826 
hdr
.
v4
.
id’tifiÿtiÚ
,

827 
hdr
.
v4
.
æags
,

828 
hdr
.
v4
.
äag_off£t
,

829 
hdr
.
v4
.
‰l
,

830 
hdr
.
v4
.
´ÙocŞ
,

831 
hdr
.
v4
.
¤c_addr
,

832 
hdr
.
v4
.
d¡_addr
});

835 #ifdeà
TUNNEL_ENABLE


836 
hdr
.
šÃr_v4
.
hdr_checksum
 = 
šÃr_v4_checksum
.
	`upd©e
({

837 
hdr
.
šÃr_v4
.
v”siÚ
,

838 
hdr
.
šÃr_v4
.
ihl
,

839 
hdr
.
šÃr_v4
.
diff£rv
,

840 
hdr
.
šÃr_v4
.
tÙ®_Ën
,

841 
hdr
.
šÃr_v4
.
id’tifiÿtiÚ
,

842 
hdr
.
šÃr_v4
.
æags
,

843 
hdr
.
šÃr_v4
.
äag_off£t
,

844 
hdr
.
šÃr_v4
.
‰l
,

845 
hdr
.
šÃr_v4
.
´ÙocŞ
,

846 
hdr
.
šÃr_v4
.
¤c_addr
,

847 
hdr
.
šÃr_v4
.
d¡_addr
});

850 
pkt
.
	`em™
(
hdr
.
‘h”Ãt
);

851 
pkt
.
	`em™
(
hdr
.
çbric
);

852 
pkt
.
	`em™
(
hdr
.
ıu
);

853 
pkt
.
	`em™
(
hdr
.
time¡amp
);

854 
pkt
.
	`em™
(
hdr
.
vÏn_g
);

855 
pkt
.
	`em™
(
hdr
.
v4
);

856 
pkt
.
	`em™
(
hdr
.
v6
);

857 
pkt
.
	`em™
(
hdr
.
udp
);

858 
pkt
.
	`em™
(
hdr
.
d‹l
);

859 
pkt
.
	`em™
(
hdr
.
d‹l_sw™ch_loÿl_»pÜt
);

860 
pkt
.
	`em™
(
hdr
.
d‹l_drİ_»pÜt
);

861 
pkt
.
	`em™
(
hdr
.
vxÏn
);

862 
pkt
.
	`em™
(
hdr
.
g»
);

863 
pkt
.
	`em™
(
hdr
.
”¥ª_ty³2
);

864 
pkt
.
	`em™
(
hdr
.
”¥ª_ty³3
);

865 
pkt
.
	`em™
(
hdr
.
”¥ª_¶©fÜm
);

866 
pkt
.
	`em™
(
hdr
.
šÃr_‘h”Ãt
);

867 
pkt
.
	`em™
(
hdr
.
šÃr_v4
);

868 
pkt
.
	`em™
(
hdr
.
šÃr_v6
);

869 
pkt
.
	`em™
(
hdr
.
šÃr_udp
);

871 
	}
}

	@shared/port.p4

23 
	~"»wr™e.p4
"

28 
cÚŒŞ
 
	$PÜtMœrÜ
(

29 
š
 
sw™ch_pÜt_t
 
pÜt
,

30 
š
 
sw™ch_pkt_¤c_t
 
¤c
,

31 
šout
 
sw™ch_mœrÜ_m‘ad©a_t
 
mœrÜ_md
)(

32 
sw™ch_ušt32_t
 
bË_size
=288) {

34 
aùiÚ
 
	`£t_mœrÜ_id
(
sw™ch_mœrÜ_£ssiÚ_t
 
£ssiÚ_id
) {

35 
mœrÜ_md
.
ty³
 = 
SWITCH_MIRROR_TYPE_PORT
;

36 
mœrÜ_md
.
¤c
 = src;

37 
mœrÜ_md
.
£ssiÚ_id
 = session_id;

40 
bË
 
pÜt_mœrÜ
 {

41 
key
 = { 
pÜt
 : 
exaù
; }

42 
aùiÚs
 = {

43 
NoAùiÚ
;

44 
£t_mœrÜ_id
;

47 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

48 
size
 = 
bË_size
;

51 
­¶y
 {

52 
pÜt_mœrÜ
.
	`­¶y
();

54 
	}
}

56 
cÚŒŞ
 
	$Ing»ssPÜtM­pšg
(

57 
šout
 
sw™ch_h—d”_t
 
hdr
,

58 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

59 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
,

60 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
)(

61 
sw™ch_ušt32_t
 
pÜt_vÏn_bË_size
,

62 
sw™ch_ušt32_t
 
bd_bË_size
,

63 
sw™ch_ušt32_t
 
pÜt_bË_size
=288,

64 
sw™ch_ušt32_t
 
vÏn_bË_size
=4096,

65 
sw™ch_ušt32_t
 
doubË_g_bË_size
=1024) {

67 
	`PÜtMœrÜ
(
pÜt_bË_size
è
pÜt_mœrÜ
;

68 
	`AùiÚProfe
(
bd_bË_size
è
bd_aùiÚ_´ofe
;

69 
Hash
<
b™
<32>>(
HashAlgÜ™hm_t
.
IDENTITY
è
hash
;

75 cÚ¡ 
b™
<32> 
vÏn_memb”sh_size
 = 1 << 19;

76 
Regi¡”
<
b™
<1>, b™<32>>(
vÏn_memb”sh_size
, 0è
vÏn_memb”sh
;

77 
Regi¡”AùiÚ
<
b™
<1>, b™<32>, b™<1>>(
vÏn_memb”sh
è
check_vÏn_memb”sh
 = {

78 
	`­¶y
(
šout
 
b™
<1> 
v®
, 
out
 b™<1> 
rv
) {

79 
rv
 = ~
v®
;

83 
aùiÚ
 
	`‹rmš©e_ıu_·ck‘
() {

85 
ig_md
.
pÜt
 = (
sw™ch_pÜt_t
è
hdr
.
ıu
.
šg»ss_pÜt
;

86 
ig_md
.
eg»ss_ifšdex
 =

87 (
sw™ch_ifšdex_t
è
hdr
.
çbric
.
d¡_pÜt_Ü_group
;

90 
ig_šŒ_md_fÜ_tm
.
by·ss_eg»ss
 = 
hdr
.
ıu
.
tx_by·ss
;

91 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = hdr.
ıu
.ether_type;

94 
aùiÚ
 
	`£t_ıu_pÜt_´İ”t›s
(

95 
sw™ch_pÜt_Ïg_šdex_t
 
pÜt_Ïg_šdex
,

96 
sw™ch_pÜt_Ïg_Ïb–_t
 
pÜt_Ïg_Ïb–
,

97 
sw™ch_yid_t
 
exşusiÚ_id
,

98 
sw™ch_qos_Œu¡_mode_t
 
Œu¡_mode
,

99 
sw™ch_qos_group_t
 
qos_group
,

100 
sw™ch_pkt_cŞÜ_t
 
cŞÜ
,

101 
sw™ch_tc_t
 
tc
) {

102 
ig_md
.
pÜt_Ïg_šdex
 =…ort_lag_index;

103 
ig_md
.
pÜt_Ïg_Ïb–
 =…ort_lag_label;

104 
ig_md
.
qos
.
Œu¡_mode
 =rust_mode;

105 
ig_md
.
qos
.
group
 = 
qos_group
;

106 
ig_md
.
qos
.
cŞÜ
 = color;

107 
ig_md
.
qos
.
tc
 =c;

108 
ig_šŒ_md_fÜ_tm
.
Ëv–2_exşusiÚ_id
 = 
exşusiÚ_id
;

110 
	`‹rmš©e_ıu_·ck‘
();

113 
aùiÚ
 
	`£t_pÜt_´İ”t›s
(

114 
sw™ch_yid_t
 
exşusiÚ_id
,

115 
sw™ch_Ë¬nšg_mode_t
 
Ë¬nšg_mode
,

116 
sw™ch_qos_Œu¡_mode_t
 
Œu¡_mode
,

117 
sw™ch_qos_group_t
 
qos_group
,

118 
sw™ch_pkt_cŞÜ_t
 
cŞÜ
,

119 
sw™ch_tc_t
 
tc
,

120 
boŞ
 
mac_pkt_şass
) {

121 
ig_md
.
qos
.
Œu¡_mode
 =rust_mode;

122 
ig_md
.
qos
.
group
 = 
qos_group
;

123 
ig_md
.
qos
.
cŞÜ
 = color;

124 
ig_md
.
qos
.
tc
 =c;

125 
ig_šŒ_md_fÜ_tm
.
Ëv–2_exşusiÚ_id
 = 
exşusiÚ_id
;

126 
ig_md
.
Ë¬nšg
.
pÜt_mode
 = 
Ë¬nšg_mode
;

127 
ig_md
.
checks
.
§me_if
 = 0xffff;

128 
ig_md
.
æags
.
mac_pkt_şass
 = mac_pkt_class;

131 
bË
 
pÜt_m­pšg
 {

132 
key
 = {

133 
ig_md
.
pÜt
 : 
exaù
;

134 
hdr
.
ıu
.
	`isV®id
(è: 
exaù
;

135 
hdr
.
ıu
.
šg»ss_pÜt
 : 
exaù
;

138 
aùiÚs
 = {

139 
£t_pÜt_´İ”t›s
;

140 
£t_ıu_pÜt_´İ”t›s
;

143 
size
 = 
pÜt_bË_size
 * 2;

146 
aùiÚ
 
	`pÜt_vÏn_miss
() {

150 
aùiÚ
 
	`£t_bd_´İ”t›s
(
sw™ch_bd_t
 
bd
,

151 
sw™ch_vrf_t
 
vrf
,

152 
sw™ch_bd_Ïb–_t
 
bd_Ïb–
,

153 
sw™ch_rid_t
 
rid
,

154 
sw™ch_¡p_group_t
 
¡p_group
,

155 
sw™ch_Ë¬nšg_mode_t
 
Ë¬nšg_mode
,

156 
boŞ
 
v4_uniÿ¡_’abË
,

157 
boŞ
 
v4_muÉiÿ¡_’abË
,

158 
boŞ
 
igmp_¢oİšg_’abË
,

159 
boŞ
 
v6_uniÿ¡_’abË
,

160 
boŞ
 
v6_muÉiÿ¡_’abË
,

161 
boŞ
 
mld_¢oİšg_’abË
,

162 
sw™ch_muÉiÿ¡_½f_group_t
 
m½f_group
,

163 
sw™ch_rmac_group_t
 
rmac_group
) {

164 
ig_md
.
bd
 = bd;

165 
ig_md
.
bd_Ïb–
 = bd_label;

166 
ig_md
.
vrf
 = vrf;

167 
ig_šŒ_md_fÜ_tm
.
rid
 =„id;

168 
ig_md
.
rmac_group
 =„mac_group;

169 
ig_md
.
¡p
.
group
 = 
¡p_group
;

170 
ig_md
.
muÉiÿ¡
.
½f_group
 = 
m½f_group
;

171 
ig_md
.
Ë¬nšg
.
bd_mode
 = 
Ë¬nšg_mode
;

172 
ig_md
.
v4
.
uniÿ¡_’abË
 = 
v4_uniÿ¡_’abË
;

173 
ig_md
.
v4
.
muÉiÿ¡_’abË
 = 
v4_muÉiÿ¡_’abË
;

174 
ig_md
.
v4
.
muÉiÿ¡_¢oİšg
 = 
igmp_¢oİšg_’abË
;

175 
ig_md
.
v6
.
uniÿ¡_’abË
 = 
v6_uniÿ¡_’abË
;

176 
ig_md
.
v6
.
muÉiÿ¡_’abË
 = 
v6_muÉiÿ¡_’abË
;

177 
ig_md
.
v6
.
muÉiÿ¡_¢oİšg
 = 
mld_¢oİšg_’abË
;

181 
bË
 
pÜt_doubË_g_to_bd_m­pšg
 {

182 
key
 = {

183 
ig_md
.
pÜt_Ïg_šdex
 : 
exaù
;

184 
hdr
.
vÏn_g
[0].
	`isV®id
(è: 
exaù
;

185 
hdr
.
vÏn_g
[0].
vid
 : 
exaù
;

186 
hdr
.
vÏn_g
[1].
	`isV®id
(è: 
exaù
;

187 
hdr
.
vÏn_g
[1].
vid
 : 
exaù
;

190 
aùiÚs
 = {

191 
NoAùiÚ
;

192 
pÜt_vÏn_miss
;

193 
£t_bd_´İ”t›s
;

196 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

197 
im¶em’tiÚ
 = 
bd_aùiÚ_´ofe
;

198 
size
 = 
doubË_g_bË_size
;

210 
bË
 
pÜt_vÏn_to_bd_m­pšg
 {

211 
key
 = {

212 
ig_md
.
pÜt_Ïg_šdex
 : 
exaù
;

213 
hdr
.
vÏn_g
[0].
	`isV®id
(è: 
‹º¬y
;

214 
hdr
.
vÏn_g
[0].
vid
 : 
‹º¬y
;

217 
aùiÚs
 = {

218 
NoAùiÚ
;

219 
pÜt_vÏn_miss
;

220 
£t_bd_´İ”t›s
;

223 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

224 
im¶em’tiÚ
 = 
bd_aùiÚ_´ofe
;

225 
size
 = 
pÜt_vÏn_bË_size
;

229 
bË
 
vÏn_to_bd_m­pšg
 {

230 
key
 = {

231 
hdr
.
vÏn_g
[0].
vid
 : 
exaù
;

234 
aùiÚs
 = {

235 
NoAùiÚ
;

236 
pÜt_vÏn_miss
;

237 
£t_bd_´İ”t›s
;

240 cÚ¡ 
deçuÉ_aùiÚ
 = 
pÜt_vÏn_miss
;

241 
im¶em’tiÚ
 = 
bd_aùiÚ_´ofe
;

242 
size
 = 
vÏn_bË_size
;

245 
bË
 
ıu_to_bd_m­pšg
 {

246 
key
 = { 
hdr
.
ıu
.
šg»ss_bd
 : 
exaù
; }

248 
aùiÚs
 = {

249 
NoAùiÚ
;

250 
pÜt_vÏn_miss
;

251 
£t_bd_´İ”t›s
;

254 cÚ¡ 
deçuÉ_aùiÚ
 = 
pÜt_vÏn_miss
;

255 
im¶em’tiÚ
 = 
bd_aùiÚ_´ofe
;

256 
size
 = 
bd_bË_size
;

259 
aùiÚ
 
	`£t_š‹rçû_´İ”t›s
(
sw™ch_ifšdex_t
 
ifšdex
, 
sw™ch_if_Ïb–_t
 
if_Ïb–
) {

260 
ig_md
.
ifšdex
 = ifindex;

261 
ig_md
.
checks
.
§me_if
 = 0xffff;

262 
ig_md
.
if_Ïb–
 = if_label;

265 
bË
 
pÜt_vÏn_to_ifšdex_m­pšg
 {

266 
key
 = {

267 
ig_md
.
pÜt_Ïg_šdex
 : 
exaù
;

268 
hdr
.
vÏn_g
[0].
vid
 : 
exaù
;

271 
aùiÚs
 = {

272 
NoAùiÚ
;

273 
£t_š‹rçû_´İ”t›s
;

276 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

277 
size
 = 
pÜt_vÏn_bË_size
;

280 
bË
 
pÜt_to_ifšdex_m­pšg
 {

281 
key
 = {

282 
ig_md
.
pÜt_Ïg_šdex
 : 
exaù
;

285 
aùiÚs
 = {

286 
NoAùiÚ
;

287 
£t_š‹rçû_´İ”t›s
;

290 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

291 
size
 = 
pÜt_bË_size
;

294 
aùiÚ
 
	`£t_³”_lšk_´İ”t›s
() {

295 
ig_šŒ_md_fÜ_tm
.
rid
 = 
SWITCH_RID_DEFAULT
;

296 
ig_md
.
æags
.
³”_lšk
 = 
Œue
;

299 
bË
 
³”_lšk
 {

300 
key
 = { 
ig_md
.
pÜt_Ïg_šdex
 : 
exaù
; }

301 
aùiÚs
 = {

302 
NoAùiÚ
;

303 
£t_³”_lšk_´İ”t›s
;

306 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

307 
size
 = 
pÜt_bË_size
;

310 
­¶y
 {

311 
pÜt_m­pšg
.
	`­¶y
().
aùiÚ_run
) {

312 
£t_ıu_pÜt_´İ”t›s
 : {

313 
ıu_to_bd_m­pšg
.
	`­¶y
();

316 
£t_pÜt_´İ”t›s
 : {

317 #ifdeà
QINQ_RIF_ENABLE


318 ià(!
pÜt_doubË_g_to_bd_m­pšg
.
	`­¶y
().
h™
) {

320 ià(!
pÜt_vÏn_to_bd_m­pšg
.
	`­¶y
().
h™
) {

321 ià(
hdr
.
vÏn_g
[0].
	`isV®id
())

322 
vÏn_to_bd_m­pšg
.
	`­¶y
();

326 #ifdeà
QINQ_RIF_ENABLE


330 #ifdeà
BRIDGE_PORT_ENABLE


331 ià(
hdr
.
vÏn_g
[0].
	`isV®id
()) {

332 if(!
pÜt_vÏn_to_ifšdex_m­pšg
.
	`­¶y
().
h™
) {

333 
pÜt_to_ifšdex_m­pšg
.
	`­¶y
();

336 
pÜt_to_ifšdex_m­pšg
.
	`­¶y
();

342 ià(
hdr
.
vÏn_g
[0].
	`isV®id
(è&& !hdr.vÏn_g[1].isV®id(è&& (
b™
<1>è
ig_md
.
æags
.
pÜt_vÏn_miss
 == 0) {

343 
b™
<32> 
pv_hash_
 = 
hash
.
	`g‘
({
ig_md
.
pÜt
[6:0], 
hdr
.
vÏn_g
[0].
vid
});

344 
ig_md
.
æags
.
pÜt_vÏn_miss
 =

345 (
boŞ
)
check_vÏn_memb”sh
.
	`execu‹
(
pv_hash_
);

348 #ifdeà
MLAG_ENABLE


349 
³”_lšk
.
	`­¶y
();

352 #ifdeà
INGRESS_PORT_MIRROR_ENABLE


353 
pÜt_mœrÜ
.
	`­¶y
(
ig_md
.
pÜt
, 
SWITCH_PKT_SRC_CLONED_INGRESS
, ig_md.
mœrÜ
);

368 
cÚŒŞ
 
	`LAG
(
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

369 
š
 
b™
<16> 
hash
,

370 
out
 
sw™ch_pÜt_t
 
eg»ss_pÜt
) {

372 
Hash
<
sw™ch_ušt16_t
>(
HashAlgÜ™hm_t
.
IDENTITY
è
£ËùÜ_hash
;

373 
	`AùiÚS–eùÜ
(1024, 
£ËùÜ_hash
, 
S–eùÜMode_t
.
FAIR
è
Ïg_£ËùÜ
;

375 
aùiÚ
 
	`£t_Ïg_pÜt
(
sw™ch_pÜt_t
 
pÜt
) {

376 
eg»ss_pÜt
 = 
pÜt
;

379 
aùiÚ
 
	`£t_³”_lšk_pÜt
(
sw™ch_pÜt_t
 
pÜt
, 
sw™ch_ifšdex_t
 
ifšdex
) {

380 #ifdeà
MLAG_ENABLE


381 
eg»ss_pÜt
 = 
pÜt
;

382 
ig_md
.
eg»ss_ifšdex
 = 
ifšdex
;

383 
ig_md
.
checks
.
§me_if
 = ig_md.
ifšdex
 ^ ifindex;

387 
aùiÚ
 
	`Ïg_miss
() { }

389 
bË
 
Ïg
 {

390 
key
 = {

391 #ifdeà
MLAG_ENABLE


392 
ig_md
.
eg»ss_ifšdex
 : 
‹º¬y
 @
	`Çme
("port_lag_index");

394 
ig_md
.
eg»ss_ifšdex
 : 
exaù
 @
	`Çme
("port_lag_index");

396 
hash
 : 
£ËùÜ
;

399 
aùiÚs
 = {

400 
Ïg_miss
;

401 
£t_Ïg_pÜt
;

402 
£t_³”_lšk_pÜt
;

405 cÚ¡ 
deçuÉ_aùiÚ
 = 
Ïg_miss
;

406 
size
 = 1024;

407 
im¶em’tiÚ
 = 
Ïg_£ËùÜ
;

410 
­¶y
 {

411 
Ïg
.
	`­¶y
();

424 
cÚŒŞ
 
	`Eg»ssPÜtM­pšg
(

425 
šout
 
sw™ch_h—d”_t
 
hdr
,

426 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

427 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

428 
š
 
sw™ch_pÜt_t
 
pÜt
)(

429 
sw™ch_ušt32_t
 
bË_size
=288) {

430 
	`PÜtMœrÜ
(
bË_size
è
pÜt_mœrÜ
;

432 
aùiÚ
 
	`pÜt_nÜm®
(
sw™ch_pÜt_Ïg_šdex_t
 
pÜt_Ïg_šdex
,

433 
sw™ch_pÜt_Ïg_Ïb–_t
 
pÜt_Ïg_Ïb–
,

434 
sw™ch_qos_group_t
 
qos_group
,

435 
boŞ
 
mÏg_memb”
) {

436 
eg_md
.
pÜt_Ïg_šdex
 =…ort_lag_index;

437 
eg_md
.
pÜt_Ïg_Ïb–
 =…ort_lag_label;

438 
eg_md
.
qos
.
group
 = 
qos_group
;

439 
eg_md
.
æags
.
mÏg_memb”
 = mlag_member;

442 
aùiÚ
 
	`ıu_»wr™e
() {

443 
hdr
.
çbric
.
	`£tV®id
();

444 
hdr
.
çbric
.
»£rved
 = 0;

445 
hdr
.
çbric
.
cŞÜ
 = 0;

446 
hdr
.
çbric
.
qos
 = 0;

447 
hdr
.
çbric
.
»£rved2
 = 0;

448 
hdr
.
çbric
.
d¡_pÜt_Ü_group
 = 0;

450 
hdr
.
ıu
.
	`£tV®id
();

451 
hdr
.
ıu
.
eg»ss_queue
 = 0;

452 
hdr
.
ıu
.
tx_by·ss
 = 0;

453 
hdr
.
ıu
.
ÿ±u»_ts
 = 0;

454 
hdr
.
ıu
.
»£rved
 = 0;

455 
hdr
.
ıu
.
šg»ss_pÜt
 = (
b™
<16>è
eg_md
.ingress_port;

456 
hdr
.
ıu
.
šg»ss_ifšdex
 = (
b™
<16>è
eg_md
.ingress_ifindex;

457 
hdr
.
ıu
.
šg»ss_bd
 = (
b™
<16>è
eg_md
.
bd
;

458 
hdr
.
ıu
.
»asÚ_code
 = 
eg_md
.
ıu_»asÚ
;

459 
hdr
.
ıu
.
‘h”_ty³
 = hdr.
‘h”Ãt
.ether_type;

461 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_BFN
;

464 
aùiÚ
 
	`pÜt_ıu
(
sw™ch_pÜt_Ïg_šdex_t
 
pÜt_Ïg_šdex
) {

465 
	`ıu_»wr™e
();

468 @
	`ignÜe_bË_d•’d’cy
("SwitchEgress.mirror_rewrite.rewrite")

469 
bË
 
pÜt_m­pšg
 {

470 
key
 = { 
pÜt
 : 
exaù
; }

472 
aùiÚs
 = {

473 
pÜt_nÜm®
;

474 
pÜt_ıu
;

477 
size
 = 
bË_size
;

480 
­¶y
 {

481 
pÜt_m­pšg
.
	`­¶y
();

483 #ifdeà
EGRESS_PORT_MIRROR_ENABLE


484 
pÜt_mœrÜ
.
	`­¶y
(
pÜt
, 
SWITCH_PKT_SRC_CLONED_EGRESS
, 
eg_md
.
mœrÜ
);

	@shared/qos.p4

23 #iâdeà
_P4_QOS_


24 
	#_P4_QOS_


	)

26 
	~"aş.p4
"

27 
	~"m‘”.p4
"

32 
aùiÚ
 
	$£t_šg»ss_tc
(
šout
 
sw™ch_qos_m‘ad©a_t
 
qos_md
, 
sw™ch_tc_t
 
tc
) {

33 
qos_md
.
tc
 =c;

34 
	}
}

36 
aùiÚ
 
	$£t_šg»ss_cŞÜ
(
šout
 
sw™ch_qos_m‘ad©a_t
 
qos_md
, 
sw™ch_pkt_cŞÜ_t
 
cŞÜ
) {

37 
qos_md
.
cŞÜ
 = color;

38 
	}
}

40 
aùiÚ
 
	$£t_šg»ss_tc_ªd_cŞÜ
(

41 
šout
 
sw™ch_qos_m‘ad©a_t
 
qos_md
, 
sw™ch_tc_t
 
tc
, 
sw™ch_pkt_cŞÜ_t
 
cŞÜ
) {

42 
	`£t_šg»ss_tc
(
qos_md
, 
tc
);

43 
	`£t_šg»ss_cŞÜ
(
qos_md
, 
cŞÜ
);

44 
	}
}

46 
aùiÚ
 
	$£t_šg»ss_m‘”
(

47 
šout
 
sw™ch_qos_m‘ad©a_t
 
qos_md
,

48 
sw™ch_pŞiûr_m‘”_šdex_t
 
šdex
) {

49 
qos_md
.
m‘”_šdex
 = 
šdex
;

50 
	}
}

52 
aùiÚ
 
	$£t_šg»ss_tc_cŞÜ_ªd_m‘”
(

53 
šout
 
sw™ch_qos_m‘ad©a_t
 
qos_md
,

54 
sw™ch_tc_t
 
tc
,

55 
sw™ch_pkt_cŞÜ_t
 
cŞÜ
,

56 
sw™ch_pŞiûr_m‘”_šdex_t
 
šdex
) {

57 #ifdeà
INGRESS_ACL_POLICER_ENABLE


58 
	`£t_šg»ss_tc_ªd_cŞÜ
(
qos_md
, 
tc
, 
cŞÜ
);

59 
qos_md
.
m‘”_šdex
 = 
šdex
;

61 
	}
}

63 
cÚŒŞ
 
	$MacQosAş
(

64 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

65 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

66 
sw™ch_ušt32_t
 
bË_size
=512) {

68 
bË
 
aş
 {

69 
key
 = {

70 
INGRESS_MAC_ACL_KEY


71 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

72 
lkp
.
pı
 : 
‹º¬y
;

75 
aùiÚs
 = {

76 
NoAùiÚ
;

77 
	`£t_šg»ss_tc
(
ig_md
.
qos
);

78 
	`£t_šg»ss_cŞÜ
(
ig_md
.
qos
);

79 
	`£t_šg»ss_tc_ªd_cŞÜ
(
ig_md
.
qos
);

80 
	`£t_šg»ss_m‘”
(
ig_md
.
qos
);

81 
	`£t_šg»ss_tc_cŞÜ_ªd_m‘”
(
ig_md
.
qos
);

84 
size
 = 
bË_size
;

87 
­¶y
 {

88 
aş
.
	`­¶y
();

90 
	}
}

92 
cÚŒŞ
 
	$Ipv4QosAş
(

93 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

94 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

95 
sw™ch_ušt32_t
 
bË_size
=512) {

97 
bË
 
aş
 {

98 
key
 = {

99 
INGRESS_IPV4_ACL_KEY


100 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

101 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

102 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

105 
aùiÚs
 = {

106 
NoAùiÚ
;

107 
	`£t_šg»ss_tc
(
ig_md
.
qos
);

108 
	`£t_šg»ss_cŞÜ
(
ig_md
.
qos
);

109 
	`£t_šg»ss_tc_ªd_cŞÜ
(
ig_md
.
qos
);

110 
	`£t_šg»ss_m‘”
(
ig_md
.
qos
);

111 
	`£t_šg»ss_tc_cŞÜ_ªd_m‘”
(
ig_md
.
qos
);

114 
size
 = 
bË_size
;

117 
­¶y
 {

118 
aş
.
	`­¶y
();

120 
	}
}

122 
cÚŒŞ
 
	$Ipv6QosAş
(

123 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

124 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

125 
sw™ch_ušt32_t
 
bË_size
=512) {

127 
bË
 
aş
 {

128 
key
 = {

129 
INGRESS_IPV6_ACL_KEY


130 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

131 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

132 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

135 
aùiÚs
 = {

136 
NoAùiÚ
;

137 
	`£t_šg»ss_tc
(
ig_md
.
qos
);

138 
	`£t_šg»ss_cŞÜ
(
ig_md
.
qos
);

139 
	`£t_šg»ss_tc_ªd_cŞÜ
(
ig_md
.
qos
);

140 
	`£t_šg»ss_m‘”
(
ig_md
.
qos
);

141 
	`£t_šg»ss_tc_cŞÜ_ªd_m‘”
(
ig_md
.
qos
);

144 
size
 = 
bË_size
;

147 
­¶y
 {

148 
aş
.
	`­¶y
();

150 
	}
}

152 
cÚŒŞ
 
	$IpQosAş
(

153 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

154 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

155 
sw™ch_ušt32_t
 
bË_size
=512) {

157 
bË
 
aş
 {

158 
key
 = {

159 
INGRESS_IP_ACL_KEY


160 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

161 
ig_md
.
bd_Ïb–
 : 
‹º¬y
;

162 
ig_md
.
l4_pÜt_Ïb–
 : 
‹º¬y
;

165 
aùiÚs
 = {

166 
NoAùiÚ
;

167 
	`£t_šg»ss_tc
(
ig_md
.
qos
);

168 
	`£t_šg»ss_cŞÜ
(
ig_md
.
qos
);

169 
	`£t_šg»ss_tc_ªd_cŞÜ
(
ig_md
.
qos
);

170 
	`£t_šg»ss_m‘”
(
ig_md
.
qos
);

171 
	`£t_šg»ss_tc_cŞÜ_ªd_m‘”
(
ig_md
.
qos
);

174 
size
 = 
bË_size
;

177 
­¶y
 {

178 
aş
.
	`­¶y
();

180 
	}
}

190 
cÚŒŞ
 
	$ECNAş
(
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

191 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

192 
šout
 
sw™ch_pkt_cŞÜ_t
 
pkt_cŞÜ
)(

193 
sw™ch_ušt32_t
 
bË_size
=512) {

194 
aùiÚ
 
	`£t_šg»ss_cŞÜ
(
sw™ch_pkt_cŞÜ_t
 
cŞÜ
) {

195 
pkt_cŞÜ
 = 
cŞÜ
;

198 
bË
 
aş
 {

199 
key
 = {

200 
ig_md
.
pÜt_Ïg_Ïb–
 : 
‹º¬y
;

201 
lkp
.
_tos
 : 
‹º¬y
;

202 
lkp
.
tı_æags
 : 
‹º¬y
;

205 
aùiÚs
 = {

206 
NoAùiÚ
;

207 
£t_šg»ss_cŞÜ
;

210 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

211 
size
 = 
bË_size
;

214 
­¶y
 {

215 
aş
.
	`­¶y
();

217 
	}
}

229 
cÚŒŞ
 
	$PFCWd
(
š
 
sw™ch_pÜt_t
 
pÜt
,

230 
š
 
sw™ch_qid_t
 
qid
,

231 
out
 
boŞ
 
æag
)(

232 
sw™ch_ušt32_t
 
bË_size
=512) {

234 
DœeùCouÁ”
<
b™
<16>>(
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

236 
aùiÚ
 
	`aş_d’y
() {

237 
æag
 = 
Œue
;

238 
¡©s
.
	`couÁ
();

241 
bË
 
aş
 {

242 
key
 = {

243 
qid
 : 
exaù
;

244 
pÜt
 : 
exaù
;

247 
aùiÚs
 = {

248 @
deçuÉÚly
 
NoAùiÚ
;

249 
aş_d’y
;

252 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

253 
couÁ”s
 = 
¡©s
;

254 
size
 = 
bË_size
;

257 
­¶y
 {

258 #ifdeà
PFC_ENABLE


259 
aş
.
	`­¶y
();

262 
	}
}

264 
cÚŒŞ
 
	$Ing»ssQoS
(

265 
š
 
sw™ch_h—d”_t
 
hdr
,

266 
š
 
sw™ch_lookup_f›lds_t
 
lkp
,

267 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

268 
sw™ch_ušt32_t
 
dsı_m­_size
=1024,

269 
sw™ch_ušt32_t
 
pı_m­_size
=1024) {

271 cÚ¡ 
b™
<32> 
µg_bË_size
 = 1024;

272 cÚ¡ 
b™
<32> 
queue_bË_size
 = 1024;

273 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
µg_¡©s
;

274 
	`Ing»ssPŞiûr
(1 << 
sw™ch_pŞiûr_m‘”_šdex_width
è
pŞiûr
;

275 
	`MacQosAş
(è
mac_aş
;

276 
	`IpQosAş
(è
_aş
;

277 #ià
	`defšed
(
INGRESS_PORT_POLICER_ENABLE
)

278 
	`PÜtPŞiûr
(è
pÜt_pŞiûr
;

281 
bË
 
dsı_tc_m­
 {

282 
key
 = {

283 
ig_md
.
qos
.
group
 : 
exaù
;

284 
lkp
.
_tos
 : 
exaù
;

287 
aùiÚs
 = {

288 
NoAùiÚ
;

289 
	`£t_šg»ss_tc
(
ig_md
.
qos
);

290 
	`£t_šg»ss_cŞÜ
(
ig_md
.
qos
);

291 
	`£t_šg»ss_tc_ªd_cŞÜ
(
ig_md
.
qos
);

292 
	`£t_šg»ss_tc_cŞÜ_ªd_m‘”
(
ig_md
.
qos
);

295 
size
 = 
dsı_m­_size
;

298 
bË
 
pı_tc_m­
 {

299 
key
 = {

300 
ig_md
.
qos
.
group
 : 
‹º¬y
;

301 
lkp
.
pı
 : 
exaù
;

304 
aùiÚs
 = {

305 
NoAùiÚ
;

306 
	`£t_šg»ss_tc
(
ig_md
.
qos
);

307 
	`£t_šg»ss_cŞÜ
(
ig_md
.
qos
);

308 
	`£t_šg»ss_tc_ªd_cŞÜ
(
ig_md
.
qos
);

309 
	`£t_šg»ss_tc_cŞÜ_ªd_m‘”
(
ig_md
.
qos
);

312 
size
 = 
pı_m­_size
;

316 
aùiÚ
 
	`£t_icos
(
sw™ch_cos_t
 
icos
) {

317 
ig_md
.
qos
.
icos
 = icos;

320 
aùiÚ
 
	`£t_queue
(
sw™ch_qid_t
 
qid
) {

321 
ig_md
.
qos
.
qid
 = qid;

324 
aùiÚ
 
	`£t_icos_ªd_queue
(
sw™ch_cos_t
 
icos
, 
sw™ch_qid_t
 
qid
) {

325 
	`£t_icos
(
icos
);

326 
	`£t_queue
(
qid
);

329 
bË
 
Œaffic_şass
 {

330 
key
 = {

331 
ig_md
.
pÜt
 : 
‹º¬y
 @
	`Çme
("port");

332 
ig_md
.
qos
.
cŞÜ
 : 
‹º¬y
 @
	`Çme
("color");

333 
ig_md
.
qos
.
tc
 : 
exaù
 @
	`Çme
("tc");

336 
aùiÚs
 = {

337 
£t_icos
;

338 
£t_queue
;

339 
£t_icos_ªd_queue
;

342 
size
 = 
queue_bË_size
;

345 
aùiÚ
 
	`couÁ
() {

346 
µg_¡©s
.
	`couÁ
();

350 
bË
 
µg
 {

351 
key
 = {

352 
ig_md
.
pÜt
 : 
exaù
 @
	`Çme
("port");

353 
ig_md
.
qos
.
icos
 : 
exaù
 @
	`Çme
("icos");

356 
aùiÚs
 = {

357 @
deçuÉÚly
 
NoAùiÚ
;

358 
couÁ
;

361 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

362 
size
 = 
µg_bË_size
;

363 
couÁ”s
 = 
µg_¡©s
;

366 
­¶y
 {

367 #ifdeà
QOS_ENABLE


368 
ig_md
.
qos
.
cŞÜ
 = 
SWITCH_METER_COLOR_GREEN
;

369 
ig_md
.
qos
.
tc
 = 0;

370 
ig_md
.
qos
.
icos
 = 0;

371 
ig_md
.
qos
.
qid
 = 0;

372 
ig_md
.
qos
.
m‘”_šdex
 = 0;

374 ià(!
	`INGRESS_BYPASS
(
QOS
)) {

376 #ià
	`defšed
(
INGRESS_PORT_POLICER_ENABLE
)

377 ià(!
	`INGRESS_BYPASS
(
POLICER
)) {

378 
pÜt_pŞiûr
.
	`­¶y
(
ig_md
.
pÜt
, ig_md.
æags
.
pÜt_pŞiûr_drİ
);

382 #ifdeà
QOS_ACL_ENABLE


383 ià(
ig_md
.
qos
.
Œu¡_mode
 & 
SWITCH_QOS_TRUST_MODE_TRUST_DSCP
 ==

384 
SWITCH_QOS_TRUST_MODE_TRUST_DSCP
 && 
lkp
.
_ty³
 !ğ
SWITCH_IP_TYPE_NONE
) {

385 
_aş
.
	`­¶y
(
lkp
, 
ig_md
);

394 } ià(
ig_md
.
qos
.
Œu¡_mode
 & 
SWITCH_QOS_TRUST_MODE_TRUST_PCP
 ==

395 
SWITCH_QOS_TRUST_MODE_TRUST_PCP
 && 
hdr
.
vÏn_g
[0].
	`isV®id
()) {

396 
mac_aş
.
	`­¶y
(
lkp
, 
ig_md
);

399 ià(
ig_md
.
qos
.
Œu¡_mode
 & 
SWITCH_QOS_TRUST_MODE_TRUST_DSCP
 ==

400 
SWITCH_QOS_TRUST_MODE_TRUST_DSCP
 && 
lkp
.
_ty³
 !ğ
SWITCH_IP_TYPE_NONE
) {

401 
dsı_tc_m­
.
	`­¶y
();

402 } if(
ig_md
.
qos
.
Œu¡_mode
 & 
SWITCH_QOS_TRUST_MODE_TRUST_PCP
 ==

403 
SWITCH_QOS_TRUST_MODE_TRUST_PCP
 && 
hdr
.
vÏn_g
[0].
	`isV®id
()) {

404 
pı_tc_m­
.
	`­¶y
();

409 #ifdeà
INGRESS_ACL_POLICER_ENABLE


410 
pŞiûr
.
	`­¶y
(
ig_md
, ig_md.
qos
, ig_md.
æags
.
aş_pŞiûr_drİ
);

412 
Œaffic_şass
.
	`­¶y
();

413 
µg
.
	`­¶y
();

416 
	}
}

419 
cÚŒŞ
 
	$Eg»ssQoS
(
šout
 
sw™ch_h—d”_t
 
hdr
,

420 
š
 
sw™ch_pÜt_t
 
pÜt
,

421 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

422 
sw™ch_ušt32_t
 
bË_size
=1024) {

424 cÚ¡ 
b™
<32> 
queue_bË_size
 = 1024;

425 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
queue_¡©s
;

426 #ià
	`defšed
(
EGRESS_PORT_POLICER_ENABLE
)

427 
	`PÜtPŞiûr2
(è
pÜt_pŞiûr
;

431 
aùiÚ
 
	`£t_v4_dsı
(
b™
<6> 
dsı
) {

432 
hdr
.
v4
.
diff£rv
[7:2] = 
dsı
;

435 
aùiÚ
 
	`£t_v4_tos
(
sw™ch_ušt8_t
 
tos
) {

436 
hdr
.
v4
.
diff£rv
 = 
tos
;

440 
aùiÚ
 
	`£t_v6_dsı
(
b™
<6> 
dsı
) {

441 #ifdeà
IPV6_ENABLE


442 
hdr
.
v6
.
Œaffic_şass
[7:2] = 
dsı
;

446 
aùiÚ
 
	`£t_v6_tos
(
sw™ch_ušt8_t
 
tos
) {

447 #ifdeà
IPV6_ENABLE


448 
hdr
.
v6
.
Œaffic_şass
 = 
tos
;

452 
aùiÚ
 
	`£t_vÏn_pı
(
b™
<3> 
pı
) {

453 
eg_md
.
lkp
.
pı
 =…cp;

456 
bË
 
qos_m­
 {

457 
key
 = {

458 
eg_md
.
qos
.
group
 : 
‹º¬y
 @
	`Çme
("group");

459 
eg_md
.
qos
.
tc
 : 
‹º¬y
 @
	`Çme
("tc");

460 
eg_md
.
qos
.
cŞÜ
 : 
‹º¬y
 @
	`Çme
("color");

461 
hdr
.
v4
.
	`isV®id
(è: 
‹º¬y
;

462 
hdr
.
v6
.
	`isV®id
(è: 
‹º¬y
;

465 
aùiÚs
 = {

466 
NoAùiÚ
;

467 
£t_v4_dsı
;

468 
£t_v4_tos
;

469 
£t_v6_dsı
;

470 
£t_v6_tos
;

471 
£t_vÏn_pı
;

474 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

475 
size
 = 
bË_size
;

478 
aùiÚ
 
	`couÁ
() {

479 
queue_¡©s
.
	`couÁ
();

484 
bË
 
queue
 {

485 
key
 = {

486 
pÜt
 : 
exaù
;

487 
eg_md
.
qos
.
qid
 : 
exaù
 @
	`Çme
("qid");

490 
aùiÚs
 = {

491 @
deçuÉÚly
 
NoAùiÚ
;

492 
couÁ
;

495 
size
 = 
queue_bË_size
;

496 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

497 
couÁ”s
 = 
queue_¡©s
;

500 
­¶y
 {

501 #ifdeà
QOS_ENABLE


502 ià(!
	`EGRESS_BYPASS
(
QOS
)) {

503 #ià
	`defšed
(
EGRESS_PORT_POLICER_ENABLE
)

504 ià(!
	`EGRESS_BYPASS
(
POLICER
)) {

505 
pÜt_pŞiûr
.
	`­¶y
(
eg_md
.
pÜt
,ƒg_md.
æags
.
pÜt_pŞiûr_drİ
);

508 
qos_m­
.
	`­¶y
();

510 
queue
.
	`­¶y
();

513 
	}
}

	@shared/rewrite.p4

24 #iâdeà
_P4_REWRITE_


25 
	#_P4_REWRITE_


	)

27 
	~"l2.p4
"

38 
cÚŒŞ
 
	$MœrÜRewr™e
(
šout
 
sw™ch_h—d”_t
 
hdr
,

39 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

40 
sw™ch_ušt32_t
 
bË_size
=1024) {

41 
b™
<16> 
Ëngth
;

43 
aùiÚ
 
	`add_‘h”Ãt_h—d”
(
š
 
mac_addr_t
 
¤c_addr
,

44 
š
 
mac_addr_t
 
d¡_addr
,

45 
š
 
b™
<16> 
‘h”_ty³
) {

46 
hdr
.
‘h”Ãt
.
	`£tV®id
();

47 
hdr
.
‘h”Ãt
.
‘h”_ty³
 =ƒther_type;

48 
hdr
.
‘h”Ãt
.
¤c_addr
 = src_addr;

49 
hdr
.
‘h”Ãt
.
d¡_addr
 = dst_addr;

52 
aùiÚ
 
	`add_vÏn_g
(
vÏn_id_t
 
vid
, 
b™
<3> 
pı
, b™<16> 
‘h”_ty³
) {

53 
hdr
.
vÏn_g
[0].
	`£tV®id
();

54 
hdr
.
vÏn_g
[0].
pı
 =…cp;

56 
hdr
.
vÏn_g
[0].
vid
 = vid;

57 
hdr
.
vÏn_g
[0].
‘h”_ty³
 =ƒther_type;

60 
aùiÚ
 
	`add_v4_h—d”
(
š
 
b™
<8> 
diff£rv
,

61 
š
 
b™
<8> 
‰l
,

62 
š
 
b™
<8> 
´ÙocŞ
,

63 
š
 
v4_addr_t
 
¤c_addr
,

64 
š
 
v4_addr_t
 
d¡_addr
) {

65 
hdr
.
v4
.
	`£tV®id
();

66 
hdr
.
v4
.
v”siÚ
 = 4
w4
;

67 
hdr
.
v4
.
ihl
 = 4
w5
;

68 
hdr
.
v4
.
diff£rv
 = diffserv;

70 
hdr
.
v4
.
id’tifiÿtiÚ
 = 0;

71 
hdr
.
v4
.
æags
 = 0;

72 
hdr
.
v4
.
äag_off£t
 = 0;

73 
hdr
.
v4
.
‰l
 =tl;

74 
hdr
.
v4
.
´ÙocŞ
 =…rotocol;

75 
hdr
.
v4
.
¤c_addr
 = src_addr;

76 
hdr
.
v4
.
d¡_addr
 = dst_addr;

79 
aùiÚ
 
	`add_g»_h—d”
(
š
 
b™
<16> 
´Ùo
) {

80 
hdr
.
g»
.
	`£tV®id
();

86 
hdr
.
g»
.
æags
 = 0;

87 
hdr
.
g»
.
v”siÚ
 = 0;

88 
hdr
.
g»
.
´Ùo
 =…roto;

91 
aùiÚ
 
	`add_”¥ª_ty³2
(
b™
<10> 
£ssiÚ_id
) {

93 
hdr
.
”¥ª_ty³2
.
	`£tV®id
();

94 
hdr
.
”¥ª_ty³2
.
v”siÚ
 = 4
w0x1
;

95 
hdr
.
”¥ª_ty³2
.
vÏn
 = 0;

96 
hdr
.
”¥ª_ty³2
.
cos_’_t
 = 0;

97 
hdr
.
”¥ª_ty³2
.
£ssiÚ_id
 = session_id;

100 
aùiÚ
 
	`add_”¥ª_ty³3
(
b™
<10> 
£ssiÚ_id
, b™<32> 
time¡amp
, 
boŞ
 
İt_sub_h—d”
) {

101 
hdr
.
”¥ª_ty³3
.
	`£tV®id
();

102 
hdr
.
”¥ª_ty³3
.
v”siÚ
 = 4
w0x2
;

103 
hdr
.
”¥ª_ty³3
.
vÏn
 = 0;

104 
hdr
.
”¥ª_ty³3
.
cos_bso_t
 = 0;

105 
hdr
.
”¥ª_ty³3
.
£ssiÚ_id
 = session_id;

106 
hdr
.
”¥ª_ty³3
.
time¡amp
 =imestamp;

107 
hdr
.
”¥ª_ty³3
.
sgt
 = 0;

108 
hdr
.
”¥ª_ty³3
.
p
 = 0;

109 
hdr
.
”¥ª_ty³3
.
á
 = 0;

110 
hdr
.
”¥ª_ty³3
.
hw_id
 = 0;

112 
hdr
.
”¥ª_ty³3
.
d
 = 0;

113 
hdr
.
”¥ª_ty³3
.
g¿
 = 0b10;

114 ià(
İt_sub_h—d”
) {

115 
hdr
.
”¥ª_ty³3
.
o
 = 1;

116 
hdr
.
”¥ª_¶©fÜm
.
	`£tV®id
();

117 
hdr
.
”¥ª_¶©fÜm
.
id
 = 0;

118 
hdr
.
”¥ª_¶©fÜm
.
šfo
 = 0;

120 
hdr
.
”¥ª_ty³3
.
o
 = 0;

124 
aùiÚ
 
	`»wr™e_
(
sw™ch_qid_t
 
qid
) {

125 
eg_md
.
qos
.
qid
 = qid;

128 
aùiÚ
 
	`»wr™e_r¥ª
(
sw™ch_qid_t
 
qid
, 
b™
<3> 
pı
, 
vÏn_id_t
 
vid
) {

129 #ifdeà
RSPAN_ENABLE


130 
eg_md
.
qos
.
qid
 = qid;

131 
	`add_vÏn_g
(
vid
, 
pı
, 
hdr
.
‘h”Ãt
.
‘h”_ty³
);

132 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_VLAN
;

136 
aùiÚ
 
	`»wr™e_”¥ª_ty³2
(

137 
sw™ch_qid_t
 
qid
,

138 
mac_addr_t
 
smac
, mac_addr_ˆ
dmac
,

139 
v4_addr_t
 
s
, ipv4_addr_ˆ
d
, 
b™
<8> 
tos
, b™<8> 
‰l
) {

141 #ifdeà
ERSPAN_TYPE2_ENABLE


142 
eg_md
.
qos
.
qid
 = qid;

143 
	`add_”¥ª_ty³2
((
b™
<10>)
eg_md
.
mœrÜ
.
£ssiÚ_id
);

144 
	`add_g»_h—d”
(
GRE_PROTOCOLS_ERSPAN_TYPE_2
);

148 
	`add_v4_h—d”
(
tos
, 
‰l
, 
IP_PROTOCOLS_GRE
, 
s
, 
d
);

149 #ifdeà
PACKET_LENGTH_ADJUSTMENT


150 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w32
;

152 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w18
;

155 
hdr
.
šÃr_‘h”Ãt
 = hdr.
‘h”Ãt
;

156 
	`add_‘h”Ãt_h—d”
(
smac
, 
dmac
, 
ETHERTYPE_IPV4
);

160 
aùiÚ
 
	`»wr™e_”¥ª_ty³2_w™h_vÏn
(

161 
sw™ch_qid_t
 
qid
,

162 
b™
<16> 
‘h”_ty³
, 
mac_addr_t
 
smac
, mac_addr_ˆ
dmac
,

163 
b™
<3> 
pı
, 
vÏn_id_t
 
vid
,

164 
v4_addr_t
 
s
, ipv4_addr_ˆ
d
, 
b™
<8> 
tos
, b™<8> 
‰l
) {

165 #ifdeà
ERSPAN_TYPE2_ENABLE


166 
eg_md
.
qos
.
qid
 = qid;

167 
	`add_”¥ª_ty³2
((
b™
<10>è
eg_md
.
mœrÜ
.
£ssiÚ_id
);

168 
	`add_g»_h—d”
(
GRE_PROTOCOLS_ERSPAN_TYPE_2
);

172 
	`add_v4_h—d”
(
tos
, 
‰l
, 
IP_PROTOCOLS_GRE
, 
s
, 
d
);

173 #ifdeà
PACKET_LENGTH_ADJUSTMENT


174 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w32
;

176 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w18
;

178 
hdr
.
šÃr_‘h”Ãt
 = hdr.
‘h”Ãt
;

179 
	`add_‘h”Ãt_h—d”
(
smac
, 
dmac
, 
‘h”_ty³
);

180 
	`add_vÏn_g
(
vid
, 
pı
, 
ETHERTYPE_IPV4
);

184 
aùiÚ
 
	`»wr™e_”¥ª_ty³3
(

185 
sw™ch_qid_t
 
qid
,

186 
mac_addr_t
 
smac
, mac_addr_ˆ
dmac
,

187 
v4_addr_t
 
s
, ipv4_addr_ˆ
d
, 
b™
<8> 
tos
, b™<8> 
‰l
) {

188 #ifdeà
ERSPAN_ENABLE


189 
eg_md
.
qos
.
qid
 = qid;

190 
	`add_”¥ª_ty³3
((
b™
<10>)
eg_md
.
mœrÜ
.
£ssiÚ_id
, (b™<32>ëg_md.
šg»ss_time¡amp
, 
çl£
);

191 
	`add_g»_h—d”
(
GRE_PROTOCOLS_ERSPAN_TYPE_3
);

195 
	`add_v4_h—d”
(
tos
, 
‰l
, 
IP_PROTOCOLS_GRE
, 
s
, 
d
);

196 #ifdeà
PACKET_LENGTH_ADJUSTMENT


197 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w36
;

199 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w22
;

202 
hdr
.
šÃr_‘h”Ãt
 = hdr.
‘h”Ãt
;

203 
	`add_‘h”Ãt_h—d”
(
smac
, 
dmac
, 
ETHERTYPE_IPV4
);

207 
aùiÚ
 
	`»wr™e_”¥ª_ty³3_w™h_vÏn
(

208 
sw™ch_qid_t
 
qid
,

209 
b™
<16> 
‘h”_ty³
, 
mac_addr_t
 
smac
, mac_addr_ˆ
dmac
,

210 
b™
<3> 
pı
, 
vÏn_id_t
 
vid
,

211 
v4_addr_t
 
s
, ipv4_addr_ˆ
d
, 
b™
<8> 
tos
, b™<8> 
‰l
) {

212 #ifdeà
ERSPAN_ENABLE


213 
eg_md
.
qos
.
qid
 = qid;

214 
	`add_”¥ª_ty³3
((
b™
<10>)
eg_md
.
mœrÜ
.
£ssiÚ_id
, (b™<32>ëg_md.
šg»ss_time¡amp
, 
çl£
);

215 
	`add_g»_h—d”
(
GRE_PROTOCOLS_ERSPAN_TYPE_3
);

219 
	`add_v4_h—d”
(
tos
, 
‰l
, 
IP_PROTOCOLS_GRE
, 
s
, 
d
);

220 #ifdeà
PACKET_LENGTH_ADJUSTMENT


221 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w36
;

223 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w22
;

225 
hdr
.
šÃr_‘h”Ãt
 = hdr.
‘h”Ãt
;

226 
	`add_‘h”Ãt_h—d”
(
smac
, 
dmac
, 
‘h”_ty³
);

227 
	`add_vÏn_g
(
vid
, 
pı
, 
ETHERTYPE_IPV4
);

231 
aùiÚ
 
	`»wr™e_”¥ª_ty³3_¶©fÜm_¥ecific
(

232 
sw™ch_qid_t
 
qid
,

233 
mac_addr_t
 
smac
, mac_addr_ˆ
dmac
,

234 
v4_addr_t
 
s
, ipv4_addr_ˆ
d
, 
b™
<8> 
tos
, b™<8> 
‰l
) {

235 #ifdeà
ERSPAN_ENABLE


236 
eg_md
.
qos
.
qid
 = qid;

237 
	`add_”¥ª_ty³3
((
b™
<10>)
eg_md
.
mœrÜ
.
£ssiÚ_id
, (b™<32>ëg_md.
šg»ss_time¡amp
, 
Œue
);

238 
	`add_g»_h—d”
(
GRE_PROTOCOLS_ERSPAN_TYPE_3
);

242 
	`add_v4_h—d”
(
tos
, 
‰l
, 
IP_PROTOCOLS_GRE
, 
s
, 
d
);

243 #ifdeà
PACKET_LENGTH_ADJUSTMENT


244 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w44
;

246 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w30
;

249 
hdr
.
šÃr_‘h”Ãt
 = hdr.
‘h”Ãt
;

250 
	`add_‘h”Ãt_h—d”
(
smac
, 
dmac
, 
ETHERTYPE_IPV4
);

254 
aùiÚ
 
	`»wr™e_”¥ª_ty³3_¶©fÜm_¥ecific_w™h_vÏn
(

255 
sw™ch_qid_t
 
qid
,

256 
b™
<16> 
‘h”_ty³
, 
mac_addr_t
 
smac
, mac_addr_ˆ
dmac
,

257 
b™
<3> 
pı
, 
vÏn_id_t
 
vid
,

258 
v4_addr_t
 
s
, ipv4_addr_ˆ
d
, 
b™
<8> 
tos
, b™<8> 
‰l
) {

259 #ifdeà
ERSPAN_ENABLE


260 
eg_md
.
qos
.
qid
 = qid;

262 
	`add_”¥ª_ty³3
((
b™
<10>)
eg_md
.
mœrÜ
.
£ssiÚ_id
, (b™<32>ëg_md.
šg»ss_time¡amp
, 
Œue
);

263 
	`add_g»_h—d”
(
GRE_PROTOCOLS_ERSPAN_TYPE_3
);

267 
	`add_v4_h—d”
(
tos
, 
‰l
, 
IP_PROTOCOLS_GRE
, 
s
, 
d
);

268 #ifdeà
PACKET_LENGTH_ADJUSTMENT


269 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w44
;

271 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w30
;

274 
hdr
.
šÃr_‘h”Ãt
 = hdr.
‘h”Ãt
;

275 
	`add_‘h”Ãt_h—d”
(
smac
, 
dmac
, 
‘h”_ty³
);

276 
	`add_vÏn_g
(
vid
, 
pı
, 
ETHERTYPE_IPV4
);

280 
aùiÚ
 
	`»wr™e_d‹l_»pÜt
(

281 
mac_addr_t
 
smac
, mac_addr_ˆ
dmac
,

282 
v4_addr_t
 
s
, ipv4_addr_ˆ
d
, 
b™
<8> 
tos
, b™<8> 
‰l
,

283 
b™
<16> 
udp_d¡_pÜt
) {

284 #ifdeà
DTEL_ENABLE


286 
hdr
.
udp
.
	`£tV®id
();

287 
hdr
.
udp
.
d¡_pÜt
 = 
udp_d¡_pÜt
;

288 
hdr
.
udp
.
checksum
 = 0;

292 
	`add_v4_h—d”
(
tos
, 
‰l
, 
IP_PROTOCOLS_UDP
, 
s
, 
d
);

293 #ifdeà
PACKET_LENGTH_ADJUSTMENT


294 
hdr
.
v4
.
tÙ®_Ën
 = 
eg_md
.
pkt_Ëngth
 + 16
w40
;

295 
hdr
.
udp
.
Ëngth
 = 
eg_md
.
pkt_Ëngth
 + 16
w20
;

299 
hdr
.
v4
.
æags
 = 2;

301 
	`add_‘h”Ãt_h—d”
(
smac
, 
dmac
, 
ETHERTYPE_IPV4
);

305 
aùiÚ
 
	`»wr™e_d‹l_»pÜt_w™h_’Œİy
(

306 
mac_addr_t
 
smac
, mac_addr_ˆ
dmac
,

307 
v4_addr_t
 
s
, ipv4_addr_ˆ
d
, 
b™
<8> 
tos
, b™<8> 
‰l
,

308 
b™
<16> 
udp_d¡_pÜt
) {

309 #ifdeà
DTEL_ENABLE


310 
	`»wr™e_d‹l_»pÜt
(
smac
, 
dmac
, 
s
, 
d
, 
tos
, 
‰l
, 
udp_d¡_pÜt
);

311 
hdr
.
udp
.
¤c_pÜt
 = 
eg_md
.
d‹l
.
hash
[15:0];

315 
aùiÚ
 
	`»wr™e_d‹l_»pÜt_w™hout_’Œİy
(

316 
mac_addr_t
 
smac
, mac_addr_ˆ
dmac
,

317 
v4_addr_t
 
s
, ipv4_addr_ˆ
d
, 
b™
<8> 
tos
, b™<8> 
‰l
,

318 
b™
<16> 
udp_d¡_pÜt
, b™<16> 
udp_¤c_pÜt
) {

319 #ifdeà
DTEL_ENABLE


320 
	`»wr™e_d‹l_»pÜt
(
smac
, 
dmac
, 
s
, 
d
, 
tos
, 
‰l
, 
udp_d¡_pÜt
);

321 
hdr
.
udp
.
¤c_pÜt
 = 
udp_¤c_pÜt
;

325 
bË
 
»wr™e
 {

326 
key
 = { 
eg_md
.
mœrÜ
.
£ssiÚ_id
 : 
exaù
; }

327 
aùiÚs
 = {

328 
NoAùiÚ
;

329 
»wr™e_
;

330 
»wr™e_r¥ª
;

331 
»wr™e_”¥ª_ty³2
;

332 
»wr™e_”¥ª_ty³3
;

333 
»wr™e_”¥ª_ty³3_¶©fÜm_¥ecific
;

334 
»wr™e_”¥ª_ty³2_w™h_vÏn
;

335 
»wr™e_”¥ª_ty³3_w™h_vÏn
;

336 
»wr™e_”¥ª_ty³3_¶©fÜm_¥ecific_w™h_vÏn
;

337 
»wr™e_d‹l_»pÜt_w™h_’Œİy
;

338 
»wr™e_d‹l_»pÜt_w™hout_’Œİy
;

341 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

342 
size
 = 
bË_size
;

346 
aùiÚ
 
	`adju¡_Ëngth
(
b™
<16> 
Ëngth_off£t
) {

347 
eg_md
.
pkt_Ëngth
 =ƒg_md.pkt_Ëngth + 
Ëngth_off£t
;

348 
eg_md
.
mœrÜ
.
ty³
 = 
SWITCH_MIRROR_TYPE_INVALID
;

351 
bË
 
pkt_Ëngth
 {

352 
key
 = { 
eg_md
.
mœrÜ
.
ty³
 : 
exaù
; }

353 
aùiÚs
 = { 
adju¡_Ëngth
; }

354 cÚ¡ 
’Œ›s
 = {

355 
SWITCH_MIRROR_TYPE_PORT
 : 
	`adju¡_Ëngth
(-14);

356 
SWITCH_MIRROR_TYPE_CPU
 : 
	`adju¡_Ëngth
(-14);

357 #ià
__TARGET_TOFINO__
 == 1

358 
SWITCH_MIRROR_TYPE_DTEL_DROP
 : 
	`adju¡_Ëngth
(-13);

359 
SWITCH_MIRROR_TYPE_DTEL_SWITCH_LOCAL
 : 
	`adju¡_Ëngth
(-15);

361 
SWITCH_MIRROR_TYPE_DTEL_DROP
 : 
	`adju¡_Ëngth
(-12);

362 
SWITCH_MIRROR_TYPE_DTEL_SWITCH_LOCAL
 : 
	`adju¡_Ëngth
(-14);

367 
­¶y
 {

368 #ià
	`defšed
(
MIRROR_ENABLE
)

369 ià(
eg_md
.
pkt_¤c
 !ğ
SWITCH_PKT_SRC_BRIDGED
) {

370 #ifdeà
PACKET_LENGTH_ADJUSTMENT


371 
pkt_Ëngth
.
	`­¶y
();

373 
»wr™e
.
	`­¶y
();

377 
	}
}

379 
cÚŒŞ
 
	$Rewr™e
(
šout
 
sw™ch_h—d”_t
 
hdr
,

380 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

381 
sw™ch_ušt32_t
 
Ãxthİ_bË_size
,

382 
sw™ch_ušt32_t
 
bd_bË_size
) {

383 
	`Eg»ssBd
(
bd_bË_size
è
eg»ss_bd
;

384 
sw™ch_smac_šdex_t
 
smac_šdex
;

386 
aùiÚ
 
	`»wr™e_l2_w™h_tuÂ–
(
sw™ch_tuÂ–_ty³_t
 
ty³
) {

387 #ifdeà
TUNNEL_ENABLE


388 
eg_md
.
æags
.
rou‹d
 = 
çl£
;

389 
eg_md
.
tuÂ–
.
ty³
 =ype;

393 
aùiÚ
 
	`»wr™e_l3
(
sw™ch_bd_t
 
bd
, 
mac_addr_t
 
dmac
) {

394 
eg_md
.
æags
.
rou‹d
 = 
Œue
;

395 
hdr
.
‘h”Ãt
.
d¡_addr
 = 
dmac
;

396 
eg_md
.
bd
 = bd;

399 
aùiÚ
 
	`»wr™e_l3_w™h_tuÂ–_id
(

400 
mac_addr_t
 
dmac
, 
sw™ch_tuÂ–_ty³_t
 
ty³
, 
sw™ch_tuÂ–_id_t
 
id
) {

401 #ifdeà
TUNNEL_ENABLE


402 
eg_md
.
æags
.
rou‹d
 = 
Œue
;

403 
hdr
.
‘h”Ãt
.
d¡_addr
 = 
dmac
;

404 
eg_md
.
bd
 = 
SWITCH_BD_DEFAULT_VRF
;

405 
eg_md
.
tuÂ–
.
ty³
 =ype;

406 
eg_md
.
tuÂ–
.
id
 = id;

410 
aùiÚ
 
	`»wr™e_l3_w™h_tuÂ–_bd
(
mac_addr_t
 
dmac
, 
sw™ch_tuÂ–_ty³_t
 
ty³
, 
sw™ch_bd_t
 
bd
) {

411 #ifdeà
TUNNEL_ENABLE


412 
eg_md
.
æags
.
rou‹d
 = 
Œue
;

413 
hdr
.
‘h”Ãt
.
d¡_addr
 = 
dmac
;

414 
eg_md
.
bd
 = bd;

415 
eg_md
.
tuÂ–
.
ty³
 =ype;

419 
aùiÚ
 
	`»wr™e_l3_w™h_tuÂ–
(
mac_addr_t
 
dmac
, 
sw™ch_tuÂ–_ty³_t
 
ty³
) {

420 #ifdeà
TUNNEL_ENABLE


421 
eg_md
.
æags
.
rou‹d
 = 
Œue
;

422 
hdr
.
‘h”Ãt
.
d¡_addr
 = 
dmac
;

423 
eg_md
.
tuÂ–
.
ty³
 =ype;

424 
eg_md
.
bd
 = (
sw™ch_bd_t
èeg_md.
vrf
;

428 
bË
 
Ãxthİ_»wr™e
 {

429 
key
 = { 
eg_md
.
Ãxthİ
 : 
exaù
; }

430 
aùiÚs
 = {

431 
NoAùiÚ
;

432 
»wr™e_l2_w™h_tuÂ–
;

433 
»wr™e_l3
;

434 
»wr™e_l3_w™h_tuÂ–
;

435 
»wr™e_l3_w™h_tuÂ–_bd
;

436 
»wr™e_l3_w™h_tuÂ–_id
;

439 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

440 
size
 = 
Ãxthİ_bË_size
;

443 
aùiÚ
 
	`»wr™e_smac
(
mac_addr_t
 
smac
) {

444 
hdr
.
‘h”Ãt
.
¤c_addr
 = 
smac
;

447 
bË
 
smac_»wr™e
 {

448 
key
 = { 
smac_šdex
 : 
exaù
; }

449 
aùiÚs
 = {

450 
NoAùiÚ
;

451 
»wr™e_smac
;

454 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

458 
aùiÚ
 
	`»wr™e_v4_muÉiÿ¡
() {

465 
aùiÚ
 
	`»wr™e_v6_muÉiÿ¡
() {

470 
bË
 
muÉiÿ¡_»wr™e
 {

471 
key
 = {

472 
hdr
.
v4
.
	`isV®id
(è: 
exaù
;

473 
hdr
.
v4
.
d¡_addr
[31:28] : 
‹º¬y
;

478 
aùiÚs
 = {

479 
NoAùiÚ
;

480 
»wr™e_v4_muÉiÿ¡
;

481 
»wr™e_v6_muÉiÿ¡
;

484 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

488 
aùiÚ
 
	`»wr™e_v4
() {

489 
hdr
.
v4
.
‰l
 = hdr.ipv4.ttl - 1;

492 
aùiÚ
 
	`»wr™e_v6
() {

493 #ifdeà
IPV6_ENABLE


494 
hdr
.
v6
.
hİ_lim™
 = hdr.ipv6.hop_limit - 1;

498 
bË
 
_»wr™e
 {

499 
key
 = {

500 
hdr
.
v4
.
	`isV®id
(è: 
exaù
;

501 
hdr
.
v6
.
	`isV®id
(è: 
exaù
;

504 
aùiÚs
 = {

505 
»wr™e_v4
;

506 
»wr™e_v6
;

509 cÚ¡ 
’Œ›s
 = {

510 (
Œue
, 
çl£
è: 
	`»wr™e_v4
();

511 (
çl£
, 
Œue
è: 
	`»wr™e_v6
();

515 
­¶y
 {

516 
smac_šdex
 = 0;

519 ià(!
	`EGRESS_BYPASS
(
REWRITE
)) {

520 
Ãxthİ_»wr™e
.
	`­¶y
();

523 
eg»ss_bd
.
	`­¶y
(
hdr
, 
eg_md
.
bd
,ƒg_md.
pkt_ty³
,ƒg_md.
pkt_¤c
,

524 
eg_md
.
bd_Ïb–
, 
smac_šdex
,ƒg_md.
checks
.
mtu
);

526 ià(!
	`EGRESS_BYPASS
(
REWRITE
è&& 
eg_md
.
æags
.
rou‹d
) {

527 
_»wr™e
.
	`­¶y
();

528 
smac_»wr™e
.
	`­¶y
();

531 
	}
}

	@shared/table_sizes.p4

23 #iâdeà
_P4_TABLE_SIZE_


24 
	#_P4_TABLE_SIZE_


	)

26 cÚ¡ 
	gb™
<32> 
	gPORT_TABLE_SIZE
 = 288 * 2;

29 cÚ¡ 
	gb™
<32> 
	gVLAN_TABLE_SIZE
 = 4096;

30 cÚ¡ 
	gb™
<32> 
	gBD_FLOOD_TABLE_SIZE
 = 
VLAN_TABLE_SIZE
 * 4;

33 cÚ¡ 
	gb™
<32> 
	gPORT_VLAN_TABLE_SIZE
 = 1024;

36 cÚ¡ 
	gb™
<32> 
	gDOUBLE_TAG_TABLE_SIZE
 = 4096;

39 cÚ¡ 
	gb™
<32> 
	gBD_TABLE_SIZE
 = 5120;

42 #ià
__TARGET_TOFINO__
 == 2

43 cÚ¡ 
	gb™
<32> 
	gMAC_TABLE_SIZE
 = 65536;

45 cÚ¡ 
	gb™
<32> 
	gMAC_TABLE_SIZE
 = 16384;

48 #ià
__TARGET_TOFINO__
 == 2

50 cÚ¡ 
	gb™
<32> 
	gIPV4_LPM_TABLE_SIZE
 = 131072;

51 cÚ¡ 
	gb™
<32> 
	gIPV6_LPM_TABLE_SIZE
 = 32768;

52 cÚ¡ 
	gb™
<32> 
	gIPV4_HOST_TABLE_SIZE
 = 65536;

53 cÚ¡ 
	gb™
<32> 
	gIPV6_HOST_TABLE_SIZE
 = 65536;

55 cÚ¡ 
	gb™
<32> 
	gIPV4_MULTICAST_STAR_G_TABLE_SIZE
 = 2048;

56 cÚ¡ 
	gb™
<32> 
	gIPV4_MULTICAST_S_G_TABLE_SIZE
 = 8192;

57 cÚ¡ 
	gb™
<32> 
	gIPV6_MULTICAST_STAR_G_TABLE_SIZE
 = 1024;

58 cÚ¡ 
	gb™
<32> 
	gIPV6_MULTICAST_S_G_TABLE_SIZE
 = 1024;

59 cÚ¡ 
	gb™
<32> 
	gRID_TABLE_SIZE
 = 32768;

62 cÚ¡ 
	gb™
<32> 
	gIPV4_LPM_TABLE_SIZE
 = 16384;

63 cÚ¡ 
	gb™
<32> 
	gIPV6_LPM_TABLE_SIZE
 = 1024;

64 cÚ¡ 
	gb™
<32> 
	gIPV4_HOST_TABLE_SIZE
 = 32768;

65 cÚ¡ 
	gb™
<32> 
	gIPV6_HOST_TABLE_SIZE
 = 8192;

67 cÚ¡ 
	gb™
<32> 
	gIPV4_MULTICAST_STAR_G_TABLE_SIZE
 = 2048;

68 cÚ¡ 
	gb™
<32> 
	gIPV4_MULTICAST_S_G_TABLE_SIZE
 = 4096;

69 cÚ¡ 
	gb™
<32> 
	gIPV6_MULTICAST_STAR_G_TABLE_SIZE
 = 512;

70 cÚ¡ 
	gb™
<32> 
	gIPV6_MULTICAST_S_G_TABLE_SIZE
 = 512;

71 cÚ¡ 
	gb™
<32> 
	gRID_TABLE_SIZE
 = 4096;

75 cÚ¡ 
	gb™
<32> 
	gDEST_TUNNEL_TABLE_SIZE
 = 512;

76 cÚ¡ 
	gb™
<32> 
	gIPV4_SRC_TUNNEL_TABLE_SIZE
 = 4096;

77 cÚ¡ 
	gb™
<32> 
	gIPV6_SRC_TUNNEL_TABLE_SIZE
 = 1024;

78 cÚ¡ 
	gb™
<32> 
	gVNI_MAPPING_TABLE_SIZE
 = 4096;

79 cÚ¡ 
	gb™
<32> 
	gTUNNEL_SRC_REWRITE_TABLE_SIZE
 = 512;

80 cÚ¡ 
	gb™
<32> 
	gTUNNEL_DST_REWRITE_TABLE_SIZE
 = 4096;

81 cÚ¡ 
	gb™
<32> 
	gTUNNEL_SMAC_REWRITE_TABLE_SIZE
 = 512;

82 cÚ¡ 
	gb™
<32> 
	gTUNNEL_DMAC_REWRITE_TABLE_SIZE
 = 4096;

83 cÚ¡ 
	gb™
<32> 
	gTUNNEL_REWRITE_TABLE_SIZE
 = 512;

86 cÚ¡ 
	gb™
<32> 
	gECMP_GROUP_TABLE_SIZE
 = 1024;

87 cÚ¡ 
	gb™
<32> 
	gOUTER_ECMP_GROUP_TABLE_SIZE
 = 4096;

88 cÚ¡ 
	gb™
<32> 
	gECMP_SELECT_TABLE_SIZE
 = 16384;

89 #ià
__TARGET_TOFINO__
 == 2

90 cÚ¡ 
	gb™
<32> 
	gNEXTHOP_TABLE_SIZE
 = 65536;

92 cÚ¡ 
	gb™
<32> 
	gNEXTHOP_TABLE_SIZE
 = 32768;

94 cÚ¡ 
	gb™
<32> 
	gOUTER_NEXTHOP_TABLE_SIZE
 = 4096;

97 #ià
__TARGET_TOFINO__
 == 2

98 cÚ¡ 
	gb™
<32> 
	gINGRESS_MAC_ACL_TABLE_SIZE
 = 512;

99 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_ACL_TABLE_SIZE
 = 4096;

100 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_ACL_TABLE_SIZE
 = 1024;

101 cÚ¡ 
	gb™
<32> 
	gINGRESS_MIRROR_ACL_TABLE_SIZE
 = 512;

102 cÚ¡ 
	gb™
<32> 
	gINGRESS_MAC_QOS_ACL_TABLE_SIZE
 = 512;

103 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_QOS_ACL_TABLE_SIZE
 = 512;

104 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_QOS_ACL_TABLE_SIZE
 = 512;

106 cÚ¡ 
	gb™
<32> 
	gINGRESS_L4_PORT_LOU_TABLE_SIZE
 = 
sw™ch_l4_pÜt_Ïb–_width
 / 2;

108 cÚ¡ 
	gb™
<32> 
	gIPV4_RACL_TABLE_SIZE
 = 512;

109 cÚ¡ 
	gb™
<32> 
	gIPV6_RACL_TABLE_SIZE
 = 512;

112 cÚ¡ 
	gb™
<32> 
	gINGRESS_MAC_ACL_TABLE_SIZE
 = 512;

113 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_ACL_TABLE_SIZE
 = 512;

114 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

115 cÚ¡ 
	gb™
<32> 
	gINGRESS_MIRROR_ACL_TABLE_SIZE
 = 512;

116 cÚ¡ 
	gb™
<32> 
	gINGRESS_MAC_QOS_ACL_TABLE_SIZE
 = 512;

117 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_QOS_ACL_TABLE_SIZE
 = 512;

118 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_QOS_ACL_TABLE_SIZE
 = 512;

120 cÚ¡ 
	gb™
<32> 
	gINGRESS_L4_PORT_LOU_TABLE_SIZE
 = 
sw™ch_l4_pÜt_Ïb–_width
 / 2;

122 cÚ¡ 
	gb™
<32> 
	gIPV4_RACL_TABLE_SIZE
 = 512;

123 cÚ¡ 
	gb™
<32> 
	gIPV6_RACL_TABLE_SIZE
 = 512;

127 cÚ¡ 
	gb™
<32> 
	gEGRESS_MAC_ACL_TABLE_SIZE
 = 512;

128 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV4_ACL_TABLE_SIZE
 = 512;

129 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

132 cÚ¡ 
	gb™
<32> 
	gWRED_SIZE
 = 1 << 
sw™ch_w»d_šdex_width
;

135 cÚ¡ 
	gb™
<32> 
	gCOPP_METER_SIZE
 = 1 << 
sw™ch_cİp_m‘”_id_width
;

136 cÚ¡ 
	gb™
<32> 
	gCOPP_DROP_TABLE_SIZE
 = 1 << (
sw™ch_cİp_m‘”_id_width
 + 1);

139 cÚ¡ 
	gb™
<32> 
	gDSCP_TO_TC_TABLE_SIZE
 = 1024;

140 cÚ¡ 
	gb™
<32> 
	gPCP_TO_TC_TABLE_SIZE
 = 1024;

141 cÚ¡ 
	gb™
<32> 
	gQUEUE_TABLE_SIZE
 = 1024;

142 cÚ¡ 
	gb™
<32> 
	gEGRESS_QOS_MAP_TABLE_SIZE
 = 1024;

145 cÚ¡ 
	gb™
<32> 
	gINGRESS_POLICER_TABLE_SIZE
 = 1 << 
sw™ch_pŞiûr_m‘”_šdex_width
;

148 cÚ¡ 
	gb™
<32> 
	gSTORM_CONTROL_TABLE_SIZE
 = 512;

151 cÚ¡ 
	gb™
<32> 
	gINGRESS_SYSTEM_ACL_TABLE_SIZE
 = 512;

152 cÚ¡ 
	gb™
<32> 
	gEGRESS_SYSTEM_ACL_TABLE_SIZE
 = 512;

153 cÚ¡ 
	gb™
<32> 
	gDROP_STATS_TABLE_SIZE
 = 1 << 
sw™ch_drİ_»asÚ_width
;

155 cÚ¡ 
	gb™
<32> 
	gL3_MTU_TABLE_SIZE
 = 1024;

	@shared/tunnel.p4

23 #ià
defšed
(
IPV6_TUNNEL_ENABLE
è&& !defšed(
IPV6_ENABLE
)

32 
cÚŒŞ
 
	$Ing»ssTuÂ–
(
š
 
sw™ch_h—d”_t
 
hdr
,

33 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

34 
šout
 
sw™ch_lookup_f›lds_t
 
lkp
)(

35 
sw™ch_ušt32_t
 
v4_¤c_v‹p_bË_size
=1024,

36 
sw™ch_ušt32_t
 
v6_¤c_v‹p_bË_size
=1024,

37 
sw™ch_ušt32_t
 
v4_d¡_v‹p_bË_size
=1024,

38 
sw™ch_ušt32_t
 
v6_d¡_v‹p_bË_size
=1024,

39 
sw™ch_ušt32_t
 
vni_m­pšg_bË_size
=1024) {

40 
	`IÂ”PktV®id©iÚ
(è
pkt_v®id©iÚ
;

42 
aùiÚ
 
	`rmac_h™
() { }

44 
bË
 
rmac
 {

45 
key
 = {

46 
ig_md
.
rmac_group
 : 
exaù
;

47 
lkp
.
mac_d¡_addr
 : 
exaù
;

50 
aùiÚs
 = {

51 
NoAùiÚ
;

52 
rmac_h™
;

55 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

56 
size
 = 1024;

59 
aùiÚ
 
	`¤c_v‹p_h™
(
sw™ch_ifšdex_t
 
ifšdex
) {

60 
ig_md
.
tuÂ–
.
ifšdex
 = ifindex;

63 
aùiÚ
 
	`¤c_v‹p_miss
() {}

65 
bË
 
¤c_v‹p
 {

66 
key
 = {

67 
lkp
.
_¤c_addr
[31:0] : 
exaù
 @
	`Çme
("src_addr");

68 
ig_md
.
vrf
 : 
exaù
;

69 
ig_md
.
tuÂ–
.
ty³
 : 
exaù
;

72 
aùiÚs
 = {

73 
¤c_v‹p_miss
;

74 
¤c_v‹p_h™
;

77 cÚ¡ 
deçuÉ_aùiÚ
 = 
¤c_v‹p_miss
;

78 
size
 = 
v4_¤c_v‹p_bË_size
;

81 
bË
 
¤c_v‹pv6
 {

82 
key
 = {

83 
lkp
.
_¤c_addr
 : 
exaù
 @
	`Çme
("src_addr");

84 
ig_md
.
vrf
 : 
exaù
;

85 
ig_md
.
tuÂ–
.
ty³
 : 
exaù
;

88 
aùiÚs
 = {

89 
¤c_v‹p_miss
;

90 
¤c_v‹p_h™
;

93 cÚ¡ 
deçuÉ_aùiÚ
 = 
¤c_v‹p_miss
;

94 
size
 = 
v6_¤c_v‹p_bË_size
;

97 
aùiÚ
 
	`d¡_v‹p_h™
() {}

100 
aùiÚ
 
	`£t_vni_´İ”t›s
(

101 
sw™ch_bd_t
 
bd
,

102 
sw™ch_vrf_t
 
vrf
,

103 
sw™ch_bd_Ïb–_t
 
bd_Ïb–
,

104 
sw™ch_rid_t
 
rid
,

105 
sw™ch_Ë¬nšg_mode_t
 
Ë¬nšg_mode
,

106 
boŞ
 
v4_uniÿ¡_’abË
,

107 
boŞ
 
v4_muÉiÿ¡_’abË
,

108 
boŞ
 
igmp_¢oİšg_’abË
,

109 
boŞ
 
v6_uniÿ¡_’abË
,

110 
boŞ
 
v6_muÉiÿ¡_’abË
,

111 
boŞ
 
mld_¢oİšg_’abË
,

112 
sw™ch_muÉiÿ¡_½f_group_t
 
m½f_group
,

113 
sw™ch_rmac_group_t
 
rmac_group
) {

114 
ig_md
.
bd
 = bd;

115 
ig_md
.
bd_Ïb–
 = bd_label;

116 
ig_md
.
vrf
 = vrf;

119 
ig_md
.
rmac_group
 =„mac_group;

120 
ig_md
.
muÉiÿ¡
.
½f_group
 = 
m½f_group
;

121 
ig_md
.
Ë¬nšg
.
bd_mode
 = 
Ë¬nšg_mode
;

122 
ig_md
.
v4
.
uniÿ¡_’abË
 = 
v4_uniÿ¡_’abË
;

123 
ig_md
.
v4
.
muÉiÿ¡_’abË
 = 
v4_muÉiÿ¡_’abË
;

124 
ig_md
.
v4
.
muÉiÿ¡_¢oİšg
 = 
igmp_¢oİšg_’abË
;

125 
ig_md
.
v6
.
uniÿ¡_’abË
 = 
v4_uniÿ¡_’abË
;

126 
ig_md
.
v6
.
muÉiÿ¡_’abË
 = 
v6_muÉiÿ¡_’abË
;

127 
ig_md
.
v6
.
muÉiÿ¡_¢oİšg
 = 
mld_¢oİšg_’abË
;

128 
ig_md
.
tuÂ–
.
‹rmš©e
 = 
Œue
;

131 
bË
 
d¡_v‹p
 {

132 
key
 = {

133 
lkp
.
_¤c_addr
[31:0] : 
‹º¬y
 @
	`Çme
("src_addr");

134 
lkp
.
_d¡_addr
[31:0] : 
‹º¬y
 @
	`Çme
("dst_addr");

135 
ig_md
.
vrf
 : 
exaù
;

136 
ig_md
.
tuÂ–
.
ty³
 : 
exaù
;

139 
aùiÚs
 = {

140 
NoAùiÚ
;

141 
d¡_v‹p_h™
;

142 
£t_vni_´İ”t›s
;

145 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

148 
bË
 
d¡_v‹pv6
 {

149 
key
 = {

150 
lkp
.
_¤c_addr
 : 
‹º¬y
 @
	`Çme
("src_addr");

151 
lkp
.
_d¡_addr
 : 
‹º¬y
 @
	`Çme
("dst_addr");

152 
ig_md
.
vrf
 : 
exaù
;

153 
ig_md
.
tuÂ–
.
ty³
 : 
exaù
;

156 
aùiÚs
 = {

157 
NoAùiÚ
;

158 
d¡_v‹p_h™
;

159 
£t_vni_´İ”t›s
;

162 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

166 
bË
 
vni_to_bd_m­pšg
 {

167 
key
 = { 
ig_md
.
tuÂ–
.
id
 : 
exaù
; }

169 
aùiÚs
 = {

170 
NoAùiÚ
;

171 
£t_vni_´İ”t›s
;

174 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

175 
size
 = 
vni_m­pšg_bË_size
;

178 
­¶y
 {

179 #ifdeà
TUNNEL_ENABLE


181 
rmac
.
	`­¶y
().
aùiÚ_run
) {

182 
rmac_h™
 : {

183 ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV4
) {

185 
d¡_v‹p
.
	`­¶y
().
aùiÚ_run
) {

186 
d¡_v‹p_h™
 : {

188 
vni_to_bd_m­pšg
.
	`­¶y
();

189 
pkt_v®id©iÚ
.
	`­¶y
(
hdr
, 
lkp
, 
ig_md
.
æags
, ig_md.
drİ_»asÚ
);

192 
£t_vni_´İ”t›s
 : {

194 
pkt_v®id©iÚ
.
	`­¶y
(
hdr
, 
lkp
, 
ig_md
.
æags
, ig_md.
drİ_»asÚ
);

197 } ià(
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_IPV6
) {

198 #ifdeà
IPV6_TUNNEL_ENABLE


200 
d¡_v‹pv6
.
	`­¶y
().
aùiÚ_run
) {

201 
d¡_v‹p_h™
 : {

203 
vni_to_bd_m­pšg
.
	`­¶y
();

204 
pkt_v®id©iÚ
.
	`­¶y
(
hdr
, 
lkp
, 
ig_md
.
æags
, ig_md.
drİ_»asÚ
);

207 
£t_vni_´İ”t›s
 : {

209 
pkt_v®id©iÚ
.
	`­¶y
(
hdr
, 
lkp
, 
ig_md
.
æags
, ig_md.
drİ_»asÚ
);

218 
	}
}

230 
cÚŒŞ
 
	$TuÂ–Deÿp
(
šout
 
sw™ch_h—d”_t
 
hdr
,

231 
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

232 
sw™ch_tuÂ–_mode_t
 
mode
) {

233 
aùiÚ
 
	`deÿp_šÃr_udp
() {

234 
hdr
.
udp
 = hdr.
šÃr_udp
;

235 
hdr
.
šÃr_udp
.
	`£tInv®id
();

238 
aùiÚ
 
	`deÿp_šÃr_tı
() {

239 
hdr
.
tı
 = hdr.
šÃr_tı
;

240 
hdr
.
šÃr_tı
.
	`£tInv®id
();

241 
hdr
.
udp
.
	`£tInv®id
();

244 
aùiÚ
 
	`deÿp_šÃr_unknown
() {

245 
hdr
.
udp
.
	`£tInv®id
();

248 
bË
 
deÿp_šÃr_l4
 {

249 
key
 = { 
hdr
.
šÃr_udp
.
	`isV®id
(è: 
exaù
; }

250 
aùiÚs
 = {

251 
deÿp_šÃr_udp
;

252 
deÿp_šÃr_unknown
;

255 cÚ¡ 
deçuÉ_aùiÚ
 = 
deÿp_šÃr_unknown
;

256 cÚ¡ 
’Œ›s
 = {

257 (
Œue
è: 
	`deÿp_šÃr_udp
();

261 
aùiÚ
 
	`cİy_v4_h—d”
() {

262 
hdr
.
v4
.
	`£tV®id
();

263 
hdr
.
v4
.
v”siÚ
 = hdr.
šÃr_v4
.version;

264 
hdr
.
v4
.
ihl
 = hdr.
šÃr_v4
.ihl;

265 
hdr
.
v4
.
tÙ®_Ën
 = hdr.
šÃr_v4
.total_len;

266 
hdr
.
v4
.
id’tifiÿtiÚ
 = hdr.
šÃr_v4
.identification;

267 
hdr
.
v4
.
æags
 = hdr.
šÃr_v4
.flags;

268 
hdr
.
v4
.
äag_off£t
 = hdr.
šÃr_v4
.frag_offset;

269 
hdr
.
v4
.
´ÙocŞ
 = hdr.
šÃr_v4
.protocol;

271 
hdr
.
v4
.
¤c_addr
 = hdr.
šÃr_v4
.src_addr;

272 
hdr
.
v4
.
d¡_addr
 = hdr.
šÃr_v4
.dst_addr;

274 ià(
mode
 =ğ
sw™ch_tuÂ–_mode_t
.
UNIFORM
) {

276 } ià(
mode
 =ğ
sw™ch_tuÂ–_mode_t
.
PIPE
) {

277 
hdr
.
v4
.
‰l
 = hdr.
šÃr_v4
.ttl;

278 
hdr
.
v4
.
diff£rv
 = hdr.
šÃr_v4
.diffserv;

281 
hdr
.
šÃr_v4
.
	`£tInv®id
();

284 
aùiÚ
 
	`cİy_v6_h—d”
() {

285 
hdr
.
v6
.
	`£tV®id
();

286 
hdr
.
v6
.
v”siÚ
 = hdr.
šÃr_v6
.version;

287 
hdr
.
v6
.
æow_Ïb–
 = hdr.
šÃr_v6
.flow_label;

288 
hdr
.
v6
.
·ylßd_Ën
 = hdr.
šÃr_v6
.payload_len;

289 
hdr
.
v6
.
Ãxt_hdr
 = hdr.
šÃr_v6
.next_hdr;

290 
hdr
.
v6
.
¤c_addr
 = hdr.
šÃr_v6
.src_addr;

291 
hdr
.
v6
.
d¡_addr
 = hdr.
šÃr_v6
.dst_addr;

293 ià(
mode
 =ğ
sw™ch_tuÂ–_mode_t
.
UNIFORM
) {

295 } ià(
mode
 =ğ
sw™ch_tuÂ–_mode_t
.
PIPE
) {

296 
hdr
.
v6
.
hİ_lim™
 = hdr.
šÃr_v6
.hop_limit;

297 
hdr
.
v6
.
Œaffic_şass
 = hdr.
šÃr_v6
.traffic_class;

300 
hdr
.
šÃr_v6
.
	`£tInv®id
();

303 
aùiÚ
 
	`šv®id©e_tuÂ–šg_h—d”s
() {

305 
hdr
.
vxÏn
.
	`£tInv®id
();

308 
aùiÚ
 
	`deÿp_šÃr_‘h”Ãt_v4
() {

309 
hdr
.
‘h”Ãt
 = hdr.
šÃr_‘h”Ãt
;

310 
	`cİy_v4_h—d”
();

311 
hdr
.
v6
.
	`£tInv®id
();

312 
hdr
.
šÃr_‘h”Ãt
.
	`£tInv®id
();

313 
	`šv®id©e_tuÂ–šg_h—d”s
();

316 
aùiÚ
 
	`deÿp_šÃr_‘h”Ãt_v6
() {

317 #ifdeà
IPV6_TUNNEL_ENABLE


318 
hdr
.
‘h”Ãt
 = hdr.
šÃr_‘h”Ãt
;

319 
	`cİy_v6_h—d”
();

320 
hdr
.
v4
.
	`£tInv®id
();

321 
hdr
.
šÃr_‘h”Ãt
.
	`£tInv®id
();

322 
	`šv®id©e_tuÂ–šg_h—d”s
();

326 
aùiÚ
 
	`deÿp_šÃr_‘h”Ãt_nÚ_
() {

327 
hdr
.
‘h”Ãt
 = hdr.
šÃr_‘h”Ãt
;

328 
hdr
.
v4
.
	`£tInv®id
();

329 
hdr
.
v6
.
	`£tInv®id
();

330 
hdr
.
šÃr_‘h”Ãt
.
	`£tInv®id
();

331 
	`šv®id©e_tuÂ–šg_h—d”s
();

334 
aùiÚ
 
	`deÿp_šÃr_v4
() {

335 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_IPV4
;

336 
	`cİy_v4_h—d”
();

337 
hdr
.
v6
.
	`£tInv®id
();

338 
	`šv®id©e_tuÂ–šg_h—d”s
();

341 
aùiÚ
 
	`deÿp_šÃr_v6
() {

342 #ifdeà
IPV6_TUNNEL_ENABLE


343 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_IPV6
;

344 
	`cİy_v6_h—d”
();

345 
hdr
.
v4
.
	`£tInv®id
();

346 
	`šv®id©e_tuÂ–šg_h—d”s
();

350 
bË
 
deÿp_šÃr_
 {

351 
key
 = {

352 
hdr
.
šÃr_‘h”Ãt
.
	`isV®id
(è: 
exaù
;

353 
hdr
.
šÃr_v4
.
	`isV®id
(è: 
exaù
;

354 
hdr
.
šÃr_v6
.
	`isV®id
(è: 
exaù
;

357 
aùiÚs
 = {

358 
deÿp_šÃr_‘h”Ãt_v4
;

359 
deÿp_šÃr_‘h”Ãt_v6
;

360 
deÿp_šÃr_‘h”Ãt_nÚ_
;

361 
deÿp_šÃr_v4
;

362 
deÿp_šÃr_v6
;

365 cÚ¡ 
’Œ›s
 = {

366 (
Œue
,rue, 
çl£
è: 
	`deÿp_šÃr_‘h”Ãt_v4
();

367 (
Œue
, 
çl£
,rueè: 
	`deÿp_šÃr_‘h”Ãt_v6
();

368 (
Œue
, 
çl£
, f®£è: 
	`deÿp_šÃr_‘h”Ãt_nÚ_
();

369 (
çl£
, 
Œue
, f®£è: 
	`deÿp_šÃr_v4
();

370 (
çl£
, f®£, 
Œue
è: 
	`deÿp_šÃr_v6
();

374 
­¶y
 {

375 #ifdeà
TUNNEL_ENABLE


377 ià(!
	`EGRESS_BYPASS
(
REWRITE
è&& 
eg_md
.
tuÂ–
.
‹rmš©e
)

378 
deÿp_šÃr_
.
	`­¶y
();

381 ià(!
	`EGRESS_BYPASS
(
REWRITE
è&& 
eg_md
.
tuÂ–
.
‹rmš©e
)

382 
deÿp_šÃr_l4
.
	`­¶y
();

385 
	}
}

387 
cÚŒŞ
 
	$TuÂ–Rewr™e
(
šout
 
sw™ch_h—d”_t
 
hdr
,

388 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

389 
sw™ch_ušt32_t
 
v4_d¡_addr_»wr™e_bË_size
=1024,

390 
sw™ch_ušt32_t
 
v6_d¡_addr_»wr™e_bË_size
=1024,

391 
sw™ch_ušt32_t
 
Ãxthİ_»wr™e_bË_size
=512,

392 
sw™ch_ušt32_t
 
¤c_addr_»wr™e_bË_size
=1024,

393 
sw™ch_ušt32_t
 
smac_»wr™e_bË_size
=1024) {

395 
	`Eg»ssBd
(
BD_TABLE_SIZE
è
eg»ss_bd
;

396 
sw™ch_bd_Ïb–_t
 
bd_Ïb–
;

397 
sw™ch_smac_šdex_t
 
smac_šdex
;

400 
aùiÚ
 
	`»wr™e_tuÂ–
(
sw™ch_bd_t
 
bd
, 
mac_addr_t
 
dmac
) {

401 
eg_md
.
bd
 = bd;

402 
hdr
.
‘h”Ãt
.
d¡_addr
 = 
dmac
;

405 
bË
 
Ãxthİ_»wr™e
 {

406 
key
 = {

407 
eg_md
.
ou‹r_Ãxthİ
 : 
exaù
;

410 
aùiÚs
 = {

411 
NoAùiÚ
;

412 
»wr™e_tuÂ–
;

415 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

416 
size
 = 
Ãxthİ_»wr™e_bË_size
;

420 
aùiÚ
 
	`»wr™e_v4_¤c
(
v4_addr_t
 
¤c_addr
) {

421 
hdr
.
v4
.
¤c_addr
 = src_addr;

424 
aùiÚ
 
	`»wr™e_v6_¤c
(
v6_addr_t
 
¤c_addr
) {

425 #ifdeà
IPV6_TUNNEL_ENABLE


426 
hdr
.
v6
.
¤c_addr
 = src_addr;

430 
bË
 
¤c_addr_»wr™e
 {

431 
key
 = { 
eg_md
.
bd
 : 
exaù
; }

432 
aùiÚs
 = {

433 
»wr™e_v4_¤c
;

434 
»wr™e_v6_¤c
;

437 
size
 = 
¤c_addr_»wr™e_bË_size
;

441 
aùiÚ
 
	`»wr™e_v4_d¡
(
v4_addr_t
 
d¡_addr
) {

442 
hdr
.
v4
.
d¡_addr
 = dst_addr;

445 
aùiÚ
 
	`»wr™e_v6_d¡
(
v6_addr_t
 
d¡_addr
) {

446 
hdr
.
v6
.
d¡_addr
 = dst_addr;

449 
bË
 
v4_d¡_addr_»wr™e
 {

450 
key
 = { 
eg_md
.
tuÂ–
.
šdex
 : 
exaù
; }

451 
aùiÚs
 = { 
»wr™e_v4_d¡
; }

452 cÚ¡ 
deçuÉ_aùiÚ
 = 
	`»wr™e_v4_d¡
(0);

453 
size
 = 
v4_d¡_addr_»wr™e_bË_size
;

456 
bË
 
v6_d¡_addr_»wr™e
 {

457 
key
 = { 
eg_md
.
tuÂ–
.
šdex
 : 
exaù
; }

458 
aùiÚs
 = { 
»wr™e_v6_d¡
; }

459 cÚ¡ 
deçuÉ_aùiÚ
 = 
	`»wr™e_v6_d¡
(0);

460 
size
 = 
v6_d¡_addr_»wr™e_bË_size
;

464 
aùiÚ
 
	`»wr™e_smac
(
mac_addr_t
 
smac
) {

465 
hdr
.
‘h”Ãt
.
¤c_addr
 = 
smac
;

468 
bË
 
smac_»wr™e
 {

469 
key
 = { 
smac_šdex
 : 
exaù
; }

470 
aùiÚs
 = {

471 
NoAùiÚ
;

472 
»wr™e_smac
;

475 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

476 
size
 = 
smac_»wr™e_bË_size
;

479 
­¶y
 {

480 #ifdeà
TUNNEL_ENABLE


481 ià(
eg_md
.
tuÂ–
.
ty³
 !ğ
SWITCH_TUNNEL_TYPE_NONE
)

482 
Ãxthİ_»wr™e
.
	`­¶y
();

484 ià(
eg_md
.
tuÂ–
.
ty³
 !ğ
SWITCH_TUNNEL_TYPE_NONE
)

485 
eg»ss_bd
.
	`­¶y
(
hdr
, 
eg_md
.
bd
,ƒg_md.
pkt_ty³
,ƒg_md.
pkt_¤c
,

486 
bd_Ïb–
, 
smac_šdex
, 
eg_md
.
checks
.
mtu
);

488 ià(
eg_md
.
tuÂ–
.
ty³
 !ğ
SWITCH_TUNNEL_TYPE_NONE
)

489 
¤c_addr_»wr™e
.
	`­¶y
();

491 ià(
eg_md
.
tuÂ–
.
ty³
 !ğ
SWITCH_TUNNEL_TYPE_NONE
) {

492 ià(
hdr
.
v4
.
	`isV®id
()) {

493 
v4_d¡_addr_»wr™e
.
	`­¶y
();

494 } ià(
hdr
.
v6
.
	`isV®id
()) {

495 #ifdeà
IPV6_ENABLE


496 
v6_d¡_addr_»wr™e
.
	`­¶y
();

501 
smac_»wr™e
.
	`­¶y
();

504 
	}
}

519 
cÚŒŞ
 
	$TuÂ–Enÿp
(
šout
 
sw™ch_h—d”_t
 
hdr
,

520 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
)(

521 
sw™ch_tuÂ–_mode_t
 
mode
=sw™ch_tuÂ–_mode_t.
PIPE
,

522 
sw™ch_ušt32_t
 
vni_m­pšg_bË_size
=1024) {

523 
b™
<16> 
·ylßd_Ën
;

524 
b™
<8> 
_´Ùo
;

526 
aùiÚ
 
	`£t_vni
(
sw™ch_tuÂ–_id_t
 
id
) {

527 
eg_md
.
tuÂ–
.
id
 = id;

530 
bË
 
bd_to_vni_m­pšg
 {

531 
key
 = { 
eg_md
.
bd
 : 
exaù
; }

533 
aùiÚs
 = {

534 
NoAùiÚ
;

535 
£t_vni
;

538 
size
 = 
vni_m­pšg_bË_size
;

541 
aùiÚ
 
	`cİy_v4_h—d”
() {

543 
hdr
.
šÃr_v4
.
	`£tV®id
();

544 
hdr
.
šÃr_v4
.
v”siÚ
 = hdr.
v4
.version;

545 
hdr
.
šÃr_v4
.
ihl
 = hdr.
v4
.ihl;

546 
hdr
.
šÃr_v4
.
diff£rv
 = hdr.
v4
.diffserv;

547 
hdr
.
šÃr_v4
.
tÙ®_Ën
 = hdr.
v4
.total_len;

548 
hdr
.
šÃr_v4
.
id’tifiÿtiÚ
 = hdr.
v4
.identification;

549 
hdr
.
šÃr_v4
.
æags
 = hdr.
v4
.flags;

550 
hdr
.
šÃr_v4
.
äag_off£t
 = hdr.
v4
.frag_offset;

551 
hdr
.
šÃr_v4
.
‰l
 = hdr.
v4
.ttl;

552 
hdr
.
šÃr_v4
.
´ÙocŞ
 = hdr.
v4
.protocol;

554 
hdr
.
šÃr_v4
.
¤c_addr
 = hdr.
v4
.src_addr;

555 
hdr
.
šÃr_v4
.
d¡_addr
 = hdr.
v4
.dst_addr;

556 
hdr
.
v4
.
	`£tInv®id
();

559 
aùiÚ
 
	`cİy_v6_h—d”
() {

560 
hdr
.
šÃr_v6
.
v”siÚ
 = hdr.
v6
.version;

561 
hdr
.
šÃr_v6
.
æow_Ïb–
 = hdr.
v6
.flow_label;

562 
hdr
.
šÃr_v6
.
·ylßd_Ën
 = hdr.
v6
.payload_len;

563 
hdr
.
šÃr_v6
.
¤c_addr
 = hdr.
v6
.src_addr;

564 
hdr
.
šÃr_v6
.
d¡_addr
 = hdr.
v6
.dst_addr;

565 
hdr
.
šÃr_v6
.
hİ_lim™
 = hdr.
v6
.hop_limit;

566 
hdr
.
šÃr_v6
.
Œaffic_şass
 = hdr.
v6
.traffic_class;

567 
hdr
.
v6
.
	`£tInv®id
();

571 
aùiÚ
 
	`»wr™e_šÃr_v4_udp
() {

572 
·ylßd_Ën
 = 
hdr
.
v4
.
tÙ®_Ën
;

573 
	`cİy_v4_h—d”
();

574 
hdr
.
šÃr_udp
 = hdr.
udp
;

575 
hdr
.
udp
.
	`£tInv®id
();

576 
_´Ùo
 = 
IP_PROTOCOLS_IPV4
;

579 
aùiÚ
 
	`»wr™e_šÃr_v4_tı
() {

580 
·ylßd_Ën
 = 
hdr
.
v4
.
tÙ®_Ën
;

581 
	`cİy_v4_h—d”
();

582 
hdr
.
šÃr_tı
 = hdr.
tı
;

583 
hdr
.
tı
.
	`£tInv®id
();

584 
_´Ùo
 = 
IP_PROTOCOLS_IPV4
;

587 
aùiÚ
 
	`»wr™e_šÃr_v4_unknown
() {

588 
·ylßd_Ën
 = 
hdr
.
v4
.
tÙ®_Ën
;

589 
	`cİy_v4_h—d”
();

590 
_´Ùo
 = 
IP_PROTOCOLS_IPV4
;

593 
aùiÚ
 
	`»wr™e_šÃr_v6_udp
() {

594 #ifdeà
IPV6_TUNNEL_ENABLE


595 
·ylßd_Ën
 = 
hdr
.
v6
.·ylßd_ËÀ+ 16
w40
;

596 
hdr
.
šÃr_v6
 = hdr.
v6
;

597 
hdr
.
šÃr_udp
 = hdr.
udp
;

598 
hdr
.
udp
.
	`£tInv®id
();

599 
hdr
.
v6
.
	`£tInv®id
();

600 
_´Ùo
 = 
IP_PROTOCOLS_IPV6
;

604 
aùiÚ
 
	`»wr™e_šÃr_v6_tı
() {

605 #ifdeà
IPV6_TUNNEL_ENABLE


606 
·ylßd_Ën
 = 
hdr
.
v6
.·ylßd_ËÀ+ 16
w40
;

607 
hdr
.
šÃr_v6
 = hdr.
v6
;

608 
hdr
.
šÃr_tı
 = hdr.
tı
;

609 
hdr
.
tı
.
	`£tInv®id
();

610 
hdr
.
v6
.
	`£tInv®id
();

611 
_´Ùo
 = 
IP_PROTOCOLS_IPV6
;

615 
aùiÚ
 
	`»wr™e_šÃr_v6_unknown
() {

616 #ifdeà
IPV6_TUNNEL_ENABLE


617 
·ylßd_Ën
 = 
hdr
.
v6
.·ylßd_ËÀ+ 16
w40
;

618 
hdr
.
šÃr_v6
 = hdr.
v6
;

619 
hdr
.
v6
.
	`£tInv®id
();

620 
_´Ùo
 = 
IP_PROTOCOLS_IPV6
;

624 
bË
 
’ÿp_ou‹r
 {

625 
key
 = {

626 
hdr
.
v4
.
	`isV®id
(è: 
exaù
;

627 
hdr
.
v6
.
	`isV®id
(è: 
exaù
;

628 
hdr
.
udp
.
	`isV®id
(è: 
exaù
;

632 
aùiÚs
 = {

633 
»wr™e_šÃr_v4_udp
;

635 
»wr™e_šÃr_v4_unknown
;

636 
»wr™e_šÃr_v6_udp
;

638 
»wr™e_šÃr_v6_unknown
;

641 cÚ¡ 
’Œ›s
 = {

642 (
Œue
, 
çl£
, f®£è: 
	`»wr™e_šÃr_v4_unknown
();

643 (
çl£
, 
Œue
, f®£è: 
	`»wr™e_šÃr_v6_unknown
();

644 (
Œue
, 
çl£
,rueè: 
	`»wr™e_šÃr_v4_udp
();

645 (
çl£
, 
Œue
,rueè: 
	`»wr™e_šÃr_v6_udp
();

652 
aùiÚ
 
	`add_udp_h—d”
(
b™
<16> 
¤c_pÜt
, b™<16> 
d¡_pÜt
) {

653 
hdr
.
udp
.
	`£tV®id
();

654 
hdr
.
udp
.
¤c_pÜt
 = src_port;

655 
hdr
.
udp
.
d¡_pÜt
 = dst_port;

656 
hdr
.
udp
.
checksum
 = 0;

660 
aùiÚ
 
	`add_vxÏn_h—d”
(
b™
<24> 
vni
) {

661 #ifdeà
VXLAN_ENABLE


662 
hdr
.
vxÏn
.
	`£tV®id
();

663 
hdr
.
vxÏn
.
æags
 = 8
w0x08
;

665 
hdr
.
vxÏn
.
vni
 = vni;

670 
aùiÚ
 
	`add_g»_h—d”
(
b™
<16> 
´Ùo
) {

671 #ifdeà
GRE_ENABLE


672 
hdr
.
g»
.
	`£tV®id
();

673 
hdr
.
g»
.
´Ùo
 =…roto;

674 
hdr
.
g»
.
C
 = 0;

675 
hdr
.
g»
.
R
 = 0;

676 
hdr
.
g»
.
K
 = 0;

677 
hdr
.
g»
.
S
 = 0;

678 
hdr
.
g»
.
s
 = 0;

679 
hdr
.
g»
.
»cur£
 = 0;

680 
hdr
.
g»
.
æags
 = 0;

681 
hdr
.
g»
.
v”siÚ
 = 0;

685 
aùiÚ
 
	`add_”¥ª_h—d”
(
b™
<32> 
time¡amp
, 
sw™ch_mœrÜ_£ssiÚ_t
 
£ssiÚ_id
) {

686 #ifdeà
ERSPAN_ENABLE


687 
hdr
.
”¥ª_ty³3
.
	`£tV®id
();

688 
hdr
.
”¥ª_ty³3
.
time¡amp
 =imestamp;

689 
hdr
.
”¥ª_ty³3
.
£ssiÚ_id
 = (
b™
<10>) session_id;

690 
hdr
.
”¥ª_ty³3
.
v”siÚ
 = 4
w0x2
;

691 
hdr
.
”¥ª_ty³3
.
sgt
 = 0;

692 
hdr
.
”¥ª_ty³3
.
vÏn
 = 0;

696 
aùiÚ
 
	`add_v4_h—d”
(
b™
<8> 
´Ùo
) {

697 
hdr
.
v4
.
	`£tV®id
();

698 
hdr
.
v4
.
v”siÚ
 = 4
w4
;

699 
hdr
.
v4
.
ihl
 = 4
w5
;

701 
hdr
.
v4
.
id’tifiÿtiÚ
 = 0;

702 
hdr
.
v4
.
æags
 = 0;

703 
hdr
.
v4
.
äag_off£t
 = 0;

704 
hdr
.
v4
.
´ÙocŞ
 = 
´Ùo
;

708 ià(
mode
 =ğ
sw™ch_tuÂ–_mode_t
.
UNIFORM
) {

710 } ià(
mode
 =ğ
sw™ch_tuÂ–_mode_t
.
PIPE
) {

711 
hdr
.
v4
.
‰l
 = 8
w64
;

712 
hdr
.
v4
.
diff£rv
 = 0;

716 
aùiÚ
 
	`add_v6_h—d”
(
b™
<8> 
´Ùo
) {

717 #ifdeà
IPV6_ENABLE


718 
hdr
.
v6
.
	`£tV®id
();

719 
hdr
.
v6
.
v”siÚ
 = 4
w6
;

720 
hdr
.
v6
.
æow_Ïb–
 = 0;

722 
hdr
.
v6
.
Ãxt_hdr
 = 
´Ùo
;

726 ià(
mode
 =ğ
sw™ch_tuÂ–_mode_t
.
UNIFORM
) {

728 } ià(
mode
 =ğ
sw™ch_tuÂ–_mode_t
.
PIPE
) {

729 
hdr
.
v6
.
hİ_lim™
 = 8
w64
;

730 
hdr
.
v6
.
Œaffic_şass
 = 0;

735 
aùiÚ
 
	`»wr™e_v4_vxÏn
(
b™
<16> 
vxÏn_pÜt
) {

736 
hdr
.
šÃr_‘h”Ãt
 = hdr.
‘h”Ãt
;

737 
	`add_v4_h—d”
(
IP_PROTOCOLS_UDP
);

740 
hdr
.
v4
.
tÙ®_Ën
 = 
·ylßd_Ën
 + 16
w50
;

742 
	`add_udp_h—d”
(
eg_md
.
tuÂ–
.
hash
, 
vxÏn_pÜt
);

745 
hdr
.
udp
.
Ëngth
 = 
·ylßd_Ën
 + 16
w30
;

747 
	`add_vxÏn_h—d”
(
eg_md
.
tuÂ–
.
id
);

748 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_IPV4
;

751 
aùiÚ
 
	`»wr™e_v4_
() {

752 
	`add_v4_h—d”
(
_´Ùo
);

755 
hdr
.
v4
.
tÙ®_Ën
 = 
·ylßd_Ën
 + 16
w20
;

756 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_IPV4
;

759 
aùiÚ
 
	`»wr™e_v6_vxÏn
(
b™
<16> 
vxÏn_pÜt
) {

760 #ifdeà
IPV6_TUNNEL_ENABLE


761 
hdr
.
šÃr_‘h”Ãt
 = hdr.
‘h”Ãt
;

762 
	`add_v6_h—d”
(
IP_PROTOCOLS_UDP
);

765 
hdr
.
v6
.
·ylßd_Ën
 =…aylßd_ËÀ+ 16
w30
;

767 
	`add_udp_h—d”
(
eg_md
.
tuÂ–
.
hash
, 
vxÏn_pÜt
);

770 
hdr
.
udp
.
Ëngth
 = 
·ylßd_Ën
 + 16
w30
;

772 
	`add_vxÏn_h—d”
(
eg_md
.
tuÂ–
.
id
);

773 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_IPV6
;

777 
aùiÚ
 
	`»wr™e_v6_
() {

778 #ifdeà
IPV6_TUNNEL_ENABLE


779 
	`add_v6_h—d”
(
_´Ùo
);

781 
hdr
.
v6
.
·ylßd_Ën
 =…ayload_len;

782 
hdr
.
‘h”Ãt
.
‘h”_ty³
 = 
ETHERTYPE_IPV6
;

787 
bË
 
tuÂ–
 {

788 
key
 = {

789 
eg_md
.
tuÂ–
.
ty³
 : 
exaù
;

792 
aùiÚs
 = {

793 
NoAùiÚ
;

794 
»wr™e_v4_vxÏn
;

795 
»wr™e_v6_vxÏn
;

796 
»wr™e_v4_
;

797 
»wr™e_v6_
;

800 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

803 
­¶y
 {

804 #ifdeà
TUNNEL_ENABLE


805 ià(
eg_md
.
tuÂ–
.
ty³
 !ğ
SWITCH_TUNNEL_TYPE_NONE
 &&ƒg_md.tuÂ–.
id
 == 0)

806 
bd_to_vni_m­pšg
.
	`­¶y
();

808 ià(
eg_md
.
tuÂ–
.
ty³
 !ğ
SWITCH_TUNNEL_TYPE_NONE
) {

810 
’ÿp_ou‹r
.
	`­¶y
();

813 
tuÂ–
.
	`­¶y
();

817 
	}
}

	@shared/types.p4

23 #iâdeà
_P4_TYPES_


24 
	#_P4_TYPES_


	)

29 
	#ETHERTYPE_IPV4
 0x0800

	)

30 
	#ETHERTYPE_ARP
 0x0806

	)

31 
	#ETHERTYPE_VLAN
 0x8100

	)

32 
	#ETHERTYPE_IPV6
 0x86dd

	)

33 
	#ETHERTYPE_MPLS
 0x8847

	)

34 
	#ETHERTYPE_PTP
 0x88F7

	)

35 
	#ETHERTYPE_FCOE
 0x8906

	)

36 
	#ETHERTYPE_ROCE
 0x8915

	)

37 
	#ETHERTYPE_BFN
 0x9000

	)

39 
	#ETHERTYPE_QINQ
 0x8100

	)

41 
	#IP_PROTOCOLS_ICMP
 1

	)

42 
	#IP_PROTOCOLS_IGMP
 2

	)

43 
	#IP_PROTOCOLS_IPV4
 4

	)

44 
	#IP_PROTOCOLS_TCP
 6

	)

45 
	#IP_PROTOCOLS_UDP
 17

	)

46 
	#IP_PROTOCOLS_IPV6
 41

	)

47 
	#IP_PROTOCOLS_SRV6
 43

	)

48 
	#IP_PROTOCOLS_GRE
 47

	)

49 
	#IP_PROTOCOLS_ICMPV6
 58

	)

51 
	#UDP_PORT_VXLAN
 4789

	)

52 
	#UDP_PORT_ROCEV2
 4791

	)

53 
	#UDP_PORT_GENV
 6081

	)

54 
	#UDP_PORT_SFLOW
 6343

	)

55 
	#UDP_PORT_MPLS
 6635

	)

57 
	#GRE_PROTOCOLS_ERSPAN_TYPE_3
 0x22EB

	)

58 
	#GRE_PROTOCOLS_NVGRE
 0x6558

	)

59 
	#GRE_PROTOCOLS_IP
 0x0800

	)

60 
	#GRE_PROTOCOLS_ERSPAN_TYPE_2
 0x88BE

	)

62 
	#VLAN_DEPTH
 2

	)

63 
	#MPLS_DEPTH
 3

	)

69 
	gb™
<32> 
	tsw™ch_ušt32_t
;

70 
	gb™
<16> 
	tsw™ch_ušt16_t
;

71 
	gb™
<8> 
	tsw™ch_ušt8_t
;

73 
PÜtId_t
 
	tsw™ch_pÜt_t
;

74 cÚ¡ 
sw™ch_pÜt_t
 
	gSWITCH_PORT_INVALID
 = 9
w0x1ff
;

76 
QueueId_t
 
	tsw™ch_qid_t
;

78 
R•liÿtiÚId_t
 
	tsw™ch_rid_t
;

79 cÚ¡ 
sw™ch_rid_t
 
	gSWITCH_RID_DEFAULT
 = 0xffff;

81 
	gb™
<3> 
	tsw™ch_šg»ss_cos_t
;

83 
	gb™
<3> 
	tsw™ch_dige¡_ty³_t
;

84 cÚ¡ 
sw™ch_dige¡_ty³_t
 
	gSWITCH_DIGEST_TYPE_INVALID
 = 0;

85 cÚ¡ 
sw™ch_dige¡_ty³_t
 
	gSWITCH_DIGEST_TYPE_MAC_LEARNING
 = 1;

87 
	gb™
<16> 
	tsw™ch_ifšdex_t
;

88 cÚ¡ 
sw™ch_ifšdex_t
 
	gSWITCH_IFINDEX_FLOOD
 = 16
w0xffff
;

90 
	gb™
<10> 
	tsw™ch_pÜt_Ïg_šdex_t
;

91 
	gb™
<16> 
	tsw™ch_bd_t
;

92 cÚ¡ 
sw™ch_bd_t
 
	gSWITCH_BD_DEFAULT_VRF
 = 4097;

94 #iâdeà
sw™ch_vrf_width


95 
	#sw™ch_vrf_width
 14

	)

97 
	gb™
<
	tsw™ch_vrf_width
> 
	tsw™ch_vrf_t
;

99 #iâdeà
sw™ch_Ãxthİ_width


100 
	#sw™ch_Ãxthİ_width
 16

	)

102 
	gb™
<
	tsw™ch_Ãxthİ_width
> 
	tsw™ch_Ãxthİ_t
;

103 
	gb™
<16> 
	tsw™ch_ou‹r_Ãxthİ_t
;

105 
	gb™
<16> 
	tsw™ch_xid_t
;

106 
	gb™
<9> 
	tsw™ch_yid_t
;

108 
	gb™
<16> 
	tsw™ch_pÜt_Ïg_Ïb–_t
;

109 
	gb™
<16> 
	tsw™ch_bd_Ïb–_t
;

110 
	gb™
<16> 
	tsw™ch_if_Ïb–_t
;

112 
	gb™
<10> 
	tsw™ch_rmac_group_t
;

113 
	gb™
<16> 
	tsw™ch_smac_šdex_t
;

115 
	gb™
<16> 
	tsw™ch_mtu_t
;

117 
	gb™
<12> 
	tsw™ch_¡©s_šdex_t
;

119 
	gb™
<16> 
	tsw™ch_ıu_»asÚ_t
;

120 cÚ¡ 
sw™ch_ıu_»asÚ_t
 
	gSWITCH_CPU_REASON_PTP
 = 8;

122 
	ssw™ch_ıu_pÜt_v®ue_£t_t
 {

123 
	mb™
<16> 
	m‘h”_ty³
;

124 
	mb™
<9> 
	mpÜt
;

127 
	#sw™ch_drİ_»asÚ_width
 8

	)

128 
	gb™
<
	tsw™ch_drİ_»asÚ_width
> 
	tsw™ch_drİ_»asÚ_t
;

129 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_UNKNOWN
 = 0;

130 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_SRC_MAC_ZERO
 = 10;

131 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_SRC_MAC_MULTICAST
 = 11;

132 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_DST_MAC_ZERO
 = 12;

133 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_ETHERNET_MISS
 = 13;

134 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_SRC_MAC_ZERO
 = 14;

135 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_SRC_MAC_MULTICAST
 = 15;

136 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_DST_MAC_ZERO
 = 16;

137 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_IP_VERSION_INVALID
 = 25;

138 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_IP_TTL_ZERO
 = 26;

139 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_IP_SRC_MULTICAST
 = 27;

140 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_IP_SRC_LOOPBACK
 = 28;

141 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_IP_MISS
 = 29;

142 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_IP_IHL_INVALID
 = 30;

143 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_OUTER_IP_INVALID_CHECKSUM
 = 31;

144 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_IP_VERSION_INVALID
 = 40;

145 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_IP_TTL_ZERO
 = 41;

146 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_IP_SRC_MULTICAST
 = 42;

147 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_IP_SRC_LOOPBACK
 = 43;

148 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_IP_IHL_INVALID
 = 44;

149 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_IP_INVALID_CHECKSUM
 = 45;

150 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_PORT_VLAN_MAPPING_MISS
 = 55;

151 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_STP_STATE_LEARNING
 = 56;

152 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_STP_STATE_BLOCKING
 = 57;

153 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_SAME_IFINDEX
 = 58;

154 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_MULTICAST_SNOOPING_ENABLED
 = 59;

155 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_MTU_CHECK_FAIL
 = 70;

156 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_TRAFFIC_MANAGER
 = 71;

157 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_METER
 = 72;

158 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_WRED
 = 73;

159 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_ACL_DENY
 = 80;

160 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_RACL_DENY
 = 81;

161 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_URPF_CHECK_FAIL
 = 82;

162 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_IPSG_MISS
 = 83;

163 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_IFINDEX
 = 84;

164 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_CPU_COLOR_YELLOW
 = 85;

165 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_CPU_COLOR_RED
 = 86;

166 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_STORM_CONTROL_COLOR_YELLOW
 = 87;

167 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_STORM_CONTROL_COLOR_RED
 = 88;

168 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_L2_MISS_UNICAST
 = 89;

169 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_L2_MISS_MULTICAST
 = 90;

170 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_L2_MISS_BROADCAST
 = 91;

171 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_EGRESS_ACL_DENY
 = 92;

172 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_NEXTHOP
 = 93;

173 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_NON_IP_ROUTER_MAC
 = 94;

174 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_MLAG_MEMBER
 = 95;

175 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_L3_IPV6_DISABLE
 = 100;

176 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_INGRESS_PFC_WD_DROP
 = 101;

177 cÚ¡ 
sw™ch_drİ_»asÚ_t
 
	gSWITCH_DROP_REASON_EGRESS_PFC_WD_DROP
 = 102;

179 
	gb™
<1> 
	tsw™ch_pÜt_ty³_t
;

180 cÚ¡ 
sw™ch_pÜt_ty³_t
 
	gSWITCH_PORT_TYPE_NORMAL
 = 0;

181 cÚ¡ 
sw™ch_pÜt_ty³_t
 
	gSWITCH_PORT_TYPE_CPU
 = 1;

183 
	gb™
<2> 
	tsw™ch__ty³_t
;

184 cÚ¡ 
sw™ch__ty³_t
 
	gSWITCH_IP_TYPE_NONE
 = 0;

185 cÚ¡ 
sw™ch__ty³_t
 
	gSWITCH_IP_TYPE_IPV4
 = 1;

186 cÚ¡ 
sw™ch__ty³_t
 
	gSWITCH_IP_TYPE_IPV6
 = 2;

188 
	gb™
<2> 
	tsw™ch__äag_t
;

189 cÚ¡ 
sw™ch__äag_t
 
	gSWITCH_IP_FRAG_NON_FRAG
 = 0b00;

190 cÚ¡ 
sw™ch__äag_t
 
	gSWITCH_IP_FRAG_HEAD
 = 0b10;

191 cÚ¡ 
sw™ch__äag_t
 
	gSWITCH_IP_FRAG_NON_HEAD
 = 0b11;

194 
	gb™
<16> 
	tsw™ch_šg»ss_by·ss_t
;

195 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_L2
 = 16
w0x0001
;

196 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_L3
 = 16
w0x0002
;

197 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_ACL
 = 16
w0x0004
;

198 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_SYSTEM_ACL
 = 16
w0x0008
;

199 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_QOS
 = 16
w0x0010
;

200 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_POLICER
 = 16
w0x0020
;

201 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_STORM_CONTROL
 = 16
w0x0040
;

202 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_STP
 = 16
w0x0080
;

203 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_SMAC
 = 16
w0x0100
;

207 cÚ¡ 
sw™ch_šg»ss_by·ss_t
 
	gSWITCH_INGRESS_BYPASS_ALL
 = 16
w0xffff
;

208 
	#INGRESS_BYPASS
(
t
è(
ig_md
.
by·ss
 & 
SWITCH_INGRESS_BYPASS_
##ˆ!ğ0)

	)

210 
	gb™
<8> 
	tsw™ch_eg»ss_by·ss_t
;

211 cÚ¡ 
sw™ch_eg»ss_by·ss_t
 
	gSWITCH_EGRESS_BYPASS_REWRITE
 = 8
w0x01
;

212 cÚ¡ 
sw™ch_eg»ss_by·ss_t
 
	gSWITCH_EGRESS_BYPASS_ACL
 = 8
w0x02
;

213 cÚ¡ 
sw™ch_eg»ss_by·ss_t
 
	gSWITCH_EGRESS_BYPASS_SYSTEM_ACL
 = 8
w0x04
;

214 cÚ¡ 
sw™ch_eg»ss_by·ss_t
 
	gSWITCH_EGRESS_BYPASS_QOS
 = 8
w0x08
;

215 cÚ¡ 
sw™ch_eg»ss_by·ss_t
 
	gSWITCH_EGRESS_BYPASS_WRED
 = 8
w0x10
;

216 cÚ¡ 
sw™ch_eg»ss_by·ss_t
 
	gSWITCH_EGRESS_BYPASS_STP
 = 8
w0x20
;

217 cÚ¡ 
sw™ch_eg»ss_by·ss_t
 
	gSWITCH_EGRESS_BYPASS_MTU
 = 8
w0x40
;

218 cÚ¡ 
sw™ch_eg»ss_by·ss_t
 
	gSWITCH_EGRESS_BYPASS_POLICER
 = 8
w0x80
;

222 cÚ¡ 
sw™ch_eg»ss_by·ss_t
 
	gSWITCH_EGRESS_BYPASS_ALL
 = 8
w0xff
;

223 
	#EGRESS_BYPASS
(
t
è(
eg_md
.
by·ss
 & 
SWITCH_EGRESS_BYPASS_
##ˆ!ğ0)

	)

227 
	gb™
<16> 
	tsw™ch_pkt_Ëngth_t
;

229 
	gb™
<8> 
	tsw™ch_pkt_¤c_t
;

230 cÚ¡ 
sw™ch_pkt_¤c_t
 
	gSWITCH_PKT_SRC_BRIDGED
 = 0;

231 cÚ¡ 
sw™ch_pkt_¤c_t
 
	gSWITCH_PKT_SRC_CLONED_INGRESS
 = 1;

232 cÚ¡ 
sw™ch_pkt_¤c_t
 
	gSWITCH_PKT_SRC_CLONED_EGRESS
 = 2;

233 cÚ¡ 
sw™ch_pkt_¤c_t
 
	gSWITCH_PKT_SRC_DEFLECTED
 = 3;

235 
	gb™
<2> 
	tsw™ch_pkt_cŞÜ_t
;

236 cÚ¡ 
sw™ch_pkt_cŞÜ_t
 
	gSWITCH_METER_COLOR_GREEN
 = 0;

237 cÚ¡ 
sw™ch_pkt_cŞÜ_t
 
	gSWITCH_METER_COLOR_YELLOW
 = 1;

238 cÚ¡ 
sw™ch_pkt_cŞÜ_t
 
	gSWITCH_METER_COLOR_RED
 = 3;

240 
	gb™
<2> 
	tsw™ch_pkt_ty³_t
;

241 cÚ¡ 
sw™ch_pkt_ty³_t
 
	gSWITCH_PKT_TYPE_UNICAST
 = 0;

242 cÚ¡ 
sw™ch_pkt_ty³_t
 
	gSWITCH_PKT_TYPE_MULTICAST
 = 1;

243 cÚ¡ 
sw™ch_pkt_ty³_t
 
	gSWITCH_PKT_TYPE_BROADCAST
 = 2;

246 
	#sw™ch_l4_pÜt_Ïb–_width
 16

	)

247 
	gb™
<
	tsw™ch_l4_pÜt_Ïb–_width
> 
	tsw™ch_l4_pÜt_Ïb–_t
;

250 
	gb™
<2> 
	tsw™ch_¡p_¡©e_t
;

251 cÚ¡ 
sw™ch_¡p_¡©e_t
 
	gSWITCH_STP_STATE_FORWARDING
 = 0;

252 cÚ¡ 
sw™ch_¡p_¡©e_t
 
	gSWITCH_STP_STATE_BLOCKING
 = 1;

253 cÚ¡ 
sw™ch_¡p_¡©e_t
 
	gSWITCH_STP_STATE_LEARNING
 = 2;

255 
	gb™
<10> 
	tsw™ch_¡p_group_t
;

257 
	ssw™ch_¡p_m‘ad©a_t
 {

258 
sw™ch_¡p_group_t
 
	mgroup
;

259 
sw™ch_¡p_¡©e_t
 
	m¡©e_
;

263 
	#sw™ch_cİp_m‘”_id_width
 8

	)

264 
	gb™
<
	tsw™ch_cİp_m‘”_id_width
> 
	tsw™ch_cİp_m‘”_id_t
;

266 
	#sw™ch_pŞiûr_m‘”_šdex_width
 10

	)

267 
	gb™
<
	tsw™ch_pŞiûr_m‘”_šdex_width
> 
	tsw™ch_pŞiûr_m‘”_šdex_t
;

271 
	gb™
<2> 
	tsw™ch_qos_Œu¡_mode_t
;

272 cÚ¡ 
sw™ch_qos_Œu¡_mode_t
 
	gSWITCH_QOS_TRUST_MODE_UNTRUSTED
 = 0;

273 cÚ¡ 
sw™ch_qos_Œu¡_mode_t
 
	gSWITCH_QOS_TRUST_MODE_TRUST_DSCP
 = 1;

274 cÚ¡ 
sw™ch_qos_Œu¡_mode_t
 
	gSWITCH_QOS_TRUST_MODE_TRUST_PCP
 = 2;

276 
	gb™
<5> 
	tsw™ch_qos_group_t
;

278 
	#sw™ch_tc_width
 8

	)

279 
	gb™
<
	tsw™ch_tc_width
> 
	tsw™ch_tc_t
;

280 
	gb™
<3> 
	tsw™ch_cos_t
;

282 
	ssw™ch_qos_m‘ad©a_t
 {

283 
sw™ch_qos_Œu¡_mode_t
 
	mŒu¡_mode
;

284 
sw™ch_qos_group_t
 
	mgroup
;

285 
sw™ch_tc_t
 
	mtc
;

286 
sw™ch_pkt_cŞÜ_t
 
	mcŞÜ
;

287 
sw™ch_pkt_cŞÜ_t
 
	maş_pŞiûr_cŞÜ
;

288 
sw™ch_pkt_cŞÜ_t
 
	mpÜt_cŞÜ
;

289 
sw™ch_pkt_cŞÜ_t
 
	mæow_cŞÜ
;

290 
sw™ch_pkt_cŞÜ_t
 
	m¡Üm_cÚŒŞ_cŞÜ
;

291 
sw™ch_pŞiûr_m‘”_šdex_t
 
	mm‘”_šdex
;

292 
sw™ch_pŞiûr_m‘”_šdex_t
 
	mšg»ss_æow_m‘”_šdex
;

293 
sw™ch_qid_t
 
	mqid
;

294 
sw™ch_šg»ss_cos_t
 
	micos
;

295 
	mb™
<19> 
	mqd•th
;

299 
	gb™
<1> 
	tsw™ch_Ë¬nšg_mode_t
;

300 cÚ¡ 
sw™ch_Ë¬nšg_mode_t
 
	gSWITCH_LEARNING_MODE_DISABLED
 = 0;

301 cÚ¡ 
sw™ch_Ë¬nšg_mode_t
 
	gSWITCH_LEARNING_MODE_LEARN
 = 1;

303 
	ssw™ch_Ë¬nšg_dige¡_t
 {

304 
sw™ch_bd_t
 
	mbd
;

305 
sw™ch_ifšdex_t
 
	mifšdex
;

306 
mac_addr_t
 
	m¤c_addr
;

309 
	ssw™ch_Ë¬nšg_m‘ad©a_t
 {

310 
sw™ch_Ë¬nšg_mode_t
 
	mbd_mode
;

311 
sw™ch_Ë¬nšg_mode_t
 
	mpÜt_mode
;

312 
sw™ch_Ë¬nšg_dige¡_t
 
	mdige¡
;

316 
	gb™
<2> 
	tsw™ch_muÉiÿ¡_mode_t
;

317 cÚ¡ 
sw™ch_muÉiÿ¡_mode_t
 
	gSWITCH_MULTICAST_MODE_NONE
 = 0;

318 cÚ¡ 
sw™ch_muÉiÿ¡_mode_t
 
	gSWITCH_MULTICAST_MODE_PIM_SM
 = 1;

319 cÚ¡ 
sw™ch_muÉiÿ¡_mode_t
 
	gSWITCH_MULTICAST_MODE_PIM_BIDIR
 = 2;

321 
MuÉiÿ¡GroupId_t
 
	tsw™ch_mgid_t
;

323 
	gb™
<16> 
	tsw™ch_muÉiÿ¡_½f_group_t
;

325 
	ssw™ch_muÉiÿ¡_m‘ad©a_t
 {

326 
sw™ch_mgid_t
 
	mid
;

327 
	mb™
<2> 
	mmode
;

328 
sw™ch_muÉiÿ¡_½f_group_t
 
	m½f_group
;

332 
	gb™
<2> 
	tsw™ch_u½f_mode_t
;

333 cÚ¡ 
sw™ch_u½f_mode_t
 
	gSWITCH_URPF_MODE_NONE
 = 0;

334 cÚ¡ 
sw™ch_u½f_mode_t
 
	gSWITCH_URPF_MODE_LOOSE
 = 1;

335 cÚ¡ 
sw™ch_u½f_mode_t
 
	gSWITCH_URPF_MODE_STRICT
 = 2;

338 
	#sw™ch_w»d_šdex_width
 8

	)

339 
	gb™
<
	tsw™ch_w»d_šdex_width
> 
	tsw™ch_w»d_šdex_t
;

341 
	gb™
<2> 
	tsw™ch_eú_cod•ošt_t
;

342 cÚ¡ 
sw™ch_eú_cod•ošt_t
 
	gSWITCH_ECN_CODEPOINT_NON_ECT
 = 0b00;

343 cÚ¡ 
sw™ch_eú_cod•ošt_t
 
	gSWITCH_ECN_CODEPOINT_ECT0
 = 0b10;

344 cÚ¡ 
sw™ch_eú_cod•ošt_t
 
	gSWITCH_ECN_CODEPOINT_ECT1
 = 0b01;

345 cÚ¡ 
sw™ch_eú_cod•ošt_t
 
	gSWITCH_ECN_CODEPOINT_CE
 = 0b11;

348 
MœrÜId_t
 
	tsw™ch_mœrÜ_£ssiÚ_t
;

349 cÚ¡ 
sw™ch_mœrÜ_£ssiÚ_t
 
	gSWITCH_MIRROR_SESSION_CPU
 = 250;

352 
	gb™
<8> 
	tsw™ch_mœrÜ_ty³_t
;

353 
	#SWITCH_MIRROR_TYPE_INVALID
 0

	)

354 
	#SWITCH_MIRROR_TYPE_PORT
 1

	)

355 
	#SWITCH_MIRROR_TYPE_CPU
 2

	)

356 
	#SWITCH_MIRROR_TYPE_DTEL_DROP
 3

	)

357 
	#SWITCH_MIRROR_TYPE_DTEL_SWITCH_LOCAL
 4

	)

360 
	ssw™ch_mœrÜ_m‘ad©a_t
 {

361 
sw™ch_pkt_¤c_t
 
	m¤c
;

362 
sw™ch_mœrÜ_ty³_t
 
	mty³
;

363 
sw™ch_mœrÜ_£ssiÚ_t
 
	m£ssiÚ_id
;

366 
h—d”
 
	gsw™ch_pÜt_mœrÜ_m‘ad©a_h
 {

367 
sw™ch_pkt_¤c_t
 
	g¤c
;

368 
sw™ch_mœrÜ_ty³_t
 
	gty³
;

369 
	gb™
<48> 
	gtime¡amp
;

370 #ià
__TARGET_TOFINO__
 == 1

371 
	gb™
<6> 
	g_·d
;

373 
sw™ch_mœrÜ_£ssiÚ_t
 
	g£ssiÚ_id
;

377 
h—d”
 
	gsw™ch_ıu_mœrÜ_m‘ad©a_h
 {

378 
sw™ch_pkt_¤c_t
 
	g¤c
;

379 
sw™ch_mœrÜ_ty³_t
 
	gty³
;

380 
	gb™
<7> 
	g_·d
;

381 
sw™ch_pÜt_t
 
	gpÜt
;

382 
sw™ch_bd_t
 
	gbd
;

383 
sw™ch_ifšdex_t
 
	gifšdex
;

384 
sw™ch_ıu_»asÚ_t
 
	g»asÚ_code
;

388 
	esw™ch_tuÂ–_mode_t
 { 
	mPIPE
, 
	mUNIFORM
 }

389 
	gb™
<3> 
	tsw™ch_tuÂ–_ty³_t
;

390 cÚ¡ 
sw™ch_tuÂ–_ty³_t
 
	gSWITCH_TUNNEL_TYPE_NONE
 = 0;

391 cÚ¡ 
sw™ch_tuÂ–_ty³_t
 
	gSWITCH_TUNNEL_TYPE_VXLAN
 = 1;

392 cÚ¡ 
sw™ch_tuÂ–_ty³_t
 
	gSWITCH_TUNNEL_TYPE_IPINIP
 = 2;

394 
	esw™ch_tuÂ–_‹rm_mode_t
 { 
	mP2P
, 
	mP2MP
 };

396 #iâdeà
sw™ch_tuÂ–_šdex_width


397 
	#sw™ch_tuÂ–_šdex_width
 16

	)

399 
	gb™
<
	tsw™ch_tuÂ–_šdex_width
> 
	tsw™ch_tuÂ–_šdex_t
;

400 
	gb™
<24> 
	tsw™ch_tuÂ–_id_t
;

402 
	ssw™ch_tuÂ–_m‘ad©a_t
 {

403 
sw™ch_tuÂ–_ty³_t
 
	mty³
;

404 
sw™ch_tuÂ–_šdex_t
 
	mšdex
;

405 
sw™ch_tuÂ–_id_t
 
	mid
;

406 
sw™ch_ifšdex_t
 
	mifšdex
;

407 
	mb™
<16> 
	mhash
;

408 
boŞ
 
	m‹rmš©e
;

412 
	gb™
<4> 
	tsw™ch_d‹l_»pÜt_ty³_t
;

413 cÚ¡ 
sw™ch_d‹l_»pÜt_ty³_t
 
	gSWITCH_DTEL_REPORT_TYPE_NONE
 = 0b000;

414 cÚ¡ 
sw™ch_d‹l_»pÜt_ty³_t
 
	gSWITCH_DTEL_REPORT_TYPE_DROP
 = 0b100;

415 cÚ¡ 
sw™ch_d‹l_»pÜt_ty³_t
 
	gSWITCH_DTEL_REPORT_TYPE_QUEUE
 = 0b010;

416 cÚ¡ 
sw™ch_d‹l_»pÜt_ty³_t
 
	gSWITCH_DTEL_REPORT_TYPE_FLOW
 = 0b001;

418 cÚ¡ 
sw™ch_d‹l_»pÜt_ty³_t
 
	gSWITCH_DTEL_SUPPRESS_REPORT
 = 0b1000;

420 
	ssw™ch_d‹l_m‘ad©a_t
 {

421 
sw™ch_d‹l_»pÜt_ty³_t
 
	m»pÜt_ty³
;

422 
	mb™
<32> 
	mÏ‹ncy
;

423 
sw™ch_mœrÜ_£ssiÚ_t
 
	m£ssiÚ_id
;

424 
	mb™
<32> 
	mhash
;

427 
h—d”
 
	gsw™ch_d‹l_sw™ch_loÿl_mœrÜ_m‘ad©a_h
 {

428 
sw™ch_pkt_¤c_t
 
	g¤c
;

429 
sw™ch_mœrÜ_ty³_t
 
	gty³
;

430 
	gb™
<48> 
	gtime¡amp
;

431 #ià
__TARGET_TOFINO__
 == 1

432 
	gb™
<6> 
	g_·d
;

434 
sw™ch_mœrÜ_£ssiÚ_t
 
	g£ssiÚ_id
;

435 
	gb™
<32> 
	ghash
;

436 
	gb™
<4> 
	g_·d1
;

437 
sw™ch_d‹l_»pÜt_ty³_t
 
	g»pÜt_ty³
;

438 
	gb™
<7> 
	g_·d2
;

439 
	gb™
<9> 
	gšg»ss_pÜt
;

440 
	gb™
<7> 
	g_·d3
;

441 
	gb™
<9> 
	geg»ss_pÜt
;

442 #ià
__TARGET_TOFINO__
 == 1

443 
	gb™
<3> 
	g_·d4
;

445 
	gb™
<1> 
	g_·d4
;

447 
sw™ch_qid_t
 
	gqid
;

448 
	gb™
<5> 
	g_·d5
;

449 
	gb™
<19> 
	gqd•th
;

450 
	gb™
<32> 
	geg»ss_time¡amp
;

453 
h—d”
 
	gsw™ch_d‹l_drİ_mœrÜ_m‘ad©a_h
 {

454 
sw™ch_pkt_¤c_t
 
	g¤c
;

455 
sw™ch_mœrÜ_ty³_t
 
	gty³
;

456 
	gb™
<48> 
	gtime¡amp
;

457 #ià
__TARGET_TOFINO__
 == 1

458 
	gb™
<6> 
	g_·d
;

460 
sw™ch_mœrÜ_£ssiÚ_t
 
	g£ssiÚ_id
;

461 
	gb™
<32> 
	ghash
;

462 
	gb™
<4> 
	g_·d1
;

463 
sw™ch_d‹l_»pÜt_ty³_t
 
	g»pÜt_ty³
;

464 
	gb™
<7> 
	g_·d2
;

465 
	gb™
<9> 
	gšg»ss_pÜt
;

466 
	gb™
<7> 
	g_·d3
;

467 
	gb™
<9> 
	geg»ss_pÜt
;

468 #ià
__TARGET_TOFINO__
 == 1

469 
	gb™
<3> 
	g_·d4
;

471 
	gb™
<1> 
	g_·d4
;

473 
sw™ch_qid_t
 
	gqid
;

474 
sw™ch_drİ_»asÚ_t
 
	gdrİ_»asÚ
;

477 @
æexibË


478 
	ssw™ch_bridged_m‘ad©a_d‹l_ex‹nsiÚ_t
 {

479 
sw™ch_d‹l_»pÜt_ty³_t
 
	m»pÜt_ty³
;

480 
sw™ch_mœrÜ_£ssiÚ_t
 
	m£ssiÚ_id
;

481 
	mb™
<32> 
	mhash
;

482 
	mb™
<9> 
	meg»ss_pÜt
;

490 @
·_cÚš”_size
("ingress", "ig_md.checks.same_if", 16)

491 @
·_cÚš”_size
("ingress", "ig_md.checks.same_bd", 16)

492 
	ssw™ch_šg»ss_æags_t
 {

493 
boŞ
 
	mv4_checksum_”r
;

494 
boŞ
 
	mšÃr_v4_checksum_”r
;

495 
boŞ
 
	mlšk_loÿl
;

496 
boŞ
 
	mrou‹d
;

497 
boŞ
 
	maş_d’y
;

498 
boŞ
 
	m¿ş_d’y
;

499 
boŞ
 
	mpÜt_vÏn_miss
;

500 
boŞ
 
	mrmac_h™
;

501 
boŞ
 
	mdmac_miss
;

502 
boŞ
 
	mmy
;

503 
boŞ
 
	mgËª
;

504 
boŞ
 
	m¡Üm_cÚŒŞ_drİ
;

505 
boŞ
 
	maş_pŞiûr_drİ
;

506 
boŞ
 
	mpÜt_pŞiûr_drİ
;

507 
boŞ
 
	mæood_to_muÉiÿ¡_rou‹rs
;

508 
boŞ
 
	m³”_lšk
;

509 
boŞ
 
	mÿ±u»_ts
;

510 
boŞ
 
	mmac_pkt_şass
;

511 
boŞ
 
	mpfc_wd_drİ
;

515 
	ssw™ch_eg»ss_æags_t
 {

516 
boŞ
 
	mrou‹d
;

517 
boŞ
 
	maş_d’y
;

518 
boŞ
 
	mmÏg_memb”
;

519 
boŞ
 
	m³”_lšk
;

520 
boŞ
 
	mÿ±u»_ts
;

521 
boŞ
 
	mw»d_drİ
;

522 
boŞ
 
	mpÜt_pŞiûr_drİ
;

523 
boŞ
 
	mpfc_wd_drİ
;

530 
	ssw™ch_šg»ss_checks_t
 {

531 
sw™ch_bd_t
 
	m§me_bd
;

532 
sw™ch_ifšdex_t
 
	m§me_if
;

533 
boŞ
 
	mm½f
;

534 
boŞ
 
	mu½f
;

538 
	ssw™ch_eg»ss_checks_t
 {

539 
sw™ch_bd_t
 
	m§me_bd
;

540 
sw™ch_mtu_t
 
	mmtu
;

541 
boŞ
 
	m¡p
;

547 
	ssw™ch__m‘ad©a_t
 {

548 
boŞ
 
	muniÿ¡_’abË
;

549 
boŞ
 
	mmuÉiÿ¡_’abË
;

550 
boŞ
 
	mmuÉiÿ¡_¢oİšg
;

554 
	ssw™ch_lookup_f›lds_t
 {

555 
sw™ch_pkt_ty³_t
 
	mpkt_ty³
;

557 
mac_addr_t
 
	mmac_¤c_addr
;

558 
mac_addr_t
 
	mmac_d¡_addr
;

559 
	mb™
<16> 
	mmac_ty³
;

560 
	mb™
<3> 
	mpı
;

563 
	mb™
<16> 
	m¬p_İcode
;

565 
sw™ch__ty³_t
 
	m_ty³
;

566 
	mb™
<8> 
	m_´Ùo
;

567 
	mb™
<8> 
	m_‰l
;

568 
	mb™
<8> 
	m_tos
;

569 
	mb™
<2> 
	m_äag
;

570 
	mb™
<128> 
	m_¤c_addr
;

571 
	mb™
<128> 
	m_d¡_addr
;

573 
	mb™
<8> 
	mtı_æags
;

574 
	mb™
<16> 
	ml4_¤c_pÜt
;

575 
	mb™
<16> 
	ml4_d¡_pÜt
;

579 @
æexibË


580 
	ssw™ch_bridged_m‘ad©a_t
 {

582 
sw™ch_pÜt_t
 
	mšg»ss_pÜt
;

583 
sw™ch_ifšdex_t
 
	mšg»ss_ifšdex
;

584 
sw™ch_bd_t
 
	mšg»ss_bd
;

585 
sw™ch_Ãxthİ_t
 
	mÃxthİ
;

586 
sw™ch_pkt_ty³_t
 
	mpkt_ty³
;

587 
boŞ
 
	mrou‹d
;

590 
boŞ
 
	m³”_lšk
;

591 
sw™ch_ıu_»asÚ_t
 
	mıu_»asÚ
;

592 
	mb™
<48> 
	mtime¡amp
;

593 
sw™ch_tc_t
 
	mtc
;

594 
sw™ch_qid_t
 
	mqid
;

595 
sw™ch_pkt_cŞÜ_t
 
	mcŞÜ
;

600 @
æexibË


601 
	ssw™ch_bridged_m‘ad©a_aş_ex‹nsiÚ_t
 {

602 
	mb™
<16> 
	ml4_¤c_pÜt
;

603 
	mb™
<16> 
	ml4_d¡_pÜt
;

604 
	mb™
<8> 
	mtı_æags
;

605 
sw™ch_l4_pÜt_Ïb–_t
 
	ml4_pÜt_Ïb–
;

608 @
æexibË


609 
	ssw™ch_bridged_m‘ad©a_tuÂ–_ex‹nsiÚ_t
 {

610 
sw™ch_tuÂ–_šdex_t
 
	mšdex
;

611 
sw™ch_ou‹r_Ãxthİ_t
 
	mou‹r_Ãxthİ
;

612 
	mb™
<16> 
	mhash
;

613 
sw™ch_vrf_t
 
	mvrf
;

614 
boŞ
 
	m‹rmš©e
;

617 #ifdeà
DTEL_ENABLE


618 @
·_©omic
("ingress", "hdr.bridged_md.base_qid")

619 @
·_cÚš”_size
("ingress", "hdr.bridged_md.base_qid", 8)

620 @
·_cÚš”_size
("ingress", "hdr.bridged_md.dtel_report_type", 8)

621 @
·_no_ov”Ïy
("ingress", "hdr.bridged_md.base_qid")

622 @
·_no_ov”Ïy
("ingress", "hdr.bridged_md.__pad_2")

623 @
·_no_ov”Ïy
("ingress", "hdr.bridged_md.__pad_3")

624 @
·_no_ov”Ïy
("ingress", "hdr.bridged_md.__pad_4")

625 @
·_no_ov”Ïy
("egress", "hdr.dtel_drop_report.ingress_port")

626 @
·_no_ov”Ïy
("egress", "hdr.dtel_drop_report.egress_port")

627 @
·_no_ov”Ïy
("egress", "hdr.dtel_switch_local_report.ingress_port")

628 @
·_no_ov”Ïy
("egress", "hdr.dtel_switch_local_report.egress_port")

629 @
·_no_ov”Ïy
("egress", "hdr.dtel_drop_report.queue_id")

630 @
·_no_ov”Ïy
("egress", "hdr.dtel_drop_report.drop_reason")

631 @
·_no_ov”Ïy
("egress", "hdr.dtel_drop_report.reserved")

634 
	gb™
<8> 
	tsw™ch_bridge_ty³_t
;

636 
h—d”
 
	gsw™ch_bridged_m‘ad©a_h
 {

637 
sw™ch_pkt_¤c_t
 
	g¤c
;

638 
sw™ch_bridge_ty³_t
 
	gty³
;

639 
sw™ch_bridged_m‘ad©a_t
 
	gba£
;

640 #ià
defšed
(
EGRESS_IP_ACL_ENABLE
è|| defšed(
EGRESS_MIRROR_ACL_ENABLE
)

641 
sw™ch_bridged_m‘ad©a_aş_ex‹nsiÚ_t
 
	gaş
;

643 #ifdeà
TUNNEL_ENABLE


644 
sw™ch_bridged_m‘ad©a_tuÂ–_ex‹nsiÚ_t
 
	gtuÂ–
;

646 #ifdeà
DTEL_ENABLE


647 
sw™ch_bridged_m‘ad©a_d‹l_ex‹nsiÚ_t
 
	gd‹l
;

651 
	ssw™ch_pÜt_m‘ad©a_t
 {

652 
sw™ch_pÜt_Ïg_šdex_t
 
	mpÜt_Ïg_šdex
;

653 
sw™ch_pÜt_Ïg_Ïb–_t
 
	mpÜt_Ïg_Ïb–
;

654 
sw™ch_ifšdex_t
 
	mifšdex
;

657 @
·_cÚš”_size
("ingress", "ig_md.lkp.l4_src_port", 8)

658 @
·_cÚš”_size
("ingress", "ig_md.l4_port_label", 8)

659 @
·_cÚš”_size
("ingress", "ig_md.mirror.src", 8)

660 @
·_cÚš”_size
("ingress", "ig_md.mirror.type", 8)

661 @
·_®Ÿs
("ingress", "ig_md.egress_port", "ig_intr_md_for_tm.ucast_egress_port")

662 #ià!
defšed
(
DTEL_DROP_REPORT_ENABLE
è&& !defšed(
DTEL_QUEUE_REPORT_ENABLE
)

663 @
·_®Ÿs
("ingress", "ig_md.multicast.id", "ig_intr_md_for_tm.mcast_grp_b")

665 @
·_®Ÿs
("ingress", "ig_md.qos.qid", "ig_intr_md_for_tm.qid")

666 @
·_®Ÿs
("ingress", "ig_md.qos.icos", "ig_intr_md_for_tm.ingress_cos")

667 @
·_cÚš”_size
("egress", "hdr.dtel_drop_report.drop_reason", 8)

669 @
·_®Ÿs
("ingress", "ig_intr_md_for_dprsr.mirror_type", "ig_md.mirror.type")

671 
	ssw™ch_šg»ss_m‘ad©a_t
 {

672 
sw™ch_ifšdex_t
 
	mifšdex
;

673 
sw™ch_pÜt_t
 
	mpÜt
;

674 
sw™ch_pÜt_t
 
	meg»ss_pÜt
;

675 
sw™ch_pÜt_Ïg_šdex_t
 
	mpÜt_Ïg_šdex
;

676 
sw™ch_ifšdex_t
 
	meg»ss_ifšdex
;

677 
sw™ch_pÜt_Ïg_šdex_t
 
	meg»ss_pÜt_Ïg_šdex
;

678 
sw™ch_bd_t
 
	mbd
;

679 
sw™ch_vrf_t
 
	mvrf
;

680 
sw™ch_Ãxthİ_t
 
	mÃxthİ
;

681 
sw™ch_ou‹r_Ãxthİ_t
 
	mou‹r_Ãxthİ
;

682 
sw™ch_Ãxthİ_t
 
	maş_Ãxthİ
;

683 
boŞ
 
	maş_»dœeù
;

685 
	mb™
<48> 
	mtime¡amp
;

686 
	mb™
<32> 
	mhash
;

688 
sw™ch_šg»ss_æags_t
 
	mæags
;

689 
sw™ch_šg»ss_checks_t
 
	mchecks
;

690 
sw™ch_šg»ss_by·ss_t
 
	mby·ss
;

692 
sw™ch__m‘ad©a_t
 
	mv4
;

693 
sw™ch__m‘ad©a_t
 
	mv6
;

694 
sw™ch_pÜt_Ïg_Ïb–_t
 
	mpÜt_Ïg_Ïb–
;

695 
sw™ch_bd_Ïb–_t
 
	mbd_Ïb–
;

696 
sw™ch_if_Ïb–_t
 
	mif_Ïb–
;

697 
sw™ch_l4_pÜt_Ïb–_t
 
	ml4_pÜt_Ïb–
;

699 
sw™ch_drİ_»asÚ_t
 
	mdrİ_»asÚ
;

700 
sw™ch_ıu_»asÚ_t
 
	mıu_»asÚ
;

702 
sw™ch_rmac_group_t
 
	mrmac_group
;

703 
sw™ch_lookup_f›lds_t
 
	mlkp
;

704 
sw™ch_muÉiÿ¡_m‘ad©a_t
 
	mmuÉiÿ¡
;

705 
sw™ch_¡p_m‘ad©a_t
 
	m¡p
;

706 
sw™ch_qos_m‘ad©a_t
 
	mqos
;

707 
sw™ch_tuÂ–_m‘ad©a_t
 
	mtuÂ–
;

708 
sw™ch_Ë¬nšg_m‘ad©a_t
 
	mË¬nšg
;

709 
sw™ch_mœrÜ_m‘ad©a_t
 
	mmœrÜ
;

710 
sw™ch_d‹l_m‘ad©a_t
 
	md‹l
;

714 @
·_cÚš”_size
("egress", "eg_md.mirror.src", 8)

715 @
·_cÚš”_size
("egress", "eg_md.mirror.type", 8)

716 
	ssw™ch_eg»ss_m‘ad©a_t
 {

717 
sw™ch_pkt_¤c_t
 
	mpkt_¤c
;

718 
sw™ch_pkt_Ëngth_t
 
	mpkt_Ëngth
;

719 
sw™ch_pkt_ty³_t
 
	mpkt_ty³
;

721 
sw™ch_pÜt_Ïg_šdex_t
 
	mpÜt_Ïg_šdex
;

722 
sw™ch_pÜt_ty³_t
 
	mpÜt_ty³
;

723 
sw™ch_pÜt_t
 
	mpÜt
;

724 
sw™ch_pÜt_t
 
	mšg»ss_pÜt
;

725 
sw™ch_ifšdex_t
 
	mšg»ss_ifšdex
;

726 
sw™ch_bd_t
 
	mbd
;

727 
sw™ch_vrf_t
 
	mvrf
;

728 
sw™ch_Ãxthİ_t
 
	mÃxthİ
;

729 
sw™ch_ou‹r_Ãxthİ_t
 
	mou‹r_Ãxthİ
;

731 
	mb™
<32> 
	mtime¡amp
;

732 
	mb™
<48> 
	mšg»ss_time¡amp
;

734 
sw™ch_eg»ss_æags_t
 
	mæags
;

735 
sw™ch_eg»ss_checks_t
 
	mchecks
;

736 
sw™ch_eg»ss_by·ss_t
 
	mby·ss
;

739 
sw™ch_pÜt_Ïg_Ïb–_t
 
	mpÜt_Ïg_Ïb–
;

740 
sw™ch_bd_Ïb–_t
 
	mbd_Ïb–
;

741 
sw™ch_if_Ïb–_t
 
	mif_Ïb–
;

742 
sw™ch_l4_pÜt_Ïb–_t
 
	ml4_pÜt_Ïb–
;

744 
sw™ch_lookup_f›lds_t
 
	mlkp
;

745 
sw™ch_qos_m‘ad©a_t
 
	mqos
;

746 
sw™ch_tuÂ–_m‘ad©a_t
 
	mtuÂ–
;

747 
sw™ch_mœrÜ_m‘ad©a_t
 
	mmœrÜ
;

748 
sw™ch_d‹l_m‘ad©a_t
 
	md‹l
;

750 
sw™ch_ıu_»asÚ_t
 
	mıu_»asÚ
;

751 
sw™ch_drİ_»asÚ_t
 
	mdrİ_»asÚ
;

755 
	ssw™ch_mœrÜ_m‘ad©a_h
 {

756 
sw™ch_pÜt_mœrÜ_m‘ad©a_h
 
	mpÜt
;

757 
sw™ch_ıu_mœrÜ_m‘ad©a_h
 
	mıu
;

758 
sw™ch_d‹l_drİ_mœrÜ_m‘ad©a_h
 
	md‹l_drİ
;

759 
sw™ch_d‹l_sw™ch_loÿl_mœrÜ_m‘ad©a_h
 
	md‹l_sw™ch_loÿl
;

763 
	ssw™ch_h—d”_t
 {

764 
sw™ch_bridged_m‘ad©a_h
 
	mbridged_md
;

766 
‘h”Ãt_h
 
	m‘h”Ãt
;

767 
çbric_h
 
	mçbric
;

768 
ıu_h
 
	mıu
;

769 
time¡amp_h
 
	mtime¡amp
;

770 
	mvÏn_g_h
[
VLAN_DEPTH
] 
	mvÏn_g
;

771 
	mm¶s_h
[
MPLS_DEPTH
] 
	mm¶s
;

772 
v4_h
 
	mv4
;

773 
v4_İtiÚ_h
 
	mv4_İtiÚ
;

774 
v6_h
 
	mv6
;

775 
¬p_h
 
	m¬p
;

776 
udp_h
 
	mudp
;

777 
icmp_h
 
	micmp
;

778 
igmp_h
 
	migmp
;

779 
tı_h
 
	mtı
;

780 
d‹l_»pÜt_v05_h
 
	md‹l
;

781 
d‹l_sw™ch_loÿl_»pÜt_h
 
	md‹l_sw™ch_loÿl_»pÜt
;

782 
d‹l_drİ_»pÜt_h
 
	md‹l_drİ_»pÜt
;

783 
roûv2_bth_h
 
	mroûv2_bth
;

784 
vxÏn_h
 
	mvxÏn
;

785 
g»_h
 
	mg»
;

786 
nvg»_h
 
	mnvg»
;

787 
g’eve_h
 
	mg’eve
;

788 
”¥ª_ty³2_h
 
	m”¥ª_ty³2
;

789 
”¥ª_ty³3_h
 
	m”¥ª_ty³3
;

790 
”¥ª_¶©fÜm_h
 
	m”¥ª_¶©fÜm
;

791 
‘h”Ãt_h
 
	mšÃr_‘h”Ãt
;

792 
v4_h
 
	mšÃr_v4
;

793 
v6_h
 
	mšÃr_v6
;

794 
udp_h
 
	mšÃr_udp
;

795 
tı_h
 
	mšÃr_tı
;

796 
icmp_h
 
	mšÃr_icmp
;

	@shared/validation.p4

27 
cÚŒŞ
 
	$PktV®id©iÚ
(

28 
š
 
sw™ch_h—d”_t
 
hdr
,

29 
šout
 
sw™ch_šg»ss_æags_t
 
æags
,

30 
šout
 
sw™ch_lookup_f›lds_t
 
lkp
,

31 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
,

32 
out
 
sw™ch_drİ_»asÚ_t
 
drİ_»asÚ
) {

37 cÚ¡ 
sw™ch_ušt32_t
 
bË_size
 = 64;

39 
aùiÚ
 
	`š™_l4_lkp_pÜts
() {

40 
lkp
.
l4_¤c_pÜt
 = 0;

41 
lkp
.
l4_d¡_pÜt
 = 0;

44 
aùiÚ
 
	`m®fÜmed_pkt
(
b™
<8> 
»asÚ
) {

45 
drİ_»asÚ
 = 
»asÚ
;

48 
aùiÚ
 
	`m®fÜmed_nÚ__pkt
(
b™
<8> 
»asÚ
) {

49 
	`š™_l4_lkp_pÜts
();

50 
lkp
.
mac_¤c_addr
 = 
hdr
.
‘h”Ãt
.
¤c_addr
;

51 
lkp
.
mac_d¡_addr
 = 
hdr
.
‘h”Ãt
.
d¡_addr
;

52 
lkp
.
mac_ty³
 = 
hdr
.
‘h”Ãt
.
‘h”_ty³
;

53 
	`m®fÜmed_pkt
(
»asÚ
);

56 
aùiÚ
 
	`v®id_uniÿ¡_pkt_uÁagged
() {

57 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_UNICAST
;

58 
lkp
.
mac_¤c_addr
 = 
hdr
.
‘h”Ãt
.
¤c_addr
;

59 
lkp
.
mac_d¡_addr
 = 
hdr
.
‘h”Ãt
.
d¡_addr
;

60 
lkp
.
mac_ty³
 = 
hdr
.
‘h”Ãt
.
‘h”_ty³
;

63 
aùiÚ
 
	`v®id_muÉiÿ¡_pkt_uÁagged
() {

64 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_MULTICAST
;

65 
lkp
.
mac_¤c_addr
 = 
hdr
.
‘h”Ãt
.
¤c_addr
;

66 
lkp
.
mac_d¡_addr
 = 
hdr
.
‘h”Ãt
.
d¡_addr
;

67 
lkp
.
mac_ty³
 = 
hdr
.
‘h”Ãt
.
‘h”_ty³
;

70 
aùiÚ
 
	`v®id_brßdÿ¡_pkt_uÁagged
() {

71 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_BROADCAST
;

72 
lkp
.
mac_¤c_addr
 = 
hdr
.
‘h”Ãt
.
¤c_addr
;

73 
lkp
.
mac_d¡_addr
 = 
hdr
.
‘h”Ãt
.
d¡_addr
;

74 
lkp
.
mac_ty³
 = 
hdr
.
‘h”Ãt
.
‘h”_ty³
;

77 
aùiÚ
 
	`v®id_uniÿ¡_pkt_gged
() {

78 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_UNICAST
;

79 
lkp
.
mac_¤c_addr
 = 
hdr
.
‘h”Ãt
.
¤c_addr
;

80 
lkp
.
mac_d¡_addr
 = 
hdr
.
‘h”Ãt
.
d¡_addr
;

81 
lkp
.
mac_ty³
 = 
hdr
.
vÏn_g
[0].
‘h”_ty³
;

82 
lkp
.
pı
 = 
hdr
.
vÏn_g
[0].pcp;

85 
aùiÚ
 
	`v®id_muÉiÿ¡_pkt_gged
() {

86 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_MULTICAST
;

87 
lkp
.
mac_¤c_addr
 = 
hdr
.
‘h”Ãt
.
¤c_addr
;

88 
lkp
.
mac_d¡_addr
 = 
hdr
.
‘h”Ãt
.
d¡_addr
;

89 
lkp
.
mac_ty³
 = 
hdr
.
vÏn_g
[0].
‘h”_ty³
;

90 
lkp
.
pı
 = 
hdr
.
vÏn_g
[0].pcp;

93 
aùiÚ
 
	`v®id_brßdÿ¡_pkt_gged
() {

94 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_BROADCAST
;

95 
lkp
.
mac_¤c_addr
 = 
hdr
.
‘h”Ãt
.
¤c_addr
;

96 
lkp
.
mac_d¡_addr
 = 
hdr
.
‘h”Ãt
.
d¡_addr
;

97 
lkp
.
mac_ty³
 = 
hdr
.
vÏn_g
[0].
‘h”_ty³
;

98 
lkp
.
pı
 = 
hdr
.
vÏn_g
[0].pcp;

101 
aùiÚ
 
	`v®id_uniÿ¡_pkt_doubË_gged
() {

102 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_UNICAST
;

103 
lkp
.
mac_¤c_addr
 = 
hdr
.
‘h”Ãt
.
¤c_addr
;

104 
lkp
.
mac_d¡_addr
 = 
hdr
.
‘h”Ãt
.
d¡_addr
;

105 
lkp
.
mac_ty³
 = 
hdr
.
vÏn_g
[1].
‘h”_ty³
;

106 
lkp
.
pı
 = 
hdr
.
vÏn_g
[1].pcp;

109 
bË
 
v®id©e_‘h”Ãt
 {

110 
key
 = {

111 
hdr
.
‘h”Ãt
.
¤c_addr
 : 
‹º¬y
;

112 
hdr
.
‘h”Ãt
.
d¡_addr
 : 
‹º¬y
;

113 
hdr
.
vÏn_g
[0].
	`isV®id
(è: 
‹º¬y
;

114 #ifdeà
QINQ_RIF_ENABLE


115 
hdr
.
vÏn_g
[1].
	`isV®id
(è: 
‹º¬y
;

119 
aùiÚs
 = {

120 
m®fÜmed_nÚ__pkt
;

121 
v®id_uniÿ¡_pkt_uÁagged
;

122 
v®id_muÉiÿ¡_pkt_uÁagged
;

123 
v®id_brßdÿ¡_pkt_uÁagged
;

124 
v®id_uniÿ¡_pkt_gged
;

125 
v®id_muÉiÿ¡_pkt_gged
;

126 
v®id_brßdÿ¡_pkt_gged
;

127 #ifdeà
QINQ_RIF_ENABLE


128 
v®id_uniÿ¡_pkt_doubË_gged
;

132 
size
 = 
bË_size
;

145 
aùiÚ
 
	`m®fÜmed_v4_pkt
(
b™
<8> 
»asÚ
) {

147 
lkp
.
_ty³
 = 
SWITCH_IP_TYPE_IPV4
;

148 
lkp
.
_tos
 = 
hdr
.
v4
.
diff£rv
;

149 
lkp
.
_´Ùo
 = 
hdr
.
v4
.
´ÙocŞ
;

150 
lkp
.
_‰l
 = 
hdr
.
v4
.
‰l
;

151 
lkp
.
_¤c_addr
 = (
b™
<128>è
hdr
.
v4
.
¤c_addr
;

152 
lkp
.
_d¡_addr
 = (
b™
<128>è
hdr
.
v4
.
d¡_addr
;

153 
	`m®fÜmed_pkt
(
»asÚ
);

156 
aùiÚ
 
	`v®id_v4_pkt
(
sw™ch__äag_t
 
_äag
) {

158 
lkp
.
_ty³
 = 
SWITCH_IP_TYPE_IPV4
;

159 
lkp
.
_tos
 = 
hdr
.
v4
.
diff£rv
;

160 
lkp
.
_´Ùo
 = 
hdr
.
v4
.
´ÙocŞ
;

161 
lkp
.
_‰l
 = 
hdr
.
v4
.
‰l
;

162 
lkp
.
_¤c_addr
 = (
b™
<128>è
hdr
.
v4
.
¤c_addr
;

163 
lkp
.
_d¡_addr
 = (
b™
<128>è
hdr
.
v4
.
d¡_addr
;

164 
lkp
.
_äag
 = ip_frag;

167 
bË
 
v®id©e_v4
 {

168 
key
 = {

169 
æags
.
v4_checksum_”r
 : 
‹º¬y
;

170 
hdr
.
v4
.
v”siÚ
 : 
‹º¬y
;

171 
hdr
.
v4
.
ihl
 : 
‹º¬y
;

172 
hdr
.
v4
.
æags
 : 
‹º¬y
;

173 
hdr
.
v4
.
äag_off£t
 : 
‹º¬y
;

174 
hdr
.
v4
.
‰l
 : 
‹º¬y
;

175 
hdr
.
v4
.
¤c_addr
[31:24] : 
‹º¬y
;

178 
aùiÚs
 = {

179 
v®id_v4_pkt
;

180 
m®fÜmed_v4_pkt
;

183 
size
 = 
bË_size
;

193 
aùiÚ
 
	`m®fÜmed_v6_pkt
(
b™
<8> 
»asÚ
) {

195 
lkp
.
_ty³
 = 
SWITCH_IP_TYPE_IPV6
;

196 
lkp
.
_tos
 = 
hdr
.
v6
.
Œaffic_şass
;

197 
lkp
.
_´Ùo
 = 
hdr
.
v6
.
Ãxt_hdr
;

198 
lkp
.
_‰l
 = 
hdr
.
v6
.
hİ_lim™
;

199 
lkp
.
_¤c_addr
 = 
hdr
.
v6
.
¤c_addr
;

200 
lkp
.
_d¡_addr
 = 
hdr
.
v6
.
d¡_addr
;

201 
	`m®fÜmed_pkt
(
»asÚ
);

204 
aùiÚ
 
	`v®id_v6_pkt
(
boŞ
 
is_lšk_loÿl
) {

206 
lkp
.
_ty³
 = 
SWITCH_IP_TYPE_IPV6
;

207 
lkp
.
_tos
 = 
hdr
.
v6
.
Œaffic_şass
;

208 
lkp
.
_´Ùo
 = 
hdr
.
v6
.
Ãxt_hdr
;

209 
lkp
.
_‰l
 = 
hdr
.
v6
.
hİ_lim™
;

210 
lkp
.
_¤c_addr
 = 
hdr
.
v6
.
¤c_addr
;

211 
lkp
.
_d¡_addr
 = 
hdr
.
v6
.
d¡_addr
;

212 
æags
.
lšk_loÿl
 = 
is_lšk_loÿl
;

215 
bË
 
v®id©e_v6
 {

216 
key
 = {

217 
hdr
.
v6
.
v”siÚ
 : 
‹º¬y
;

218 
hdr
.
v6
.
hİ_lim™
 : 
‹º¬y
;

219 
hdr
.
v6
.
¤c_addr
[127:96] : 
‹º¬y
;

222 
aùiÚs
 = {

223 
v®id_v6_pkt
;

224 
m®fÜmed_v6_pkt
;

227 
size
 = 
bË_size
;

233 
aùiÚ
 
	`£t_tı_pÜts
() {

234 
lkp
.
l4_¤c_pÜt
 = 
hdr
.
tı
.
¤c_pÜt
;

235 
lkp
.
l4_d¡_pÜt
 = 
hdr
.
tı
.
d¡_pÜt
;

236 
lkp
.
tı_æags
 = 
hdr
.
tı
.
æags
;

239 
aùiÚ
 
	`£t_udp_pÜts
() {

240 
lkp
.
l4_¤c_pÜt
 = 
hdr
.
udp
.
¤c_pÜt
;

241 
lkp
.
l4_d¡_pÜt
 = 
hdr
.
udp
.
d¡_pÜt
;

244 
aùiÚ
 
	`£t_icmp_ty³
() {

245 
lkp
.
l4_¤c_pÜt
[7:0] = 
hdr
.
icmp
.
ty³
;

246 
lkp
.
l4_¤c_pÜt
[15:8] = 
hdr
.
icmp
.
code
;

247 
lkp
.
l4_d¡_pÜt
 = 0;

250 
aùiÚ
 
	`£t_igmp_ty³
() {

251 #ifdeà
IGMP_SNOOPING_ENABLE


252 
lkp
.
l4_¤c_pÜt
[7:0] = 
hdr
.
icmp
.
ty³
;

253 
lkp
.
l4_¤c_pÜt
[15:8] = 0;

255 
lkp
.
l4_¤c_pÜt
 = 0;

257 
lkp
.
l4_d¡_pÜt
 = 0;

260 
aùiÚ
 
	`£t_¬p_İcode
() {

261 
	`š™_l4_lkp_pÜts
();

262 
lkp
.
¬p_İcode
 = 
hdr
.
¬p
.
İcode
;

266 
bË
 
v®id©e_Ùh”
 {

267 
key
 = {

268 
hdr
.
tı
.
	`isV®id
(è: 
exaù
;

269 
hdr
.
udp
.
	`isV®id
(è: 
exaù
;

270 
hdr
.
icmp
.
	`isV®id
(è: 
exaù
;

271 
hdr
.
igmp
.
	`isV®id
(è: 
exaù
;

272 
hdr
.
¬p
.
	`isV®id
(è: 
exaù
;

275 
aùiÚs
 = {

276 
š™_l4_lkp_pÜts
;

277 
£t_tı_pÜts
;

278 
£t_udp_pÜts
;

279 
£t_icmp_ty³
;

280 
£t_igmp_ty³
;

281 
£t_¬p_İcode
;

284 cÚ¡ 
deçuÉ_aùiÚ
 = 
š™_l4_lkp_pÜts
;

285 cÚ¡ 
’Œ›s
 = {

286 (
Œue
, 
çl£
, f®£, f®£, f®£è: 
	`£t_tı_pÜts
();

287 (
çl£
, 
Œue
, f®£, f®£, f®£è: 
	`£t_udp_pÜts
();

288 (
çl£
, f®£, 
Œue
, f®£, f®£è: 
	`£t_icmp_ty³
();

289 (
çl£
, f®£, f®£, 
Œue
, f®£è: 
	`£t_igmp_ty³
();

290 (
çl£
, f®£, f®£, f®£, 
Œue
è: 
	`£t_¬p_İcode
();

294 
­¶y
 {

295 
æags
.
lšk_loÿl
 = 
çl£
;

298 
lkp
.
mac_¤c_addr
 = 0;

299 
lkp
.
mac_d¡_addr
 = 0;

300 
lkp
.
mac_ty³
 = 0;

301 
lkp
.
pı
 = 0;

302 
lkp
.
¬p_İcode
 = 0;

303 
lkp
.
_ty³
 = 0;

304 
lkp
.
_tos
 = 0;

305 
lkp
.
_´Ùo
 = 0;

306 
lkp
.
_‰l
 = 0;

307 
lkp
.
_¤c_addr
 = 0;

308 
lkp
.
_d¡_addr
 = 0;

309 
lkp
.
_äag
 = 0;

311 
v®id©e_‘h”Ãt
.
	`­¶y
().
aùiÚ_run
) {

312 
m®fÜmed_nÚ__pkt
 : {}

314 ià(
hdr
.
v4
.
	`isV®id
()) {

315 
v®id©e_v4
.
	`­¶y
();

316 } ià(
hdr
.
v6
.
	`isV®id
()) {

317 #ifdeà
IPV6_ENABLE


318 
v®id©e_v6
.
	`­¶y
();

322 
v®id©e_Ùh”
.
	`­¶y
();

326 
	}
}

332 
cÚŒŞ
 
	$IÂ”PktV®id©iÚ
(

333 
š
 
sw™ch_h—d”_t
 
hdr
,

334 
šout
 
sw™ch_lookup_f›lds_t
 
lkp
,

335 
šout
 
sw™ch_šg»ss_æags_t
 
æags
,

336 
šout
 
sw™ch_drİ_»asÚ_t
 
drİ_»asÚ
) {

338 
aùiÚ
 
	`v®id_uniÿ¡_pkt
() {

340 
lkp
.
mac_¤c_addr
 = 
hdr
.
šÃr_‘h”Ãt
.
¤c_addr
;

341 
lkp
.
mac_d¡_addr
 = 
hdr
.
šÃr_‘h”Ãt
.
d¡_addr
;

342 
lkp
.
mac_ty³
 = 
hdr
.
šÃr_‘h”Ãt
.
‘h”_ty³
;

343 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_UNICAST
;

347 
aùiÚ
 
	`v®id_muÉiÿ¡_pkt
() {

349 
lkp
.
mac_¤c_addr
 = 
hdr
.
šÃr_‘h”Ãt
.
¤c_addr
;

350 
lkp
.
mac_d¡_addr
 = 
hdr
.
šÃr_‘h”Ãt
.
d¡_addr
;

351 
lkp
.
mac_ty³
 = 
hdr
.
šÃr_‘h”Ãt
.
‘h”_ty³
;

352 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_MULTICAST
;

355 
aùiÚ
 
	`v®id_brßdÿ¡_pkt
() {

357 
lkp
.
mac_¤c_addr
 = 
hdr
.
šÃr_‘h”Ãt
.
¤c_addr
;

358 
lkp
.
mac_d¡_addr
 = 
hdr
.
šÃr_‘h”Ãt
.
d¡_addr
;

359 
lkp
.
mac_ty³
 = 
hdr
.
šÃr_‘h”Ãt
.
‘h”_ty³
;

360 
lkp
.
pkt_ty³
 = 
SWITCH_PKT_TYPE_BROADCAST
;

363 
aùiÚ
 
	`m®fÜmed_pkt
(
b™
<8> 
»asÚ
) {

364 
drİ_»asÚ
 = 
»asÚ
;

367 
bË
 
v®id©e_‘h”Ãt
 {

368 
key
 = {

369 
hdr
.
šÃr_‘h”Ãt
.
	`isV®id
(è: 
exaù
;

370 
hdr
.
šÃr_‘h”Ãt
.
d¡_addr
 : 
‹º¬y
;

373 
aùiÚs
 = {

374 
NoAùiÚ
;

375 
v®id_uniÿ¡_pkt
;

376 
v®id_muÉiÿ¡_pkt
;

377 
v®id_brßdÿ¡_pkt
;

378 
m®fÜmed_pkt
;

382 
aùiÚ
 
	`v®id_v4_pkt
() {

384 
lkp
.
_ty³
 = 
SWITCH_IP_TYPE_IPV4
;

385 
lkp
.
_tos
 = 
hdr
.
šÃr_v4
.
diff£rv
;

386 
lkp
.
_‰l
 = 
hdr
.
šÃr_v4
.
‰l
;

387 
lkp
.
_´Ùo
 = 
hdr
.
šÃr_v4
.
´ÙocŞ
;

388 
lkp
.
_¤c_addr
 = (
b™
<128>è
hdr
.
šÃr_v4
.
¤c_addr
;

389 
lkp
.
_d¡_addr
 = (
b™
<128>è
hdr
.
šÃr_v4
.
d¡_addr
;

392 
bË
 
v®id©e_v4
 {

393 
key
 = {

394 
æags
.
šÃr_v4_checksum_”r
 : 
‹º¬y
;

395 
hdr
.
šÃr_v4
.
v”siÚ
 : 
‹º¬y
;

396 
hdr
.
šÃr_v4
.
ihl
 : 
‹º¬y
;

397 
hdr
.
šÃr_v4
.
‰l
 : 
‹º¬y
;

400 
aùiÚs
 = {

401 
v®id_v4_pkt
;

402 
m®fÜmed_pkt
;

418 
aùiÚ
 
	`v®id_v6_pkt
() {

419 #ifdeà
IPV6_ENABLE


421 
lkp
.
_ty³
 = 
SWITCH_IP_TYPE_IPV6
;

422 
lkp
.
_tos
 = 
hdr
.
šÃr_v6
.
Œaffic_şass
;

423 
lkp
.
_‰l
 = 
hdr
.
šÃr_v6
.
hİ_lim™
;

424 
lkp
.
_´Ùo
 = 
hdr
.
šÃr_v6
.
Ãxt_hdr
;

425 
lkp
.
_¤c_addr
 = 
hdr
.
šÃr_v6
.
¤c_addr
;

426 
lkp
.
_d¡_addr
 = 
hdr
.
šÃr_v6
.
d¡_addr
;

427 
æags
.
lšk_loÿl
 = 
çl£
;

431 
bË
 
v®id©e_v6
 {

432 
key
 = {

433 
hdr
.
šÃr_v6
.
v”siÚ
 : 
‹º¬y
;

434 
hdr
.
šÃr_v6
.
hİ_lim™
 : 
‹º¬y
;

437 
aùiÚs
 = {

438 
v®id_v6_pkt
;

439 
m®fÜmed_pkt
;

441 cÚ¡ 
’Œ›s
 = {

442 (0 &&& 0, 0è: 
	`m®fÜmed_pkt
(
SWITCH_DROP_REASON_IP_IHL_INVALID
);

443 (6, 0 &&& 0è: 
	`v®id_v6_pkt
();

444 (0 &&& 0, 0 &&& 0è: 
	`m®fÜmed_pkt
(
SWITCH_DROP_REASON_IP_VERSION_INVALID
);

448 
aùiÚ
 
	`£t_tı_pÜts
() {

449 
lkp
.
l4_¤c_pÜt
 = 
hdr
.
šÃr_tı
.
¤c_pÜt
;

450 
lkp
.
l4_d¡_pÜt
 = 
hdr
.
šÃr_tı
.
d¡_pÜt
;

453 
aùiÚ
 
	`£t_udp_pÜts
() {

454 
lkp
.
l4_¤c_pÜt
 = 
hdr
.
šÃr_udp
.
¤c_pÜt
;

455 
lkp
.
l4_d¡_pÜt
 = 
hdr
.
šÃr_udp
.
d¡_pÜt
;

458 
bË
 
v®id©e_Ùh”
 {

459 
key
 = {

460 
hdr
.
šÃr_tı
.
	`isV®id
(è: 
exaù
;

461 
hdr
.
šÃr_udp
.
	`isV®id
(è: 
exaù
;

464 
aùiÚs
 = {

465 
NoAùiÚ
;

466 
£t_tı_pÜts
;

467 
£t_udp_pÜts
;

470 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

471 cÚ¡ 
’Œ›s
 = {

472 (
Œue
, 
çl£
è: 
	`£t_tı_pÜts
();

473 (
çl£
, 
Œue
è: 
	`£t_udp_pÜts
();

478 
­¶y
 {

479 
v®id©e_‘h”Ãt
.
	`­¶y
().
aùiÚ_run
) {

480 
m®fÜmed_pkt
 : {}

482 ià(
hdr
.
šÃr_v4
.
	`isV®id
()) {

483 
v®id©e_v4
.
	`­¶y
();

484 } ià(
hdr
.
šÃr_v6
.
	`isV®id
()) {

485 #ifdeà
IPV6_TUNNEL_ENABLE


486 
v®id©e_v6
.
	`­¶y
();

490 
v®id©e_Ùh”
.
	`­¶y
();

494 
	}
}

	@shared/wred.p4

31 
cÚŒŞ
 
	$WRED
(
šout
 
sw™ch_h—d”_t
 
hdr
,

32 
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

33 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

34 
out
 
boŞ
 
æag
) {

36 
sw™ch_w»d_šdex_t
 
šdex
;

39 
b™
<1> 
w»d_æag
;

40 cÚ¡ 
sw™ch_ušt32_t
 
w»d_size
 = 1 << 
sw™ch_w»d_šdex_width
;

42 cÚ¡ 
sw™ch_ušt32_t
 
w»d_šdex_bË_size
 = 2048;

44 
DœeùCouÁ”
<
b™
<32>>(
CouÁ”Ty³_t
.
PACKETS_AND_BYTES
è
¡©s
;

46 
W»d
<
b™
<19>, 
sw™ch_w»d_šdex_t
>(
w»d_size
, 1 , 0 ) 
w»d
;

48 
aùiÚ
 
	`£t_v4_eú
() {

49 
hdr
.
v4
.
diff£rv
[1:0] = 
SWITCH_ECN_CODEPOINT_CE
;

52 
aùiÚ
 
	`£t_v6_eú
() {

53 
hdr
.
v6
.
Œaffic_şass
[1:0] = 
SWITCH_ECN_CODEPOINT_CE
;

56 
aùiÚ
 
	`drİ
() {

57 
æag
 = 
Œue
;

62 
bË
 
w»d_aùiÚ
 {

63 
key
 = {

64 
šdex
 : 
exaù
;

65 
hdr
.
v4
.
	`isV®id
(è: 
‹º¬y
;

66 
hdr
.
v4
.
diff£rv
 : 
‹º¬y
;

67 
hdr
.
v6
.
	`isV®id
(è: 
‹º¬y
;

68 
hdr
.
v6
.
Œaffic_şass
 : 
‹º¬y
;

71 
aùiÚs
 = {

72 
NoAùiÚ
;

73 
drİ
;

74 
£t_v4_eú
;

75 
£t_v6_eú
;

79 
size
 = 4 * 
w»d_size
;

82 
aùiÚ
 
	`£t_w»d_šdex
(
sw™ch_w»d_šdex_t
 
w»d_šdex
) {

83 
šdex
 = 
w»d_šdex
;

84 
w»d_æag
 = (
b™
<1>è
w»d
.
	`execu‹
(
eg_md
.
qos
.
qd•th
, 
w»d_šdex
);

88 
bË
 
w»d_šdex
 {

89 
key
 = {

90 
eg_šŒ_md
.
eg»ss_pÜt
 : 
exaù
 @
	`Çme
("port");

91 
eg_md
.
qos
.
qid
 : 
exaù
 @
	`Çme
("qid");

92 
eg_md
.
qos
.
cŞÜ
 : 
exaù
 @
	`Çme
("color");

95 
aùiÚs
 = {

96 
NoAùiÚ
;

97 
£t_w»d_šdex
;

100 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

101 
size
 = 
w»d_šdex_bË_size
;

104 
aùiÚ
 
	`couÁ
(è{ 
¡©s
.count(); }

106 
bË
 
w»d_¡©s
 {

107 
key
 = {

108 
eg_šŒ_md
.
eg»ss_pÜt
 : 
exaù
 @
	`Çme
("port");

109 
eg_md
.
qos
.
qid
 : 
exaù
 @
	`Çme
("qid");

110 
eg_md
.
qos
.
cŞÜ
 : 
exaù
 @
	`Çme
("color");

111 
æag
 : 
exaù
;

114 
aùiÚs
 = {

115 @
deçuÉÚly
 
NoAùiÚ
;

116 
couÁ
;

119 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

120 
size
 = 2 * 
w»d_šdex_bË_size
;

121 
couÁ”s
 = 
¡©s
;

124 
­¶y
 {

125 #ifdeà
WRED_ENABLE


126 
æag
 = 
çl£
;

127 
w»d_æag
 = 0;

128 
šdex
 = 0;

130 ià(!
	`EGRESS_BYPASS
(
WRED
))

131 
w»d_šdex
.
	`­¶y
();

133 ià(!
	`EGRESS_BYPASS
(
WRED
è&& 
w»d_æag
 == 1) {

134 
w»d_aùiÚ
.
	`­¶y
().
aùiÚ_run
) {

135 
NoAùiÚ
 : {}

136  : { 
w»d_¡©s
.
	`­¶y
(); }

141 
	}
}

	@switch-tofino/features.p4

27 
	#COPP_ENABLE


	)

28 #ià
__TARGET_TOFINO__
 == 1

29 
	#DTEL_ENABLE


	)

30 
	#DTEL_QUEUE_REPORT_ENABLE


	)

31 
	#DTEL_DROP_REPORT_ENABLE


	)

32 
	#DTEL_FLOW_REPORT_ENABLE


	)

33 
	#DTEL_ACL_ENABLE


	)

36 
	#EGRESS_PORT_MIRROR_ENABLE


	)

37 
	#ERSPAN_ENABLE


	)

38 
	#ERSPAN_TYPE2_ENABLE


	)

39 
	#INGRESS_ACL_POLICER_ENABLE


	)

40 
	#INGRESS_PORT_MIRROR_ENABLE


	)

42 
	#IPV6_ENABLE


	)

44 
	#L4_PORT_LOU_ENABLE


	)

46 
	#MIRROR_ENABLE


	)

47 
	#INGRESS_MIRROR_ACL_ENABLE


	)

48 
	#NON_SHARED_INGRESS_MIRROR_ACL


	)

50 
	#MULTICAST_ENABLE


	)

51 
	#PACKET_LENGTH_ADJUSTMENT


	)

56 
	#QOS_ENABLE


	)

58 
	#RACL_ENABLE


	)

59 
	#STORM_CONTROL_ENABLE


	)

60 
	#STP_ENABLE


	)

	@switch-tofino/switch.p4

23 #ià
defšed
(
A0_PROFILE
)

24 
	~"sw™ch_tofšo_a0.p4
"

25 #–ià
defšed
(
B0_PROFILE
)

26 
	~"sw™ch_tofšo_b0.p4
"

27 #–ià
defšed
(
L0_PROFILE
)

28 
	~"sw™ch_´ofe_l0.p4
"

31 
	~<cÜe.p4
>

32 #ià
__TARGET_TOFINO__
 == 2

33 
	~<t2Ç.p4
>

35 
	~<Ša.p4
>

38 
	~"ã©u»s.p4
"

39 
	~"h—d”s.p4
"

40 
	~"ty³s.p4
"

42 cÚ¡ 
	gb™
<32> 
	gPORT_TABLE_SIZE
 = 288 * 2;

45 cÚ¡ 
	gb™
<32> 
	gVLAN_TABLE_SIZE
 = 4096;

46 cÚ¡ 
	gb™
<32> 
	gBD_FLOOD_TABLE_SIZE
 = 
VLAN_TABLE_SIZE
 * 4;

49 cÚ¡ 
	gb™
<32> 
	gPORT_VLAN_TABLE_SIZE
 = 1024;

52 cÚ¡ 
	gb™
<32> 
	gDOUBLE_TAG_TABLE_SIZE
 = 4096;

55 cÚ¡ 
	gb™
<32> 
	gBD_TABLE_SIZE
 = 5120;

58 cÚ¡ 
	gb™
<32> 
	gMAC_TABLE_SIZE
 = 16384;

61 cÚ¡ 
	gb™
<32> 
	gIPV4_LPM_TABLE_SIZE
 = 16384;

62 cÚ¡ 
	gb™
<32> 
	gIPV6_LPM_TABLE_SIZE
 = 1024;

63 cÚ¡ 
	gb™
<32> 
	gIPV4_HOST_TABLE_SIZE
 = 16384;

64 cÚ¡ 
	gb™
<32> 
	gIPV6_HOST_TABLE_SIZE
 = 8192;

66 cÚ¡ 
	gb™
<32> 
	gIPV4_MULTICAST_STAR_G_TABLE_SIZE
 = 2048;

67 cÚ¡ 
	gb™
<32> 
	gIPV4_MULTICAST_S_G_TABLE_SIZE
 = 4096;

68 cÚ¡ 
	gb™
<32> 
	gIPV6_MULTICAST_STAR_G_TABLE_SIZE
 = 512;

69 cÚ¡ 
	gb™
<32> 
	gIPV6_MULTICAST_S_G_TABLE_SIZE
 = 512;

70 cÚ¡ 
	gb™
<32> 
	gRID_TABLE_SIZE
 = 4096;

73 cÚ¡ 
	gb™
<32> 
	gDEST_TUNNEL_TABLE_SIZE
 = 512;

74 cÚ¡ 
	gb™
<32> 
	gIPV4_SRC_TUNNEL_TABLE_SIZE
 = 4096;

75 cÚ¡ 
	gb™
<32> 
	gIPV6_SRC_TUNNEL_TABLE_SIZE
 = 1024;

76 cÚ¡ 
	gb™
<32> 
	gVNI_MAPPING_TABLE_SIZE
 = 4096;

77 cÚ¡ 
	gb™
<32> 
	gTUNNEL_SRC_REWRITE_TABLE_SIZE
 = 512;

78 cÚ¡ 
	gb™
<32> 
	gTUNNEL_DST_REWRITE_TABLE_SIZE
 = 4096;

79 cÚ¡ 
	gb™
<32> 
	gTUNNEL_SMAC_REWRITE_TABLE_SIZE
 = 512;

80 cÚ¡ 
	gb™
<32> 
	gTUNNEL_DMAC_REWRITE_TABLE_SIZE
 = 4096;

81 cÚ¡ 
	gb™
<32> 
	gTUNNEL_REWRITE_TABLE_SIZE
 = 512;

84 cÚ¡ 
	gb™
<32> 
	gECMP_GROUP_TABLE_SIZE
 = 1024;

85 cÚ¡ 
	gb™
<32> 
	gOUTER_ECMP_GROUP_TABLE_SIZE
 = 1024;

86 cÚ¡ 
	gb™
<32> 
	gECMP_SELECT_TABLE_SIZE
 = 16384;

87 cÚ¡ 
	gb™
<32> 
	gOUTER_ECMP_SELECT_TABLE_SIZE
 = 16384;

88 cÚ¡ 
	gb™
<32> 
	gNEXTHOP_TABLE_SIZE
 = 16384;

89 cÚ¡ 
	gb™
<32> 
	gNUM_TUNNELS
 = 4096;

92 cÚ¡ 
	gb™
<32> 
	gINGRESS_MAC_ACL_TABLE_SIZE
 = 512;

93 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_ACL_TABLE_SIZE
 = 512;

94 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

95 cÚ¡ 
	gb™
<32> 
	gINGRESS_MIRROR_ACL_TABLE_SIZE
 = 512;

96 cÚ¡ 
	gb™
<32> 
	gINGRESS_MAC_QOS_ACL_TABLE_SIZE
 = 512;

97 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_QOS_ACL_TABLE_SIZE
 = 512;

98 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_QOS_ACL_TABLE_SIZE
 = 512;

100 cÚ¡ 
	gb™
<32> 
	gINGRESS_L4_PORT_LOU_TABLE_SIZE
 = 
sw™ch_l4_pÜt_Ïb–_width
 / 2;

102 cÚ¡ 
	gb™
<32> 
	gIPV4_RACL_TABLE_SIZE
 = 512;

103 cÚ¡ 
	gb™
<32> 
	gIPV6_RACL_TABLE_SIZE
 = 512;

106 cÚ¡ 
	gb™
<32> 
	gEGRESS_MAC_ACL_TABLE_SIZE
 = 512;

107 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV4_ACL_TABLE_SIZE
 = 512;

108 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

111 cÚ¡ 
	gb™
<32> 
	gWRED_SIZE
 = 1 << 
sw™ch_w»d_šdex_width
;

114 cÚ¡ 
	gb™
<32> 
	gCOPP_METER_SIZE
 = 1 << 
sw™ch_cİp_m‘”_id_width
;

115 cÚ¡ 
	gb™
<32> 
	gCOPP_DROP_TABLE_SIZE
 = 1 << (
sw™ch_cİp_m‘”_id_width
 + 1);

118 cÚ¡ 
	gb™
<32> 
	gDSCP_TO_TC_TABLE_SIZE
 = 1024;

119 cÚ¡ 
	gb™
<32> 
	gPCP_TO_TC_TABLE_SIZE
 = 1024;

120 cÚ¡ 
	gb™
<32> 
	gQUEUE_TABLE_SIZE
 = 1024;

121 cÚ¡ 
	gb™
<32> 
	gEGRESS_QOS_MAP_TABLE_SIZE
 = 1024;

124 cÚ¡ 
	gb™
<32> 
	gINGRESS_POLICER_TABLE_SIZE
 = 1 << 
sw™ch_pŞiûr_m‘”_šdex_width
;

127 cÚ¡ 
	gb™
<32> 
	gSTORM_CONTROL_TABLE_SIZE
 = 512;

130 cÚ¡ 
	gb™
<32> 
	gINGRESS_SYSTEM_ACL_TABLE_SIZE
 = 512;

131 cÚ¡ 
	gb™
<32> 
	gEGRESS_SYSTEM_ACL_TABLE_SIZE
 = 512;

132 cÚ¡ 
	gb™
<32> 
	gDROP_STATS_TABLE_SIZE
 = 1 << 
sw™ch_drİ_»asÚ_width
;

134 cÚ¡ 
	gb™
<32> 
	gL3_MTU_TABLE_SIZE
 = 1024;

136 #ià
__TARGET_TOFINO__
 == 1

137 
	~"ut.p4
"

139 
	~"../sw™ch-tofšo2/ut.p4
"

142 
	~"l3.p4
"

143 
	~"Ãxthİ.p4
"

144 
	~"·rde.p4
"

145 
	~"pÜt.p4
"

146 
	~"v®id©iÚ.p4
"

147 
	~"»wr™e.p4
"

148 
	~"tuÂ–.p4
"

149 
	~"muÉiÿ¡.p4
"

150 
	~"qos.p4
"

151 
	~"m‘”.p4
"

152 
	~"w»d.p4
"

153 
	~"d‹l.p4
"

155 @
·_no_ov”Ïy
("ingress", "hdr.bridged_md.__pad_3")

157 
cÚŒŞ
 
	$Sw™chIng»ss
(

158 
šout
 
sw™ch_h—d”_t
 
hdr
,

159 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

160 
š
 
šg»ss_šŒšsic_m‘ad©a_t
 
ig_šŒ_md
,

161 
š
 
šg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
ig_šŒ_äom_´¤
,

162 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

163 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
) {

165 
	`Ing»ssPÜtM­pšg
(
PORT_VLAN_TABLE_SIZE
,

166 
BD_TABLE_SIZE
,

167 
DOUBLE_TAG_TABLE_SIZE
è
šg»ss_pÜt_m­pšg
;

168 
	`PktV®id©iÚ
(è
pkt_v®id©iÚ
;

169 
	`Ing»ssSTP
(è
¡p
;

170 
	`SMAC
(
MAC_TABLE_SIZE
è
smac
;

171 
	`DMAC
(
MAC_TABLE_SIZE
è
dmac
;

172 
	`Ing»ssTuÂ–
(
IPV4_SRC_TUNNEL_TABLE_SIZE
è
tuÂ–
;

173 
	`Ing»ssBd
(
BD_TABLE_SIZE
è
bd_¡©s
;

174 
	`Ing»ssMuÉiÿ¡
(
IPV4_MULTICAST_S_G_TABLE_SIZE
,

175 
IPV4_MULTICAST_STAR_G_TABLE_SIZE
,

176 
IPV6_MULTICAST_S_G_TABLE_SIZE
,

177 
IPV6_MULTICAST_STAR_G_TABLE_SIZE
è
muÉiÿ¡
;

178 
	`Ing»ssUniÿ¡
(
dmac
,

179 
IPV4_HOST_TABLE_SIZE
,

180 
IPV4_LPM_TABLE_SIZE
,

181 
IPV6_HOST_TABLE_SIZE
,

182 
IPV6_LPM_TABLE_SIZE
è
uniÿ¡
;

183 
	`Ing»ssAş
(
INGRESS_IPV4_ACL_TABLE_SIZE
,

184 
INGRESS_IPV6_ACL_TABLE_SIZE
,

185 
INGRESS_MAC_ACL_TABLE_SIZE
,

186 
Œue
 ) 
aş
;

187 
	`MœrÜAş
(
¡©s_’abË
=
Œue
è
mœrÜ_aş
;

188 
	`Rou‹rAş
(
IPV4_RACL_TABLE_SIZE
, 
IPV6_RACL_TABLE_SIZE
, 
Œue
è
¿ş
;

190 
	`Ing»ssD‹l
(è
d‹l
;

191 
	`Ing»ssQoS
(è
qos
;

192 
	`StÜmCÚŒŞ
(
STORM_CONTROL_TABLE_SIZE
è
¡Üm_cÚŒŞ
;

193 
	`Nexthİ
(
NEXTHOP_TABLE_SIZE
, 
ECMP_GROUP_TABLE_SIZE
, 
ECMP_SELECT_TABLE_SIZE
è
Ãxthİ
;

194 
	`Ou‹rFib
(

195 
NUM_TUNNELS
, 
OUTER_ECMP_GROUP_TABLE_SIZE
, 
OUTER_ECMP_SELECT_TABLE_SIZE
è
ou‹r_fib
;

196 
	`LAG
(è
Ïg
;

197 
	`MuÉiÿ¡Floodšg
(
BD_FLOOD_TABLE_SIZE
è
æood
;

198 
	`Ing»ssSy¡emAş
(è
sy¡em_aş
;

200 
­¶y
 {

201 
ig_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

202 
ig_md
.
muÉiÿ¡
.
id
 = 0;

203 
ig_md
.
æags
.
¿ş_d’y
 = 
çl£
;

204 #ifdeà
MULTICAST_ENABLE


205 
ig_md
.
æags
.
æood_to_muÉiÿ¡_rou‹rs
 = 
çl£
;

208 
pkt_v®id©iÚ
.
	`­¶y
(
hdr
, 
ig_md
.
æags
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
, ig_md.
drİ_»asÚ
);

209 
šg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

210 
¡p
.
	`­¶y
(
ig_md
, ig_md.stp);

212 
tuÂ–
.
	`­¶y
(
hdr
, 
ig_md
, ig_md.
lkp
);

213 
smac
.
	`­¶y
(
ig_md
.
lkp
.
mac_¤c_addr
, ig_md, 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
);

214 
bd_¡©s
.
	`­¶y
(
ig_md
.
bd
, ig_md.
lkp
.
pkt_ty³
);

215 
aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

216 
mœrÜ_aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

217 ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_UNICAST
) {

219 
uniÿ¡
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

220 } ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_MULTICAST
 &&

221 
ig_md
.
lkp
.
_ty³
 !ğ
SWITCH_IP_TYPE_NONE
) {

223 
muÉiÿ¡
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

226 
dmac
.
	`­¶y
(
ig_md
.
lkp
.
mac_d¡_addr
, ig_md);

229 
¿ş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

230 ià(
ig_md
.
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_NONE
)

231 
	`compu‹_nÚ__hash
(
ig_md
.
lkp
, ig_md.
hash
);

233 
	`compu‹__hash
(
ig_md
.
lkp
, ig_md.
hash
);

235 
Ãxthİ
.
	`­¶y
(
ig_md
.
lkp
, ig_md, ig_md.
hash
[15:0]);

236 
qos
.
	`­¶y
(
hdr
, 
ig_md
.
lkp
, ig_md);

237 
¡Üm_cÚŒŞ
.
	`­¶y
(
ig_md
, ig_md.
lkp
.
pkt_ty³
, ig_md.
æags
.
¡Üm_cÚŒŞ_drİ
);

238 
ou‹r_fib
.
	`­¶y
(
ig_md
, ig_md.
hash
[31:16]);

240 ià(
ig_md
.
eg»ss_ifšdex
 =ğ
SWITCH_IFINDEX_FLOOD
) {

241 
æood
.
	`­¶y
(
ig_md
);

243 
Ïg
.
	`­¶y
(
ig_md
, ig_md.
hash
[31:16], 
ig_šŒ_md_fÜ_tm
.
uÿ¡_eg»ss_pÜt
);

246 
sy¡em_aş
.
	`­¶y
(
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

247 
d‹l
.
	`­¶y
(

248 
hdr
, 
ig_md
.
lkp
, ig_md, ig_md.
hash
[15:0], 
ig_šŒ_md_fÜ_d´¤
, 
ig_šŒ_md_fÜ_tm
);

251 ià(
ig_šŒ_md_fÜ_tm
.
by·ss_eg»ss
 =ğ1
w0
) {

252 
	`add_bridged_md
(
hdr
.
bridged_md
, 
ig_md
);

255 
	`£t_ig_šŒ_md
(
ig_md
, 
ig_šŒ_md_fÜ_d´¤
, 
ig_šŒ_md_fÜ_tm
);

257 
	}
}

259 
cÚŒŞ
 
	$Sw™chEg»ss
(

260 
šout
 
sw™ch_h—d”_t
 
hdr
,

261 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

262 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

263 
š
 
eg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
eg_šŒ_md_äom_´¤
,

264 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

265 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_ouut_pÜt_t
 
eg_šŒ_md_fÜ_İÜt
) {

266 
	`Eg»ssPÜtM­pšg
(
PORT_TABLE_SIZE
è
eg»ss_pÜt_m­pšg
;

267 
	`Eg»ssSTP
(è
¡p
;

268 
	`Eg»ssAş
(è
aş
;

269 
	`Eg»ssQoS
(
EGRESS_QOS_MAP_TABLE_SIZE
è
qos
;

270 
	`Eg»ssSy¡emAş
(è
sy¡em_aş
;

271 
	`Rewr™e
(
NEXTHOP_TABLE_SIZE
, 
BD_TABLE_SIZE
è
»wr™e
;

272 
	`Eg»ssD‹l
(è
d‹l
;

273 
	`MœrÜRewr™e
(è
mœrÜ_»wr™e
;

274 
	`VÏnXÏ‹
(
VLAN_TABLE_SIZE
, 
PORT_VLAN_TABLE_SIZE
è
vÏn_xÏ‹
;

275 
	`VÏnDeÿp
(è
vÏn_deÿp
;

276 
	`TuÂ–Deÿp
(
sw™ch_tuÂ–_mode_t
.
PIPE
è
tuÂ–_deÿp
;

277 
	`TuÂ–Enÿp
(
sw™ch_tuÂ–_mode_t
.
PIPE
è
tuÂ–_’ÿp
;

278 
	`TuÂ–Rewr™e
(è
tuÂ–_»wr™e
;

280 
	`MTU
(è
mtu
;

281 
	`WRED
(è
w»d
;

282 
	`MuÉiÿ¡R•liÿtiÚ
(
RID_TABLE_SIZE
è
muÉiÿ¡_»¶iÿtiÚ
;

284 
­¶y
 {

285 
eg_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

286 
eg_md
.
time¡amp
 = 
eg_šŒ_md_äom_´¤
.
glob®_t¡amp
[31:0];

287 
eg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md
.
eg»ss_pÜt
);

288 
mœrÜ_»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

289 
muÉiÿ¡_»¶iÿtiÚ
.
	`­¶y
(
eg_šŒ_md
.
eg»ss_rid
,ƒg_šŒ_md.
eg»ss_pÜt
, 
eg_md
);

290 
¡p
.
	`­¶y
(
eg_md
, 
eg_šŒ_md
.
eg»ss_pÜt
,ƒg_md.
checks
.stp);

291 
vÏn_deÿp
.
	`­¶y
(
hdr
, 
eg_md
);

292 
tuÂ–_deÿp
.
	`­¶y
(
hdr
, 
eg_md
);

293 
qos
.
	`­¶y
(
hdr
, 
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
);

294 
w»d
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
,ƒg_md.
æags
.
w»d_drİ
);

296 
»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

297 
aş
.
	`­¶y
(
hdr
, 
eg_md
.
lkp
,ƒg_md);

298 
tuÂ–_’ÿp
.
	`­¶y
(
hdr
, 
eg_md
);

299 
tuÂ–_»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

300 
mtu
.
	`­¶y
(
hdr
, 
eg_md
,ƒg_md.
checks
.mtu);

301 
vÏn_xÏ‹
.
	`­¶y
(
hdr
, 
eg_md
);

303 
d‹l
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
,ƒg_md.d‹l.
hash
, 
eg_šŒ_md_fÜ_d´¤
);

304 
sy¡em_aş
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
, 
eg_šŒ_md_fÜ_d´¤
);

306 
	`£t_eg_šŒ_md
(
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md_fÜ_İÜt
);

308 
	}
}

310 
P–še
(
Sw™chIng»ssP¬£r
(),

311 
Sw™chIng»ss
(),

312 
Sw™chIng»ssD•¬£r
(),

313 
Sw™chEg»ssP¬£r
(),

314 
Sw™chEg»ss
(),

315 
	$Sw™chEg»ssD•¬£r
()è
pe
;

317 
	$Sw™ch
(
pe
è
maš
;

	@switch-tofino/switch_profile_l0.p4

23 
	~<cÜe.p4
>

24 #ià
__TARGET_TOFINO__
 == 2

25 
	~<t2Ç.p4
>

27 
	~<Ša.p4
>

33 
	#ACL_REDIRECT_ENABLE


	)

34 
	#COPP_ENABLE


	)

35 
	#EGRESS_IP_ACL_ENABLE


	)

36 
	#EGRESS_PORT_MIRROR_ENABLE


	)

37 
	#ERSPAN_ENABLE


	)

38 
	#ERSPAN_TYPE2_ENABLE


	)

39 
	#INGRESS_ACL_POLICER_ENABLE


	)

40 
	#INGRESS_PORT_MIRROR_ENABLE


	)

41 
	#IPV6_ENABLE


	)

42 
	#L4_PORT_LOU_ENABLE


	)

43 
	#MIRROR_ENABLE


	)

44 
	#MIRROR_ACL_ENABLE


	)

45 
	#QOS_ENABLE


	)

46 
	#STORM_CONTROL_ENABLE


	)

47 
	#UNICAST_SELF_FORWARDING_CHECK


	)

48 
	#WRED_ENABLE


	)

49 
	#PACKET_LENGTH_ADJUSTMENT


	)

55 cÚ¡ 
	gb™
<32> 
	gVLAN_TABLE_SIZE
 = 4096;

56 cÚ¡ 
	gb™
<32> 
	gBD_FLOOD_TABLE_SIZE
 = 
VLAN_TABLE_SIZE
 * 4;

59 cÚ¡ 
	gb™
<32> 
	gPORT_VLAN_TABLE_SIZE
 = 1024;

62 cÚ¡ 
	gb™
<32> 
	gBD_TABLE_SIZE
 = 5120;

65 cÚ¡ 
	gb™
<32> 
	gMAC_TABLE_SIZE
 = 16384;

68 cÚ¡ 
	gb™
<32> 
	gIPV4_HOST_TABLE_SIZE
 = 65536;

69 cÚ¡ 
	gb™
<32> 
	gIPV4_LPM_TABLE_SIZE
 = 32768;

70 cÚ¡ 
	gb™
<32> 
	gIPV6_HOST_TABLE_SIZE
 = 16384;

71 cÚ¡ 
	gb™
<32> 
	gIPV6_LPM_TABLE_SIZE
 = 16384;

74 cÚ¡ 
	gb™
<32> 
	gECMP_GROUP_TABLE_SIZE
 = 1024;

75 cÚ¡ 
	gb™
<32> 
	gECMP_SELECT_TABLE_SIZE
 = 16384;

76 cÚ¡ 
	gb™
<32> 
	gNEXTHOP_TABLE_SIZE
 = 65536;

79 cÚ¡ 
	gb™
<32> 
	gINGRESS_MAC_ACL_TABLE_SIZE
 = 512;

80 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_ACL_TABLE_SIZE
 = 1024;

81 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

83 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

84 cÚ¡ 
	gb™
<32> 
	gEGRESS_MAC_ACL_TABLE_SIZE
 = 512;

85 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV4_ACL_TABLE_SIZE
 = 512;

87 
	~"h—d”s.p4
"

88 
	~"ty³s.p4
"

89 
	~"ut.p4
"

91 
	~"l3.p4
"

92 
	~"Ãxthİ.p4
"

93 
	~"·rde.p4
"

94 
	~"pÜt.p4
"

95 
	~"v®id©iÚ.p4
"

96 
	~"»wr™e.p4
"

97 
	~"muÉiÿ¡.p4
"

98 
	~"qos.p4
"

99 
	~"m‘”.p4
"

100 
	~"w»d.p4
"

101 
	~"tuÂ–.p4
"

102 
	~"aş.p4
"

104 
cÚŒŞ
 
	$Sw™chIng»ss
(

105 
šout
 
sw™ch_h—d”_t
 
hdr
,

106 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

107 
š
 
šg»ss_šŒšsic_m‘ad©a_t
 
ig_šŒ_md
,

108 
š
 
šg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
ig_šŒ_äom_´¤
,

109 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

110 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
) {

111 
	`Ing»ssPÜtM­pšg
(
PORT_VLAN_TABLE_SIZE
, 
BD_TABLE_SIZE
è
šg»ss_pÜt_m­pšg
;

112 
	`PktV®id©iÚ
(è
pkt_v®id©iÚ
;

113 
	`SMAC
(
MAC_TABLE_SIZE
è
smac
;

114 
	`DMAC
(
MAC_TABLE_SIZE
è
dmac
;

115 
	`Ing»ssBd
(
BD_TABLE_SIZE
è
bd_¡©s
;

116 
	`Ing»ssUniÿ¡
(
dmac
,

117 
IPV4_HOST_TABLE_SIZE
,

118 
IPV4_LPM_TABLE_SIZE
,

119 
IPV6_HOST_TABLE_SIZE
,

120 
IPV6_LPM_TABLE_SIZE
è
uniÿ¡
;

121 
	`Ing»ssAş
(

122 
INGRESS_IPV4_ACL_TABLE_SIZE
, 
INGRESS_IPV6_ACL_TABLE_SIZE
, 
INGRESS_MAC_ACL_TABLE_SIZE
è
aş
;

123 
	`MœrÜAş
(
¡©s_’abË
=
Œue
è
mœrÜ_aş
;

124 
	`ECNAş
(è
eú_aş
;

125 
	`Ing»ssQoS
(è
qos
;

126 
	`StÜmCÚŒŞ
(è
¡Üm_cÚŒŞ
;

127 
	`Nexthİ
(
NEXTHOP_TABLE_SIZE
, 
ECMP_GROUP_TABLE_SIZE
, 
ECMP_SELECT_TABLE_SIZE
è
Ãxthİ
;

128 
	`LAG
(è
Ïg
;

129 
	`MuÉiÿ¡Floodšg
(
BD_FLOOD_TABLE_SIZE
è
æood
;

130 
	`Ing»ssSy¡emAş
(è
sy¡em_aş
;

132 
aùiÚ
 
	`v_h™
(
sw™ch_pÜt_t
 
pÜt
) {

136 
ig_šŒ_md_fÜ_tm
.
uÿ¡_eg»ss_pÜt
 = 
pÜt
;

137 
ig_md
.
eg»ss_pÜt_Ïg_šdex
 = 0;

138 
ig_md
.
eg»ss_ifšdex
 = 0;

139 
ig_md
.
by·ss
 = 
SWITCH_INGRESS_BYPASS_ALL
;

142 
bË
 
v
 {

143 
key
 = {

144 
hdr
.
v4
.
d¡_addr
 : 
exaù
;

145 
ig_md
.
lkp
.
l4_d¡_pÜt
 : 
exaù
;

146 
ig_md
.
lkp
.
_´Ùo
 : 
exaù
;

149 
aùiÚs
 = {

150 
NoAùiÚ
;

151 
v_h™
;

154 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

157 
­¶y
 {

158 
ig_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

159 
ig_md
.
muÉiÿ¡
.
id
 = 0;

160 
ig_md
.
æags
.
¿ş_d’y
 = 
çl£
;

161 #ifdeà
MULTICAST_ENABLE


162 
ig_md
.
æags
.
æood_to_muÉiÿ¡_rou‹rs
 = 
çl£
;

165 
pkt_v®id©iÚ
.
	`­¶y
(

166 
hdr
, 
ig_md
.
æags
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
, ig_md.
drİ_»asÚ
);

167 
šg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

168 
smac
.
	`­¶y
(
ig_md
.
lkp
.
mac_¤c_addr
, ig_md, 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
);

169 
bd_¡©s
.
	`­¶y
(
ig_md
.
bd
, ig_md.
lkp
.
pkt_ty³
);

171 ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_UNICAST
) {

173 
uniÿ¡
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

174 
v
.
	`­¶y
();

175 } ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_MULTICAST
 &&

176 
ig_md
.
lkp
.
_ty³
 !ğ
SWITCH_IP_TYPE_NONE
) {

180 
dmac
.
	`­¶y
(
ig_md
.
lkp
.
mac_d¡_addr
, ig_md);

183 
aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

184 
mœrÜ_aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

185 ià(
ig_md
.
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_NONE
) {

186 
	`compu‹_nÚ__hash
(
ig_md
.
lkp
, ig_md.
hash
);

188 
	`compu‹__hash
(
ig_md
.
lkp
, ig_md.
hash
);

191 
Ãxthİ
.
	`­¶y
(
ig_md
.
lkp
, ig_md, ig_md.
hash
[15:0]);

192 
qos
.
	`­¶y
(
hdr
, 
ig_md
.
lkp
, ig_md);

193 
¡Üm_cÚŒŞ
.
	`­¶y
(
ig_md
, ig_md.
lkp
.
pkt_ty³
, ig_md.
æags
.
¡Üm_cÚŒŞ_drİ
);

195 ià(
ig_md
.
eg»ss_ifšdex
 =ğ
SWITCH_IFINDEX_FLOOD
) {

196 
æood
.
	`­¶y
(
ig_md
);

198 
Ïg
.
	`­¶y
(
ig_md
, ig_md.
hash
[31:16], 
ig_šŒ_md_fÜ_tm
.
uÿ¡_eg»ss_pÜt
);

201 
eú_aş
.
	`­¶y
(
ig_md
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
.
·ck‘_cŞÜ
);

202 
sy¡em_aş
.
	`­¶y
(

203 
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

206 ià(
ig_šŒ_md_fÜ_tm
.
by·ss_eg»ss
 =ğ1
w0
) {

207 
	`add_bridged_md
(
hdr
.
bridged_md
, 
ig_md
);

210 
	`£t_ig_šŒ_md
(
ig_md
, 
ig_šŒ_md_fÜ_d´¤
, 
ig_šŒ_md_fÜ_tm
);

212 
	}
}

214 
cÚŒŞ
 
	$Sw™chEg»ss
(

215 
šout
 
sw™ch_h—d”_t
 
hdr
,

216 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

217 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

218 
š
 
eg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
eg_šŒ_äom_´¤
,

219 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

220 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_ouut_pÜt_t
 
eg_šŒ_md_fÜ_İÜt
) {

221 
	`Eg»ssPÜtM­pšg
(è
eg»ss_pÜt_m­pšg
;

222 
	`Eg»ssAş
(

223 
EGRESS_IPV4_ACL_TABLE_SIZE
, 
EGRESS_IPV6_ACL_TABLE_SIZE
, 
EGRESS_MAC_ACL_TABLE_SIZE
è
aş
;

224 
	`Eg»ssQoS
(è
qos
;

225 
	`Eg»ssSy¡emAş
(è
sy¡em_aş
;

226 
	`Rewr™e
(
NEXTHOP_TABLE_SIZE
, 
BD_TABLE_SIZE
è
»wr™e
;

227 
	`MœrÜRewr™e
(è
mœrÜ_»wr™e
;

228 
	`VÏnXÏ‹
(
VLAN_TABLE_SIZE
, 
PORT_VLAN_TABLE_SIZE
è
vÏn_xÏ‹
;

229 
	`VÏnDeÿp
(è
vÏn_deÿp
;

230 
	`MTU
(è
mtu
;

231 
	`WRED
(è
w»d
;

232 
	`MuÉiÿ¡R•liÿtiÚ
(è
muÉiÿ¡_»¶iÿtiÚ
;

234 
­¶y
 {

235 
eg_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

236 
eg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md
.
eg»ss_pÜt
);

237 
muÉiÿ¡_»¶iÿtiÚ
.
	`­¶y
(

238 
eg_šŒ_md
.
eg»ss_rid
,ƒg_šŒ_md.
eg»ss_pÜt
, 
eg_md
);

240 
mœrÜ_»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

241 
vÏn_deÿp
.
	`­¶y
(
hdr
, 
eg_md
);

242 
qos
.
	`­¶y
(
hdr
, 
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
);

243 
w»d
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
,ƒg_md.
æags
.
w»d_drİ
);

245 
»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

246 
aş
.
	`­¶y
(
hdr
, 
eg_md
.
lkp
,ƒg_md);

247 
mtu
.
	`­¶y
(
hdr
, 
eg_md
,ƒg_md.
checks
.mtu);

248 
vÏn_xÏ‹
.
	`­¶y
(
hdr
, 
eg_md
);

250 
sy¡em_aş
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
, 
eg_šŒ_md_fÜ_d´¤
);

252 
	`£t_eg_šŒ_md
(
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md_fÜ_İÜt
);

254 
	}
}

256 
cÚŒŞ
 
	$L4LB
(
šout
 
sw™ch_h—d”_t
 
hdr
,

257 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
)(

258 
sw™ch_ušt32_t
 
cÚn_bË_size
,

259 
sw™ch_ušt32_t
 
v_bË_size
,

260 
sw™ch_ušt32_t
 
d_poŞ_bË_size
) {

269 
b™
<6> 
poŞ_v”siÚ
;

271 
b™
<16> 
dige¡
;

272 
Hash
<
b™
<16>>(
HashAlgÜ™hm_t
.
CRC16
è
dige¡_hash
;

274 
Hash
<
b™
<32>>(
HashAlgÜ™hm_t
.
CRC32
è
£ËùÜ_hash
;

275 
	`AùiÚS–eùÜ
(1024, 
£ËùÜ_hash
, 
S–eùÜMode_t
.
FAIR
è
d_£ËùÜ
;

277 
aùiÚ
 
	`£t_poŞ_v”siÚ
(
b™
<6> 
v”siÚ
) {

278 
poŞ_v”siÚ
 = 
v”siÚ
;

281 @
´agma
 
´oxy_hash_width
 16

283 
bË
 
cÚn
 {

284 
key
 = {

285 
hdr
.
v4
.
¤c_addr
 : 
exaù
;

286 
hdr
.
v4
.
d¡_addr
 : 
exaù
;

287 
hdr
.
v4
.
´ÙocŞ
 : 
exaù
;

288 
ig_md
.
lkp
.
l4_¤c_pÜt
 : 
exaù
;

289 
ig_md
.
lkp
.
l4_d¡_pÜt
 : 
exaù
;

292 
aùiÚs
 = {

293 
NoAùiÚ
;

294 
£t_poŞ_v”siÚ
;

297 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

298 
size
 = 
cÚn_bË_size
;

299 
idË_timeout
 = 
Œue
;

302 
bË
 
v
 {

303 
key
 = {

304 
hdr
.
v4
.
d¡_addr
 : 
exaù
 @
	`Çme
("vip");

305 
ig_md
.
lkp
.
l4_d¡_pÜt
 : 
exaù
;

306 
ig_md
.
lkp
.
_´Ùo
 : 
exaù
;

309 
aùiÚs
 = {

310 
NoAùiÚ
;

311 
£t_poŞ_v”siÚ
;

314 cÚ¡ 
deçuÉ_aùiÚ
 = 
NoAùiÚ
;

317 
aùiÚ
 
	`£t_d
(
v4_addr_t
 
d
, 
b™
<16> 
d¡_pÜt
) {

318 
hdr
.
v4
.
d¡_addr
 = 
d
;

319 
ig_md
.
lkp
.
l4_d¡_pÜt
 = 
d¡_pÜt
;

322 
bË
 
d_poŞ
 {

323 
key
 = {

324 
poŞ_v”siÚ
 : 
exaù
;

325 
hdr
.
v4
.
d¡_addr
 : 
exaù
 @
	`Çme
("vip");

326 
ig_md
.
lkp
.
l4_d¡_pÜt
 : 
exaù
;

327 
hdr
.
v4
.
¤c_addr
 : 
£ËùÜ
;

328 
ig_md
.
lkp
.
l4_¤c_pÜt
 : 
£ËùÜ
;

331 
aùiÚs
 = {

332 
NoAùiÚ
;

333 
£t_d
;

336 
size
 = 
d_poŞ_bË_size
;

337 
im¶em’tiÚ
 = 
d_£ËùÜ
;

340 
­¶y
 {

341 ià(!
cÚn
.
	`­¶y
().
h™
) {

342 
v
.
	`­¶y
();

344 ià(
poŞ_v”siÚ
 != 0) {

349 
d_poŞ
.
	`­¶y
();

351 ià(
hdr
.
tı
.
	`isV®id
()) {

352 
hdr
.
tı
.
d¡_pÜt
 = 
ig_md
.
lkp
.
l4_d¡_pÜt
;

353 } ià(
hdr
.
udp
.
	`isV®id
()) {

354 
hdr
.
udp
.
d¡_pÜt
 = 
ig_md
.
lkp
.
l4_d¡_pÜt
;

357 
	}
}

359 
cÚŒŞ
 
	$L4LBIng»ss
(

360 
šout
 
sw™ch_h—d”_t
 
hdr
,

361 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

362 
š
 
šg»ss_šŒšsic_m‘ad©a_t
 
ig_šŒ_md
,

363 
š
 
šg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
ig_šŒ_äom_´¤
,

364 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

365 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
) {

367 
aùiÚ
 
	`fib_h™
(
mac_addr_t
 
dmac
, 
sw™ch_pÜt_t
 
pÜt
) {

368 
hdr
.
‘h”Ãt
.
d¡_addr
 = 
dmac
;

369 
ig_šŒ_md_fÜ_tm
.
uÿ¡_eg»ss_pÜt
 = 
pÜt
;

370 
ig_šŒ_md_fÜ_tm
.
by·ss_eg»ss
 = 1
w1
;

371 
ig_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0x0;

374 
aùiÚ
 
	`fib_miss
() {

375 
ig_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0x1;

378 
bË
 
fib
 {

379 
key
 = { 
hdr
.
v4
.
d¡_addr
 : 
exaù
; }

380 
aùiÚs
 = {

381 
fib_h™
;

382 
fib_miss
;

385 cÚ¡ 
deçuÉ_aùiÚ
 = 
fib_miss
;

388 
­¶y
 {

389 
fib
.
	`­¶y
();

391 
	}
}

393 
cÚŒŞ
 
	$L4LBEg»ss
(

394 
šout
 
sw™ch_h—d”_t
 
hdr
,

395 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
eg_md
,

396 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

397 
š
 
eg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
eg_šŒ_äom_´¤
,

398 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

399 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_ouut_pÜt_t
 
eg_šŒ_md_fÜ_İÜt
) {

401 
	`L4LB
(
cÚn_bË_size
=1 << 18,

402 
v_bË_size
=16384,

403 
d_poŞ_bË_size
=16384è
l4lb
;

405 
­¶y
 {

406 
l4lb
.
	`­¶y
(
hdr
, 
eg_md
);

408 
	}
}

414 
·r£r
 
	$Pack‘P¬£r
(
·ck‘_š
 
pkt
, 
šout
 
sw™ch_h—d”_t
 
hdr
) {

415 
¡©e
 
¡¬t
 {

416 
pkt
.
	`exŒaù
(
hdr
.
‘h”Ãt
);

417 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
‘h”Ãt
.
‘h”_ty³
) {

418 
ETHERTYPE_IPV4
 : 
·r£_v4
;

419  : 
acû±
;

423 
¡©e
 
·r£_v4
 {

424 
pkt
.
	`exŒaù
(
hdr
.
v4
);

425 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
v4
.
´ÙocŞ
) {

426 
IP_PROTOCOLS_TCP
 : 
·r£_tı
;

427 
IP_PROTOCOLS_UDP
 : 
·r£_udp
;

428  : 
acû±
;

432 
¡©e
 
·r£_vÏn
 {

433 
pkt
.
	`exŒaù
(
hdr
.
vÏn_g
.
Ãxt
);

434 
Œªs™iÚ
 
	`£Ëù
(
hdr
.
vÏn_g
.
Ï¡
.
‘h”_ty³
) {

435 
ETHERTYPE_IPV4
 : 
·r£_v4
;

436 
ETHERTYPE_VLAN
 : 
·r£_vÏn
;

437  : 
acû±
;

441 
¡©e
 
·r£_udp
 {

442 
pkt
.
	`exŒaù
(
hdr
.
udp
);

443 
Œªs™iÚ
 
acû±
;

446 
¡©e
 
·r£_tı
 {

447 
pkt
.
	`exŒaù
(
hdr
.
tı
);

448 
Œªs™iÚ
 
acû±
;

450 
	}
}

452 
·r£r
 
	$L4LBIng»ssP¬£r
(
·ck‘_š
 
pkt
,

453 
out
 
sw™ch_h—d”_t
 
hdr
,

454 
out
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

455 
out
 
šg»ss_šŒšsic_m‘ad©a_t
 
ig_šŒ_md
) {

457 
	`Pack‘P¬£r
(è
·ck‘_·r£r
;

458 
¡©e
 
¡¬t
 {

459 
pkt
.
	`exŒaù
(
ig_šŒ_md
);

460 
pkt
.
	`advªû
(
PORT_METADATA_SIZE
);

461 
·ck‘_·r£r
.
	`­¶y
(
pkt
, 
hdr
);

462 
Œªs™iÚ
 
acû±
;

464 
	}
}

466 
·r£r
 
	$L4LBEg»ssP¬£r
(
·ck‘_š
 
pkt
,

467 
out
 
sw™ch_h—d”_t
 
hdr
,

468 
out
 
sw™ch_šg»ss_m‘ad©a_t
 
eg_md
,

469 
out
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
) {

471 
	`Pack‘P¬£r
(è
·ck‘_·r£r
;

472 
¡©e
 
¡¬t
 {

473 
pkt
.
	`exŒaù
(
eg_šŒ_md
);

474 
Œªs™iÚ
 
·r£_bridged_m‘ad©a
;

477 
¡©e
 
·r£_bridged_m‘ad©a
 {

478 
pkt
.
	`exŒaù
(
hdr
.
bridged_md
);

479 
eg_md
.
lkp
.
l4_¤c_pÜt
 = 
hdr
.
bridged_md
.
aş
.l4_src_port;

480 
eg_md
.
lkp
.
l4_d¡_pÜt
 = 
hdr
.
bridged_md
.
aş
.l4_dst_port;

481 
·ck‘_·r£r
.
	`­¶y
(
pkt
, 
hdr
);

482 
Œªs™iÚ
 
acû±
;

484 
	}
}

489 
cÚŒŞ
 
	$L4LBIng»ssD•¬£r
(

490 
·ck‘_out
 
pkt
,

491 
šout
 
sw™ch_h—d”_t
 
hdr
,

492 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

493 
š
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
) {

495 
­¶y
 {

496 
pkt
.
	`em™
(
hdr
.
‘h”Ãt
);

497 
pkt
.
	`em™
(
hdr
.
vÏn_g
);

498 
pkt
.
	`em™
(
hdr
.
v4
);

499 
pkt
.
	`em™
(
hdr
.
udp
);

500 
pkt
.
	`em™
(
hdr
.
tı
);

502 
	}
}

504 
cÚŒŞ
 
	$L4LBEg»ssD•¬£r
(

505 
·ck‘_out
 
pkt
,

506 
šout
 
sw™ch_h—d”_t
 
hdr
,

507 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
eg_md
,

508 
š
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
) {

510 
­¶y
 {

511 
pkt
.
	`em™
(
hdr
.
‘h”Ãt
);

512 
pkt
.
	`em™
(
hdr
.
vÏn_g
);

513 
pkt
.
	`em™
(
hdr
.
v4
);

514 
pkt
.
	`em™
(
hdr
.
udp
);

515 
pkt
.
	`em™
(
hdr
.
tı
);

517 
	}
}

519 
P–še
(
L4LBIng»ssP¬£r
(),

520 
L4LBIng»ss
(),

521 
L4LBIng»ssD•¬£r
(),

522 
L4LBEg»ssP¬£r
(),

523 
L4LBEg»ss
(),

524 
	$L4LBEg»ssD•¬£r
()è
lb
;

527 
	`P–še
(
	`Sw™chIng»ssP¬£r
(),

528 
	`Sw™chIng»ss
(),

529 
	`Sw™chIng»ssD•¬£r
(),

530 
	`Sw™chEg»ssP¬£r
(),

531 
	`Sw™chEg»ss
(),

532 
	$Sw™chEg»ssD•¬£r
()è
pe
;

534 
	$Sw™ch
(
pe
, 
lb
è
maš
;

	@switch-tofino/switch_tofino_a0.p4

23 
	~<cÜe.p4
>

24 
	~<Ša.p4
>

29 
	#ACL_REDIRECT_ENABLE


	)

30 
	#COPP_ENABLE


	)

31 
	#DTEL_ENABLE


	)

32 
	#DTEL_QUEUE_REPORT_ENABLE


	)

33 
	#DTEL_DROP_REPORT_ENABLE


	)

34 
	#DTEL_FLOW_REPORT_ENABLE


	)

35 
	#DTEL_ACL_ENABLE


	)

36 
	#ECN_ACL_ENABLE


	)

37 
	#EGRESS_IP_ACL_ENABLE


	)

38 
	#EGRESS_PORT_MIRROR_ENABLE


	)

39 
	#ERSPAN_ENABLE


	)

40 
	#ERSPAN_TYPE2_ENABLE


	)

41 
	#INGRESS_ACL_POLICER_ENABLE


	)

42 
	#INGRESS_PORT_MIRROR_ENABLE


	)

43 
	#IPV6_ENABLE


	)

44 
	#L4_PORT_LOU_ENABLE


	)

45 
	#MIRROR_ENABLE


	)

46 
	#INGRESS_MIRROR_ACL_ENABLE


	)

47 
	#QOS_ENABLE


	)

48 
	#STORM_CONTROL_ENABLE


	)

49 
	#UNICAST_SELF_FORWARDING_CHECK


	)

50 
	#WRED_ENABLE


	)

51 
	#PACKET_LENGTH_ADJUSTMENT


	)

57 cÚ¡ 
	gb™
<32> 
	gVLAN_TABLE_SIZE
 = 4096;

58 cÚ¡ 
	gb™
<32> 
	gBD_FLOOD_TABLE_SIZE
 = 
VLAN_TABLE_SIZE
 * 4;

61 cÚ¡ 
	gb™
<32> 
	gPORT_VLAN_TABLE_SIZE
 = 1024;

64 cÚ¡ 
	gb™
<32> 
	gBD_TABLE_SIZE
 = 5120;

67 cÚ¡ 
	gb™
<32> 
	gMAC_TABLE_SIZE
 = 16384;

70 cÚ¡ 
	gb™
<32> 
	gIPV4_HOST_TABLE_SIZE
 = 65536;

71 cÚ¡ 
	gb™
<32> 
	gIPV4_LOCAL_HOST_TABLE_SIZE
 = 8192;

72 cÚ¡ 
	gb™
<32> 
	gIPV4_LPM_TABLE_SIZE
 = 32768;

73 cÚ¡ 
	gb™
<32> 
	gIPV6_HOST_TABLE_SIZE
 = 16384;

74 cÚ¡ 
	gb™
<32> 
	gIPV6_LPM_TABLE_SIZE
 = 10240;

75 cÚ¡ 
	gb™
<32> 
	gIPV6_LPM64_TABLE_SIZE
 = 0;

78 cÚ¡ 
	gb™
<32> 
	gECMP_GROUP_TABLE_SIZE
 = 1024;

79 cÚ¡ 
	gb™
<32> 
	gECMP_SELECT_TABLE_SIZE
 = 16384;

80 cÚ¡ 
	gb™
<32> 
	gNEXTHOP_TABLE_SIZE
 = 65536;

83 cÚ¡ 
	gb™
<32> 
	gINGRESS_MAC_ACL_TABLE_SIZE
 = 512;

84 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_ACL_TABLE_SIZE
 = 1024;

85 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

87 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

88 cÚ¡ 
	gb™
<32> 
	gEGRESS_MAC_ACL_TABLE_SIZE
 = 512;

89 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV4_ACL_TABLE_SIZE
 = 512;

91 
	~"h—d”s.p4
"

92 
	~"ty³s.p4
"

93 
	~"ut.p4
"

95 
	~"l3.p4
"

96 
	~"Ãxthİ.p4
"

97 
	~"·rde.p4
"

98 
	~"pÜt.p4
"

99 
	~"v®id©iÚ.p4
"

100 
	~"»wr™e.p4
"

101 
	~"muÉiÿ¡.p4
"

102 
	~"qos.p4
"

103 
	~"m‘”.p4
"

104 
	~"w»d.p4
"

105 
	~"aş.p4
"

106 
	~"d‹l.p4
"

108 
cÚŒŞ
 
	$Sw™chIng»ss
(

109 
šout
 
sw™ch_h—d”_t
 
hdr
,

110 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

111 
š
 
šg»ss_šŒšsic_m‘ad©a_t
 
ig_šŒ_md
,

112 
š
 
šg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
ig_šŒ_äom_´¤
,

113 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

114 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
) {

115 
	`Ing»ssPÜtM­pšg
(
PORT_VLAN_TABLE_SIZE
, 
BD_TABLE_SIZE
è
šg»ss_pÜt_m­pšg
;

116 
	`PktV®id©iÚ
(è
pkt_v®id©iÚ
;

117 
	`SMAC
(
MAC_TABLE_SIZE
è
smac
;

118 
	`DMAC
(
MAC_TABLE_SIZE
è
dmac
;

119 
	`Ing»ssBd
(
BD_TABLE_SIZE
è
bd_¡©s
;

120 
	`Ing»ssUniÿ¡
(
dmac
,

121 
IPV4_HOST_TABLE_SIZE
,

122 
IPV4_LPM_TABLE_SIZE
,

123 
IPV6_HOST_TABLE_SIZE
,

124 
IPV6_LPM_TABLE_SIZE
,

125 
IPV6_LPM64_TABLE_SIZE
,

126 
çl£
 ) 
uniÿ¡
;

127 
	`Ing»ssAş
(
INGRESS_IPV4_ACL_TABLE_SIZE
, 
INGRESS_IPV6_ACL_TABLE_SIZE
, 0, 
çl£
è
aş
;

128 
	`MœrÜAş
(
¡©s_’abË
=
Œue
è
mœrÜ_aş
;

129 
	`ECNAş
(è
eú_aş
;

130 
	`PFCWd
(512è
pfc_wd
;

131 
	`Ing»ssQoS
(è
qos
;

132 
	`StÜmCÚŒŞ
(è
¡Üm_cÚŒŞ
;

133 
	`Nexthİ
(
NEXTHOP_TABLE_SIZE
, 
ECMP_GROUP_TABLE_SIZE
, 
ECMP_SELECT_TABLE_SIZE
è
Ãxthİ
;

134 
	`LAG
(è
Ïg
;

135 
	`MuÉiÿ¡Floodšg
(
BD_FLOOD_TABLE_SIZE
è
æood
;

136 
	`Ing»ssSy¡emAş
(è
sy¡em_aş
;

137 
	`Ing»ssD‹l
(è
d‹l
;

139 
­¶y
 {

140 
ig_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

141 
ig_md
.
muÉiÿ¡
.
id
 = 0;

142 
ig_md
.
æags
.
¿ş_d’y
 = 
çl£
;

143 #ifdeà
MULTICAST_ENABLE


144 
ig_md
.
æags
.
æood_to_muÉiÿ¡_rou‹rs
 = 
çl£
;

147 
pkt_v®id©iÚ
.
	`­¶y
(

148 
hdr
, 
ig_md
.
æags
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
, ig_md.
drİ_»asÚ
);

149 
šg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

150 
smac
.
	`­¶y
(
ig_md
.
lkp
.
mac_¤c_addr
, ig_md, 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
);

151 
bd_¡©s
.
	`­¶y
(
ig_md
.
bd
, ig_md.
lkp
.
pkt_ty³
);

152 ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_UNICAST
) {

154 
uniÿ¡
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

155 } ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_MULTICAST
 &&

156 
ig_md
.
lkp
.
_ty³
 !ğ
SWITCH_IP_TYPE_NONE
) {

160 
dmac
.
	`­¶y
(
ig_md
.
lkp
.
mac_d¡_addr
, ig_md);

163 
aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

164 
mœrÜ_aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

166 ià(
ig_md
.
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_NONE
) {

167 
	`compu‹_nÚ__hash
(
ig_md
.
lkp
, ig_md.
hash
);

169 
	`compu‹__hash
(
ig_md
.
lkp
, ig_md.
hash
);

172 
Ãxthİ
.
	`­¶y
(
ig_md
.
lkp
, ig_md, ig_md.
hash
[15:0]);

173 
qos
.
	`­¶y
(
hdr
, 
ig_md
.
lkp
, ig_md);

174 
¡Üm_cÚŒŞ
.
	`­¶y
(
ig_md
, ig_md.
lkp
.
pkt_ty³
, ig_md.
æags
.
¡Üm_cÚŒŞ_drİ
);

176 ià(
ig_md
.
eg»ss_ifšdex
 =ğ
SWITCH_IFINDEX_FLOOD
) {

177 
æood
.
	`­¶y
(
ig_md
);

179 
Ïg
.
	`­¶y
(
ig_md
, ig_md.
hash
[31:16], 
ig_šŒ_md_fÜ_tm
.
uÿ¡_eg»ss_pÜt
);

182 
eú_aş
.
	`­¶y
(
ig_md
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
.
·ck‘_cŞÜ
);

183 
pfc_wd
.
	`­¶y
(
ig_md
.
pÜt
, ig_md.
qos
.
qid
, ig_md.
æags
.
pfc_wd_drİ
);

185 
sy¡em_aş
.
	`­¶y
(
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

186 
d‹l
.
	`­¶y
(

187 
hdr
, 
ig_md
.
lkp
, ig_md, ig_md.
hash
[15:0], 
ig_šŒ_md_fÜ_d´¤
, 
ig_šŒ_md_fÜ_tm
);

190 ià(
ig_šŒ_md_fÜ_tm
.
by·ss_eg»ss
 =ğ1
w0
) {

191 
	`add_bridged_md
(
hdr
.
bridged_md
, 
ig_md
);

194 
	`£t_ig_šŒ_md
(
ig_md
, 
ig_šŒ_md_fÜ_d´¤
, 
ig_šŒ_md_fÜ_tm
);

196 
	}
}

198 
cÚŒŞ
 
	$Sw™chEg»ss
(

199 
šout
 
sw™ch_h—d”_t
 
hdr
,

200 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

201 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

202 
š
 
eg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
eg_šŒ_äom_´¤
,

203 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

204 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_ouut_pÜt_t
 
eg_šŒ_md_fÜ_İÜt
) {

205 
	`Eg»ssPÜtM­pšg
(è
eg»ss_pÜt_m­pšg
;

206 
	`Eg»ssAş
(

207 
EGRESS_IPV4_ACL_TABLE_SIZE
, 
EGRESS_IPV6_ACL_TABLE_SIZE
, 
EGRESS_MAC_ACL_TABLE_SIZE
è
aş
;

208 
	`Eg»ssQoS
(è
qos
;

209 
	`Eg»ssSy¡emAş
(è
sy¡em_aş
;

210 
	`PFCWd
(512è
pfc_wd
;

211 
	`Rewr™e
(
NEXTHOP_TABLE_SIZE
, 
BD_TABLE_SIZE
è
»wr™e
;

212 
	`MœrÜRewr™e
(è
mœrÜ_»wr™e
;

213 
	`VÏnXÏ‹
(
VLAN_TABLE_SIZE
, 
PORT_VLAN_TABLE_SIZE
è
vÏn_xÏ‹
;

214 
	`VÏnDeÿp
(è
vÏn_deÿp
;

215 
	`MTU
(è
mtu
;

216 
	`WRED
(è
w»d
;

217 
	`MuÉiÿ¡R•liÿtiÚ
(è
muÉiÿ¡_»¶iÿtiÚ
;

218 
	`Eg»ssD‹l
(è
d‹l
;

220 
­¶y
 {

221 
eg_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

222 
eg_md
.
time¡amp
 = 
eg_šŒ_äom_´¤
.
glob®_t¡amp
[31:0];

223 
eg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md
.
eg»ss_pÜt
);

224 
muÉiÿ¡_»¶iÿtiÚ
.
	`­¶y
(

225 
eg_šŒ_md
.
eg»ss_rid
,ƒg_šŒ_md.
eg»ss_pÜt
, 
eg_md
);

226 
mœrÜ_»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

227 
vÏn_deÿp
.
	`­¶y
(
hdr
, 
eg_md
);

228 
qos
.
	`­¶y
(
hdr
, 
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
);

229 
w»d
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
,ƒg_md.
æags
.
w»d_drİ
);

231 
»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

232 
aş
.
	`­¶y
(
hdr
, 
eg_md
.
lkp
,ƒg_md);

233 
mtu
.
	`­¶y
(
hdr
, 
eg_md
,ƒg_md.
checks
.mtu);

234 
vÏn_xÏ‹
.
	`­¶y
(
hdr
, 
eg_md
);

235 
pfc_wd
.
	`­¶y
(
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
.
qos
.
qid
,ƒg_md.
æags
.
pfc_wd_drİ
);

237 
d‹l
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
,ƒg_md.d‹l.
hash
, 
eg_šŒ_md_fÜ_d´¤
);

238 
sy¡em_aş
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
, 
eg_šŒ_md_fÜ_d´¤
);

240 
	`£t_eg_šŒ_md
(
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md_fÜ_İÜt
);

242 
	}
}

244 
P–še
(
Sw™chIng»ssP¬£r
(),

245 
Sw™chIng»ss
(),

246 
Sw™chIng»ssD•¬£r
(),

247 
Sw™chEg»ssP¬£r
(),

248 
Sw™chEg»ss
(),

249 
	$Sw™chEg»ssD•¬£r
()è
pe
;

251 
	$Sw™ch
(
pe
è
maš
;

	@switch-tofino/switch_tofino_b0.p4

23 
	~<cÜe.p4
>

24 
	~<Ša.p4
>

29 
	#ACL_REDIRECT_ENABLE


	)

30 
	#COPP_ENABLE


	)

31 
	#ECN_ACL_ENABLE


	)

32 
	#EGRESS_PORT_MIRROR_ENABLE


	)

33 
	#EGRESS_MIRROR_ACL_ENABLE


	)

34 
	#ERSPAN_ENABLE


	)

35 
	#ERSPAN_TYPE2_ENABLE


	)

36 
	#INGRESS_ACL_POLICER_ENABLE


	)

37 
	#INGRESS_PORT_MIRROR_ENABLE


	)

38 
	#IPINIP_ENABLE


	)

39 
	#IPV6_ENABLE


	)

40 
	#L4_PORT_LOU_ENABLE


	)

41 
	#MIRROR_ENABLE


	)

42 
	#INGRESS_MIRROR_ACL_ENABLE


	)

43 
	#QOS_ENABLE


	)

44 
	#TUNNEL_ENABLE


	)

45 
	#IPV6_TUNNEL_ENABLE


	)

46 
	#VXLAN_ENABLE


	)

47 
	#WRED_ENABLE


	)

54 cÚ¡ 
	gb™
<32> 
	gVLAN_TABLE_SIZE
 = 4096;

55 cÚ¡ 
	gb™
<32> 
	gBD_FLOOD_TABLE_SIZE
 = 
VLAN_TABLE_SIZE
 * 4;

58 cÚ¡ 
	gb™
<32> 
	gPORT_VLAN_TABLE_SIZE
 = 1024;

61 cÚ¡ 
	gb™
<32> 
	gDOUBLE_TAG_TABLE_SIZE
 = 4096;

64 
	#sw™ch_vrf_width
 14

	)

67 cÚ¡ 
	gb™
<32> 
	gBD_TABLE_SIZE
 = 5120;

70 cÚ¡ 
	gb™
<32> 
	gMAC_TABLE_SIZE
 = 16384;

73 cÚ¡ 
	gb™
<32> 
	gIPV4_HOST_TABLE_SIZE
 = 65536;

74 cÚ¡ 
	gb™
<32> 
	gIPV4_LPM_TABLE_SIZE
 = 16384;

75 cÚ¡ 
	gb™
<32> 
	gIPV6_HOST_TABLE_SIZE
 = 4096;

76 cÚ¡ 
	gb™
<32> 
	gIPV6_LPM_TABLE_SIZE
 = 10240;

79 cÚ¡ 
	gb™
<32> 
	gECMP_GROUP_TABLE_SIZE
 = 1024;

80 cÚ¡ 
	gb™
<32> 
	gECMP_SELECT_TABLE_SIZE
 = 16384;

81 
	#sw™ch_Ãxthİ_width
 16

	)

82 cÚ¡ 
	gb™
<32> 
	gNEXTHOP_TABLE_SIZE
 = 1 << 
sw™ch_Ãxthİ_width
;

85 
	#sw™ch_tuÂ–_šdex_width
 16

	)

86 cÚ¡ 
	gb™
<32> 
	gTUNNEL_IPV4_REWRITE_SIZE
 = 65536;

87 cÚ¡ 
	gb™
<32> 
	gTUNNEL_IPV6_REWRITE_SIZE
 = 8192;

88 cÚ¡ 
	gb™
<32> 
	gNUM_TUNNELS
 = 
TUNNEL_IPV4_REWRITE_SIZE
 + 
TUNNEL_IPV6_REWRITE_SIZE
;

89 cÚ¡ 
	gb™
<32> 
	gOUTER_ECMP_GROUP_TABLE_SIZE
 = 1024;

90 cÚ¡ 
	gb™
<32> 
	gOUTER_ECMP_SELECT_TABLE_SIZE
 = 16384;

93 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_ACL_TABLE_SIZE
 = 1024;

94 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

96 
	~"h—d”s.p4
"

97 
	~"ty³s.p4
"

98 
	~"ut.p4
"

100 
	~"l3.p4
"

101 
	~"Ãxthİ.p4
"

102 
	~"·rde.p4
"

103 
	~"pÜt.p4
"

104 
	~"v®id©iÚ.p4
"

105 
	~"»wr™e.p4
"

106 
	~"muÉiÿ¡.p4
"

107 
	~"qos.p4
"

108 
	~"m‘”.p4
"

109 
	~"w»d.p4
"

110 
	~"tuÂ–.p4
"

111 
	~"aş.p4
"

113 
cÚŒŞ
 
	$Sw™chIng»ss
(

114 
šout
 
sw™ch_h—d”_t
 
hdr
,

115 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

116 
š
 
šg»ss_šŒšsic_m‘ad©a_t
 
ig_šŒ_md
,

117 
š
 
šg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
ig_šŒ_äom_´¤
,

118 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

119 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
) {

120 
	`Ing»ssPÜtM­pšg
(
PORT_VLAN_TABLE_SIZE
, 
BD_TABLE_SIZE
è
šg»ss_pÜt_m­pšg
;

121 
	`PktV®id©iÚ
(è
pkt_v®id©iÚ
;

122 
	`SMAC
(
MAC_TABLE_SIZE
è
smac
;

123 
	`DMAC
(
MAC_TABLE_SIZE
è
dmac
;

124 
	`Ing»ssBd
(
BD_TABLE_SIZE
è
bd_¡©s
;

125 
	`Ing»ssUniÿ¡
(
dmac
,

126 
IPV4_HOST_TABLE_SIZE
,

127 
IPV4_LPM_TABLE_SIZE
,

128 
IPV6_HOST_TABLE_SIZE
,

129 
IPV6_LPM_TABLE_SIZE
è
uniÿ¡
;

130 
	`Ing»ssAş
(
INGRESS_IPV4_ACL_TABLE_SIZE
, 
INGRESS_IPV6_ACL_TABLE_SIZE
, 0, 
çl£
è
aş
;

131 
	`Ing»ssTuÂ–
(è
tuÂ–
;

132 
	`MœrÜAş
(
¡©s_’abË
=
Œue
è
mœrÜ_aş
;

133 
	`ECNAş
(è
eú_aş
;

134 
	`PFCWd
(512è
pfc_wd
;

135 
	`Ing»ssQoS
(è
qos
;

136 
	`Nexthİ
(
NEXTHOP_TABLE_SIZE
, 
ECMP_GROUP_TABLE_SIZE
, 
ECMP_SELECT_TABLE_SIZE
è
Ãxthİ
;

137 
	`Ou‹rFib
(

138 
NUM_TUNNELS
, 
OUTER_ECMP_GROUP_TABLE_SIZE
, 
OUTER_ECMP_SELECT_TABLE_SIZE
è
ou‹r_fib
;

139 
	`LAG
(è
Ïg
;

140 
	`MuÉiÿ¡Floodšg
(
BD_FLOOD_TABLE_SIZE
è
æood
;

141 
	`Ing»ssSy¡emAş
(è
sy¡em_aş
;

143 
­¶y
 {

144 
ig_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

145 
ig_md
.
muÉiÿ¡
.
id
 = 0;

146 
ig_md
.
æags
.
¿ş_d’y
 = 
çl£
;

147 #ifdeà
MULTICAST_ENABLE


148 
ig_md
.
æags
.
æood_to_muÉiÿ¡_rou‹rs
 = 
çl£
;

151 
pkt_v®id©iÚ
.
	`­¶y
(

152 
hdr
, 
ig_md
.
æags
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
, ig_md.
drİ_»asÚ
);

153 
šg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

155 
tuÂ–
.
	`­¶y
(
hdr
, 
ig_md
, ig_md.
lkp
);

156 
smac
.
	`­¶y
(
ig_md
.
lkp
.
mac_¤c_addr
, ig_md, 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
);

157 
bd_¡©s
.
	`­¶y
(
ig_md
.
bd
, ig_md.
lkp
.
pkt_ty³
);

158 ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_UNICAST
) {

160 
uniÿ¡
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

161 } ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_MULTICAST
 &&

162 
ig_md
.
lkp
.
_ty³
 !ğ
SWITCH_IP_TYPE_NONE
) {

166 
dmac
.
	`­¶y
(
ig_md
.
lkp
.
mac_d¡_addr
, ig_md);

169 
aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

170 
mœrÜ_aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

171 ià(
ig_md
.
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_NONE
) {

172 
	`compu‹_nÚ__hash
(
ig_md
.
lkp
, ig_md.
hash
);

174 
	`compu‹__hash
(
ig_md
.
lkp
, ig_md.
hash
);

177 
Ãxthİ
.
	`­¶y
(
ig_md
.
lkp
, ig_md, ig_md.
hash
[15:0]);

178 
qos
.
	`­¶y
(
hdr
, 
ig_md
.
lkp
, ig_md);

179 
ou‹r_fib
.
	`­¶y
(
ig_md
, ig_md.
hash
[31:16]);

180 ià(
ig_md
.
eg»ss_ifšdex
 =ğ
SWITCH_IFINDEX_FLOOD
) {

181 
æood
.
	`­¶y
(
ig_md
);

183 
Ïg
.
	`­¶y
(
ig_md
, ig_md.
hash
[31:16], 
ig_šŒ_md_fÜ_tm
.
uÿ¡_eg»ss_pÜt
);

186 
eú_aş
.
	`­¶y
(
ig_md
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
.
·ck‘_cŞÜ
);

187 
pfc_wd
.
	`­¶y
(
ig_md
.
pÜt
, ig_md.
qos
.
qid
, ig_md.
æags
.
pfc_wd_drİ
);

189 
sy¡em_aş
.
	`­¶y
(

190 
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

193 ià(
ig_šŒ_md_fÜ_tm
.
by·ss_eg»ss
 =ğ1
w0
) {

194 
	`add_bridged_md
(
hdr
.
bridged_md
, 
ig_md
);

197 
	`£t_ig_šŒ_md
(
ig_md
, 
ig_šŒ_md_fÜ_d´¤
, 
ig_šŒ_md_fÜ_tm
);

199 
	}
}

201 
cÚŒŞ
 
	$Sw™chEg»ss
(

202 
šout
 
sw™ch_h—d”_t
 
hdr
,

203 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

204 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

205 
š
 
eg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
eg_šŒ_äom_´¤
,

206 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

207 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_ouut_pÜt_t
 
eg_šŒ_md_fÜ_İÜt
) {

208 
	`Eg»ssPÜtM­pšg
(è
eg»ss_pÜt_m­pšg
;

209 
	`Eg»ssQoS
(è
qos
;

210 
	`Eg»ssMœrÜAş
(è
mœrÜ_aş
;

211 
	`Eg»ssSy¡emAş
(è
sy¡em_aş
;

212 
	`PFCWd
(512è
pfc_wd
;

213 
	`Rewr™e
(
NEXTHOP_TABLE_SIZE
, 
BD_TABLE_SIZE
è
»wr™e
;

214 
	`MœrÜRewr™e
(è
mœrÜ_»wr™e
;

215 
	`VÏnXÏ‹
(
VLAN_TABLE_SIZE
, 
PORT_VLAN_TABLE_SIZE
è
vÏn_xÏ‹
;

216 
	`VÏnDeÿp
(è
vÏn_deÿp
;

217 
	`TuÂ–Deÿp
(
mode
=
sw™ch_tuÂ–_mode_t
.
PIPE
è
tuÂ–_deÿp
;

218 
	`TuÂ–Enÿp
(
mode
=
sw™ch_tuÂ–_mode_t
.
PIPE
è
tuÂ–_’ÿp
;

219 
	`TuÂ–Rewr™e
(
TUNNEL_IPV4_REWRITE_SIZE
, 
TUNNEL_IPV6_REWRITE_SIZE
, 1024è
tuÂ–_»wr™e
;

221 
	`MTU
(è
mtu
;

222 
	`WRED
(è
w»d
;

223 
	`MuÉiÿ¡R•liÿtiÚ
(è
muÉiÿ¡_»¶iÿtiÚ
;

225 
­¶y
 {

227 
eg_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

228 
mœrÜ_»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

229 
eg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md
.
eg»ss_pÜt
);

230 
vÏn_deÿp
.
	`­¶y
(
hdr
, 
eg_md
);

231 
tuÂ–_deÿp
.
	`­¶y
(
hdr
, 
eg_md
);

232 
»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

233 
qos
.
	`­¶y
(
hdr
, 
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
);

234 
w»d
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
,ƒg_md.
æags
.
w»d_drİ
);

235 
mœrÜ_aş
.
	`­¶y
(
hdr
, 
eg_md
.
lkp
,ƒg_md);

236 
tuÂ–_’ÿp
.
	`­¶y
(
hdr
, 
eg_md
);

237 
tuÂ–_»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

238 
mtu
.
	`­¶y
(
hdr
, 
eg_md
,ƒg_md.
checks
.mtu);

239 
vÏn_xÏ‹
.
	`­¶y
(
hdr
, 
eg_md
);

240 
pfc_wd
.
	`­¶y
(
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
.
qos
.
qid
,ƒg_md.
æags
.
pfc_wd_drİ
);

241 
sy¡em_aş
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
, 
eg_šŒ_md_fÜ_d´¤
);

243 
	`£t_eg_šŒ_md
(
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md_fÜ_İÜt
);

245 
	}
}

247 
P–še
(
Sw™chIng»ssP¬£r
(),

248 
Sw™chIng»ss
(),

249 
Sw™chIng»ssD•¬£r
(),

250 
Sw™chEg»ssP¬£r
(),

251 
Sw™chEg»ss
(),

252 
	$Sw™chEg»ssD•¬£r
()è
pe
;

254 
	$Sw™ch
(
pe
è
maš
;

	@switch-tofino/util.p4

23 
	~"ty³s.p4
"

26 
	gHash
<
	gb™
<32>>(
	gHashAlgÜ™hm_t
.
	gCRC32
è
	g_hash
;

27 
	gHash
<
	gb™
<32>>(
	gHashAlgÜ™hm_t
.
	gCRC32
è
	gnÚ__hash
;

29 
aùiÚ
 
compu‹__hash
(
š
 
sw™ch_lookup_f›lds_t
 
lkp
, 
out
 
b™
<32> 
hash
) {

30 
	ghash
 = 
_hash
.
g‘
({
lkp
.
_¤c_addr
,

31 
lkp
.
_d¡_addr
,

32 
lkp
.
_´Ùo
,

33 
lkp
.
l4_d¡_pÜt
,

34 
lkp
.
l4_¤c_pÜt
});

37 
aùiÚ
 
compu‹_nÚ__hash
(
š
 
sw™ch_lookup_f›lds_t
 
lkp
, 
out
 
b™
<32> 
hash
) {

38 
	ghash
 = 
nÚ__hash
.
g‘
({
lkp
.
mac_ty³
,†kp.
mac_¤c_addr
,†kp.
mac_d¡_addr
});

42 
aùiÚ
 
	$add_bridged_md
(

43 
šout
 
sw™ch_bridged_m‘ad©a_h
 
bridged_md
, 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
) {

44 
bridged_md
.
	`£tV®id
();

45 
bridged_md
.
¤c
 = 
SWITCH_PKT_SRC_BRIDGED
;

46 
bridged_md
.
ba£
 = {

47 
ig_md
.
pÜt
, ig_md.
ifšdex
, ig_md.
bd
, ig_md.
Ãxthİ
, ig_md.
lkp
.
pkt_ty³
,

48 
ig_md
.
æags
.
rou‹d
, ig_md.æags.
³”_lšk
, ig_md.
ıu_»asÚ
,

49 
ig_md
.
time¡amp
, ig_md.
qos
.
tc
, ig_md.qos.
qid
, ig_md.qos.
cŞÜ
};

51 #ià
	`defšed
(
EGRESS_IP_ACL_ENABLE
è|| defšed(
EGRESS_MIRROR_ACL_ENABLE
)

52 
bridged_md
.
aş
 = {
ig_md
.
lkp
.
l4_¤c_pÜt
,

53 
ig_md
.
lkp
.
l4_d¡_pÜt
,

54 
ig_md
.
lkp
.
tı_æags
,

55 
ig_md
.
l4_pÜt_Ïb–
};

58 #ifdeà
TUNNEL_ENABLE


59 
bridged_md
.
tuÂ–
 = {
ig_md
.tuÂ–.
šdex
,

60 
ig_md
.
ou‹r_Ãxthİ
,

61 
ig_md
.
hash
[15:0],

62 
ig_md
.
vrf
,

63 
ig_md
.
tuÂ–
.
‹rmš©e
};

66 #ifdeà
DTEL_ENABLE


67 
bridged_md
.
d‹l
 = {
ig_md
.d‹l.
»pÜt_ty³
,

68 
ig_md
.
d‹l
.
£ssiÚ_id
,

69 
ig_md
.
hash
,

70 
ig_md
.
eg»ss_pÜt
};

72 
	}
}

74 
aùiÚ
 
	$£t_ig_šŒ_md
(
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

75 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

76 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
) {

77 
ig_šŒ_md_fÜ_tm
.
mÿ¡_g½_b
 = 
ig_md
.
muÉiÿ¡
.
id
;

80 
ig_šŒ_md_fÜ_tm
.
Ëv–2_mÿ¡_hash
 = 
ig_md
.
hash
[28:16];

82 #ifdeà
QOS_ENABLE


83 
ig_šŒ_md_fÜ_tm
.
qid
 = 
ig_md
.
qos
.qid;

84 
ig_šŒ_md_fÜ_tm
.
šg»ss_cos
 = 
ig_md
.
qos
.
icos
;

86 
	}
}

88 
aùiÚ
 
	$£t_eg_šŒ_md
(
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

89 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

90 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_ouut_pÜt_t
 
eg_šŒ_md_fÜ_İÜt
) {

91 #ifdeà
PTP_ENABLE


92 
eg_šŒ_md_fÜ_İÜt
.
ÿ±u»_t¡amp_Ú_tx
 = 
eg_md
.
æags
.
ÿ±u»_ts
;

94 
eg_šŒ_md_fÜ_d´¤
.
mœrÜ_ty³
 = (
b™
<3>è
eg_md
.
mœrÜ
.
ty³
;

95 
	}
}

	@switch-tofino2/switch_tofino2_c0.p4

23 
	~<cÜe.p4
>

24 
	~<t2Ç.p4
>

29 
	#ACL_REDIRECT_ENABLE


	)

30 
	#COPP_ENABLE


	)

31 
	#DTEL_ENABLE


	)

32 
	#DTEL_QUEUE_REPORT_ENABLE


	)

33 
	#DTEL_DROP_REPORT_ENABLE


	)

34 
	#DTEL_FLOW_REPORT_ENABLE


	)

35 
	#DTEL_ACL_ENABLE


	)

36 
	#ECN_ACL_ENABLE


	)

37 
	#EGRESS_IP_ACL_ENABLE


	)

38 
	#EGRESS_PORT_MIRROR_ENABLE


	)

39 
	#ERSPAN_ENABLE


	)

40 
	#ERSPAN_TYPE2_ENABLE


	)

41 
	#INGRESS_ACL_POLICER_ENABLE


	)

42 
	#INGRESS_PORT_MIRROR_ENABLE


	)

43 
	#IPV6_ENABLE


	)

44 
	#L4_PORT_LOU_ENABLE


	)

45 
	#MIRROR_ENABLE


	)

46 
	#INGRESS_MIRROR_ACL_ENABLE


	)

47 
	#QOS_ENABLE


	)

48 
	#STORM_CONTROL_ENABLE


	)

49 
	#UNICAST_SELF_FORWARDING_CHECK


	)

50 
	#WRED_ENABLE


	)

51 
	#PACKET_LENGTH_ADJUSTMENT


	)

57 cÚ¡ 
	gb™
<32> 
	gVLAN_TABLE_SIZE
 = 4096;

58 cÚ¡ 
	gb™
<32> 
	gBD_FLOOD_TABLE_SIZE
 = 
VLAN_TABLE_SIZE
 * 4;

61 cÚ¡ 
	gb™
<32> 
	gPORT_VLAN_TABLE_SIZE
 = 1024;

64 cÚ¡ 
	gb™
<32> 
	gBD_TABLE_SIZE
 = 5120;

67 cÚ¡ 
	gb™
<32> 
	gMAC_TABLE_SIZE
 = 16384;

70 cÚ¡ 
	gb™
<32> 
	gIPV4_HOST_TABLE_SIZE
 = 65536;

71 cÚ¡ 
	gb™
<32> 
	gIPV4_LPM_TABLE_SIZE
 = 32786;

72 cÚ¡ 
	gb™
<32> 
	gIPV6_HOST_TABLE_SIZE
 = 192512;

73 cÚ¡ 
	gb™
<32> 
	gIPV6_LPM_TABLE_SIZE
 = 36864;

76 cÚ¡ 
	gb™
<32> 
	gECMP_GROUP_TABLE_SIZE
 = 1024;

77 cÚ¡ 
	gb™
<32> 
	gECMP_SELECT_TABLE_SIZE
 = 16384;

78 
	#sw™ch_Ãxthİ_width
 14

	)

79 cÚ¡ 
	gb™
<32> 
	gNEXTHOP_TABLE_SIZE
 = 1 << 
sw™ch_Ãxthİ_width
;

82 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_ACL_TABLE_SIZE
 = 2048;

83 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_ACL_TABLE_SIZE
 = 2048;

86 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV4_ACL_TABLE_SIZE
 = 512;

87 cÚ¡ 
	gb™
<32> 
	gEGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

89 
	~"h—d”s.p4
"

90 
	~"ty³s.p4
"

91 
	~"ut.p4
"

93 
	~"l3.p4
"

94 
	~"Ãxthİ.p4
"

95 
	~"·rde.p4
"

96 
	~"pÜt.p4
"

97 
	~"v®id©iÚ.p4
"

98 
	~"»wr™e.p4
"

99 
	~"muÉiÿ¡.p4
"

100 
	~"qos.p4
"

101 
	~"m‘”.p4
"

102 
	~"w»d.p4
"

103 
	~"aş.p4
"

104 
	~"d‹l.p4
"

106 
cÚŒŞ
 
	$Sw™chIng»ss
(

107 
šout
 
sw™ch_h—d”_t
 
hdr
,

108 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

109 
š
 
šg»ss_šŒšsic_m‘ad©a_t
 
ig_šŒ_md
,

110 
š
 
šg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
ig_šŒ_äom_´¤
,

111 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

112 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
) {

113 
	`Ing»ssPÜtM­pšg
(
PORT_VLAN_TABLE_SIZE
, 
BD_TABLE_SIZE
è
šg»ss_pÜt_m­pšg
;

114 
	`PktV®id©iÚ
(è
pkt_v®id©iÚ
;

115 
	`SMAC
(
MAC_TABLE_SIZE
è
smac
;

116 
	`DMAC
(
MAC_TABLE_SIZE
è
dmac
;

117 
	`Ing»ssBd
(
BD_TABLE_SIZE
è
bd_¡©s
;

118 
	`Ing»ssUniÿ¡
(
dmac
,

119 
IPV4_HOST_TABLE_SIZE
,

120 
IPV4_LPM_TABLE_SIZE
,

121 
IPV6_HOST_TABLE_SIZE
,

122 
IPV6_LPM_TABLE_SIZE
è
uniÿ¡
;

123 
	`Ing»ssAş
(

124 
INGRESS_IPV4_ACL_TABLE_SIZE
, 
INGRESS_IPV6_ACL_TABLE_SIZE
, 0, 
çl£
è
aş
;

125 
	`MœrÜAş
(
¡©s_’abË
=
Œue
è
mœrÜ_aş
;

126 
	`ECNAş
(è
eú_aş
;

127 
	`PFCWd
(512è
pfc_wd
;

128 
	`Ing»ssQoS
(è
qos
;

129 
	`StÜmCÚŒŞ
(è
¡Üm_cÚŒŞ
;

130 
	`Nexthİ
(
NEXTHOP_TABLE_SIZE
, 
ECMP_GROUP_TABLE_SIZE
, 
ECMP_SELECT_TABLE_SIZE
è
Ãxthİ
;

131 
	`LAG
(è
Ïg
;

132 
	`MuÉiÿ¡Floodšg
(
BD_FLOOD_TABLE_SIZE
è
æood
;

133 
	`Ing»ssSy¡emAş
(è
sy¡em_aş
;

134 
	`Ing»ssD‹l
(è
d‹l
;

136 
­¶y
 {

137 
ig_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

138 
ig_md
.
muÉiÿ¡
.
id
 = 0;

139 
ig_md
.
æags
.
¿ş_d’y
 = 
çl£
;

140 #ifdeà
MULTICAST_ENABLE


141 
ig_md
.
æags
.
æood_to_muÉiÿ¡_rou‹rs
 = 
çl£
;

144 
pkt_v®id©iÚ
.
	`­¶y
(

145 
hdr
, 
ig_md
.
æags
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
, ig_md.
drİ_»asÚ
);

146 
šg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

147 
smac
.
	`­¶y
(
ig_md
.
lkp
.
mac_¤c_addr
, ig_md, 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
);

148 
bd_¡©s
.
	`­¶y
(
ig_md
.
bd
, ig_md.
lkp
.
pkt_ty³
);

149 ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_UNICAST
) {

151 
uniÿ¡
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

152 } ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_MULTICAST
 &&

153 
ig_md
.
lkp
.
_ty³
 !ğ
SWITCH_IP_TYPE_NONE
) {

157 
dmac
.
	`­¶y
(
ig_md
.
lkp
.
mac_d¡_addr
, ig_md);

160 
aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

161 
mœrÜ_aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

163 ià(
ig_md
.
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_NONE
) {

164 
	`compu‹_nÚ__hash
(
ig_md
.
lkp
, ig_md.
hash
);

166 
	`compu‹__hash
(
ig_md
.
lkp
, ig_md.
hash
);

169 
Ãxthİ
.
	`­¶y
(
ig_md
.
lkp
, ig_md, ig_md.
hash
[15:0]);

170 
qos
.
	`­¶y
(
hdr
, 
ig_md
.
lkp
, ig_md);

171 
¡Üm_cÚŒŞ
.
	`­¶y
(
ig_md
, ig_md.
lkp
.
pkt_ty³
, ig_md.
æags
.
¡Üm_cÚŒŞ_drİ
);

173 ià(
ig_md
.
eg»ss_ifšdex
 =ğ
SWITCH_IFINDEX_FLOOD
) {

174 
æood
.
	`­¶y
(
ig_md
);

176 
Ïg
.
	`­¶y
(
ig_md
, ig_md.
hash
[31:16], 
ig_šŒ_md_fÜ_tm
.
uÿ¡_eg»ss_pÜt
);

179 
eú_aş
.
	`­¶y
(
ig_md
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
.
·ck‘_cŞÜ
);

180 
pfc_wd
.
	`­¶y
(
ig_md
.
pÜt
, ig_md.
qos
.
qid
, ig_md.
æags
.
pfc_wd_drİ
);

182 
sy¡em_aş
.
	`­¶y
(
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

183 
d‹l
.
	`­¶y
(

184 
hdr
, 
ig_md
.
lkp
, ig_md, ig_md.
hash
[15:0], 
ig_šŒ_md_fÜ_d´¤
, 
ig_šŒ_md_fÜ_tm
);

187 ià(
ig_šŒ_md_fÜ_tm
.
by·ss_eg»ss
 =ğ1
w0
) {

188 
	`add_bridged_md
(
hdr
.
bridged_md
, 
ig_md
);

191 
	`£t_ig_šŒ_md
(
ig_md
, 
ig_šŒ_md_fÜ_d´¤
, 
ig_šŒ_md_fÜ_tm
);

193 
	}
}

195 
cÚŒŞ
 
	$Sw™chEg»ss
(

196 
šout
 
sw™ch_h—d”_t
 
hdr
,

197 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

198 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

199 
š
 
eg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
eg_šŒ_äom_´¤
,

200 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

201 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_ouut_pÜt_t
 
eg_šŒ_md_fÜ_İÜt
) {

202 
	`Eg»ssPÜtM­pšg
(è
eg»ss_pÜt_m­pšg
;

203 
	`Eg»ssAş
(
EGRESS_IPV4_ACL_TABLE_SIZE
, 
EGRESS_IPV6_ACL_TABLE_SIZE
, 0è
aş
;

204 
	`Eg»ssQoS
(è
qos
;

205 
	`Eg»ssSy¡emAş
(è
sy¡em_aş
;

206 
	`PFCWd
(512è
pfc_wd
;

207 
	`Rewr™e
(
NEXTHOP_TABLE_SIZE
, 
BD_TABLE_SIZE
è
»wr™e
;

208 
	`MœrÜRewr™e
(è
mœrÜ_»wr™e
;

209 
	`VÏnXÏ‹
(
VLAN_TABLE_SIZE
, 
PORT_VLAN_TABLE_SIZE
è
vÏn_xÏ‹
;

210 
	`VÏnDeÿp
(è
vÏn_deÿp
;

211 
	`MTU
(è
mtu
;

212 
	`WRED
(è
w»d
;

213 
	`MuÉiÿ¡R•liÿtiÚ
(è
muÉiÿ¡_»¶iÿtiÚ
;

214 
	`Eg»ssD‹l
(è
d‹l
;

216 
­¶y
 {

217 
eg_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

218 
eg_md
.
time¡amp
 = 
eg_šŒ_äom_´¤
.
glob®_t¡amp
[31:0];

219 
eg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md
.
eg»ss_pÜt
);

220 
muÉiÿ¡_»¶iÿtiÚ
.
	`­¶y
(

221 
eg_šŒ_md
.
eg»ss_rid
,ƒg_šŒ_md.
eg»ss_pÜt
, 
eg_md
);

222 
mœrÜ_»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

223 
vÏn_deÿp
.
	`­¶y
(
hdr
, 
eg_md
);

224 
qos
.
	`­¶y
(
hdr
, 
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
);

225 
w»d
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
,ƒg_md.
æags
.
w»d_drİ
);

227 
»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

228 
aş
.
	`­¶y
(
hdr
, 
eg_md
.
lkp
,ƒg_md);

229 
mtu
.
	`­¶y
(
hdr
, 
eg_md
,ƒg_md.
checks
.mtu);

230 
vÏn_xÏ‹
.
	`­¶y
(
hdr
, 
eg_md
);

231 
pfc_wd
.
	`­¶y
(
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
.
qos
.
qid
,ƒg_md.
æags
.
pfc_wd_drİ
);

233 
d‹l
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
,ƒg_md.d‹l.
hash
, 
eg_šŒ_md_fÜ_d´¤
);

234 
sy¡em_aş
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
, 
eg_šŒ_md_fÜ_d´¤
);

236 
	`£t_eg_šŒ_md
(
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md_fÜ_İÜt
);

238 
	}
}

240 
P–še
(
Sw™chIng»ssP¬£r
(),

241 
Sw™chIng»ss
(),

242 
Sw™chIng»ssD•¬£r
(),

243 
Sw™chEg»ssP¬£r
(),

244 
Sw™chEg»ss
(),

245 
	$Sw™chEg»ssD•¬£r
()è
pe
;

247 
	$Sw™ch
(
pe
è
maš
;

	@switch-tofino2/switch_tofino2_d0.p4

23 
	~<cÜe.p4
>

24 
	~<t2Ç.p4
>

29 
	#ACL_REDIRECT_ENABLE


	)

30 
	#COPP_ENABLE


	)

31 
	#ECN_ACL_ENABLE


	)

32 
	#EGRESS_PORT_MIRROR_ENABLE


	)

33 
	#EGRESS_MIRROR_ACL_ENABLE


	)

34 
	#ERSPAN_ENABLE


	)

35 
	#ERSPAN_TYPE2_ENABLE


	)

36 
	#INGRESS_ACL_POLICER_ENABLE


	)

37 
	#INGRESS_PORT_MIRROR_ENABLE


	)

38 
	#IPINIP_ENABLE


	)

39 
	#IPV6_ENABLE


	)

40 
	#L4_PORT_LOU_ENABLE


	)

41 
	#MIRROR_ENABLE


	)

42 
	#INGRESS_MIRROR_ACL_ENABLE


	)

43 
	#QOS_ENABLE


	)

44 
	#TUNNEL_ENABLE


	)

45 
	#IPV6_TUNNEL_ENABLE


	)

46 
	#VXLAN_ENABLE


	)

47 
	#WRED_ENABLE


	)

54 cÚ¡ 
	gb™
<32> 
	gVLAN_TABLE_SIZE
 = 4096;

55 cÚ¡ 
	gb™
<32> 
	gBD_FLOOD_TABLE_SIZE
 = 
VLAN_TABLE_SIZE
 * 4;

58 cÚ¡ 
	gb™
<32> 
	gPORT_VLAN_TABLE_SIZE
 = 1024;

61 cÚ¡ 
	gb™
<32> 
	gDOUBLE_TAG_TABLE_SIZE
 = 4096;

64 
	#sw™ch_vrf_width
 14

	)

67 cÚ¡ 
	gb™
<32> 
	gBD_TABLE_SIZE
 = 5120;

70 cÚ¡ 
	gb™
<32> 
	gMAC_TABLE_SIZE
 = 4096;

73 
	#sw™ch_tuÂ–_šdex_width
 18

	)

74 cÚ¡ 
	gb™
<32> 
	gTUNNEL_IPV4_REWRITE_SIZE
 = 262144;

75 cÚ¡ 
	gb™
<32> 
	gTUNNEL_IPV6_REWRITE_SIZE
 = 98304;

76 cÚ¡ 
	gb™
<32> 
	gNUM_TUNNELS
 = 
TUNNEL_IPV4_REWRITE_SIZE
 + 
TUNNEL_IPV6_REWRITE_SIZE
;

77 cÚ¡ 
	gb™
<32> 
	gOUTER_ECMP_GROUP_TABLE_SIZE
 = 1024;

78 cÚ¡ 
	gb™
<32> 
	gOUTER_ECMP_SELECT_TABLE_SIZE
 = 16384;

81 cÚ¡ 
	gb™
<32> 
	gIPV4_HOST_TABLE_SIZE
 = 
NUM_TUNNELS
;

82 cÚ¡ 
	gb™
<32> 
	gIPV4_LPM_TABLE_SIZE
 = 2048;

83 cÚ¡ 
	gb™
<32> 
	gIPV6_HOST_TABLE_SIZE
 = 8192;

84 cÚ¡ 
	gb™
<32> 
	gIPV6_LPM_TABLE_SIZE
 = 10240;

87 cÚ¡ 
	gb™
<32> 
	gECMP_GROUP_TABLE_SIZE
 = 1024;

88 cÚ¡ 
	gb™
<32> 
	gECMP_SELECT_TABLE_SIZE
 = 16384;

89 
	#sw™ch_Ãxthİ_width
 19

	)

90 cÚ¡ 
	gb™
<32> 
	gNEXTHOP_TABLE_SIZE
 = 
NUM_TUNNELS
;

93 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV4_ACL_TABLE_SIZE
 = 1024;

94 cÚ¡ 
	gb™
<32> 
	gINGRESS_IPV6_ACL_TABLE_SIZE
 = 512;

96 
	~"h—d”s.p4
"

97 
	~"ty³s.p4
"

98 
	~"ut.p4
"

100 
	~"l3.p4
"

101 
	~"Ãxthİ.p4
"

102 
	~"·rde.p4
"

103 
	~"pÜt.p4
"

104 
	~"v®id©iÚ.p4
"

105 
	~"»wr™e.p4
"

106 
	~"muÉiÿ¡.p4
"

107 
	~"qos.p4
"

108 
	~"m‘”.p4
"

109 
	~"w»d.p4
"

110 
	~"tuÂ–.p4
"

111 
	~"aş.p4
"

113 
cÚŒŞ
 
	$Sw™chIng»ss
(

114 
šout
 
sw™ch_h—d”_t
 
hdr
,

115 
šout
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

116 
š
 
šg»ss_šŒšsic_m‘ad©a_t
 
ig_šŒ_md
,

117 
š
 
šg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
ig_šŒ_äom_´¤
,

118 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

119 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
) {

120 
	`Ing»ssPÜtM­pšg
(
PORT_VLAN_TABLE_SIZE
, 
BD_TABLE_SIZE
è
šg»ss_pÜt_m­pšg
;

121 
	`PktV®id©iÚ
(è
pkt_v®id©iÚ
;

122 
	`SMAC
(
MAC_TABLE_SIZE
è
smac
;

123 
	`DMAC
(
MAC_TABLE_SIZE
è
dmac
;

124 
	`Ing»ssBd
(
BD_TABLE_SIZE
è
bd_¡©s
;

125 
	`Ing»ssUniÿ¡
(
dmac
,

126 
IPV4_HOST_TABLE_SIZE
,

127 
IPV4_LPM_TABLE_SIZE
,

128 
IPV6_HOST_TABLE_SIZE
,

129 
IPV6_LPM_TABLE_SIZE
è
uniÿ¡
;

130 
	`Ing»ssAş
(
INGRESS_IPV4_ACL_TABLE_SIZE
, 
INGRESS_IPV6_ACL_TABLE_SIZE
, 0, 
çl£
è
aş
;

131 
	`Ing»ssTuÂ–
(è
tuÂ–
;

132 
	`MœrÜAş
(
¡©s_’abË
=
Œue
è
mœrÜ_aş
;

133 
	`ECNAş
(è
eú_aş
;

134 
	`PFCWd
(512è
pfc_wd
;

135 
	`Ing»ssQoS
(è
qos
;

136 
	`Nexthİ
(
NEXTHOP_TABLE_SIZE
, 
ECMP_GROUP_TABLE_SIZE
, 
ECMP_SELECT_TABLE_SIZE
è
Ãxthİ
;

137 
	`Ou‹rFib
(

138 
NUM_TUNNELS
, 
OUTER_ECMP_GROUP_TABLE_SIZE
, 
OUTER_ECMP_SELECT_TABLE_SIZE
è
ou‹r_fib
;

139 
	`LAG
(è
Ïg
;

140 
	`MuÉiÿ¡Floodšg
(
BD_FLOOD_TABLE_SIZE
è
æood
;

141 
	`Ing»ssSy¡emAş
(è
sy¡em_aş
;

143 
­¶y
 {

144 
pkt_v®id©iÚ
.
	`­¶y
(

145 
hdr
, 
ig_md
.
æags
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
, ig_md.
drİ_»asÚ
);

146 
šg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

148 
tuÂ–
.
	`­¶y
(
hdr
, 
ig_md
, ig_md.
lkp
);

149 
smac
.
	`­¶y
(
ig_md
.
lkp
.
mac_¤c_addr
, ig_md, 
ig_šŒ_md_fÜ_d´¤
.
dige¡_ty³
);

150 
bd_¡©s
.
	`­¶y
(
ig_md
.
bd
, ig_md.
lkp
.
pkt_ty³
);

151 ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_UNICAST
) {

153 
uniÿ¡
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

154 } ià(
ig_md
.
lkp
.
pkt_ty³
 =ğ
SWITCH_PKT_TYPE_MULTICAST
 &&

155 
ig_md
.
lkp
.
_ty³
 !ğ
SWITCH_IP_TYPE_NONE
) {

159 
dmac
.
	`­¶y
(
ig_md
.
lkp
.
mac_d¡_addr
, ig_md);

162 
aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

163 
mœrÜ_aş
.
	`­¶y
(
ig_md
.
lkp
, ig_md);

164 ià(
ig_md
.
lkp
.
_ty³
 =ğ
SWITCH_IP_TYPE_NONE
) {

165 
	`compu‹_nÚ__hash
(
ig_md
.
lkp
, ig_md.
hash
);

167 
	`compu‹__hash
(
ig_md
.
lkp
, ig_md.
hash
);

170 
Ãxthİ
.
	`­¶y
(
ig_md
.
lkp
, ig_md, ig_md.
hash
[15:0]);

171 
qos
.
	`­¶y
(
hdr
, 
ig_md
.
lkp
, ig_md);

172 
ou‹r_fib
.
	`­¶y
(
ig_md
, ig_md.
hash
[31:16]);

173 ià(
ig_md
.
eg»ss_ifšdex
 =ğ
SWITCH_IFINDEX_FLOOD
) {

174 
æood
.
	`­¶y
(
ig_md
);

176 
Ïg
.
	`­¶y
(
ig_md
, ig_md.
hash
[31:16], 
ig_šŒ_md_fÜ_tm
.
uÿ¡_eg»ss_pÜt
);

179 
eú_aş
.
	`­¶y
(
ig_md
, ig_md.
lkp
, 
ig_šŒ_md_fÜ_tm
.
·ck‘_cŞÜ
);

180 
pfc_wd
.
	`­¶y
(
ig_md
.
pÜt
, ig_md.
qos
.
qid
, ig_md.
æags
.
pfc_wd_drİ
);

182 
sy¡em_aş
.
	`­¶y
(

183 
ig_md
, 
ig_šŒ_md_fÜ_tm
, 
ig_šŒ_md_fÜ_d´¤
);

186 ià(
ig_šŒ_md_fÜ_tm
.
by·ss_eg»ss
 =ğ1
w0
) {

187 
	`add_bridged_md
(
hdr
.
bridged_md
, 
ig_md
);

190 
	`£t_ig_šŒ_md
(
ig_md
, 
ig_šŒ_md_fÜ_d´¤
, 
ig_šŒ_md_fÜ_tm
);

192 
	}
}

194 
cÚŒŞ
 
	$Sw™chEg»ss
(

195 
šout
 
sw™ch_h—d”_t
 
hdr
,

196 
šout
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

197 
š
 
eg»ss_šŒšsic_m‘ad©a_t
 
eg_šŒ_md
,

198 
š
 
eg»ss_šŒšsic_m‘ad©a_äom_·r£r_t
 
eg_šŒ_äom_´¤
,

199 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

200 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_ouut_pÜt_t
 
eg_šŒ_md_fÜ_İÜt
) {

201 
	`Eg»ssPÜtM­pšg
(è
eg»ss_pÜt_m­pšg
;

202 
	`Eg»ssQoS
(è
qos
;

203 
	`Eg»ssMœrÜAş
(è
mœrÜ_aş
;

204 
	`Eg»ssSy¡emAş
(è
sy¡em_aş
;

205 
	`PFCWd
(512è
pfc_wd
;

206 
	`Rewr™e
(
NEXTHOP_TABLE_SIZE
, 
BD_TABLE_SIZE
è
»wr™e
;

207 
	`MœrÜRewr™e
(è
mœrÜ_»wr™e
;

208 
	`VÏnXÏ‹
(
VLAN_TABLE_SIZE
, 
PORT_VLAN_TABLE_SIZE
è
vÏn_xÏ‹
;

209 
	`VÏnDeÿp
(è
vÏn_deÿp
;

210 
	`TuÂ–Deÿp
(
mode
=
sw™ch_tuÂ–_mode_t
.
PIPE
è
tuÂ–_deÿp
;

211 
	`TuÂ–Enÿp
(
mode
=
sw™ch_tuÂ–_mode_t
.
PIPE
è
tuÂ–_’ÿp
;

212 
	`TuÂ–Rewr™e
(
TUNNEL_IPV4_REWRITE_SIZE
, 
TUNNEL_IPV6_REWRITE_SIZE
, 1024è
tuÂ–_»wr™e
;

214 
	`MTU
(è
mtu
;

215 
	`WRED
(è
w»d
;

216 
	`MuÉiÿ¡R•liÿtiÚ
(è
muÉiÿ¡_»¶iÿtiÚ
;

218 
­¶y
 {

220 
eg_šŒ_md_fÜ_d´¤
.
drİ_ùl
 = 0;

221 
mœrÜ_»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

222 
eg»ss_pÜt_m­pšg
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md
.
eg»ss_pÜt
);

223 
vÏn_deÿp
.
	`­¶y
(
hdr
, 
eg_md
);

224 
tuÂ–_deÿp
.
	`­¶y
(
hdr
, 
eg_md
);

225 
»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

226 
qos
.
	`­¶y
(
hdr
, 
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
);

227 
w»d
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
,ƒg_md.
æags
.
w»d_drİ
);

228 
mœrÜ_aş
.
	`­¶y
(
hdr
, 
eg_md
.
lkp
,ƒg_md);

229 
tuÂ–_’ÿp
.
	`­¶y
(
hdr
, 
eg_md
);

230 
tuÂ–_»wr™e
.
	`­¶y
(
hdr
, 
eg_md
);

231 
mtu
.
	`­¶y
(
hdr
, 
eg_md
,ƒg_md.
checks
.mtu);

232 
vÏn_xÏ‹
.
	`­¶y
(
hdr
, 
eg_md
);

233 
pfc_wd
.
	`­¶y
(
eg_šŒ_md
.
eg»ss_pÜt
, 
eg_md
.
qos
.
qid
,ƒg_md.
æags
.
pfc_wd_drİ
);

234 
sy¡em_aş
.
	`­¶y
(
hdr
, 
eg_md
, 
eg_šŒ_md
, 
eg_šŒ_md_fÜ_d´¤
);

236 
	`£t_eg_šŒ_md
(
eg_md
, 
eg_šŒ_md_fÜ_d´¤
, 
eg_šŒ_md_fÜ_İÜt
);

238 
	}
}

240 
P–še
(
Sw™chIng»ssP¬£r
(),

241 
Sw™chIng»ss
(),

242 
Sw™chIng»ssD•¬£r
(),

243 
Sw™chEg»ssP¬£r
(),

244 
Sw™chEg»ss
(),

245 
	$Sw™chEg»ssD•¬£r
()è
pe
;

247 
	$Sw™ch
(
pe
è
maš
;

	@switch-tofino2/util.p4

23 
	~"ty³s.p4
"

26 
	gHash
<
	gb™
<32>>(
	gHashAlgÜ™hm_t
.
	gCRC32
è
	g_hash
;

27 
	gHash
<
	gb™
<32>>(
	gHashAlgÜ™hm_t
.
	gCRC32
è
	gnÚ__hash
;

29 
aùiÚ
 
compu‹__hash
(
š
 
sw™ch_lookup_f›lds_t
 
lkp
, 
out
 
b™
<32> 
hash
) {

30 
	ghash
 = 
_hash
.
g‘
({
lkp
.
_¤c_addr
,

31 
lkp
.
_d¡_addr
,

32 
lkp
.
_´Ùo
,

33 
lkp
.
l4_d¡_pÜt
,

34 
lkp
.
l4_¤c_pÜt
});

37 
aùiÚ
 
compu‹_nÚ__hash
(
š
 
sw™ch_lookup_f›lds_t
 
lkp
, 
out
 
b™
<32> 
hash
) {

38 
	ghash
 = 
nÚ__hash
.
g‘
({
lkp
.
mac_ty³
,†kp.
mac_¤c_addr
,†kp.
mac_d¡_addr
});

42 
aùiÚ
 
	$add_bridged_md
(

43 
šout
 
sw™ch_bridged_m‘ad©a_h
 
bridged_md
, 
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
) {

44 
bridged_md
.
	`£tV®id
();

45 
bridged_md
.
¤c
 = 
SWITCH_PKT_SRC_BRIDGED
;

46 
bridged_md
.
ba£
 = {

47 
ig_md
.
pÜt
, ig_md.
ifšdex
, ig_md.
bd
, ig_md.
Ãxthİ
, ig_md.
lkp
.
pkt_ty³
,

48 
ig_md
.
æags
.
rou‹d
, ig_md.æags.
³”_lšk
, ig_md.
ıu_»asÚ
,

49 
ig_md
.
time¡amp
, ig_md.
qos
.
tc
, ig_md.qos.
qid
, ig_md.qos.
cŞÜ
};

51 #ià
	`defšed
(
EGRESS_IP_ACL_ENABLE
è|| defšed(
EGRESS_MIRROR_ACL_ENABLE
)

52 
bridged_md
.
aş
 = {
ig_md
.
lkp
.
l4_¤c_pÜt
,

53 
ig_md
.
lkp
.
l4_d¡_pÜt
,

54 
ig_md
.
lkp
.
tı_æags
,

55 
ig_md
.
l4_pÜt_Ïb–
};

58 #ifdeà
TUNNEL_ENABLE


59 
bridged_md
.
tuÂ–
 = {
ig_md
.tuÂ–.
šdex
,

60 
ig_md
.
ou‹r_Ãxthİ
,

61 
ig_md
.
hash
[15:0],

62 
ig_md
.
vrf
,

63 
ig_md
.
tuÂ–
.
‹rmš©e
};

66 #ifdeà
DTEL_ENABLE


67 
bridged_md
.
d‹l
 = {
ig_md
.d‹l.
»pÜt_ty³
,

68 
ig_md
.
d‹l
.
£ssiÚ_id
,

69 
ig_md
.
hash
,

70 
ig_md
.
eg»ss_pÜt
};

72 
	}
}

74 
aùiÚ
 
	$£t_ig_šŒ_md
(
š
 
sw™ch_šg»ss_m‘ad©a_t
 
ig_md
,

75 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
ig_šŒ_md_fÜ_d´¤
,

76 
šout
 
šg»ss_šŒšsic_m‘ad©a_fÜ_tm_t
 
ig_šŒ_md_fÜ_tm
) {

79 
ig_šŒ_md_fÜ_tm
.
Ëv–2_mÿ¡_hash
 = 
ig_md
.
hash
[28:16];

80 
ig_šŒ_md_fÜ_tm
.
mÿ¡_g½_b
 = 
ig_md
.
muÉiÿ¡
.
id
;

82 #ifdeà
QOS_ENABLE


83 
ig_šŒ_md_fÜ_tm
.
qid
 = 
ig_md
.
qos
.qid;

84 
ig_šŒ_md_fÜ_tm
.
šg»ss_cos
 = 
ig_md
.
qos
.
icos
;

86 
	}
}

88 
aùiÚ
 
	$£t_eg_šŒ_md
(
š
 
sw™ch_eg»ss_m‘ad©a_t
 
eg_md
,

89 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_d•¬£r_t
 
eg_šŒ_md_fÜ_d´¤
,

90 
šout
 
eg»ss_šŒšsic_m‘ad©a_fÜ_ouut_pÜt_t
 
eg_šŒ_md_fÜ_İÜt
) {

91 #ifdeà
PTP_ENABLE


92 
eg_šŒ_md_fÜ_İÜt
.
ÿ±u»_t¡amp_Ú_tx
 = 
eg_md
.
æags
.
ÿ±u»_ts
;

94 #ifdeà
MIRROR_ENABLE


95 
eg_šŒ_md_fÜ_d´¤
.
mœrÜ_ty³
 = (
b™
<4>è
eg_md
.
mœrÜ
.
ty³
;

96 
eg_šŒ_md_fÜ_d´¤
.
mœrÜ_io_£Ëù
 = 1;

98 
	}
}

	@
1
.
0
26
551
shared/acl.p4
shared/dtel.p4
shared/headers.p4
shared/l2.p4
shared/l3.p4
shared/meter.p4
shared/multicast.p4
shared/nexthop.p4
shared/parde.p4
shared/port.p4
shared/qos.p4
shared/rewrite.p4
shared/table_sizes.p4
shared/tunnel.p4
shared/types.p4
shared/validation.p4
shared/wred.p4
switch-tofino/features.p4
switch-tofino/switch.p4
switch-tofino/switch_profile_l0.p4
switch-tofino/switch_tofino_a0.p4
switch-tofino/switch_tofino_b0.p4
switch-tofino/util.p4
switch-tofino2/switch_tofino2_c0.p4
switch-tofino2/switch_tofino2_d0.p4
switch-tofino2/util.p4
